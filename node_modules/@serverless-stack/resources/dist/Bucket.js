"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Bucket = void 0;
const constructs_1 = require("constructs");
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const s3Notifications = __importStar(require("aws-cdk-lib/aws-s3-notifications"));
const Queue_1 = require("./Queue");
const Topic_1 = require("./Topic");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class Bucket extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const { s3Bucket, notifications, defaultFunctionProps } = props || {};
        this.notifications = [];
        this.permissionsAttachedForAllNotifications = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Bucket
        ////////////////////
        if (Construct_1.isCDKConstruct(s3Bucket)) {
            this.s3Bucket = s3Bucket;
        }
        else {
            const s3BucketProps = (s3Bucket || {});
            this.s3Bucket = new s3.Bucket(this, "Bucket", Object.assign({}, s3BucketProps));
        }
        ///////////////////////////
        // Create Notifications
        ///////////////////////////
        this.addNotifications(this, notifications || []);
    }
    get bucketArn() {
        return this.s3Bucket.bucketArn;
    }
    get bucketName() {
        return this.s3Bucket.bucketName;
    }
    get notificationFunctions() {
        return this.notifications.filter((notification) => notification instanceof Function_1.Function);
    }
    addNotifications(scope, notifications) {
        notifications.forEach((notification) => this.addNotification(scope, notification));
    }
    attachPermissions(permissions) {
        this.notifications
            .filter((notification) => notification instanceof Function_1.Function)
            .forEach((notification) => notification.attachPermissions(permissions));
        this.permissionsAttachedForAllNotifications.push(permissions);
    }
    attachPermissionsToNotification(index, permissions) {
        const notification = this.notifications[index];
        if (!(notification instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" Bucket notification because it's not a Lambda function`);
        }
        notification.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "Bucket",
            data: {
                name: this.s3Bucket.bucketName,
                notifications: this.notifications.map((n) => Construct_1.getFunctionRef(n)),
            },
        };
    }
    addNotification(scope, notification) {
        if (notification instanceof Queue_1.Queue ||
            notification.queue) {
            notification = notification;
            this.addQueueNotification(scope, notification);
        }
        else if (notification instanceof Topic_1.Topic ||
            notification.topic) {
            notification = notification;
            this.addTopicNotification(scope, notification);
        }
        else {
            notification = notification;
            this.addFunctionNotification(scope, notification);
        }
    }
    addQueueNotification(scope, notification) {
        // Parse notification props
        let notificationProps;
        let queue;
        if (notification instanceof Queue_1.Queue) {
            notification = notification;
            queue = notification;
        }
        else {
            notification = notification;
            notificationProps = notification.notificationProps;
            queue = notification.queue;
        }
        this.notifications.push(queue);
        // Create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            s3.EventType.OBJECT_CREATED,
            s3.EventType.OBJECT_REMOVED,
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.s3Bucket.addEventNotification(event, new s3Notifications.SqsDestination(queue.sqsQueue), ...filters));
    }
    addTopicNotification(scope, notification) {
        // Parse notification props
        let notificationProps;
        let topic;
        if (notification instanceof Topic_1.Topic) {
            notification = notification;
            topic = notification;
        }
        else {
            notification = notification;
            notificationProps = notification.notificationProps;
            topic = notification.topic;
        }
        this.notifications.push(topic);
        // Create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            s3.EventType.OBJECT_CREATED,
            s3.EventType.OBJECT_REMOVED,
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.s3Bucket.addEventNotification(event, new s3Notifications.SnsDestination(topic.snsTopic), ...filters));
    }
    addFunctionNotification(scope, notification) {
        // parse notification
        let notificationFunction, notificationProps;
        if (notification.function) {
            notification = notification;
            notificationFunction = notification.function;
            notificationProps = notification.notificationProps;
        }
        else {
            notificationFunction = notification;
        }
        // create function
        const i = this.notifications.length;
        const fn = Function_1.Function.fromDefinition(scope, `Notification_${this.node.id}_${i}`, notificationFunction, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the Table construct can apply the "defaultFunctionProps" to them.`);
        this.notifications.push(fn);
        // create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            s3.EventType.OBJECT_CREATED,
            s3.EventType.OBJECT_REMOVED,
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.s3Bucket.addEventNotification(event, new s3Notifications.LambdaDestination(fn), ...filters));
        // attached permissions
        this.permissionsAttachedForAllNotifications.forEach((permissions) => fn.attachPermissions(permissions));
    }
}
exports.Bucket = Bucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0J1Y2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBQ3ZDLHVEQUF5QztBQUN6QyxrRkFBb0U7QUFDcEUsbUNBQWdDO0FBQ2hDLG1DQUFnQztBQUNoQywyQ0FBMkU7QUFDM0UseUNBQStFO0FBd0MvRSxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLE1BQU8sU0FBUSxzQkFBUztJQU1uQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQW1CO1FBQzNELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3RFLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxzQ0FBc0MsR0FBRyxFQUFFLENBQUM7UUFDakQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO1FBRWpELG9CQUFvQjtRQUNwQixnQkFBZ0I7UUFDaEIsb0JBQW9CO1FBRXBCLElBQUksMEJBQWMsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM1QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQXFCLENBQUM7U0FDdkM7YUFBTTtZQUNMLE1BQU0sYUFBYSxHQUFHLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBbUIsQ0FBQztZQUN6RCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxvQkFDdkMsYUFBYSxFQUNoQixDQUFDO1NBQ0o7UUFFRCwyQkFBMkI7UUFDM0IsdUJBQXVCO1FBQ3ZCLDJCQUEyQjtRQUUzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLGFBQWEsSUFBSSxF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LG1PQUFtTyxDQUNwTyxDQUFDO1FBQ0YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFNUIsdUJBQXVCO1FBQ3ZCLE1BQU0sTUFBTSxHQUFHLENBQUEsaUJBQWlCLGFBQWpCLGlCQUFpQix1QkFBakIsaUJBQWlCLENBQUUsTUFBTSxLQUFJO1lBQzFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsY0FBYztZQUMzQixFQUFFLENBQUMsU0FBUyxDQUFDLGNBQWM7U0FDNUIsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHLENBQUEsaUJBQWlCLGFBQWpCLGlCQUFpQix1QkFBakIsaUJBQWlCLENBQUUsT0FBTyxLQUFJLEVBQUUsQ0FBQztRQUNqRCxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FDaEMsS0FBSyxFQUNMLElBQUksZUFBZSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxFQUN6QyxHQUFHLE9BQU8sQ0FDWCxDQUNGLENBQUM7UUFFRix1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLHNDQUFzQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQ2xFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FDbEMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXhPRCx3QkF3T0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgczNOb3RpZmljYXRpb25zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtczMtbm90aWZpY2F0aW9uc1wiO1xuaW1wb3J0IHsgUXVldWUgfSBmcm9tIFwiLi9RdWV1ZVwiO1xuaW1wb3J0IHsgVG9waWMgfSBmcm9tIFwiLi9Ub3BpY1wiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBCdWNrZXRQcm9wcyB7XG4gIHJlYWRvbmx5IHMzQnVja2V0PzogczMuQnVja2V0IHwgczMuQnVja2V0UHJvcHM7XG4gIHJlYWRvbmx5IG5vdGlmaWNhdGlvbnM/OiAoXG4gICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICB8IEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHNcbiAgICB8IFF1ZXVlXG4gICAgfCBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzXG4gICAgfCBUb3BpY1xuICAgIHwgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wc1xuICApW107XG4gIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCdWNrZXROb3RpZmljYXRpb25Qcm9wcyB7XG4gIHJlYWRvbmx5IGV2ZW50cz86IHMzLkV2ZW50VHlwZVtdO1xuICByZWFkb25seSBmaWx0ZXJzPzogczMuTm90aWZpY2F0aW9uS2V5RmlsdGVyW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVja2V0RnVuY3Rpb25Ob3RpZmljYXRpb25Qcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IG5vdGlmaWNhdGlvblByb3BzPzogQnVja2V0Tm90aWZpY2F0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wcyB7XG4gIHJlYWRvbmx5IHF1ZXVlOiBRdWV1ZTtcbiAgcmVhZG9ubHkgbm90aWZpY2F0aW9uUHJvcHM/OiBCdWNrZXROb3RpZmljYXRpb25Qcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzIHtcbiAgcmVhZG9ubHkgdG9waWM6IFRvcGljO1xuICByZWFkb25seSBub3RpZmljYXRpb25Qcm9wcz86IEJ1Y2tldE5vdGlmaWNhdGlvblByb3BzO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBCdWNrZXQgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgczNCdWNrZXQ6IHMzLkJ1Y2tldDtcbiAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25zOiAoRm4gfCBRdWV1ZSB8IFRvcGljKVtdO1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxOb3RpZmljYXRpb25zOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEJ1Y2tldFByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHsgczNCdWNrZXQsIG5vdGlmaWNhdGlvbnMsIGRlZmF1bHRGdW5jdGlvblByb3BzIH0gPSBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLm5vdGlmaWNhdGlvbnMgPSBbXTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxOb3RpZmljYXRpb25zID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgQnVja2V0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChpc0NES0NvbnN0cnVjdChzM0J1Y2tldCkpIHtcbiAgICAgIHRoaXMuczNCdWNrZXQgPSBzM0J1Y2tldCBhcyBzMy5CdWNrZXQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHMzQnVja2V0UHJvcHMgPSAoczNCdWNrZXQgfHwge30pIGFzIHMzLkJ1Y2tldFByb3BzO1xuICAgICAgdGhpcy5zM0J1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgXCJCdWNrZXRcIiwge1xuICAgICAgICAuLi5zM0J1Y2tldFByb3BzLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIE5vdGlmaWNhdGlvbnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIHRoaXMuYWRkTm90aWZpY2F0aW9ucyh0aGlzLCBub3RpZmljYXRpb25zIHx8IFtdKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYnVja2V0QXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuczNCdWNrZXQuYnVja2V0QXJuO1xuICB9XG5cbiAgcHVibGljIGdldCBidWNrZXROYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuczNCdWNrZXQuYnVja2V0TmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbm90aWZpY2F0aW9uRnVuY3Rpb25zKCk6IEZuW10ge1xuICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbnMuZmlsdGVyKFxuICAgICAgKG5vdGlmaWNhdGlvbikgPT4gbm90aWZpY2F0aW9uIGluc3RhbmNlb2YgRm5cbiAgICApIGFzIEZuW107XG4gIH1cblxuICBwdWJsaWMgYWRkTm90aWZpY2F0aW9ucyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIG5vdGlmaWNhdGlvbnM6IChcbiAgICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgICB8IEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHNcbiAgICAgIHwgUXVldWVcbiAgICAgIHwgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wc1xuICAgICAgfCBUb3BpY1xuICAgICAgfCBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzXG4gICAgKVtdXG4gICk6IHZvaWQge1xuICAgIG5vdGlmaWNhdGlvbnMuZm9yRWFjaCgobm90aWZpY2F0aW9uKSA9PlxuICAgICAgdGhpcy5hZGROb3RpZmljYXRpb24oc2NvcGUsIG5vdGlmaWNhdGlvbilcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIHRoaXMubm90aWZpY2F0aW9uc1xuICAgICAgLmZpbHRlcigobm90aWZpY2F0aW9uKSA9PiBub3RpZmljYXRpb24gaW5zdGFuY2VvZiBGbilcbiAgICAgIC5mb3JFYWNoKChub3RpZmljYXRpb24pID0+IG5vdGlmaWNhdGlvbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucykpO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbE5vdGlmaWNhdGlvbnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb05vdGlmaWNhdGlvbihcbiAgICBpbmRleDogbnVtYmVyLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBub3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvbnNbaW5kZXhdO1xuICAgIGlmICghKG5vdGlmaWNhdGlvbiBpbnN0YW5jZW9mIEZuKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGF0dGFjaCBwZXJtaXNzaW9ucyB0byB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBCdWNrZXQgbm90aWZpY2F0aW9uIGJlY2F1c2UgaXQncyBub3QgYSBMYW1iZGEgZnVuY3Rpb25gXG4gICAgICApO1xuICAgIH1cbiAgICBub3RpZmljYXRpb24uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIkJ1Y2tldFwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBuYW1lOiB0aGlzLnMzQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIG5vdGlmaWNhdGlvbnM6IHRoaXMubm90aWZpY2F0aW9ucy5tYXAoKG4pID0+IGdldEZ1bmN0aW9uUmVmKG4pKSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkTm90aWZpY2F0aW9uKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgbm90aWZpY2F0aW9uOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgQnVja2V0RnVuY3Rpb25Ob3RpZmljYXRpb25Qcm9wc1xuICAgICAgfCBRdWV1ZVxuICAgICAgfCBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzXG4gICAgICB8IFRvcGljXG4gICAgICB8IEJ1Y2tldFRvcGljTm90aWZpY2F0aW9uUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgbm90aWZpY2F0aW9uIGluc3RhbmNlb2YgUXVldWUgfHxcbiAgICAgIChub3RpZmljYXRpb24gYXMgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wcykucXVldWVcbiAgICApIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBRdWV1ZSB8IEJ1Y2tldFF1ZXVlTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICB0aGlzLmFkZFF1ZXVlTm90aWZpY2F0aW9uKHNjb3BlLCBub3RpZmljYXRpb24pO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBub3RpZmljYXRpb24gaW5zdGFuY2VvZiBUb3BpYyB8fFxuICAgICAgKG5vdGlmaWNhdGlvbiBhcyBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzKS50b3BpY1xuICAgICkge1xuICAgICAgbm90aWZpY2F0aW9uID0gbm90aWZpY2F0aW9uIGFzIFRvcGljIHwgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wcztcbiAgICAgIHRoaXMuYWRkVG9waWNOb3RpZmljYXRpb24oc2NvcGUsIG5vdGlmaWNhdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhc1xuICAgICAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICAgICB8IEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICB0aGlzLmFkZEZ1bmN0aW9uTm90aWZpY2F0aW9uKHNjb3BlLCBub3RpZmljYXRpb24pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUXVldWVOb3RpZmljYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBub3RpZmljYXRpb246IFF1ZXVlIHwgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wc1xuICApOiB2b2lkIHtcbiAgICAvLyBQYXJzZSBub3RpZmljYXRpb24gcHJvcHNcbiAgICBsZXQgbm90aWZpY2F0aW9uUHJvcHM7XG4gICAgbGV0IHF1ZXVlOiBRdWV1ZTtcbiAgICBpZiAobm90aWZpY2F0aW9uIGluc3RhbmNlb2YgUXVldWUpIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBRdWV1ZTtcbiAgICAgIHF1ZXVlID0gbm90aWZpY2F0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICBub3RpZmljYXRpb24gPSBub3RpZmljYXRpb24gYXMgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wcztcbiAgICAgIG5vdGlmaWNhdGlvblByb3BzID0gbm90aWZpY2F0aW9uLm5vdGlmaWNhdGlvblByb3BzO1xuICAgICAgcXVldWUgPSBub3RpZmljYXRpb24ucXVldWU7XG4gICAgfVxuICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKHF1ZXVlKTtcblxuICAgIC8vIENyZWF0ZSBOb3RpZmljYXRpb25zXG4gICAgY29uc3QgZXZlbnRzID0gbm90aWZpY2F0aW9uUHJvcHM/LmV2ZW50cyB8fCBbXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX0NSRUFURUQsXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX1JFTU9WRUQsXG4gICAgXTtcbiAgICBjb25zdCBmaWx0ZXJzID0gbm90aWZpY2F0aW9uUHJvcHM/LmZpbHRlcnMgfHwgW107XG4gICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgdGhpcy5zM0J1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihcbiAgICAgICAgZXZlbnQsXG4gICAgICAgIG5ldyBzM05vdGlmaWNhdGlvbnMuU3FzRGVzdGluYXRpb24ocXVldWUuc3FzUXVldWUpLFxuICAgICAgICAuLi5maWx0ZXJzXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVG9waWNOb3RpZmljYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBub3RpZmljYXRpb246IFRvcGljIHwgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wc1xuICApOiB2b2lkIHtcbiAgICAvLyBQYXJzZSBub3RpZmljYXRpb24gcHJvcHNcbiAgICBsZXQgbm90aWZpY2F0aW9uUHJvcHM7XG4gICAgbGV0IHRvcGljOiBUb3BpYztcbiAgICBpZiAobm90aWZpY2F0aW9uIGluc3RhbmNlb2YgVG9waWMpIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBUb3BpYztcbiAgICAgIHRvcGljID0gbm90aWZpY2F0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICBub3RpZmljYXRpb24gPSBub3RpZmljYXRpb24gYXMgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wcztcbiAgICAgIG5vdGlmaWNhdGlvblByb3BzID0gbm90aWZpY2F0aW9uLm5vdGlmaWNhdGlvblByb3BzO1xuICAgICAgdG9waWMgPSBub3RpZmljYXRpb24udG9waWM7XG4gICAgfVxuICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKHRvcGljKTtcblxuICAgIC8vIENyZWF0ZSBOb3RpZmljYXRpb25zXG4gICAgY29uc3QgZXZlbnRzID0gbm90aWZpY2F0aW9uUHJvcHM/LmV2ZW50cyB8fCBbXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX0NSRUFURUQsXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX1JFTU9WRUQsXG4gICAgXTtcbiAgICBjb25zdCBmaWx0ZXJzID0gbm90aWZpY2F0aW9uUHJvcHM/LmZpbHRlcnMgfHwgW107XG4gICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgdGhpcy5zM0J1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihcbiAgICAgICAgZXZlbnQsXG4gICAgICAgIG5ldyBzM05vdGlmaWNhdGlvbnMuU25zRGVzdGluYXRpb24odG9waWMuc25zVG9waWMpLFxuICAgICAgICAuLi5maWx0ZXJzXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRnVuY3Rpb25Ob3RpZmljYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBub3RpZmljYXRpb246IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gcGFyc2Ugbm90aWZpY2F0aW9uXG4gICAgbGV0IG5vdGlmaWNhdGlvbkZ1bmN0aW9uLCBub3RpZmljYXRpb25Qcm9wcztcbiAgICBpZiAoKG5vdGlmaWNhdGlvbiBhcyBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzKS5mdW5jdGlvbikge1xuICAgICAgbm90aWZpY2F0aW9uID0gbm90aWZpY2F0aW9uIGFzIEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICBub3RpZmljYXRpb25GdW5jdGlvbiA9IG5vdGlmaWNhdGlvbi5mdW5jdGlvbjtcbiAgICAgIG5vdGlmaWNhdGlvblByb3BzID0gbm90aWZpY2F0aW9uLm5vdGlmaWNhdGlvblByb3BzO1xuICAgIH0gZWxzZSB7XG4gICAgICBub3RpZmljYXRpb25GdW5jdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBGdW5jdGlvbkRlZmluaXRpb247XG4gICAgfVxuXG4gICAgLy8gY3JlYXRlIGZ1bmN0aW9uXG4gICAgY29uc3QgaSA9IHRoaXMubm90aWZpY2F0aW9ucy5sZW5ndGg7XG4gICAgY29uc3QgZm4gPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgYE5vdGlmaWNhdGlvbl8ke3RoaXMubm9kZS5pZH1fJHtpfWAsXG4gICAgICBub3RpZmljYXRpb25GdW5jdGlvbixcbiAgICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICBgVGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgYWxsIHRoZSBjb25zdW1lcnMgdXNpbmcgRnVuY3Rpb25Qcm9wcywgc28gdGhlIFRhYmxlIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKGZuKTtcblxuICAgIC8vIGNyZWF0ZSBOb3RpZmljYXRpb25zXG4gICAgY29uc3QgZXZlbnRzID0gbm90aWZpY2F0aW9uUHJvcHM/LmV2ZW50cyB8fCBbXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX0NSRUFURUQsXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX1JFTU9WRUQsXG4gICAgXTtcbiAgICBjb25zdCBmaWx0ZXJzID0gbm90aWZpY2F0aW9uUHJvcHM/LmZpbHRlcnMgfHwgW107XG4gICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgdGhpcy5zM0J1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihcbiAgICAgICAgZXZlbnQsXG4gICAgICAgIG5ldyBzM05vdGlmaWNhdGlvbnMuTGFtYmRhRGVzdGluYXRpb24oZm4pLFxuICAgICAgICAuLi5maWx0ZXJzXG4gICAgICApXG4gICAgKTtcblxuICAgIC8vIGF0dGFjaGVkIHBlcm1pc3Npb25zXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsTm90aWZpY2F0aW9ucy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==