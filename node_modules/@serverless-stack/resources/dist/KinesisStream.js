"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KinesisStream = void 0;
const constructs_1 = require("constructs");
const kinesis = __importStar(require("aws-cdk-lib/aws-kinesis"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class KinesisStream extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { kinesisStream, consumers, defaultFunctionProps } = props || {};
        this.functions = {};
        this.permissionsAttachedForAllConsumers = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Stream
        ////////////////////
        if (Construct_1.isCDKConstruct(kinesisStream)) {
            this.kinesisStream = kinesisStream;
        }
        else {
            const kinesisStreamProps = (kinesisStream || {});
            this.kinesisStream = new kinesis.Stream(this, "Stream", Object.assign({ streamName: root.logicalPrefixedName(id) }, kinesisStreamProps));
        }
        ///////////////////////////
        // Create Consumers
        ///////////////////////////
        if (consumers) {
            Object.keys(consumers).forEach((consumerName) => this.addConsumer(this, consumerName, consumers[consumerName]));
        }
    }
    get streamArn() {
        return this.kinesisStream.streamArn;
    }
    get streamName() {
        return this.kinesisStream.streamName;
    }
    addConsumers(scope, consumers) {
        Object.keys(consumers).forEach((consumerName) => {
            this.addConsumer(scope, consumerName, consumers[consumerName]);
        });
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllConsumers.push(permissions);
    }
    attachPermissionsToConsumer(consumerName, permissions) {
        if (!this.functions[consumerName]) {
            throw new Error(`The "${consumerName}" consumer was not found in the "${this.node.id}" KinesisStream.`);
        }
        this.functions[consumerName].attachPermissions(permissions);
    }
    getFunction(consumerName) {
        return this.functions[consumerName];
    }
    getConstructMetadata() {
        return {
            type: "KinesisStream",
            data: {
                streamName: this.kinesisStream.streamName,
                consumers: Object.entries(this.functions).map(([name, fn]) => ({
                    name,
                    fn: Construct_1.getFunctionRef(fn),
                })),
            },
        };
    }
    addConsumer(scope, consumerName, consumer) {
        // normalize consumer
        let consumerFunction, consumerProps;
        if (consumer.function) {
            consumer = consumer;
            consumerFunction = consumer.function;
            consumerProps = consumer.consumerProps;
        }
        else {
            consumerFunction = consumer;
        }
        consumerProps = Object.assign({ startingPosition: lambda.StartingPosition.LATEST }, (consumerProps || {}));
        // create function
        const fn = Function_1.Function.fromDefinition(scope, consumerName, consumerFunction, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the KinesisStream construct can apply the "defaultFunctionProps" to them.`);
        this.functions[consumerName] = fn;
        // create event source
        const eventSource = new lambdaEventSources.KinesisEventSource(this.kinesisStream, consumerProps);
        fn.addEventSource(eventSource);
        // attach permissions
        this.permissionsAttachedForAllConsumers.forEach((permissions) => {
            fn.attachPermissions(permissions);
        });
        return fn;
    }
}
exports.KinesisStream = KinesisStream;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiS2luZXNpc1N0cmVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9LaW5lc2lzU3RyZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBdUM7QUFDdkMsaUVBQW1EO0FBQ25ELCtEQUFpRDtBQUNqRCx5RkFBMkU7QUFFM0UsMkNBQTJFO0FBQzNFLHlDQUErRTtBQW9CL0UscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxhQUFjLFNBQVEsc0JBQVM7SUFNMUMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUEwQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUN2RSxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsa0NBQWtDLEdBQUcsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQUVqRCxvQkFBb0I7UUFDcEIsZ0JBQWdCO1FBQ2hCLG9CQUFvQjtRQUVwQixJQUFJLDBCQUFjLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDakMsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFnQyxDQUFDO1NBQ3ZEO2FBQU07WUFDTCxNQUFNLGtCQUFrQixHQUFHLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBd0IsQ0FBQztZQUN4RSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxrQkFDcEQsVUFBVSxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsSUFDckMsa0JBQWtC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QUFFLENBQUMsQ0FDekIsQ0FBQztRQUVGLGtCQUFrQjtRQUNsQixNQUFNLEVBQUUsR0FBRyxtQkFBRSxDQUFDLGNBQWMsQ0FDMUIsS0FBSyxFQUNMLFlBQVksRUFDWixnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLG9CQUFvQixFQUN6QiwyT0FBMk8sQ0FDNU8sQ0FBQztRQUNGLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRWxDLHNCQUFzQjtRQUN0QixNQUFNLFdBQVcsR0FBRyxJQUFJLGtCQUFrQixDQUFDLGtCQUFrQixDQUMzRCxJQUFJLENBQUMsYUFBYSxFQUNsQixhQUFhLENBQ2QsQ0FBQztRQUNGLEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFL0IscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUM5RCxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7Q0FDRjtBQTNJRCxzQ0EySUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMga2luZXNpcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWtpbmVzaXNcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgbGFtYmRhRXZlbnRTb3VyY2VzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXNcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBLaW5lc2lzU3RyZWFtUHJvcHMge1xuICByZWFkb25seSBraW5lc2lzU3RyZWFtPzoga2luZXNpcy5JU3RyZWFtIHwga2luZXNpcy5TdHJlYW1Qcm9wcztcbiAgcmVhZG9ubHkgY29uc3VtZXJzPzoge1xuICAgIFtjb25zdW1lck5hbWU6IHN0cmluZ106IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEtpbmVzaXNTdHJlYW1Db25zdW1lclByb3BzO1xuICB9O1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHMge1xuICByZWFkb25seSBmdW5jdGlvbjogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBjb25zdW1lclByb3BzPzogbGFtYmRhRXZlbnRTb3VyY2VzLktpbmVzaXNFdmVudFNvdXJjZVByb3BzO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBLaW5lc2lzU3RyZWFtIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGtpbmVzaXNTdHJlYW06IGtpbmVzaXMuSVN0cmVhbTtcbiAgcHJpdmF0ZSBmdW5jdGlvbnM6IHsgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRm4gfTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEtpbmVzaXNTdHJlYW1Qcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCB7IGtpbmVzaXNTdHJlYW0sIGNvbnN1bWVycywgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfSA9IHByb3BzIHx8IHt9O1xuICAgIHRoaXMuZnVuY3Rpb25zID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgU3RyZWFtXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChpc0NES0NvbnN0cnVjdChraW5lc2lzU3RyZWFtKSkge1xuICAgICAgdGhpcy5raW5lc2lzU3RyZWFtID0ga2luZXNpc1N0cmVhbSBhcyBraW5lc2lzLklTdHJlYW07XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGtpbmVzaXNTdHJlYW1Qcm9wcyA9IChraW5lc2lzU3RyZWFtIHx8IHt9KSBhcyBraW5lc2lzLlN0cmVhbVByb3BzO1xuICAgICAgdGhpcy5raW5lc2lzU3RyZWFtID0gbmV3IGtpbmVzaXMuU3RyZWFtKHRoaXMsIFwiU3RyZWFtXCIsIHtcbiAgICAgICAgc3RyZWFtTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4ua2luZXNpc1N0cmVhbVByb3BzLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIENvbnN1bWVyc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGNvbnN1bWVycykge1xuICAgICAgT2JqZWN0LmtleXMoY29uc3VtZXJzKS5mb3JFYWNoKChjb25zdW1lck5hbWU6IHN0cmluZykgPT5cbiAgICAgICAgdGhpcy5hZGRDb25zdW1lcih0aGlzLCBjb25zdW1lck5hbWUsIGNvbnN1bWVyc1tjb25zdW1lck5hbWVdKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0IHN0cmVhbUFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmtpbmVzaXNTdHJlYW0uc3RyZWFtQXJuO1xuICB9XG5cbiAgcHVibGljIGdldCBzdHJlYW1OYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMua2luZXNpc1N0cmVhbS5zdHJlYW1OYW1lO1xuICB9XG5cbiAgcHVibGljIGFkZENvbnN1bWVycyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGNvbnN1bWVyczoge1xuICAgICAgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHM7XG4gICAgfVxuICApOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhjb25zdW1lcnMpLmZvckVhY2goKGNvbnN1bWVyTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICB0aGlzLmFkZENvbnN1bWVyKHNjb3BlLCBjb25zdW1lck5hbWUsIGNvbnN1bWVyc1tjb25zdW1lck5hbWVdKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBPYmplY3QudmFsdWVzKHRoaXMuZnVuY3Rpb25zKS5mb3JFYWNoKChmbikgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9Db25zdW1lcihcbiAgICBjb25zdW1lck5hbWU6IHN0cmluZyxcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmZ1bmN0aW9uc1tjb25zdW1lck5hbWVdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgXCIke2NvbnN1bWVyTmFtZX1cIiBjb25zdW1lciB3YXMgbm90IGZvdW5kIGluIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIEtpbmVzaXNTdHJlYW0uYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmZ1bmN0aW9uc1tjb25zdW1lck5hbWVdLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGdW5jdGlvbihjb25zdW1lck5hbWU6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbY29uc3VtZXJOYW1lXTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJLaW5lc2lzU3RyZWFtXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHN0cmVhbU5hbWU6IHRoaXMua2luZXNpc1N0cmVhbS5zdHJlYW1OYW1lLFxuICAgICAgICBjb25zdW1lcnM6IE9iamVjdC5lbnRyaWVzKHRoaXMuZnVuY3Rpb25zKS5tYXAoKFtuYW1lLCBmbl0pID0+ICh7XG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBmbjogZ2V0RnVuY3Rpb25SZWYoZm4pLFxuICAgICAgICB9KSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFkZENvbnN1bWVyKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgY29uc3VtZXJOYW1lOiBzdHJpbmcsXG4gICAgY29uc3VtZXI6IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEtpbmVzaXNTdHJlYW1Db25zdW1lclByb3BzXG4gICk6IEZuIHtcbiAgICAvLyBub3JtYWxpemUgY29uc3VtZXJcbiAgICBsZXQgY29uc3VtZXJGdW5jdGlvbiwgY29uc3VtZXJQcm9wcztcbiAgICBpZiAoKGNvbnN1bWVyIGFzIEtpbmVzaXNTdHJlYW1Db25zdW1lclByb3BzKS5mdW5jdGlvbikge1xuICAgICAgY29uc3VtZXIgPSBjb25zdW1lciBhcyBLaW5lc2lzU3RyZWFtQ29uc3VtZXJQcm9wcztcbiAgICAgIGNvbnN1bWVyRnVuY3Rpb24gPSBjb25zdW1lci5mdW5jdGlvbjtcbiAgICAgIGNvbnN1bWVyUHJvcHMgPSBjb25zdW1lci5jb25zdW1lclByb3BzO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdW1lckZ1bmN0aW9uID0gY29uc3VtZXIgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgIH1cbiAgICBjb25zdW1lclByb3BzID0ge1xuICAgICAgc3RhcnRpbmdQb3NpdGlvbjogbGFtYmRhLlN0YXJ0aW5nUG9zaXRpb24uTEFURVNULFxuICAgICAgLi4uKGNvbnN1bWVyUHJvcHMgfHwge30pLFxuICAgIH07XG5cbiAgICAvLyBjcmVhdGUgZnVuY3Rpb25cbiAgICBjb25zdCBmbiA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBjb25zdW1lck5hbWUsXG4gICAgICBjb25zdW1lckZ1bmN0aW9uLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIGNvbnN1bWVycyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgS2luZXNpc1N0cmVhbSBjb25zdHJ1Y3QgY2FuIGFwcGx5IHRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgdG8gdGhlbS5gXG4gICAgKTtcbiAgICB0aGlzLmZ1bmN0aW9uc1tjb25zdW1lck5hbWVdID0gZm47XG5cbiAgICAvLyBjcmVhdGUgZXZlbnQgc291cmNlXG4gICAgY29uc3QgZXZlbnRTb3VyY2UgPSBuZXcgbGFtYmRhRXZlbnRTb3VyY2VzLktpbmVzaXNFdmVudFNvdXJjZShcbiAgICAgIHRoaXMua2luZXNpc1N0cmVhbSxcbiAgICAgIGNvbnN1bWVyUHJvcHNcbiAgICApO1xuICAgIGZuLmFkZEV2ZW50U291cmNlKGV2ZW50U291cmNlKTtcblxuICAgIC8vIGF0dGFjaCBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbENvbnN1bWVycy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT4ge1xuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG59XG4iXX0=