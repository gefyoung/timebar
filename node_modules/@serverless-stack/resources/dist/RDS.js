"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RDS = void 0;
const path_1 = __importDefault(require("path"));
const fs = __importStar(require("fs-extra"));
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const ec2 = __importStar(require("aws-cdk-lib/aws-ec2"));
const rds = __importStar(require("aws-cdk-lib/aws-rds"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class RDS extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const app = scope.node.root;
        const { rdsServerlessCluster, engine, defaultDatabaseName, migrations } = props || {};
        ////////////////////
        // Create Bucket
        ////////////////////
        const rdsServerlessClusterProps = (rdsServerlessCluster || {});
        this.validateRDSServerlessClusterProps(rdsServerlessClusterProps);
        this.validateRequiredProps(props || {});
        this.engine = engine;
        this.defaultDatabaseName = defaultDatabaseName;
        this.rdsServerlessCluster = new rds.ServerlessCluster(this, "Cluster", Object.assign(Object.assign({ clusterIdentifier: app.logicalPrefixedName(id) }, rdsServerlessClusterProps), { defaultDatabaseName, enableDataApi: true, engine: this.getEngine(engine), vpc: this.getVpc(rdsServerlessClusterProps), vpcSubnets: this.getVpcSubnets(rdsServerlessClusterProps) }));
        ///////////////////////////
        // Create Migrations
        ///////////////////////////
        if (migrations) {
            this.validateMigrationsFileExists(migrations);
            this.migratorFunction = this.createMigrationsFunction(engine, defaultDatabaseName, migrations);
            this.createMigrationCustomResource();
        }
    }
    get clusterArn() {
        return this.rdsServerlessCluster.clusterArn;
    }
    get clusterIdentifier() {
        return this.rdsServerlessCluster.clusterIdentifier;
    }
    get clusterEndpoint() {
        return this.rdsServerlessCluster.clusterEndpoint;
    }
    get secretArn() {
        return this.rdsServerlessCluster.secret.secretArn;
    }
    getConstructMetadata() {
        return {
            type: "RDS",
            data: {
                engine: this.engine,
                secretArn: this.secretArn,
                clusterArn: this.clusterArn,
                clusterIdentifier: this.clusterIdentifier,
                defaultDatabaseName: this.defaultDatabaseName,
                migrator: this.migratorFunction && Construct_1.getFunctionRef(this.migratorFunction),
            },
        };
    }
    validateRDSServerlessClusterProps(props) {
        // Validate "engine" is passed in from the top level
        if (props.engine) {
            throw new Error(`Use "engine" instead of "rdsServerlessCluster.engine" to configure the RDS database engine.`);
        }
        // Validate "defaultDatabaseName" is passed in from the top level
        if (props.defaultDatabaseName) {
            throw new Error(`Use "defaultDatabaseName" instead of "rdsServerlessCluster.defaultDatabaseName" to configure the RDS database engine.`);
        }
        // Validate "enableDataApi" is not passed in
        if (props.enableDataApi === false) {
            throw new Error(`Do not configure the "rdsServerlessCluster.enableDataApi". Data API is always enabled for this construct.`);
        }
    }
    validateRequiredProps(props) {
        if (!props.engine) {
            throw new Error(`Missing "engine" in the "${this.node.id}" RDS`);
        }
        if (!props.defaultDatabaseName) {
            throw new Error(`Missing "defaultDatabaseName" in the "${this.node.id}" RDS`);
        }
    }
    validateMigrationsFileExists(migrations) {
        if (!fs.existsSync(migrations))
            throw new Error(`Cannot find the migrations in "${path_1.default.resolve(migrations)}".`);
    }
    getEngine(engine) {
        if (engine === "mysql5.6") {
            return rds.DatabaseClusterEngine.aurora({
                version: rds.AuroraEngineVersion.VER_10A,
            });
        }
        else if (engine === "mysql5.7") {
            return rds.DatabaseClusterEngine.auroraMysql({
                version: rds.AuroraMysqlEngineVersion.VER_2_07_1,
            });
        }
        else if (engine === "postgresql10.14") {
            return rds.DatabaseClusterEngine.auroraPostgres({
                version: rds.AuroraPostgresEngineVersion.VER_10_14,
            });
        }
        throw new Error(`The specified "engine" is not supported for sst.RDS. Only mysql5.6, mysql5.7, and postgresql10.14 engines are currently supported.`);
    }
    getVpc(props) {
        if (props.vpc) {
            return props.vpc;
        }
        return new ec2.Vpc(this, "vpc", {
            natGateways: 0,
            subnetConfiguration: [
                {
                    cidrMask: 24,
                    name: "public",
                    subnetType: ec2.SubnetType.PUBLIC,
                },
                {
                    cidrMask: 28,
                    name: "rds",
                    subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
                }
            ]
        });
    }
    getVpcSubnets(props) {
        if (props.vpc) {
            return props.vpcSubnets;
        }
        return {
            subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
        };
    }
    createMigrationsFunction(engine, defaultDatabaseName, migrations) {
        const app = this.node.root;
        // path to migration scripts inside the Lambda function
        const migrationsDestination = "sst_rds_migration_scripts";
        // fullpath of the migrator Lambda function
        // Note:
        // - when invoked from `sst build`, __dirname is `resources/dist`
        // - when running resources tests, __dirname is `resources/src`
        // For now we will do `__dirname/../dist` to make both cases work.
        const srcPath = path_1.default.resolve(path_1.default.join(__dirname, "..", "dist", "RDS_migrator"));
        const fn = new Function_1.Function(this, "MigrationFunction", {
            srcPath,
            handler: "index.handler",
            runtime: "nodejs14.x",
            timeout: 900,
            memorySize: 1024,
            environment: {
                RDS_ARN: this.rdsServerlessCluster.clusterArn,
                RDS_SECRET: this.rdsServerlessCluster.secret.secretArn,
                RDS_DATABASE: defaultDatabaseName,
                RDS_ENGINE_MODE: engine === "postgresql10.14" ? "postgres" : "mysql",
                // for live development, perserve the migrations path so the migrator
                // can locate the migration files
                RDS_MIGRATIONS_PATH: app.local
                    ? migrations
                    : migrationsDestination,
            },
            bundle: {
                // Note that we need to generate a relative path of the migrations off the
                // srcPath because sst.Function internally builds the copy "from" path by
                // joining the srcPath and the from path.
                copyFiles: [{
                        from: path_1.default.relative(path_1.default.resolve(srcPath), path_1.default.resolve(migrations)),
                        to: migrationsDestination,
                    }],
            },
        });
        fn.attachPermissions([this.rdsServerlessCluster]);
        return fn;
    }
    createMigrationCustomResource() {
        var _a, _b, _c;
        const app = this.node.root;
        // Create custom resource handler
        const handler = new lambda.Function(this, "MigrationHandler", {
            code: lambda.Code.fromAsset(path_1.default.join(__dirname, "Script")),
            runtime: lambda.Runtime.NODEJS_14_X,
            handler: "index.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        (_a = this.migratorFunction) === null || _a === void 0 ? void 0 : _a.grantInvoke(handler);
        // Note: "BuiltAt" is set to current timestamp to ensure the Custom
        //       Resource function is run on every update.
        //
        //       Do not use the current timestamp in Live mode, b/c we want the
        //       this custom resource to remain the same in CloudFormation template
        //       when rebuilding infrastructure. Otherwise, there will always be
        //       a change when rebuilding infrastructure b/c the "BuildAt" property
        //       changes on each build.
        const builtAt = app.local ? app.debugStartedAt : Date.now();
        new cdk.CustomResource(this, "MigrationResource", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTScript",
            properties: {
                UserCreateFunction: app.local ? undefined : (_b = this.migratorFunction) === null || _b === void 0 ? void 0 : _b.functionName,
                UserUpdateFunction: app.local ? undefined : (_c = this.migratorFunction) === null || _c === void 0 ? void 0 : _c.functionName,
                UserParams: JSON.stringify({}),
                BuiltAt: builtAt,
            },
        });
    }
}
exports.RDS = RDS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUkRTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1JEUy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLDZDQUErQjtBQUMvQiwyQ0FBdUM7QUFDdkMsaURBQW1DO0FBQ25DLHlEQUEyQztBQUMzQyx5REFBMkM7QUFDM0MsK0RBQWlEO0FBRWpELDJDQUEyRTtBQUMzRSx5Q0FBNEM7QUFtQjVDLHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCLE1BQWEsR0FBSSxTQUFRLHNCQUFTO0lBTWhDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBZTtRQUN2RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ25DLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsbUJBQW1CLEVBQUUsVUFBVSxFQUFFLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUV0RixvQkFBb0I7UUFDcEIsZ0JBQWdCO1FBQ2hCLG9CQUFvQjtRQUVwQixNQUFNLHlCQUF5QixHQUFHLENBQUMsb0JBQW9CLElBQUksRUFBRSxDQUFpQyxDQUFDO1FBRS9GLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUM7UUFFeEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDO1FBQy9DLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsU0FBUyxnQ0FDbkUsaUJBQWlCLEVBQUUsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEVBQUUs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RSx3RUFBd0U7UUFDeEUsMkVBQTJFO1FBQzNFLCtCQUErQjtRQUMvQixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUQsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxtQkFBbUIsRUFBRTtZQUNoRCxZQUFZLEVBQUUsT0FBTyxDQUFDLFdBQVc7WUFDakMsWUFBWSxFQUFFLG1CQUFtQjtZQUNqQyxVQUFVLEVBQUU7Z0JBQ1Ysa0JBQWtCLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFBLElBQUksQ0FBQyxnQkFBZ0IsMENBQUUsWUFBWTtnQkFDL0Usa0JBQWtCLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFBLElBQUksQ0FBQyxnQkFBZ0IsMENBQUUsWUFBWTtnQkFDL0UsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO2dCQUM5QixPQUFPLEVBQUUsT0FBTzthQUNqQjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQXhQRCxrQkF3UEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGVjMiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0ICogYXMgcmRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtcmRzXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBSRFNQcm9wcyB7XG4gIHJlYWRvbmx5IHJkc1NlcnZlcmxlc3NDbHVzdGVyPzogUkRTQ2RrU2VydmVybGVzc0NsdXN0ZXJQcm9wcztcbiAgcmVhZG9ubHkgZW5naW5lOiBSRFNFbmdpbmVUeXBlO1xuICByZWFkb25seSBkZWZhdWx0RGF0YWJhc2VOYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IG1pZ3JhdGlvbnM/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIFJEU0VuZ2luZVR5cGUgPSBcIm15c3FsNS42XCIgfCBcIm15c3FsNS43XCIgfCBcInBvc3RncmVzcWwxMC4xNFwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJEU0Nka1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMgZXh0ZW5kcyBPbWl0PHJkcy5TZXJ2ZXJsZXNzQ2x1c3RlclByb3BzLCBcInZwY1wiIHwgXCJlbmdpbmVcIiB8IFwiZGVmYXVsdERhdGFiYXNlTmFtZVwiID4ge1xuICByZWFkb25seSB2cGM/OiBlYzIuSVZwYztcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgUkRTIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IHJkc1NlcnZlcmxlc3NDbHVzdGVyOiByZHMuU2VydmVybGVzc0NsdXN0ZXI7XG4gIHB1YmxpYyByZWFkb25seSBtaWdyYXRvckZ1bmN0aW9uPzogRm47XG4gIHByaXZhdGUgcmVhZG9ubHkgZW5naW5lOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdERhdGFiYXNlTmFtZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBSRFNQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBhcHAgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHsgcmRzU2VydmVybGVzc0NsdXN0ZXIsIGVuZ2luZSwgZGVmYXVsdERhdGFiYXNlTmFtZSwgbWlncmF0aW9ucyB9ID0gcHJvcHMgfHwge307XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBCdWNrZXRcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgY29uc3QgcmRzU2VydmVybGVzc0NsdXN0ZXJQcm9wcyA9IChyZHNTZXJ2ZXJsZXNzQ2x1c3RlciB8fCB7fSkgYXMgUkRTQ2RrU2VydmVybGVzc0NsdXN0ZXJQcm9wcztcblxuICAgIHRoaXMudmFsaWRhdGVSRFNTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzKHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpO1xuICAgIHRoaXMudmFsaWRhdGVSZXF1aXJlZFByb3BzKHByb3BzIHx8IHt9KTtcblxuICAgIHRoaXMuZW5naW5lID0gZW5naW5lO1xuICAgIHRoaXMuZGVmYXVsdERhdGFiYXNlTmFtZSA9IGRlZmF1bHREYXRhYmFzZU5hbWU7XG4gICAgdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3RlciA9IG5ldyByZHMuU2VydmVybGVzc0NsdXN0ZXIodGhpcywgXCJDbHVzdGVyXCIsIHtcbiAgICAgIGNsdXN0ZXJJZGVudGlmaWVyOiBhcHAubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAuLi5yZHNTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzLFxuICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZSxcbiAgICAgIGVuYWJsZURhdGFBcGk6IHRydWUsXG4gICAgICBlbmdpbmU6IHRoaXMuZ2V0RW5naW5lKGVuZ2luZSksXG4gICAgICB2cGM6IHRoaXMuZ2V0VnBjKHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpLFxuICAgICAgdnBjU3VibmV0czogdGhpcy5nZXRWcGNTdWJuZXRzKHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpLFxuICAgIH0pO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIE1pZ3JhdGlvbnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChtaWdyYXRpb25zKSB7XG4gICAgICB0aGlzLnZhbGlkYXRlTWlncmF0aW9uc0ZpbGVFeGlzdHMobWlncmF0aW9ucyk7XG5cbiAgICAgIHRoaXMubWlncmF0b3JGdW5jdGlvbiA9IHRoaXMuY3JlYXRlTWlncmF0aW9uc0Z1bmN0aW9uKGVuZ2luZSwgZGVmYXVsdERhdGFiYXNlTmFtZSwgbWlncmF0aW9ucyk7XG4gICAgICB0aGlzLmNyZWF0ZU1pZ3JhdGlvbkN1c3RvbVJlc291cmNlKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBjbHVzdGVyQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucmRzU2VydmVybGVzc0NsdXN0ZXIuY2x1c3RlckFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY2x1c3RlcklkZW50aWZpZXIoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3Rlci5jbHVzdGVySWRlbnRpZmllcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY2x1c3RlckVuZHBvaW50KCk6IHJkcy5FbmRwb2ludCB7XG4gICAgcmV0dXJuIHRoaXMucmRzU2VydmVybGVzc0NsdXN0ZXIuY2x1c3RlckVuZHBvaW50O1xuICB9XG5cbiAgcHVibGljIGdldCBzZWNyZXRBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3Rlci5zZWNyZXQhLnNlY3JldEFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJSRFNcIiBhcyBjb25zdCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZW5naW5lOiB0aGlzLmVuZ2luZSxcbiAgICAgICAgc2VjcmV0QXJuOiB0aGlzLnNlY3JldEFybixcbiAgICAgICAgY2x1c3RlckFybjogdGhpcy5jbHVzdGVyQXJuLFxuICAgICAgICBjbHVzdGVySWRlbnRpZmllcjogdGhpcy5jbHVzdGVySWRlbnRpZmllcixcbiAgICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZTogdGhpcy5kZWZhdWx0RGF0YWJhc2VOYW1lLFxuICAgICAgICBtaWdyYXRvcjogdGhpcy5taWdyYXRvckZ1bmN0aW9uICYmIGdldEZ1bmN0aW9uUmVmKHRoaXMubWlncmF0b3JGdW5jdGlvbiksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUkRTU2VydmVybGVzc0NsdXN0ZXJQcm9wcyhwcm9wczogUkRTQ2RrU2VydmVybGVzc0NsdXN0ZXJQcm9wcykge1xuICAgIC8vIFZhbGlkYXRlIFwiZW5naW5lXCIgaXMgcGFzc2VkIGluIGZyb20gdGhlIHRvcCBsZXZlbFxuICAgIGlmICgocHJvcHMgYXMgYW55KS5lbmdpbmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFVzZSBcImVuZ2luZVwiIGluc3RlYWQgb2YgXCJyZHNTZXJ2ZXJsZXNzQ2x1c3Rlci5lbmdpbmVcIiB0byBjb25maWd1cmUgdGhlIFJEUyBkYXRhYmFzZSBlbmdpbmUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBcImRlZmF1bHREYXRhYmFzZU5hbWVcIiBpcyBwYXNzZWQgaW4gZnJvbSB0aGUgdG9wIGxldmVsXG4gICAgaWYgKChwcm9wcyBhcyBhbnkpLmRlZmF1bHREYXRhYmFzZU5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFVzZSBcImRlZmF1bHREYXRhYmFzZU5hbWVcIiBpbnN0ZWFkIG9mIFwicmRzU2VydmVybGVzc0NsdXN0ZXIuZGVmYXVsdERhdGFiYXNlTmFtZVwiIHRvIGNvbmZpZ3VyZSB0aGUgUkRTIGRhdGFiYXNlIGVuZ2luZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIFwiZW5hYmxlRGF0YUFwaVwiIGlzIG5vdCBwYXNzZWQgaW5cbiAgICBpZiAocHJvcHMuZW5hYmxlRGF0YUFwaSA9PT0gZmFsc2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwicmRzU2VydmVybGVzc0NsdXN0ZXIuZW5hYmxlRGF0YUFwaVwiLiBEYXRhIEFQSSBpcyBhbHdheXMgZW5hYmxlZCBmb3IgdGhpcyBjb25zdHJ1Y3QuYFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUmVxdWlyZWRQcm9wcyhwcm9wczogUkRTUHJvcHMpIHtcbiAgICBpZiAoIXByb3BzLmVuZ2luZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIFwiZW5naW5lXCIgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgUkRTYCk7XG4gICAgfVxuXG4gICAgaWYgKCFwcm9wcy5kZWZhdWx0RGF0YWJhc2VOYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJkZWZhdWx0RGF0YWJhc2VOYW1lXCIgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgUkRTYCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZU1pZ3JhdGlvbnNGaWxlRXhpc3RzKG1pZ3JhdGlvbnM6IHN0cmluZykge1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhtaWdyYXRpb25zKSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBmaW5kIHRoZSBtaWdyYXRpb25zIGluIFwiJHtwYXRoLnJlc29sdmUobWlncmF0aW9ucyl9XCIuYFxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RW5naW5lKGVuZ2luZTogUkRTRW5naW5lVHlwZSk6IHJkcy5JQ2x1c3RlckVuZ2luZSB7XG4gICAgaWYgKGVuZ2luZSA9PT0gXCJteXNxbDUuNlwiKSB7XG4gICAgICByZXR1cm4gcmRzLkRhdGFiYXNlQ2x1c3RlckVuZ2luZS5hdXJvcmEoe1xuICAgICAgICB2ZXJzaW9uOiByZHMuQXVyb3JhRW5naW5lVmVyc2lvbi5WRVJfMTBBLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGVuZ2luZSA9PT0gXCJteXNxbDUuN1wiKSB7XG4gICAgICByZXR1cm4gcmRzLkRhdGFiYXNlQ2x1c3RlckVuZ2luZS5hdXJvcmFNeXNxbCh7XG4gICAgICAgIHZlcnNpb246IHJkcy5BdXJvcmFNeXNxbEVuZ2luZVZlcnNpb24uVkVSXzJfMDdfMSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIGlmIChlbmdpbmUgPT09IFwicG9zdGdyZXNxbDEwLjE0XCIpIHtcbiAgICAgIHJldHVybiByZHMuRGF0YWJhc2VDbHVzdGVyRW5naW5lLmF1cm9yYVBvc3RncmVzKHtcbiAgICAgICAgdmVyc2lvbjogcmRzLkF1cm9yYVBvc3RncmVzRW5naW5lVmVyc2lvbi5WRVJfMTBfMTQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIHNwZWNpZmllZCBcImVuZ2luZVwiIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIHNzdC5SRFMuIE9ubHkgbXlzcWw1LjYsIG15c3FsNS43LCBhbmQgcG9zdGdyZXNxbDEwLjE0IGVuZ2luZXMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQuYFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFZwYyhwcm9wczogUkRTQ2RrU2VydmVybGVzc0NsdXN0ZXJQcm9wcyk6IGVjMi5JVnBjIHtcbiAgICBpZiAocHJvcHMudnBjKSB7XG4gICAgICByZXR1cm4gcHJvcHMudnBjO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgZWMyLlZwYyh0aGlzLCBcInZwY1wiLCB7XG4gICAgICBuYXRHYXRld2F5czogMCxcbiAgICAgIHN1Ym5ldENvbmZpZ3VyYXRpb246IFtcbiAgICAgICAge1xuICAgICAgICAgIGNpZHJNYXNrOiAyNCxcbiAgICAgICAgICBuYW1lOiBcInB1YmxpY1wiLFxuICAgICAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBVQkxJQyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGNpZHJNYXNrOiAyOCxcbiAgICAgICAgICBuYW1lOiBcInJkc1wiLFxuICAgICAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEVfSVNPTEFURUQsXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRWcGNTdWJuZXRzKHByb3BzOiBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzKTogZWMyLlN1Ym5ldFNlbGVjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHByb3BzLnZwYykge1xuICAgICAgcmV0dXJuIHByb3BzLnZwY1N1Ym5ldHM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEVfSVNPTEFURUQsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWlncmF0aW9uc0Z1bmN0aW9uKGVuZ2luZTogc3RyaW5nLCBkZWZhdWx0RGF0YWJhc2VOYW1lOiBzdHJpbmcsIG1pZ3JhdGlvbnM6IHN0cmluZykge1xuICAgIGNvbnN0IGFwcCA9IHRoaXMubm9kZS5yb290IGFzIEFwcDtcblxuICAgIC8vIHBhdGggdG8gbWlncmF0aW9uIHNjcmlwdHMgaW5zaWRlIHRoZSBMYW1iZGEgZnVuY3Rpb25cbiAgICBjb25zdCBtaWdyYXRpb25zRGVzdGluYXRpb24gPSBcInNzdF9yZHNfbWlncmF0aW9uX3NjcmlwdHNcIjtcblxuICAgIC8vIGZ1bGxwYXRoIG9mIHRoZSBtaWdyYXRvciBMYW1iZGEgZnVuY3Rpb25cbiAgICAvLyBOb3RlOlxuICAgIC8vIC0gd2hlbiBpbnZva2VkIGZyb20gYHNzdCBidWlsZGAsIF9fZGlybmFtZSBpcyBgcmVzb3VyY2VzL2Rpc3RgXG4gICAgLy8gLSB3aGVuIHJ1bm5pbmcgcmVzb3VyY2VzIHRlc3RzLCBfX2Rpcm5hbWUgaXMgYHJlc291cmNlcy9zcmNgXG4gICAgLy8gRm9yIG5vdyB3ZSB3aWxsIGRvIGBfX2Rpcm5hbWUvLi4vZGlzdGAgdG8gbWFrZSBib3RoIGNhc2VzIHdvcmsuXG4gICAgY29uc3Qgc3JjUGF0aCA9IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwiZGlzdFwiLCBcIlJEU19taWdyYXRvclwiKSk7XG5cbiAgICBjb25zdCBmbiA9IG5ldyBGbih0aGlzLCBcIk1pZ3JhdGlvbkZ1bmN0aW9uXCIsIHtcbiAgICAgIHNyY1BhdGgsXG4gICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgIHJ1bnRpbWU6IFwibm9kZWpzMTQueFwiLFxuICAgICAgdGltZW91dDogOTAwLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFJEU19BUk46IHRoaXMucmRzU2VydmVybGVzc0NsdXN0ZXIuY2x1c3RlckFybixcbiAgICAgICAgUkRTX1NFQ1JFVDogdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3Rlci5zZWNyZXQhLnNlY3JldEFybixcbiAgICAgICAgUkRTX0RBVEFCQVNFOiBkZWZhdWx0RGF0YWJhc2VOYW1lLFxuICAgICAgICBSRFNfRU5HSU5FX01PREU6IGVuZ2luZSA9PT0gXCJwb3N0Z3Jlc3FsMTAuMTRcIiA/IFwicG9zdGdyZXNcIiA6IFwibXlzcWxcIixcbiAgICAgICAgLy8gZm9yIGxpdmUgZGV2ZWxvcG1lbnQsIHBlcnNlcnZlIHRoZSBtaWdyYXRpb25zIHBhdGggc28gdGhlIG1pZ3JhdG9yXG4gICAgICAgIC8vIGNhbiBsb2NhdGUgdGhlIG1pZ3JhdGlvbiBmaWxlc1xuICAgICAgICBSRFNfTUlHUkFUSU9OU19QQVRIOiBhcHAubG9jYWxcbiAgICAgICAgICA/IG1pZ3JhdGlvbnNcbiAgICAgICAgICA6IG1pZ3JhdGlvbnNEZXN0aW5hdGlvbixcbiAgICAgIH0sXG4gICAgICBidW5kbGU6IHtcbiAgICAgICAgLy8gTm90ZSB0aGF0IHdlIG5lZWQgdG8gZ2VuZXJhdGUgYSByZWxhdGl2ZSBwYXRoIG9mIHRoZSBtaWdyYXRpb25zIG9mZiB0aGVcbiAgICAgICAgLy8gc3JjUGF0aCBiZWNhdXNlIHNzdC5GdW5jdGlvbiBpbnRlcm5hbGx5IGJ1aWxkcyB0aGUgY29weSBcImZyb21cIiBwYXRoIGJ5XG4gICAgICAgIC8vIGpvaW5pbmcgdGhlIHNyY1BhdGggYW5kIHRoZSBmcm9tIHBhdGguXG4gICAgICAgIGNvcHlGaWxlczogW3tcbiAgICAgICAgICBmcm9tOiBwYXRoLnJlbGF0aXZlKHBhdGgucmVzb2x2ZShzcmNQYXRoKSwgcGF0aC5yZXNvbHZlKG1pZ3JhdGlvbnMpKSxcbiAgICAgICAgICB0bzogbWlncmF0aW9uc0Rlc3RpbmF0aW9uLFxuICAgICAgICB9XSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhbdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3Rlcl0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNaWdyYXRpb25DdXN0b21SZXNvdXJjZSgpIHtcbiAgICBjb25zdCBhcHAgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlIGhhbmRsZXJcbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIk1pZ3JhdGlvbkhhbmRsZXJcIiwge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsIFwiU2NyaXB0XCIpKSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgIH0pO1xuICAgIHRoaXMubWlncmF0b3JGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICAvLyBOb3RlOiBcIkJ1aWx0QXRcIiBpcyBzZXQgdG8gY3VycmVudCB0aW1lc3RhbXAgdG8gZW5zdXJlIHRoZSBDdXN0b21cbiAgICAvLyAgICAgICBSZXNvdXJjZSBmdW5jdGlvbiBpcyBydW4gb24gZXZlcnkgdXBkYXRlLlxuICAgIC8vXG4gICAgLy8gICAgICAgRG8gbm90IHVzZSB0aGUgY3VycmVudCB0aW1lc3RhbXAgaW4gTGl2ZSBtb2RlLCBiL2Mgd2Ugd2FudCB0aGVcbiAgICAvLyAgICAgICB0aGlzIGN1c3RvbSByZXNvdXJjZSB0byByZW1haW4gdGhlIHNhbWUgaW4gQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGVcbiAgICAvLyAgICAgICB3aGVuIHJlYnVpbGRpbmcgaW5mcmFzdHJ1Y3R1cmUuIE90aGVyd2lzZSwgdGhlcmUgd2lsbCBhbHdheXMgYmVcbiAgICAvLyAgICAgICBhIGNoYW5nZSB3aGVuIHJlYnVpbGRpbmcgaW5mcmFzdHJ1Y3R1cmUgYi9jIHRoZSBcIkJ1aWxkQXRcIiBwcm9wZXJ0eVxuICAgIC8vICAgICAgIGNoYW5nZXMgb24gZWFjaCBidWlsZC5cbiAgICBjb25zdCBidWlsdEF0ID0gYXBwLmxvY2FsID8gYXBwLmRlYnVnU3RhcnRlZEF0IDogRGF0ZS5ub3coKTtcbiAgICBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsIFwiTWlncmF0aW9uUmVzb3VyY2VcIiwge1xuICAgICAgc2VydmljZVRva2VuOiBoYW5kbGVyLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUU2NyaXB0XCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFVzZXJDcmVhdGVGdW5jdGlvbjogYXBwLmxvY2FsID8gdW5kZWZpbmVkIDogdGhpcy5taWdyYXRvckZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJVcGRhdGVGdW5jdGlvbjogYXBwLmxvY2FsID8gdW5kZWZpbmVkIDogdGhpcy5taWdyYXRvckZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJQYXJhbXM6IEpTT04uc3RyaW5naWZ5KHt9KSxcbiAgICAgICAgQnVpbHRBdDogYnVpbHRBdCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==