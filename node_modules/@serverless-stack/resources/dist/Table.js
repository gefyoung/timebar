"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Table = exports.TableFieldType = void 0;
const constructs_1 = require("constructs");
const dynamodb = __importStar(require("aws-cdk-lib/aws-dynamodb"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const core_1 = require("@serverless-stack/core");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const logger = core_1.getChildLogger("resources");
var TableFieldType;
(function (TableFieldType) {
    TableFieldType["BINARY"] = "B";
    TableFieldType["NUMBER"] = "N";
    TableFieldType["STRING"] = "S";
})(TableFieldType = exports.TableFieldType || (exports.TableFieldType = {}));
/////////////////////
// Construct
/////////////////////
class Table extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { fields, primaryIndex, globalIndexes, localIndexes, secondaryIndexes, dynamodbTable, kinesisStream, stream, consumers, defaultFunctionProps, } = props;
        this.functions = {};
        this.fields = fields;
        this.permissionsAttachedForAllConsumers = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Input Validation
        ////////////////////
        if (consumers)
            this.checkDeprecatedConsumers(consumers);
        if (secondaryIndexes)
            this.checkDeprecatedSecondaryIndexes();
        this.validateFieldsAndIndexes(id, props);
        ////////////////////
        // Create Table
        ////////////////////
        if (Construct_1.isCDKConstruct(dynamodbTable)) {
            // Validate "fields" is not configured
            if (fields !== undefined) {
                throw new Error(`Cannot configure the "fields" when "dynamodbTable" is a construct in the "${id}" Table`);
            }
            // Validate "stream" is not configured
            if (stream !== undefined) {
                throw new Error(`Cannot configure the "stream" when "dynamodbTable" is a construct in the "${id}" Table`);
            }
            this.dynamodbTableType = "IMPORTED";
            this.dynamodbTable = dynamodbTable;
        }
        else {
            let dynamodbTableProps = (dynamodbTable || {});
            // Validate "fields" is configured
            if (fields === undefined) {
                throw new Error(`Missing "fields" in the "${id}" Table`);
            }
            // Validate dynamodbTableProps does not contain "partitionKey", "sortKey" and "stream"
            if (dynamodbTableProps.partitionKey) {
                throw new Error(`Cannot configure the "dynamodbTableProps.partitionKey" in the "${id}" Table`);
            }
            if (dynamodbTableProps.sortKey) {
                throw new Error(`Cannot configure the "dynamodbTableProps.sortKey" in the "${id}" Table`);
            }
            if (dynamodbTableProps.stream) {
                throw new Error(`Cannot configure the "dynamodbTableProps.stream" in the "${id}" Table`);
            }
            if (fields && primaryIndex) {
                dynamodbTableProps = Object.assign(Object.assign({}, dynamodbTableProps), { partitionKey: this.buildAttribute(fields, primaryIndex.partitionKey), sortKey: primaryIndex.sortKey
                        ? this.buildAttribute(fields, primaryIndex.sortKey)
                        : undefined });
            }
            this.dynamodbTableType = "CREATED";
            this.dynamodbTable = new dynamodb.Table(this, "Table", Object.assign({ tableName: root.logicalPrefixedName(id), pointInTimeRecovery: true, billingMode: dynamodb.BillingMode.PAY_PER_REQUEST, stream: this.buildStreamConfig(stream) }, dynamodbTableProps));
        }
        //////////////////////////////
        // Create Secondary Indexes
        //////////////////////////////
        const allGlobalIndexes = globalIndexes || secondaryIndexes;
        if (allGlobalIndexes)
            this.addGlobalIndexes(allGlobalIndexes);
        if (localIndexes)
            this.addLocalIndexes(localIndexes);
        ///////////////////////////
        // Create Consumers
        ///////////////////////////
        if (consumers) {
            Object.keys(consumers).forEach((consumerName) => this.addConsumer(this, consumerName, consumers[consumerName]));
        }
        // Create Kinesis Stream
        this.buildKinesisStreamSpec(kinesisStream);
    }
    addGlobalIndexes(secondaryIndexes) {
        var _a, _b, _c;
        if (!this.fields)
            throw new Error(`Cannot add secondary indexes to "${this.node.id}" Table without defining "fields"`);
        for (const [indexName, { partitionKey, sortKey, indexProps },] of Object.entries(secondaryIndexes)) {
            // Validate indexProps does not contain "indexName", "partitionKey" and "sortKey"
            if ((_a = indexProps) === null || _a === void 0 ? void 0 : _a.indexName) {
                throw new Error(`Cannot configure the "indexProps.indexName" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            if ((_b = indexProps) === null || _b === void 0 ? void 0 : _b.partitionKey) {
                throw new Error(`Cannot configure the "indexProps.partitionKey" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            if ((_c = indexProps) === null || _c === void 0 ? void 0 : _c.sortKey) {
                throw new Error(`Cannot configure the "indexProps.sortKey" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            this.dynamodbTable.addGlobalSecondaryIndex(Object.assign({ indexName, partitionKey: this.buildAttribute(this.fields, partitionKey), sortKey: sortKey
                    ? this.buildAttribute(this.fields, sortKey)
                    : undefined }, indexProps));
        }
    }
    addLocalIndexes(secondaryIndexes) {
        var _a, _b;
        if (!this.fields)
            throw new Error(`Cannot add local secondary indexes to "${this.node.id}" Table without defining "fields"`);
        for (const [indexName, { sortKey, indexProps }] of Object.entries(secondaryIndexes)) {
            // Validate indexProps does not contain "indexName", "partitionKey" and "sortKey"
            if ((_a = indexProps) === null || _a === void 0 ? void 0 : _a.indexName) {
                throw new Error(`Cannot configure the "indexProps.indexName" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            if ((_b = indexProps) === null || _b === void 0 ? void 0 : _b.sortKey) {
                throw new Error(`Cannot configure the "indexProps.sortKey" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            this.dynamodbTable.addLocalSecondaryIndex(Object.assign({ indexName, sortKey: this.buildAttribute(this.fields, sortKey) }, indexProps));
        }
    }
    get tableArn() {
        return this.dynamodbTable.tableArn;
    }
    get tableName() {
        return this.dynamodbTable.tableName;
    }
    addConsumers(scope, consumers) {
        // Handle deprecated consumers
        this.checkDeprecatedConsumers(consumers);
        Object.keys(consumers).forEach((consumerName) => {
            this.addConsumer(scope, consumerName, consumers[consumerName]);
        });
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllConsumers.push(permissions);
    }
    attachPermissionsToConsumer(consumerName, permissions) {
        if (!this.functions[consumerName]) {
            throw new Error(`The "${consumerName}" consumer was not found in the "${this.node.id}" Table.`);
        }
        this.functions[consumerName].attachPermissions(permissions);
    }
    getFunction(consumerName) {
        return this.functions[consumerName];
    }
    getConstructMetadata() {
        return {
            type: "Table",
            data: {
                tableName: this.dynamodbTable.tableName,
                consumers: Object.entries(this.functions).map(([name, fun]) => ({
                    name,
                    fn: Construct_1.getFunctionRef(fun),
                })),
            },
        };
    }
    addConsumer(scope, consumerName, consumer) {
        // validate stream enabled
        // note: if table is imported, do not check because we want to allow ppl to
        //       import without specifying the "tableStreamArn". And let them add
        //       consumers to it.
        if (!this.dynamodbTable.tableStreamArn) {
            const errorMsgs = [
                `Please enable the "stream" option to add consumers to the "${this.node.id}" Table.`,
            ];
            if (this.dynamodbTableType === "IMPORTED") {
                errorMsgs.push(`To import a table with stream enabled, use the "Table.fromTableAttributes()" method, and set the "tableStreamArn" in the attributes.`);
            }
            throw new Error(errorMsgs.join(" "));
        }
        // parse consumer
        let consumerFunction, consumerProps;
        if (consumer.function) {
            consumer = consumer;
            consumerFunction = consumer.function;
            consumerProps = consumer.consumerProps;
        }
        else {
            consumerFunction = consumer;
        }
        consumerProps = Object.assign({ startingPosition: lambda.StartingPosition.LATEST }, (consumerProps || {}));
        // create function
        const fn = Function_1.Function.fromDefinition(scope, consumerName, consumerFunction, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the Table construct can apply the "defaultFunctionProps" to them.`);
        this.functions[consumerName] = fn;
        // create event source
        const eventSource = new lambdaEventSources.DynamoEventSource(this.dynamodbTable, consumerProps);
        fn.addEventSource(eventSource);
        // attach permissions
        this.permissionsAttachedForAllConsumers.forEach((permissions) => {
            fn.attachPermissions(permissions);
        });
        return fn;
    }
    buildAttribute(fields, name) {
        return {
            name,
            type: this.convertTableFieldTypeToAttributeType(fields[name]),
        };
    }
    buildStreamConfig(stream) {
        if (stream === true) {
            return dynamodb.StreamViewType.NEW_AND_OLD_IMAGES;
        }
        else if (stream === false) {
            return undefined;
        }
        return stream;
    }
    convertTableFieldTypeToAttributeType(fieldType) {
        if (fieldType === TableFieldType.BINARY) {
            return dynamodb.AttributeType.BINARY;
        }
        else if (fieldType === TableFieldType.NUMBER) {
            return dynamodb.AttributeType.NUMBER;
        }
        else {
            return dynamodb.AttributeType.STRING;
        }
    }
    buildKinesisStreamSpec(kinesisStream) {
        if (!kinesisStream) {
            return;
        }
        const cfTable = this.dynamodbTable.node.defaultChild;
        cfTable.addPropertyOverride("KinesisStreamSpecification.StreamArn", kinesisStream.streamArn);
    }
    validateFieldsAndIndexes(id, props) {
        const { fields, primaryIndex } = props;
        // Validate "fields"
        if (fields && Object.keys(fields).length === 0) {
            throw new Error(`No fields defined for the "${id}" Table`);
        }
        // Validate "primaryIndex"
        if (primaryIndex && !primaryIndex.partitionKey) {
            throw new Error(`Missing "partitionKey" in primary index for the "${id}" Table`);
        }
        // Validate "fields" and "primaryIndex" co-exists
        if (fields) {
            if (!primaryIndex) {
                throw new Error(`Missing "primaryIndex" in "${id}" Table`);
            }
        }
        else {
            if (primaryIndex) {
                throw new Error(`Cannot configure the "primaryIndex" without setting the "fields" in "${id}" Table`);
            }
        }
    }
    checkDeprecatedConsumers(consumers) {
        if (Array.isArray(consumers)) {
            throw new Error(`The "consumers" property no longer takes an array. It nows takes an associative array with the consumer name being the index key. More details on upgrading - https://docs.serverless-stack.com/constructs/Table#upgrading-to-v0210`);
        }
    }
    checkDeprecatedSecondaryIndexes() {
        logger.debug(`WARNING: The "secondaryIndexes" property has been renamed to "globalIndexes". "secondaryIndexes" will continue to work but will be removed at a later date. More details on the deprecation - https://docs.serverless-stack.com/constructs/Table#secondaryindexes-deprecated`);
    }
}
exports.Table = Table;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvVGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2QyxtRUFBcUQ7QUFDckQsK0RBQWlEO0FBQ2pELHlGQUEyRTtBQUMzRSxpREFBd0Q7QUFFeEQsMkNBQTJFO0FBQzNFLHlDQUErRTtBQUkvRSxNQUFNLE1BQU0sR0FBRyxxQkFBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBRTNDLElBQVksY0FJWDtBQUpELFdBQVksY0FBYztJQUN4Qiw4QkFBc0MsQ0FBQTtJQUN0Qyw4QkFBc0MsQ0FBQTtJQUN0Qyw4QkFBc0MsQ0FBQTtBQUN4QyxDQUFDLEVBSlcsY0FBYyxHQUFkLHNCQUFjLEtBQWQsc0JBQWMsUUFJekI7QUF3REQscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxLQUFNLFNBQVEsc0JBQVM7SUFTbEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFpQjtRQUN6RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sRUFDSixNQUFNLEVBQ04sWUFBWSxFQUNaLGFBQWEsRUFDYixZQUFZLEVBQ1osZ0JBQWdCLEVBQ2hCLGFBQWEsRUFDYixhQUFhLEVBQ2IsTUFBTSxFQUNOLFNBQVMsRUFDVCxvQkFBb0IsR0FDckIsR0FBRyxLQUFLLENBQUM7UUFDVixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsa0NBQWtDLEdBQUcsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQUVqRCxvQkFBb0I7UUFDcEIsbUJBQW1CO1FB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SSxDQUFDLFlBQVksRUFBRTtnQkFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxTQUFTLENBQUMsQ0FBQzthQUM1RDtTQUNGO2FBQU07WUFDTCxJQUFJLFlBQVksRUFBRTtnQkFDaEIsTUFBTSxJQUFJLEtBQUssQ0FDYix3RUFBd0UsRUFBRSxTQUFTLENBQ3BGLENBQUM7YUFDSDtTQUNGO0lBQ0gsQ0FBQztJQUVPLHdCQUF3QixDQUFDLFNBRWhDO1FBQ0MsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQzVCLE1BQU0sSUFBSSxLQUFLLENBQ2IscU9BQXFPLENBQ3RPLENBQUM7U0FDSDtJQUNILENBQUM7SUFFTywrQkFBK0I7UUFDckMsTUFBTSxDQUFDLEtBQUssQ0FDViw4UUFBOFEsQ0FDL1EsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQWhaRCxzQkFnWkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1keW5hbW9kYlwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFFdmVudFNvdXJjZXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuaW1wb3J0IHsgZ2V0Q2hpbGRMb2dnZXIgfSBmcm9tIFwiQHNlcnZlcmxlc3Mtc3RhY2svY29yZVwiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBnZXRGdW5jdGlvblJlZiwgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBLaW5lc2lzU3RyZWFtIH0gZnJvbSBcIi4vS2luZXNpc1N0cmVhbVwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuY29uc3QgbG9nZ2VyID0gZ2V0Q2hpbGRMb2dnZXIoXCJyZXNvdXJjZXNcIik7XG5cbmV4cG9ydCBlbnVtIFRhYmxlRmllbGRUeXBlIHtcbiAgQklOQVJZID0gZHluYW1vZGIuQXR0cmlidXRlVHlwZS5CSU5BUlksXG4gIE5VTUJFUiA9IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuTlVNQkVSLFxuICBTVFJJTkcgPSBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBUYWJsZVByb3BzIHtcbiAgcmVhZG9ubHkgZmllbGRzPzogUmVjb3JkPHN0cmluZywgVGFibGVGaWVsZFR5cGU+O1xuICByZWFkb25seSBwcmltYXJ5SW5kZXg/OiBUYWJsZUdsb2JhbEluZGV4UHJvcHM7XG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgZ2xvYmFsSW5kZXhlc1xuICAgKi9cbiAgcmVhZG9ubHkgc2Vjb25kYXJ5SW5kZXhlcz86IFJlY29yZDxzdHJpbmcsIFRhYmxlR2xvYmFsSW5kZXhQcm9wcz47XG4gIHJlYWRvbmx5IGdsb2JhbEluZGV4ZXM/OiBSZWNvcmQ8c3RyaW5nLCBUYWJsZUdsb2JhbEluZGV4UHJvcHM+O1xuICByZWFkb25seSBsb2NhbEluZGV4ZXM/OiBSZWNvcmQ8c3RyaW5nLCBUYWJsZUxvY2FsSW5kZXhQcm9wcz47XG4gIHJlYWRvbmx5IGR5bmFtb2RiVGFibGU/OiBkeW5hbW9kYi5JVGFibGUgfCBUYWJsZUNka1Byb3BzO1xuICByZWFkb25seSBraW5lc2lzU3RyZWFtPzogS2luZXNpc1N0cmVhbTtcbiAgcmVhZG9ubHkgc3RyZWFtPzogYm9vbGVhbiB8IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlO1xuICByZWFkb25seSBjb25zdW1lcnM/OiB7XG4gICAgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgVGFibGVDb25zdW1lclByb3BzO1xuICB9O1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGFibGVDb25zdW1lclByb3BzIHtcbiAgcmVhZG9ubHkgZnVuY3Rpb246IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgY29uc3VtZXJQcm9wcz86IGxhbWJkYUV2ZW50U291cmNlcy5EeW5hbW9FdmVudFNvdXJjZVByb3BzO1xufVxuXG5leHBvcnQgdHlwZSBUYWJsZUxvY2FsSW5kZXhQcm9wcyA9IHtcbiAgcmVhZG9ubHkgc29ydEtleTogc3RyaW5nO1xuICByZWFkb25seSBpbmRleFByb3BzPzogT21pdDxcbiAgICBkeW5hbW9kYi5Mb2NhbFNlY29uZGFyeUluZGV4UHJvcHMsXG4gICAga2V5b2YgVGFibGVMb2NhbEluZGV4UHJvcHMgfCBcImluZGV4TmFtZVwiXG4gID47XG59O1xuXG5leHBvcnQgdHlwZSBUYWJsZUdsb2JhbEluZGV4UHJvcHMgPSB7XG4gIHJlYWRvbmx5IHBhcnRpdGlvbktleTogc3RyaW5nO1xuICByZWFkb25seSBzb3J0S2V5Pzogc3RyaW5nO1xuICByZWFkb25seSBpbmRleFByb3BzPzogVGFibGVDZGtJbmRleFByb3BzO1xufTtcblxuLy8gT2xkIGV4cG9ydFxuZXhwb3J0IHR5cGUgVGFibGVJbmRleFByb3BzID0gVGFibGVHbG9iYWxJbmRleFByb3BzO1xuXG5leHBvcnQgdHlwZSBUYWJsZUNka1Byb3BzID0gT21pdDxcbiAgZHluYW1vZGIuVGFibGVQcm9wcyxcbiAgXCJwYXJ0aXRpb25LZXlcIiB8IFwic29ydEtleVwiXG4+O1xuXG5leHBvcnQgdHlwZSBUYWJsZUNka0luZGV4UHJvcHMgPSBPbWl0PFxuICBkeW5hbW9kYi5HbG9iYWxTZWNvbmRhcnlJbmRleFByb3BzLFxuICBcImluZGV4TmFtZVwiIHwgXCJwYXJ0aXRpb25LZXlcIiB8IFwic29ydEtleVwiXG4+O1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBUYWJsZSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBkeW5hbW9kYlRhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbiAgcHJpdmF0ZSByZWFkb25seSBkeW5hbW9kYlRhYmxlVHlwZTogXCJDUkVBVEVEXCIgfCBcIklNUE9SVEVEXCI7XG4gIHByaXZhdGUgZnVuY3Rpb25zOiB7IFtjb25zdW1lck5hbWU6IHN0cmluZ106IEZuIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbENvbnN1bWVyczogUGVybWlzc2lvbnNbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RyZWFtPzogZHluYW1vZGIuU3RyZWFtVmlld1R5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgZmllbGRzPzogUmVjb3JkPHN0cmluZywgVGFibGVGaWVsZFR5cGU+O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBUYWJsZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHtcbiAgICAgIGZpZWxkcyxcbiAgICAgIHByaW1hcnlJbmRleCxcbiAgICAgIGdsb2JhbEluZGV4ZXMsXG4gICAgICBsb2NhbEluZGV4ZXMsXG4gICAgICBzZWNvbmRhcnlJbmRleGVzLFxuICAgICAgZHluYW1vZGJUYWJsZSxcbiAgICAgIGtpbmVzaXNTdHJlYW0sXG4gICAgICBzdHJlYW0sXG4gICAgICBjb25zdW1lcnMsXG4gICAgICBkZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICB9ID0gcHJvcHM7XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLmZpZWxkcyA9IGZpZWxkcztcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIElucHV0IFZhbGlkYXRpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGlmIChjb25zdW1lcnMpIHRoaXMuY2hlY2tEZXByZWNhdGVkQ29uc3VtZXJzKGNvbnN1bWVycyk7XG4gICAgaWYgKHNlY29uZGFyeUluZGV4ZXMpIHRoaXMuY2hlY2tEZXByZWNhdGVkU2Vjb25kYXJ5SW5kZXhlcygpO1xuICAgIHRoaXMudmFsaWRhdGVGaWVsZHNBbmRJbmRleGVzKGlkLCBwcm9wcyk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBUYWJsZVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KGR5bmFtb2RiVGFibGUpKSB7XG4gICAgICAvLyBWYWxpZGF0ZSBcImZpZWxkc1wiIGlzIG5vdCBjb25maWd1cmVkXG4gICAgICBpZiAoZmllbGRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImZpZWxkc1wiIHdoZW4gXCJkeW5hbW9kYlRhYmxlXCIgaXMgYSBjb25zdHJ1Y3QgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgXCJzdHJlYW1cIiBpcyBub3QgY29uZmlndXJlZFxuICAgICAgaWYgKHN0cmVhbSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJzdHJlYW1cIiB3aGVuIFwiZHluYW1vZGJUYWJsZVwiIGlzIGEgY29uc3RydWN0IGluIHRoZSBcIiR7aWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZHluYW1vZGJUYWJsZVR5cGUgPSBcIklNUE9SVEVEXCI7XG4gICAgICB0aGlzLmR5bmFtb2RiVGFibGUgPSBkeW5hbW9kYlRhYmxlIGFzIGR5bmFtb2RiLlRhYmxlO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgZHluYW1vZGJUYWJsZVByb3BzID0gKGR5bmFtb2RiVGFibGUgfHwge30pIGFzIGR5bmFtb2RiLlRhYmxlUHJvcHM7XG5cbiAgICAgIC8vIFZhbGlkYXRlIFwiZmllbGRzXCIgaXMgY29uZmlndXJlZFxuICAgICAgaWYgKGZpZWxkcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBcImZpZWxkc1wiIGluIHRoZSBcIiR7aWR9XCIgVGFibGVgKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgZHluYW1vZGJUYWJsZVByb3BzIGRvZXMgbm90IGNvbnRhaW4gXCJwYXJ0aXRpb25LZXlcIiwgXCJzb3J0S2V5XCIgYW5kIFwic3RyZWFtXCJcbiAgICAgIGlmIChkeW5hbW9kYlRhYmxlUHJvcHMucGFydGl0aW9uS2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJkeW5hbW9kYlRhYmxlUHJvcHMucGFydGl0aW9uS2V5XCIgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChkeW5hbW9kYlRhYmxlUHJvcHMuc29ydEtleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiZHluYW1vZGJUYWJsZVByb3BzLnNvcnRLZXlcIiBpbiB0aGUgXCIke2lkfVwiIFRhYmxlYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGR5bmFtb2RiVGFibGVQcm9wcy5zdHJlYW0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImR5bmFtb2RiVGFibGVQcm9wcy5zdHJlYW1cIiBpbiB0aGUgXCIke2lkfVwiIFRhYmxlYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmllbGRzICYmIHByaW1hcnlJbmRleCkge1xuICAgICAgICBkeW5hbW9kYlRhYmxlUHJvcHMgPSB7XG4gICAgICAgICAgLi4uZHluYW1vZGJUYWJsZVByb3BzLFxuICAgICAgICAgIHBhcnRpdGlvbktleTogdGhpcy5idWlsZEF0dHJpYnV0ZShmaWVsZHMsIHByaW1hcnlJbmRleC5wYXJ0aXRpb25LZXkpLFxuICAgICAgICAgIHNvcnRLZXk6IHByaW1hcnlJbmRleC5zb3J0S2V5XG4gICAgICAgICAgICA/IHRoaXMuYnVpbGRBdHRyaWJ1dGUoZmllbGRzLCBwcmltYXJ5SW5kZXguc29ydEtleSlcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICB0aGlzLmR5bmFtb2RiVGFibGVUeXBlID0gXCJDUkVBVEVEXCI7XG4gICAgICB0aGlzLmR5bmFtb2RiVGFibGUgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgXCJUYWJsZVwiLCB7XG4gICAgICAgIHRhYmxlTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgcG9pbnRJblRpbWVSZWNvdmVyeTogdHJ1ZSxcbiAgICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgICAgc3RyZWFtOiB0aGlzLmJ1aWxkU3RyZWFtQ29uZmlnKHN0cmVhbSksXG4gICAgICAgIC4uLihkeW5hbW9kYlRhYmxlUHJvcHMgYXMgZHluYW1vZGIuVGFibGVQcm9wcyksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgU2Vjb25kYXJ5IEluZGV4ZXNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBhbGxHbG9iYWxJbmRleGVzID0gZ2xvYmFsSW5kZXhlcyB8fCBzZWNvbmRhcnlJbmRleGVzO1xuICAgIGlmIChhbGxHbG9iYWxJbmRleGVzKSB0aGlzLmFkZEdsb2JhbEluZGV4ZXMoYWxsR2xvYmFsSW5kZXhlcyk7XG4gICAgaWYgKGxvY2FsSW5kZXhlcykgdGhpcy5hZGRMb2NhbEluZGV4ZXMobG9jYWxJbmRleGVzKTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBDb25zdW1lcnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAoY29uc3VtZXJzKSB7XG4gICAgICBPYmplY3Qua2V5cyhjb25zdW1lcnMpLmZvckVhY2goKGNvbnN1bWVyTmFtZTogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmFkZENvbnN1bWVyKHRoaXMsIGNvbnN1bWVyTmFtZSwgY29uc3VtZXJzW2NvbnN1bWVyTmFtZV0pXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBLaW5lc2lzIFN0cmVhbVxuICAgIHRoaXMuYnVpbGRLaW5lc2lzU3RyZWFtU3BlYyhraW5lc2lzU3RyZWFtKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRHbG9iYWxJbmRleGVzKFxuICAgIHNlY29uZGFyeUluZGV4ZXM6IE5vbk51bGxhYmxlPFRhYmxlUHJvcHNbXCJnbG9iYWxJbmRleGVzXCJdPlxuICApIHtcbiAgICBpZiAoIXRoaXMuZmllbGRzKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGFkZCBzZWNvbmRhcnkgaW5kZXhlcyB0byBcIiR7dGhpcy5ub2RlLmlkfVwiIFRhYmxlIHdpdGhvdXQgZGVmaW5pbmcgXCJmaWVsZHNcImBcbiAgICAgICk7XG4gICAgZm9yIChjb25zdCBbXG4gICAgICBpbmRleE5hbWUsXG4gICAgICB7IHBhcnRpdGlvbktleSwgc29ydEtleSwgaW5kZXhQcm9wcyB9LFxuICAgIF0gb2YgT2JqZWN0LmVudHJpZXMoc2Vjb25kYXJ5SW5kZXhlcykpIHtcbiAgICAgIC8vIFZhbGlkYXRlIGluZGV4UHJvcHMgZG9lcyBub3QgY29udGFpbiBcImluZGV4TmFtZVwiLCBcInBhcnRpdGlvbktleVwiIGFuZCBcInNvcnRLZXlcIlxuICAgICAgaWYgKChpbmRleFByb3BzIGFzIGR5bmFtb2RiLkdsb2JhbFNlY29uZGFyeUluZGV4UHJvcHMpPy5pbmRleE5hbWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImluZGV4UHJvcHMuaW5kZXhOYW1lXCIgaW4gdGhlIFwiJHtpbmRleE5hbWV9XCIgaW5kZXggb2YgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoKGluZGV4UHJvcHMgYXMgZHluYW1vZGIuR2xvYmFsU2Vjb25kYXJ5SW5kZXhQcm9wcyk/LnBhcnRpdGlvbktleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaW5kZXhQcm9wcy5wYXJ0aXRpb25LZXlcIiBpbiB0aGUgXCIke2luZGV4TmFtZX1cIiBpbmRleCBvZiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmICgoaW5kZXhQcm9wcyBhcyBkeW5hbW9kYi5HbG9iYWxTZWNvbmRhcnlJbmRleFByb3BzKT8uc29ydEtleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaW5kZXhQcm9wcy5zb3J0S2V5XCIgaW4gdGhlIFwiJHtpbmRleE5hbWV9XCIgaW5kZXggb2YgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZHluYW1vZGJUYWJsZS5hZGRHbG9iYWxTZWNvbmRhcnlJbmRleCh7XG4gICAgICAgIGluZGV4TmFtZSxcbiAgICAgICAgcGFydGl0aW9uS2V5OiB0aGlzLmJ1aWxkQXR0cmlidXRlKHRoaXMuZmllbGRzLCBwYXJ0aXRpb25LZXkpLFxuICAgICAgICBzb3J0S2V5OiBzb3J0S2V5XG4gICAgICAgICAgPyB0aGlzLmJ1aWxkQXR0cmlidXRlKHRoaXMuZmllbGRzLCBzb3J0S2V5KVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAuLi5pbmRleFByb3BzLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFkZExvY2FsSW5kZXhlcyhcbiAgICBzZWNvbmRhcnlJbmRleGVzOiBOb25OdWxsYWJsZTxUYWJsZVByb3BzW1wibG9jYWxJbmRleGVzXCJdPlxuICApIHtcbiAgICBpZiAoIXRoaXMuZmllbGRzKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGFkZCBsb2NhbCBzZWNvbmRhcnkgaW5kZXhlcyB0byBcIiR7dGhpcy5ub2RlLmlkfVwiIFRhYmxlIHdpdGhvdXQgZGVmaW5pbmcgXCJmaWVsZHNcImBcbiAgICAgICk7XG4gICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCB7IHNvcnRLZXksIGluZGV4UHJvcHMgfV0gb2YgT2JqZWN0LmVudHJpZXMoXG4gICAgICBzZWNvbmRhcnlJbmRleGVzIVxuICAgICkpIHtcbiAgICAgIC8vIFZhbGlkYXRlIGluZGV4UHJvcHMgZG9lcyBub3QgY29udGFpbiBcImluZGV4TmFtZVwiLCBcInBhcnRpdGlvbktleVwiIGFuZCBcInNvcnRLZXlcIlxuICAgICAgaWYgKChpbmRleFByb3BzIGFzIGR5bmFtb2RiLkxvY2FsU2Vjb25kYXJ5SW5kZXhQcm9wcyk/LmluZGV4TmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaW5kZXhQcm9wcy5pbmRleE5hbWVcIiBpbiB0aGUgXCIke2luZGV4TmFtZX1cIiBpbmRleCBvZiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmICgoaW5kZXhQcm9wcyBhcyBkeW5hbW9kYi5Mb2NhbFNlY29uZGFyeUluZGV4UHJvcHMpPy5zb3J0S2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJpbmRleFByb3BzLnNvcnRLZXlcIiBpbiB0aGUgXCIke2luZGV4TmFtZX1cIiBpbmRleCBvZiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5keW5hbW9kYlRhYmxlLmFkZExvY2FsU2Vjb25kYXJ5SW5kZXgoe1xuICAgICAgICBpbmRleE5hbWUsXG4gICAgICAgIHNvcnRLZXk6IHRoaXMuYnVpbGRBdHRyaWJ1dGUodGhpcy5maWVsZHMsIHNvcnRLZXkpLFxuICAgICAgICAuLi5pbmRleFByb3BzLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCB0YWJsZUFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmR5bmFtb2RiVGFibGUudGFibGVBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRhYmxlTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmR5bmFtb2RiVGFibGUudGFibGVOYW1lO1xuICB9XG5cbiAgcHVibGljIGFkZENvbnN1bWVycyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGNvbnN1bWVyczoge1xuICAgICAgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgVGFibGVDb25zdW1lclByb3BzO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgLy8gSGFuZGxlIGRlcHJlY2F0ZWQgY29uc3VtZXJzXG4gICAgdGhpcy5jaGVja0RlcHJlY2F0ZWRDb25zdW1lcnMoY29uc3VtZXJzKTtcblxuICAgIE9iamVjdC5rZXlzKGNvbnN1bWVycykuZm9yRWFjaCgoY29uc3VtZXJOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuYWRkQ29uc3VtZXIoc2NvcGUsIGNvbnN1bWVyTmFtZSwgY29uc3VtZXJzW2NvbnN1bWVyTmFtZV0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb0NvbnN1bWVyKFxuICAgIGNvbnN1bWVyTmFtZTogc3RyaW5nLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuZnVuY3Rpb25zW2NvbnN1bWVyTmFtZV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBcIiR7Y29uc3VtZXJOYW1lfVwiIGNvbnN1bWVyIHdhcyBub3QgZm91bmQgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgVGFibGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmZ1bmN0aW9uc1tjb25zdW1lck5hbWVdLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGdW5jdGlvbihjb25zdW1lck5hbWU6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbY29uc3VtZXJOYW1lXTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJUYWJsZVwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICB0YWJsZU5hbWU6IHRoaXMuZHluYW1vZGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIGNvbnN1bWVyczogT2JqZWN0LmVudHJpZXModGhpcy5mdW5jdGlvbnMpLm1hcCgoW25hbWUsIGZ1bl0pID0+ICh7XG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBmbjogZ2V0RnVuY3Rpb25SZWYoZnVuKSxcbiAgICAgICAgfSkpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb25zdW1lcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGNvbnN1bWVyTmFtZTogc3RyaW5nLFxuICAgIGNvbnN1bWVyOiBGdW5jdGlvbkRlZmluaXRpb24gfCBUYWJsZUNvbnN1bWVyUHJvcHNcbiAgKTogRm4ge1xuICAgIC8vIHZhbGlkYXRlIHN0cmVhbSBlbmFibGVkXG4gICAgLy8gbm90ZTogaWYgdGFibGUgaXMgaW1wb3J0ZWQsIGRvIG5vdCBjaGVjayBiZWNhdXNlIHdlIHdhbnQgdG8gYWxsb3cgcHBsIHRvXG4gICAgLy8gICAgICAgaW1wb3J0IHdpdGhvdXQgc3BlY2lmeWluZyB0aGUgXCJ0YWJsZVN0cmVhbUFyblwiLiBBbmQgbGV0IHRoZW0gYWRkXG4gICAgLy8gICAgICAgY29uc3VtZXJzIHRvIGl0LlxuICAgIGlmICghdGhpcy5keW5hbW9kYlRhYmxlLnRhYmxlU3RyZWFtQXJuKSB7XG4gICAgICBjb25zdCBlcnJvck1zZ3MgPSBbXG4gICAgICAgIGBQbGVhc2UgZW5hYmxlIHRoZSBcInN0cmVhbVwiIG9wdGlvbiB0byBhZGQgY29uc3VtZXJzIHRvIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFRhYmxlLmAsXG4gICAgICBdO1xuICAgICAgaWYgKHRoaXMuZHluYW1vZGJUYWJsZVR5cGUgPT09IFwiSU1QT1JURURcIikge1xuICAgICAgICBlcnJvck1zZ3MucHVzaChcbiAgICAgICAgICBgVG8gaW1wb3J0IGEgdGFibGUgd2l0aCBzdHJlYW0gZW5hYmxlZCwgdXNlIHRoZSBcIlRhYmxlLmZyb21UYWJsZUF0dHJpYnV0ZXMoKVwiIG1ldGhvZCwgYW5kIHNldCB0aGUgXCJ0YWJsZVN0cmVhbUFyblwiIGluIHRoZSBhdHRyaWJ1dGVzLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZ3Muam9pbihcIiBcIikpO1xuICAgIH1cblxuICAgIC8vIHBhcnNlIGNvbnN1bWVyXG4gICAgbGV0IGNvbnN1bWVyRnVuY3Rpb24sIGNvbnN1bWVyUHJvcHM7XG4gICAgaWYgKChjb25zdW1lciBhcyBUYWJsZUNvbnN1bWVyUHJvcHMpLmZ1bmN0aW9uKSB7XG4gICAgICBjb25zdW1lciA9IGNvbnN1bWVyIGFzIFRhYmxlQ29uc3VtZXJQcm9wcztcbiAgICAgIGNvbnN1bWVyRnVuY3Rpb24gPSBjb25zdW1lci5mdW5jdGlvbjtcbiAgICAgIGNvbnN1bWVyUHJvcHMgPSBjb25zdW1lci5jb25zdW1lclByb3BzO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdW1lckZ1bmN0aW9uID0gY29uc3VtZXIgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgIH1cbiAgICBjb25zdW1lclByb3BzID0ge1xuICAgICAgc3RhcnRpbmdQb3NpdGlvbjogbGFtYmRhLlN0YXJ0aW5nUG9zaXRpb24uTEFURVNULFxuICAgICAgLi4uKGNvbnN1bWVyUHJvcHMgfHwge30pLFxuICAgIH07XG5cbiAgICAvLyBjcmVhdGUgZnVuY3Rpb25cbiAgICBjb25zdCBmbiA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBjb25zdW1lck5hbWUsXG4gICAgICBjb25zdW1lckZ1bmN0aW9uLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIGNvbnN1bWVycyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgVGFibGUgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG4gICAgdGhpcy5mdW5jdGlvbnNbY29uc3VtZXJOYW1lXSA9IGZuO1xuXG4gICAgLy8gY3JlYXRlIGV2ZW50IHNvdXJjZVxuICAgIGNvbnN0IGV2ZW50U291cmNlID0gbmV3IGxhbWJkYUV2ZW50U291cmNlcy5EeW5hbW9FdmVudFNvdXJjZShcbiAgICAgIHRoaXMuZHluYW1vZGJUYWJsZSxcbiAgICAgIGNvbnN1bWVyUHJvcHNcbiAgICApO1xuICAgIGZuLmFkZEV2ZW50U291cmNlKGV2ZW50U291cmNlKTtcblxuICAgIC8vIGF0dGFjaCBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbENvbnN1bWVycy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT4ge1xuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEF0dHJpYnV0ZShcbiAgICBmaWVsZHM6IHsgW2tleTogc3RyaW5nXTogVGFibGVGaWVsZFR5cGUgfSxcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogZHluYW1vZGIuQXR0cmlidXRlIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHR5cGU6IHRoaXMuY29udmVydFRhYmxlRmllbGRUeXBlVG9BdHRyaWJ1dGVUeXBlKGZpZWxkc1tuYW1lXSksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRTdHJlYW1Db25maWcoXG4gICAgc3RyZWFtPzogYm9vbGVhbiB8IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlXG4gICk6IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoc3RyZWFtID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4gZHluYW1vZGIuU3RyZWFtVmlld1R5cGUuTkVXX0FORF9PTERfSU1BR0VTO1xuICAgIH0gZWxzZSBpZiAoc3RyZWFtID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RyZWFtO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VGFibGVGaWVsZFR5cGVUb0F0dHJpYnV0ZVR5cGUoXG4gICAgZmllbGRUeXBlOiBUYWJsZUZpZWxkVHlwZVxuICApOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlIHtcbiAgICBpZiAoZmllbGRUeXBlID09PSBUYWJsZUZpZWxkVHlwZS5CSU5BUlkpIHtcbiAgICAgIHJldHVybiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLkJJTkFSWTtcbiAgICB9IGVsc2UgaWYgKGZpZWxkVHlwZSA9PT0gVGFibGVGaWVsZFR5cGUuTlVNQkVSKSB7XG4gICAgICByZXR1cm4gZHluYW1vZGIuQXR0cmlidXRlVHlwZS5OVU1CRVI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkS2luZXNpc1N0cmVhbVNwZWMoa2luZXNpc1N0cmVhbT86IEtpbmVzaXNTdHJlYW0pOiB2b2lkIHtcbiAgICBpZiAoIWtpbmVzaXNTdHJlYW0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjZlRhYmxlID0gdGhpcy5keW5hbW9kYlRhYmxlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGR5bmFtb2RiLkNmblRhYmxlO1xuICAgIGNmVGFibGUuYWRkUHJvcGVydHlPdmVycmlkZShcbiAgICAgIFwiS2luZXNpc1N0cmVhbVNwZWNpZmljYXRpb24uU3RyZWFtQXJuXCIsXG4gICAgICBraW5lc2lzU3RyZWFtLnN0cmVhbUFyblxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlRmllbGRzQW5kSW5kZXhlcyhpZDogc3RyaW5nLCBwcm9wczogVGFibGVQcm9wcyk6IHZvaWQge1xuICAgIGNvbnN0IHsgZmllbGRzLCBwcmltYXJ5SW5kZXggfSA9IHByb3BzO1xuXG4gICAgLy8gVmFsaWRhdGUgXCJmaWVsZHNcIlxuICAgIGlmIChmaWVsZHMgJiYgT2JqZWN0LmtleXMoZmllbGRzKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gZmllbGRzIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgVGFibGVgKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBcInByaW1hcnlJbmRleFwiXG4gICAgaWYgKHByaW1hcnlJbmRleCAmJiAhcHJpbWFyeUluZGV4LnBhcnRpdGlvbktleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTWlzc2luZyBcInBhcnRpdGlvbktleVwiIGluIHByaW1hcnkgaW5kZXggZm9yIHRoZSBcIiR7aWR9XCIgVGFibGVgXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIFwiZmllbGRzXCIgYW5kIFwicHJpbWFyeUluZGV4XCIgY28tZXhpc3RzXG4gICAgaWYgKGZpZWxkcykge1xuICAgICAgaWYgKCFwcmltYXJ5SW5kZXgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIFwicHJpbWFyeUluZGV4XCIgaW4gXCIke2lkfVwiIFRhYmxlYCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwcmltYXJ5SW5kZXgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcInByaW1hcnlJbmRleFwiIHdpdGhvdXQgc2V0dGluZyB0aGUgXCJmaWVsZHNcIiBpbiBcIiR7aWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0RlcHJlY2F0ZWRDb25zdW1lcnMoY29uc3VtZXJzOiB7XG4gICAgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgVGFibGVDb25zdW1lclByb3BzO1xuICB9KTogdm9pZCB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoY29uc3VtZXJzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlIFwiY29uc3VtZXJzXCIgcHJvcGVydHkgbm8gbG9uZ2VyIHRha2VzIGFuIGFycmF5LiBJdCBub3dzIHRha2VzIGFuIGFzc29jaWF0aXZlIGFycmF5IHdpdGggdGhlIGNvbnN1bWVyIG5hbWUgYmVpbmcgdGhlIGluZGV4IGtleS4gTW9yZSBkZXRhaWxzIG9uIHVwZ3JhZGluZyAtIGh0dHBzOi8vZG9jcy5zZXJ2ZXJsZXNzLXN0YWNrLmNvbS9jb25zdHJ1Y3RzL1RhYmxlI3VwZ3JhZGluZy10by12MDIxMGBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0RlcHJlY2F0ZWRTZWNvbmRhcnlJbmRleGVzKCk6IHZvaWQge1xuICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBXQVJOSU5HOiBUaGUgXCJzZWNvbmRhcnlJbmRleGVzXCIgcHJvcGVydHkgaGFzIGJlZW4gcmVuYW1lZCB0byBcImdsb2JhbEluZGV4ZXNcIi4gXCJzZWNvbmRhcnlJbmRleGVzXCIgd2lsbCBjb250aW51ZSB0byB3b3JrIGJ1dCB3aWxsIGJlIHJlbW92ZWQgYXQgYSBsYXRlciBkYXRlLiBNb3JlIGRldGFpbHMgb24gdGhlIGRlcHJlY2F0aW9uIC0gaHR0cHM6Ly9kb2NzLnNlcnZlcmxlc3Mtc3RhY2suY29tL2NvbnN0cnVjdHMvVGFibGUjc2Vjb25kYXJ5aW5kZXhlcy1kZXByZWNhdGVkYFxuICAgICk7XG4gIH1cbn1cbiJdfQ==