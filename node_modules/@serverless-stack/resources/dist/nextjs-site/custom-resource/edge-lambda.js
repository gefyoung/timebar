"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const AWS = __importStar(require("aws-sdk"));
AWS.config.logger = console;
const util_1 = require("./util");
const cfnResponse = __importStar(require("./cfn-response"));
const s3 = new AWS.S3({ region: "us-east-1" });
const lambda = new AWS.Lambda({ region: "us-east-1" });
function handler(cfnRequest) {
    return __awaiter(this, void 0, void 0, function* () {
        util_1.log("onEventHandler", cfnRequest);
        // Get bucket name
        const functionName = cfnRequest.RequestType === "Create"
            ? generateFunctionName(cfnRequest.ResourceProperties.FunctionNamePrefix)
            : cfnRequest.PhysicalResourceId.split(":").pop();
        // Process request
        let PhysicalResourceId;
        let Data;
        const bucket = cfnRequest.ResourceProperties.FunctionBucket;
        const params = cfnRequest.ResourceProperties.FunctionParams;
        switch (cfnRequest.RequestType) {
            case "Create": {
                yield copyAsset(bucket, params);
                const ret = yield createFunction(functionName, params);
                PhysicalResourceId = ret.FunctionArn;
                Data = {
                    FunctionArn: ret.FunctionArn,
                };
                break;
            }
            case "Update": {
                const oldParams = cfnRequest.OldResourceProperties.FunctionParams;
                if (isConfigurationChanged(params, oldParams)) {
                    yield updateFunctionConfiguration(functionName, params);
                }
                if (isCodeChanged(params, oldParams)) {
                    yield copyAsset(bucket, params);
                    yield updateFunctionCode(functionName, params);
                }
                PhysicalResourceId = cfnRequest.PhysicalResourceId;
                Data = {
                    FunctionArn: cfnRequest.PhysicalResourceId,
                };
                break;
            }
            case "Delete": {
                yield deleteFunction(functionName);
                break;
            }
            default:
                throw new Error("Unsupported request type");
        }
        // Build response
        return cfnResponse.submitResponse("SUCCESS", Object.assign(Object.assign({}, cfnRequest), { PhysicalResourceId,
            Data }));
    });
}
function generateFunctionName(prefix) {
    const MAX_NAME_LENGTH = 64;
    const length = 20;
    const characters = "abcdefghijklmnopqrstuvwxyz";
    const charactersLength = characters.length;
    let result = `${prefix
        .toLowerCase()
        .slice(0, MAX_NAME_LENGTH - length - 1)}-`;
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}
function copyAsset(bucket, params) {
    return __awaiter(this, void 0, void 0, function* () {
        util_1.log(`copyAsset() called with params`, bucket, params);
        // Copy
        util_1.log(`copy`);
        const resp = yield s3
            .copyObject({
            Bucket: bucket,
            CopySource: `/${params.Code.S3Bucket}/${params.Code.S3Key}`,
            Key: params.Code.S3Key,
        })
            .promise();
        util_1.log(`response`, resp);
        // Update params
        params.Code.S3Bucket = bucket;
    });
}
function createFunction(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        util_1.log(`createFunction() called with params`, params);
        const resp = yield lambda
            .createFunction(Object.assign(Object.assign({}, params), { FunctionName: functionName }))
            .promise();
        util_1.log(`response`, resp);
        return { FunctionArn: resp.FunctionArn };
    });
}
function updateFunctionConfiguration(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        util_1.log(`updateFunctionConfiguration() called with params`, params);
        const resp = yield lambda
            .updateFunctionConfiguration(Object.assign(Object.assign({}, params), { Code: undefined }))
            .promise();
        util_1.log(`response`, resp);
    });
}
function updateFunctionCode(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        util_1.log(`updateFunctionCode() called with params`, params);
        const resp = yield lambda
            .updateFunctionCode(Object.assign({ FunctionName: functionName, Publish: false }, params.Code))
            .promise();
        util_1.log(`response`, resp);
    });
}
function deleteFunction(functionName) {
    return __awaiter(this, void 0, void 0, function* () {
        util_1.log(`deleteFunction() called with functionName`, functionName);
        const resp = yield lambda
            .deleteFunction({
            FunctionName: functionName,
        })
            .promise();
        util_1.log(`response`, resp);
    });
}
function isConfigurationChanged(params, oldParams) {
    return (Object.keys(params).length !== Object.keys(params).length ||
        ["Description", "Handler", "Runtime", "MemorySize", "Timeout", "Role"].some((p) => params[p] !== oldParams[p]));
}
function isCodeChanged(params, oldParams) {
    return (params.Code.S3Bucket !== oldParams.Code.S3Bucket ||
        params.Code.S3Key !== oldParams.Code.S3Key);
}
module.exports = {
    handler: cfnResponse.safeHandler(handler),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRnZS1sYW1iZGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbmV4dGpzLXNpdGUvY3VzdG9tLXJlc291cmNlL2VkZ2UtbGFtYmRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNkNBQStCO0FBQy9CLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQztBQUU1QixpQ0FBNkI7QUFDN0IsNERBQThDO0FBQzlDLE1BQU0sRUFBRSxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQy9DLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBTXZELFNBQWUsT0FBTyxDQUNwQixVQUF1RDs7UUFFdkQsVUFBRyxDQUFDLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRWxDLGtCQUFrQjtRQUNsQixNQUFNLFlBQVksR0FDaEIsVUFBVSxDQUFDLFdBQVcsS0FBSyxRQUFRO1lBQ2pDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLENBQUM7WUFDeEUsQ0FBQyxDQUFFLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFhLENBQUM7UUFFakUsa0JBQWtCO1FBQ2xCLElBQUksa0JBQWtCLENBQUM7UUFDdkIsSUFBSSxJQUFJLENBQUM7UUFDVCxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDO1FBQzVELE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUM7UUFDNUQsUUFBUSxVQUFVLENBQUMsV0FBVyxFQUFFO1lBQzlCLEtBQUssUUFB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Q2hELFVBQUcsQ0FBQywyQ0FBMkMsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUUvRCxNQUFNLElBQUksR0FBRyxNQUFNLE1BQU07YUFDdEIsY0FBYyxDQUFDO1lBQ2QsWUFBWSxFQUFFLFlBQVk7U0FDM0IsQ0FBQzthQUNELE9BQU8sRUFBRSxDQUFDO1FBRWIsVUFBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN4QixDQUFDO0NBQUE7QUFFRCxTQUFTLHNCQUFzQixDQUFDLE1BQVcsRUFBRSxTQUFjO0lBQ3pELE9BQU8sQ0FDTCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU07UUFDekQsQ0FBQyxhQUFhLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDekUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQ2xDLENBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxNQUFXLEVBQUUsU0FBYztJQUNoRCxPQUFPLENBQ0wsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRO1FBQ2hELE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUMzQyxDQUFDO0FBQ0osQ0FBQztBQS9KRCxpQkFBUztJQUNQLE9BQU8sRUFBRSxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztDQUMxQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gXCJhd3Mtc2RrXCI7XG5BV1MuY29uZmlnLmxvZ2dlciA9IGNvbnNvbGU7XG5cbmltcG9ydCB7IGxvZyB9IGZyb20gXCIuL3V0aWxcIjtcbmltcG9ydCAqIGFzIGNmblJlc3BvbnNlIGZyb20gXCIuL2Nmbi1yZXNwb25zZVwiO1xuY29uc3QgczMgPSBuZXcgQVdTLlMzKHsgcmVnaW9uOiBcInVzLWVhc3QtMVwiIH0pO1xuY29uc3QgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoeyByZWdpb246IFwidXMtZWFzdC0xXCIgfSk7XG5cbmV4cG9ydCA9IHtcbiAgaGFuZGxlcjogY2ZuUmVzcG9uc2Uuc2FmZUhhbmRsZXIoaGFuZGxlciksXG59O1xuXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxuICBjZm5SZXF1ZXN0OiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50XG4pIHtcbiAgbG9nKFwib25FdmVudEhhbmRsZXJcIiwgY2ZuUmVxdWVzdCk7XG5cbiAgLy8gR2V0IGJ1Y2tldCBuYW1lXG4gIGNvbnN0IGZ1bmN0aW9uTmFtZSA9XG4gICAgY2ZuUmVxdWVzdC5SZXF1ZXN0VHlwZSA9PT0gXCJDcmVhdGVcIlxuICAgICAgPyBnZW5lcmF0ZUZ1bmN0aW9uTmFtZShjZm5SZXF1ZXN0LlJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvbk5hbWVQcmVmaXgpXG4gICAgICA6IChjZm5SZXF1ZXN0LlBoeXNpY2FsUmVzb3VyY2VJZC5zcGxpdChcIjpcIikucG9wKCkgYXMgc3RyaW5nKTtcblxuICAvLyBQcm9jZXNzIHJlcXVlc3RcbiAgbGV0IFBoeXNpY2FsUmVzb3VyY2VJZDtcbiAgbGV0IERhdGE7XG4gIGNvbnN0IGJ1Y2tldCA9IGNmblJlcXVlc3QuUmVzb3VyY2VQcm9wZXJ0aWVzLkZ1bmN0aW9uQnVja2V0O1xuICBjb25zdCBwYXJhbXMgPSBjZm5SZXF1ZXN0LlJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvblBhcmFtcztcbiAgc3dpdGNoIChjZm5SZXF1ZXN0LlJlcXVlc3RUeXBlKSB7XG4gICAgY2FzZSBcIkNyZWF0ZVwiOiB7XG4gICAgICBhd2FpdCBjb3B5QXNzZXQoYnVja2V0LCBwYXJhbXMpO1xuICAgICAgY29uc3QgcmV0ID0gYXdhaXQgY3JlYXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lLCBwYXJhbXMpO1xuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkID0gcmV0LkZ1bmN0aW9uQXJuO1xuICAgICAgRGF0YSA9IHtcbiAgICAgICAgRnVuY3Rpb25Bcm46IHJldC5GdW5jdGlvbkFybixcbiAgICAgIH07XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY2FzZSBcIlVwZGF0ZVwiOiB7XG4gICAgICBjb25zdCBvbGRQYXJhbXMgPSBjZm5SZXF1ZXN0Lk9sZFJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvblBhcmFtcztcbiAgICAgIGlmIChpc0NvbmZpZ3VyYXRpb25DaGFuZ2VkKHBhcmFtcywgb2xkUGFyYW1zKSkge1xuICAgICAgICBhd2FpdCB1cGRhdGVGdW5jdGlvbkNvbmZpZ3VyYXRpb24oZnVuY3Rpb25OYW1lLCBwYXJhbXMpO1xuICAgICAgfVxuICAgICAgaWYgKGlzQ29kZUNoYW5nZWQocGFyYW1zLCBvbGRQYXJhbXMpKSB7XG4gICAgICAgIGF3YWl0IGNvcHlBc3NldChidWNrZXQsIHBhcmFtcyk7XG4gICAgICAgIGF3YWl0IHVwZGF0ZUZ1bmN0aW9uQ29kZShmdW5jdGlvbk5hbWUsIHBhcmFtcyk7XG4gICAgICB9XG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQgPSBjZm5SZXF1ZXN0LlBoeXNpY2FsUmVzb3VyY2VJZDtcbiAgICAgIERhdGEgPSB7XG4gICAgICAgIEZ1bmN0aW9uQXJuOiBjZm5SZXF1ZXN0LlBoeXNpY2FsUmVzb3VyY2VJZCxcbiAgICAgIH07XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY2FzZSBcIkRlbGV0ZVwiOiB7XG4gICAgICBhd2FpdCBkZWxldGVGdW5jdGlvbihmdW5jdGlvbk5hbWUpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCByZXF1ZXN0IHR5cGVcIik7XG4gIH1cblxuICAvLyBCdWlsZCByZXNwb25zZVxuICByZXR1cm4gY2ZuUmVzcG9uc2Uuc3VibWl0UmVzcG9uc2UoXCJTVUNDRVNTXCIsIHtcbiAgICAuLi5jZm5SZXF1ZXN0LFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZCxcbiAgICBEYXRhLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVGdW5jdGlvbk5hbWUocHJlZml4OiBzdHJpbmcpIHtcbiAgY29uc3QgTUFYX05BTUVfTEVOR1RIID0gNjQ7XG4gIGNvbnN0IGxlbmd0aCA9IDIwO1xuICBjb25zdCBjaGFyYWN0ZXJzID0gXCJhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5elwiO1xuICBjb25zdCBjaGFyYWN0ZXJzTGVuZ3RoID0gY2hhcmFjdGVycy5sZW5ndGg7XG4gIGxldCByZXN1bHQgPSBgJHtwcmVmaXhcbiAgICAudG9Mb3dlckNhc2UoKVxuICAgIC5zbGljZSgwLCBNQVhfTkFNRV9MRU5HVEggLSBsZW5ndGggLSAxKX0tYDtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgIHJlc3VsdCArPSBjaGFyYWN0ZXJzLmNoYXJBdChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFyYWN0ZXJzTGVuZ3RoKSk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29weUFzc2V0KGJ1Y2tldDogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xuICBsb2coYGNvcHlBc3NldCgpIGNhbGxlZCB3aXRoIHBhcmFtc2AsIGJ1Y2tldCwgcGFyYW1zKTtcblxuICAvLyBDb3B5XG4gIGxvZyhgY29weWApO1xuICBjb25zdCByZXNwID0gYXdhaXQgczNcbiAgICAuY29weU9iamVjdCh7XG4gICAgICBCdWNrZXQ6IGJ1Y2tldCxcbiAgICAgIENvcHlTb3VyY2U6IGAvJHtwYXJhbXMuQ29kZS5TM0J1Y2tldH0vJHtwYXJhbXMuQ29kZS5TM0tleX1gLFxuICAgICAgS2V5OiBwYXJhbXMuQ29kZS5TM0tleSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcblxuICAvLyBVcGRhdGUgcGFyYW1zXG4gIHBhcmFtcy5Db2RlLlMzQnVja2V0ID0gYnVja2V0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbihmdW5jdGlvbk5hbWU6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGBjcmVhdGVGdW5jdGlvbigpIGNhbGxlZCB3aXRoIHBhcmFtc2AsIHBhcmFtcyk7XG5cbiAgY29uc3QgcmVzcCA9IGF3YWl0IGxhbWJkYVxuICAgIC5jcmVhdGVGdW5jdGlvbih7XG4gICAgICAuLi5wYXJhbXMsXG4gICAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uTmFtZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG5cbiAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xuXG4gIHJldHVybiB7IEZ1bmN0aW9uQXJuOiByZXNwLkZ1bmN0aW9uQXJuIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUZ1bmN0aW9uQ29uZmlndXJhdGlvbihmdW5jdGlvbk5hbWU6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGB1cGRhdGVGdW5jdGlvbkNvbmZpZ3VyYXRpb24oKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMpO1xuXG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAudXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uKHtcbiAgICAgIC4uLnBhcmFtcyxcbiAgICAgIENvZGU6IHVuZGVmaW5lZCxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlRnVuY3Rpb25Db2RlKGZ1bmN0aW9uTmFtZTogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xuICBsb2coYHVwZGF0ZUZ1bmN0aW9uQ29kZSgpIGNhbGxlZCB3aXRoIHBhcmFtc2AsIHBhcmFtcyk7XG5cbiAgY29uc3QgcmVzcCA9IGF3YWl0IGxhbWJkYVxuICAgIC51cGRhdGVGdW5jdGlvbkNvZGUoe1xuICAgICAgRnVuY3Rpb25OYW1lOiBmdW5jdGlvbk5hbWUsXG4gICAgICBQdWJsaXNoOiBmYWxzZSxcbiAgICAgIC4uLnBhcmFtcy5Db2RlLFxuICAgIH0pXG4gICAgLnByb21pc2UoKTtcbiAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWxldGVGdW5jdGlvbihmdW5jdGlvbk5hbWU6IHN0cmluZykge1xuICBsb2coYGRlbGV0ZUZ1bmN0aW9uKCkgY2FsbGVkIHdpdGggZnVuY3Rpb25OYW1lYCwgZnVuY3Rpb25OYW1lKTtcblxuICBjb25zdCByZXNwID0gYXdhaXQgbGFtYmRhXG4gICAgLmRlbGV0ZUZ1bmN0aW9uKHtcbiAgICAgIEZ1bmN0aW9uTmFtZTogZnVuY3Rpb25OYW1lLFxuICAgIH0pXG4gICAgLnByb21pc2UoKTtcblxuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG59XG5cbmZ1bmN0aW9uIGlzQ29uZmlndXJhdGlvbkNoYW5nZWQocGFyYW1zOiBhbnksIG9sZFBhcmFtczogYW55KSB7XG4gIHJldHVybiAoXG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5sZW5ndGggIT09IE9iamVjdC5rZXlzKHBhcmFtcykubGVuZ3RoIHx8XG4gICAgW1wiRGVzY3JpcHRpb25cIiwgXCJIYW5kbGVyXCIsIFwiUnVudGltZVwiLCBcIk1lbW9yeVNpemVcIiwgXCJUaW1lb3V0XCIsIFwiUm9sZVwiXS5zb21lKFxuICAgICAgKHApID0+IHBhcmFtc1twXSAhPT0gb2xkUGFyYW1zW3BdXG4gICAgKVxuICApO1xufVxuXG5mdW5jdGlvbiBpc0NvZGVDaGFuZ2VkKHBhcmFtczogYW55LCBvbGRQYXJhbXM6IGFueSkge1xuICByZXR1cm4gKFxuICAgIHBhcmFtcy5Db2RlLlMzQnVja2V0ICE9PSBvbGRQYXJhbXMuQ29kZS5TM0J1Y2tldCB8fFxuICAgIHBhcmFtcy5Db2RlLlMzS2V5ICE9PSBvbGRQYXJhbXMuQ29kZS5TM0tleVxuICApO1xufVxuIl19