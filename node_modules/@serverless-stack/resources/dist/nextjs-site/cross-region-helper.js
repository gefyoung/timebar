"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateVersionLogicalId = exports.createVersion = exports.createFunction = exports.getOrCreateBucket = void 0;
const path = __importStar(require("path"));
const crypto = __importStar(require("crypto"));
const cdk = __importStar(require("aws-cdk-lib"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
function getOrCreateBucket(scope) {
    // Do not recreate if exist
    const providerId = "EdgeLambdaBucketProvider";
    const resId = "EdgeLambdaBucket";
    const stack = cdk.Stack.of(scope);
    const existingResource = stack.node.tryFindChild(resId);
    if (existingResource) {
        return existingResource;
    }
    // Create provider
    const provider = new lambda.Function(stack, providerId, {
        code: lambda.Code.fromAsset(path.join(__dirname, "custom-resource")),
        handler: "s3-bucket.handler",
        runtime: lambda.Runtime.NODEJS_12_X,
        timeout: cdk.Duration.minutes(15),
        memorySize: 1024,
        initialPolicy: [
            new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: ["s3:*"],
                resources: ["*"],
            }),
        ],
    });
    // Create custom resource
    const resource = new cdk.CustomResource(stack, resId, {
        serviceToken: provider.functionArn,
        resourceType: "Custom::SSTEdgeLambdaBucket",
        properties: {
            BucketNamePrefix: `${stack.stackName}-${resId}`,
        },
    });
    return resource;
}
exports.getOrCreateBucket = getOrCreateBucket;
function createFunction(scope, name, role, bucketName, functionParams) {
    // Do not recreate if exist
    const providerId = "EdgeLambdaProvider";
    const resId = `${name}EdgeLambda`;
    const stack = cdk.Stack.of(scope);
    let provider = stack.node.tryFindChild(providerId);
    // Create provider if not already created
    if (!provider) {
        provider = new lambda.Function(stack, providerId, {
            code: lambda.Code.fromAsset(path.join(__dirname, "custom-resource")),
            handler: "edge-lambda.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            initialPolicy: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["lambda:*", "s3:*"],
                    resources: ["*"],
                }),
            ],
        });
        if (provider.role) {
            role.grantPassRole(provider.role);
        }
    }
    // Create custom resource
    const resource = new cdk.CustomResource(scope, resId, {
        serviceToken: provider.functionArn,
        resourceType: "Custom::SSTEdgeLambda",
        properties: {
            FunctionNamePrefix: `${cdk.Stack.of(scope).stackName}-${resId}`,
            FunctionBucket: bucketName,
            FunctionParams: functionParams,
        },
    });
    return resource;
}
exports.createFunction = createFunction;
function createVersion(scope, name, functionArn) {
    // Do not recreate if exist
    const providerId = "EdgeLambdaVersionProvider";
    const resId = `${name}EdgeLambdaVersion`;
    const stack = cdk.Stack.of(scope);
    let provider = stack.node.tryFindChild(providerId);
    // Create provider if not already created
    if (!provider) {
        provider = new lambda.Function(stack, providerId, {
            code: lambda.Code.fromAsset(path.join(__dirname, "custom-resource")),
            handler: "edge-lambda-version.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            initialPolicy: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["lambda:*"],
                    resources: ["*"],
                }),
            ],
        });
    }
    // Create custom resource
    return new cdk.CustomResource(scope, resId, {
        serviceToken: provider.functionArn,
        resourceType: "Custom::SSTEdgeLambdaVersion",
        properties: {
            FunctionArn: functionArn,
        },
    });
}
exports.createVersion = createVersion;
function updateVersionLogicalId(functionCR, versionCR) {
    // Override the version's logical ID with a lazy string which includes the
    // hash of the function itself, so a new version resource is created when
    // the function configuration changes.
    const cfn = versionCR.node.defaultChild;
    const originalLogicalId = cdk.Stack.of(versionCR).resolve(cfn.logicalId);
    cfn.overrideLogicalId(cdk.Lazy.uncachedString({
        produce: () => {
            const hash = calculateHash(functionCR);
            const logicalId = trimFromStart(originalLogicalId, 255 - 32);
            return `${logicalId}${hash}`;
        },
    }));
}
exports.updateVersionLogicalId = updateVersionLogicalId;
function trimFromStart(s, maxLength) {
    const desiredLength = Math.min(maxLength, s.length);
    const newStart = s.length - desiredLength;
    return s.substring(newStart);
}
function calculateHash(resource) {
    // render the cloudformation resource from this function
    // config is of the shape:
    // {
    //  Resources: {
    //    LogicalId: {
    //      Type: 'Function',
    //      Properties: { ... }
    // }}}
    const cfnResource = resource.node.defaultChild;
    const config = cdk.Stack.of(resource).resolve(cfnResource._toCloudFormation());
    const resources = config.Resources;
    const resourceKeys = Object.keys(resources);
    if (resourceKeys.length !== 1) {
        throw new Error(`Expected one rendered CloudFormation resource but found ${resourceKeys.length}`);
    }
    const logicalId = resourceKeys[0];
    const properties = resources[logicalId].Properties.FunctionParams;
    const hash = crypto.createHash("md5");
    hash.update(JSON.stringify(properties));
    return hash.digest("hex");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3MtcmVnaW9uLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9uZXh0anMtc2l0ZS9jcm9zcy1yZWdpb24taGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkI7QUFDN0IsK0NBQWlDO0FBRWpDLGlEQUFtQztBQUNuQyx5REFBMkM7QUFDM0MsK0RBQWlEO0FBRWpELFNBQWdCLGlCQUFpQixDQUFDLEtBQWdCO0lBQ2hELDJCQUEyQjtJQUMzQixNQUFNLFVBQVUsR0FBRywwQkFBMEIsQ0FBQztJQUM5QyxNQUFNLEtBQUssR0FBRyxrQkFBa0IsQ0FBQztJQUNqQyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsQyxNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBdUIsQ0FBQztJQUM5RSxJQUFJLGdCQUFnQixFQUFFO1FBQ3BCLE9BQU8sZ0JBQWdCLENBQUM7S0FDekI7SUFFRCxrQkFBa0I7SUFDbEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUU7UUFDdEQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDcEUsT0FBTyxFQUFFLG1CQUFtQjtRQUM1QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1FBQ25DLE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDakMsVUFBVSxFQUFFLElBQUk7UUFDaEIsYUFBYSxFQUFFO1lBQ2IsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO2dCQUN0QixNQUFNLEVBQUUs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QyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUMxQyxXQUFtQixDQUFDLGlCQUFpQixFQUFFLENBQ3pDLENBQUM7SUFDRixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0lBQ25DLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsSUFBSSxZQUFZLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUM3QixNQUFNLElBQUksS0FBSyxDQUNiLDJEQUEyRCxZQUFZLENBQUMsTUFBTSxFQUFFLENBQ2pGLENBQUM7S0FDSDtJQUNELE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQyxNQUFNLFVBQVUsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQztJQUVsRSxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3hDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUM1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0T3JDcmVhdGVCdWNrZXQoc2NvcGU6IENvbnN0cnVjdCk6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gIC8vIERvIG5vdCByZWNyZWF0ZSBpZiBleGlzdFxuICBjb25zdCBwcm92aWRlcklkID0gXCJFZGdlTGFtYmRhQnVja2V0UHJvdmlkZXJcIjtcbiAgY29uc3QgcmVzSWQgPSBcIkVkZ2VMYW1iZGFCdWNrZXRcIjtcbiAgY29uc3Qgc3RhY2sgPSBjZGsuU3RhY2sub2Yoc2NvcGUpO1xuICBjb25zdCBleGlzdGluZ1Jlc291cmNlID0gc3RhY2subm9kZS50cnlGaW5kQ2hpbGQocmVzSWQpIGFzIGNkay5DdXN0b21SZXNvdXJjZTtcbiAgaWYgKGV4aXN0aW5nUmVzb3VyY2UpIHtcbiAgICByZXR1cm4gZXhpc3RpbmdSZXNvdXJjZTtcbiAgfVxuXG4gIC8vIENyZWF0ZSBwcm92aWRlclxuICBjb25zdCBwcm92aWRlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssIHByb3ZpZGVySWQsIHtcbiAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgXCJjdXN0b20tcmVzb3VyY2VcIikpLFxuICAgIGhhbmRsZXI6IFwiczMtYnVja2V0LmhhbmRsZXJcIixcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICBpbml0aWFsUG9saWN5OiBbXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wiczM6KlwiXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSksXG4gICAgXSxcbiAgfSk7XG5cbiAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICBjb25zdCByZXNvdXJjZSA9IG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2Uoc3RhY2ssIHJlc0lkLCB7XG4gICAgc2VydmljZVRva2VuOiBwcm92aWRlci5mdW5jdGlvbkFybixcbiAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RFZGdlTGFtYmRhQnVja2V0XCIsXG4gICAgcHJvcGVydGllczoge1xuICAgICAgQnVja2V0TmFtZVByZWZpeDogYCR7c3RhY2suc3RhY2tOYW1lfS0ke3Jlc0lkfWAsXG4gICAgfSxcbiAgfSk7XG5cbiAgcmV0dXJuIHJlc291cmNlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb24oXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIG5hbWU6IHN0cmluZyxcbiAgcm9sZTogaWFtLlJvbGUsXG4gIGJ1Y2tldE5hbWU6IHN0cmluZyxcbiAgZnVuY3Rpb25QYXJhbXM6IGFueVxuKTogY2RrLkN1c3RvbVJlc291cmNlIHtcbiAgLy8gRG8gbm90IHJlY3JlYXRlIGlmIGV4aXN0XG4gIGNvbnN0IHByb3ZpZGVySWQgPSBcIkVkZ2VMYW1iZGFQcm92aWRlclwiO1xuICBjb25zdCByZXNJZCA9IGAke25hbWV9RWRnZUxhbWJkYWA7XG4gIGNvbnN0IHN0YWNrID0gY2RrLlN0YWNrLm9mKHNjb3BlKTtcbiAgbGV0IHByb3ZpZGVyID0gc3RhY2subm9kZS50cnlGaW5kQ2hpbGQocHJvdmlkZXJJZCkgYXMgbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIC8vIENyZWF0ZSBwcm92aWRlciBpZiBub3QgYWxyZWFkeSBjcmVhdGVkXG4gIGlmICghcHJvdmlkZXIpIHtcbiAgICBwcm92aWRlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssIHByb3ZpZGVySWQsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCBcImN1c3RvbS1yZXNvdXJjZVwiKSksXG4gICAgICBoYW5kbGVyOiBcImVkZ2UtbGFtYmRhLmhhbmRsZXJcIixcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIGluaXRpYWxQb2xpY3k6IFtcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICBhY3Rpb25zOiBbXCJsYW1iZGE6KlwiLCBcInMzOipcIl0sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgICB9KSxcbiAgICAgIF0sXG4gICAgfSk7XG4gICAgaWYgKHByb3ZpZGVyLnJvbGUpIHtcbiAgICAgIHJvbGUuZ3JhbnRQYXNzUm9sZShwcm92aWRlci5yb2xlKTtcbiAgICB9XG4gIH1cblxuICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlXG4gIGNvbnN0IHJlc291cmNlID0gbmV3IGNkay5DdXN0b21SZXNvdXJjZShzY29wZSwgcmVzSWQsIHtcbiAgICBzZXJ2aWNlVG9rZW46IHByb3ZpZGVyLmZ1bmN0aW9uQXJuLFxuICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVEVkZ2VMYW1iZGFcIixcbiAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICBGdW5jdGlvbk5hbWVQcmVmaXg6IGAke2Nkay5TdGFjay5vZihzY29wZSkuc3RhY2tOYW1lfS0ke3Jlc0lkfWAsXG4gICAgICBGdW5jdGlvbkJ1Y2tldDogYnVja2V0TmFtZSxcbiAgICAgIEZ1bmN0aW9uUGFyYW1zOiBmdW5jdGlvblBhcmFtcyxcbiAgICB9LFxuICB9KTtcblxuICByZXR1cm4gcmVzb3VyY2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVWZXJzaW9uKFxuICBzY29wZTogQ29uc3RydWN0LFxuICBuYW1lOiBzdHJpbmcsXG4gIGZ1bmN0aW9uQXJuOiBzdHJpbmdcbik6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gIC8vIERvIG5vdCByZWNyZWF0ZSBpZiBleGlzdFxuICBjb25zdCBwcm92aWRlcklkID0gXCJFZGdlTGFtYmRhVmVyc2lvblByb3ZpZGVyXCI7XG4gIGNvbnN0IHJlc0lkID0gYCR7bmFtZX1FZGdlTGFtYmRhVmVyc2lvbmA7XG4gIGNvbnN0IHN0YWNrID0gY2RrLlN0YWNrLm9mKHNjb3BlKTtcbiAgbGV0IHByb3ZpZGVyID0gc3RhY2subm9kZS50cnlGaW5kQ2hpbGQocHJvdmlkZXJJZCkgYXMgbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIC8vIENyZWF0ZSBwcm92aWRlciBpZiBub3QgYWxyZWFkeSBjcmVhdGVkXG4gIGlmICghcHJvdmlkZXIpIHtcbiAgICBwcm92aWRlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssIHByb3ZpZGVySWQsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCBcImN1c3RvbS1yZXNvdXJjZVwiKSksXG4gICAgICBoYW5kbGVyOiBcImVkZ2UtbGFtYmRhLXZlcnNpb24uaGFuZGxlclwiLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEyX1gsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgaW5pdGlhbFBvbGljeTogW1xuICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgIGFjdGlvbnM6IFtcImxhbWJkYToqXCJdLFxuICAgICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICByZXR1cm4gbmV3IGNkay5DdXN0b21SZXNvdXJjZShzY29wZSwgcmVzSWQsIHtcbiAgICBzZXJ2aWNlVG9rZW46IHByb3ZpZGVyLmZ1bmN0aW9uQXJuLFxuICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVEVkZ2VMYW1iZGFWZXJzaW9uXCIsXG4gICAgcHJvcGVydGllczoge1xuICAgICAgRnVuY3Rpb25Bcm46IGZ1bmN0aW9uQXJuLFxuICAgIH0sXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlVmVyc2lvbkxvZ2ljYWxJZChcbiAgZnVuY3Rpb25DUjogY2RrLkN1c3RvbVJlc291cmNlLFxuICB2ZXJzaW9uQ1I6IGNkay5DdXN0b21SZXNvdXJjZVxuKSB7XG4gIC8vIE92ZXJyaWRlIHRoZSB2ZXJzaW9uJ3MgbG9naWNhbCBJRCB3aXRoIGEgbGF6eSBzdHJpbmcgd2hpY2ggaW5jbHVkZXMgdGhlXG4gIC8vIGhhc2ggb2YgdGhlIGZ1bmN0aW9uIGl0c2VsZiwgc28gYSBuZXcgdmVyc2lvbiByZXNvdXJjZSBpcyBjcmVhdGVkIHdoZW5cbiAgLy8gdGhlIGZ1bmN0aW9uIGNvbmZpZ3VyYXRpb24gY2hhbmdlcy5cbiAgY29uc3QgY2ZuID0gdmVyc2lvbkNSLm5vZGUuZGVmYXVsdENoaWxkIGFzIGNkay5DZm5SZXNvdXJjZTtcbiAgY29uc3Qgb3JpZ2luYWxMb2dpY2FsSWQgPSBjZGsuU3RhY2sub2YodmVyc2lvbkNSKS5yZXNvbHZlKFxuICAgIGNmbi5sb2dpY2FsSWRcbiAgKSBhcyBzdHJpbmc7XG4gIGNmbi5vdmVycmlkZUxvZ2ljYWxJZChcbiAgICBjZGsuTGF6eS51bmNhY2hlZFN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGhhc2ggPSBjYWxjdWxhdGVIYXNoKGZ1bmN0aW9uQ1IpO1xuICAgICAgICBjb25zdCBsb2dpY2FsSWQgPSB0cmltRnJvbVN0YXJ0KG9yaWdpbmFsTG9naWNhbElkLCAyNTUgLSAzMik7XG4gICAgICAgIHJldHVybiBgJHtsb2dpY2FsSWR9JHtoYXNofWA7XG4gICAgICB9LFxuICAgIH0pXG4gICk7XG59XG5cbmZ1bmN0aW9uIHRyaW1Gcm9tU3RhcnQoczogc3RyaW5nLCBtYXhMZW5ndGg6IG51bWJlcikge1xuICBjb25zdCBkZXNpcmVkTGVuZ3RoID0gTWF0aC5taW4obWF4TGVuZ3RoLCBzLmxlbmd0aCk7XG4gIGNvbnN0IG5ld1N0YXJ0ID0gcy5sZW5ndGggLSBkZXNpcmVkTGVuZ3RoO1xuICByZXR1cm4gcy5zdWJzdHJpbmcobmV3U3RhcnQpO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVIYXNoKHJlc291cmNlOiBjZGsuQ3VzdG9tUmVzb3VyY2UpOiBzdHJpbmcge1xuICAvLyByZW5kZXIgdGhlIGNsb3VkZm9ybWF0aW9uIHJlc291cmNlIGZyb20gdGhpcyBmdW5jdGlvblxuICAvLyBjb25maWcgaXMgb2YgdGhlIHNoYXBlOlxuICAvLyB7XG4gIC8vICBSZXNvdXJjZXM6IHtcbiAgLy8gICAgTG9naWNhbElkOiB7XG4gIC8vICAgICAgVHlwZTogJ0Z1bmN0aW9uJyxcbiAgLy8gICAgICBQcm9wZXJ0aWVzOiB7IC4uLiB9XG4gIC8vIH19fVxuICBjb25zdCBjZm5SZXNvdXJjZSA9IHJlc291cmNlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGNkay5DZm5SZXNvdXJjZTtcbiAgY29uc3QgY29uZmlnID0gY2RrLlN0YWNrLm9mKHJlc291cmNlKS5yZXNvbHZlKFxuICAgIChjZm5SZXNvdXJjZSBhcyBhbnkpLl90b0Nsb3VkRm9ybWF0aW9uKClcbiAgKTtcbiAgY29uc3QgcmVzb3VyY2VzID0gY29uZmlnLlJlc291cmNlcztcbiAgY29uc3QgcmVzb3VyY2VLZXlzID0gT2JqZWN0LmtleXMocmVzb3VyY2VzKTtcbiAgaWYgKHJlc291cmNlS2V5cy5sZW5ndGggIT09IDEpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgRXhwZWN0ZWQgb25lIHJlbmRlcmVkIENsb3VkRm9ybWF0aW9uIHJlc291cmNlIGJ1dCBmb3VuZCAke3Jlc291cmNlS2V5cy5sZW5ndGh9YFxuICAgICk7XG4gIH1cbiAgY29uc3QgbG9naWNhbElkID0gcmVzb3VyY2VLZXlzWzBdO1xuICBjb25zdCBwcm9wZXJ0aWVzID0gcmVzb3VyY2VzW2xvZ2ljYWxJZF0uUHJvcGVydGllcy5GdW5jdGlvblBhcmFtcztcblxuICBjb25zdCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goXCJtZDVcIik7XG4gIGhhc2gudXBkYXRlKEpTT04uc3RyaW5naWZ5KHByb3BlcnRpZXMpKTtcbiAgcmV0dXJuIGhhc2guZGlnZXN0KFwiaGV4XCIpO1xufVxuIl19