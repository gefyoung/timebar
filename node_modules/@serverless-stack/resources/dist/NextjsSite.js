"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextjsSite = void 0;
const chalk_1 = __importDefault(require("chalk"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const child_process_1 = require("child_process");
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const sqs = __importStar(require("aws-cdk-lib/aws-sqs"));
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const s3Assets = __importStar(require("aws-cdk-lib/aws-s3-assets"));
const cloudfront = __importStar(require("aws-cdk-lib/aws-cloudfront"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
const lambda_layer_awscli_1 = require("aws-cdk-lib/lambda-layer-awscli");
const origins = __importStar(require("aws-cdk-lib/aws-cloudfront-origins"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const route53Patterns = __importStar(require("aws-cdk-lib/aws-route53-patterns"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const Construct_1 = require("./Construct");
const BaseSite_1 = require("./BaseSite");
const permission_1 = require("./util/permission");
const builder_1 = require("./util/builder");
const crossRegionHelper = __importStar(require("./nextjs-site/cross-region-helper"));
class NextjsSite extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        // Local development or skip build => stub asset
        this.isPlaceholder =
            (root.local || root.skipBuild) && !props.disablePlaceholder;
        const buildDir = root.buildDir;
        const fileSizeLimit = root.isJestTest()
            ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: "jestFileSizeLimitOverride" not exposed in props
                props.jestFileSizeLimitOverride || 200
            : 200;
        this.props = props;
        this.awsCliLayer = new lambda_layer_awscli_1.AwsCliLayer(this, "AwsCliLayer");
        this.registerSiteEnvironment();
        // Build app
        if (this.isPlaceholder) {
            this.buildOutDir = null;
            this.assets = this.zipAppStubAssets();
            this.deployId = `deploy-live`;
            this.routesManifest = null;
        }
        else {
            this.buildOutDir = root.isJestTest()
                ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    // @ts-ignore: "jestBuildOutputPath" not exposed in props
                    props.jestBuildOutputPath || this.buildApp()
                : this.buildApp();
            const buildIdFile = path.resolve(this.buildOutDir, "assets", "BUILD_ID");
            const buildId = fs.readFileSync(buildIdFile).toString();
            this.assets = this.zipAppAssets(fileSizeLimit, buildDir);
            this.deployId = `deploy-${buildId}`;
            this.routesManifest = this.readRoutesManifest();
        }
        // Create Bucket
        this.s3Bucket = this.createS3Bucket();
        // Handle Incremental Static Regeneration
        this.sqsRegenerationQueue = this.createRegenerationQueue();
        this.regenerationFunction = this.createRegenerationFunction();
        // Create Lambda@Edge functions (always created in us-east-1)
        this.edgeLambdaRole = this.createEdgeFunctionRole();
        this.mainFunctionVersion = this.createEdgeFunction("Main", "default-lambda");
        this.apiFunctionVersion = this.createEdgeFunction("Api", "api-lambda");
        this.imageFunctionVersion = this.createEdgeFunction("Image", "image-lambda");
        // Create Custom Domain
        this.validateCustomDomainSettings();
        this.hostedZone = this.lookupHostedZone();
        this.acmCertificate = this.createCertificate();
        // Create S3 Deployment
        const s3deployCR = this.createS3Deployment();
        // Create CloudFront
        this.cfDistribution = this.createCloudFrontDistribution();
        this.cfDistribution.node.addDependency(s3deployCR);
        // Invalidate CloudFront
        const invalidationCR = this.createCloudFrontInvalidation();
        invalidationCR.node.addDependency(this.cfDistribution);
        // Connect Custom Domain to CloudFront Distribution
        this.createRoute53Records();
    }
    get url() {
        return `https://${this.cfDistribution.distributionDomainName}`;
    }
    get customDomainUrl() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return `https://${customDomain}`;
        }
        else {
            return `https://${customDomain.domainName}`;
        }
    }
    get bucketArn() {
        return this.s3Bucket.bucketArn;
    }
    get bucketName() {
        return this.s3Bucket.bucketName;
    }
    get distributionId() {
        return this.cfDistribution.distributionId;
    }
    get distributionDomain() {
        return this.cfDistribution.distributionDomainName;
    }
    attachPermissions(permissions) {
        permission_1.attachPermissionsToRole(this.edgeLambdaRole, permissions);
    }
    getConstructMetadata() {
        return {
            type: "NextSite",
            data: {
                distributionId: this.cfDistribution.distributionId,
                customDomainUrl: this.customDomainUrl,
            },
        };
    }
    zipAppAssets(fileSizeLimit, buildDir) {
        // validate buildOutput exists
        const siteOutputPath = path.resolve(path.join(this.buildOutDir, "assets"));
        if (!fs.existsSync(siteOutputPath)) {
            throw new Error(`No build output found at "${siteOutputPath}" for the "${this.node.id}" NextjsSite.`);
        }
        // create zip files
        const script = path.join(__dirname, "../assets/BaseSite/archiver.js");
        const zipPath = path.resolve(path.join(buildDir, `NextjsSite-${this.node.id}-${this.node.addr}`));
        // clear zip path to ensure no partX.zip remain from previous build
        fs.removeSync(zipPath);
        const cmd = ["node", script, siteOutputPath, zipPath, fileSizeLimit].join(" ");
        try {
            child_process_1.execSync(cmd, {
                stdio: "inherit",
            });
        }
        catch (e) {
            throw new Error(`There was a problem generating the "${this.node.id}" NextjsSite package.`);
        }
        // create assets
        const assets = [];
        for (let partId = 0;; partId++) {
            const zipFilePath = path.join(zipPath, `part${partId}.zip`);
            if (!fs.existsSync(zipFilePath)) {
                break;
            }
            assets.push(new s3Assets.Asset(this, `Asset${partId}`, {
                path: zipFilePath,
            }));
        }
        return assets;
    }
    zipAppStubAssets() {
        return [
            new s3Assets.Asset(this, "Asset", {
                path: path.resolve(__dirname, "../assets/NextjsSite/site-stub"),
            }),
        ];
    }
    createEdgeFunction(name, handlerPath) {
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        const hasRealCode = typeof this.buildOutDir === "string" &&
            fs.pathExistsSync(path.join(this.buildOutDir, handlerPath, "index.js"));
        // Create function asset
        const assetPath = hasRealCode && this.buildOutDir
            ? path.join(this.buildOutDir, handlerPath)
            : path.join(__dirname, "../assets/NextjsSite/edge-lambda-stub");
        const asset = new s3Assets.Asset(this, `${name}FunctionAsset`, {
            path: assetPath,
        });
        // Create function based on region
        const root = this.node.root;
        return root.region === "us-east-1"
            ? this.createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode)
            : this.createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode);
    }
    createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode) {
        const { defaultFunctionProps: fnProps } = this.props;
        // Create function
        const fn = new lambda.Function(this, `${name}Function`, {
            description: `${name} handler for Next.js`,
            handler: "index.handler",
            currentVersionOptions: {
                removalPolicy: cdk.RemovalPolicy.DESTROY,
            },
            logRetention: logs.RetentionDays.THREE_DAYS,
            code: lambda.Code.fromAsset(assetPath),
            runtime: lambda.Runtime.NODEJS_12_X,
            memorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 512,
            timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 10),
            role: this.edgeLambdaRole,
        });
        // Create alias
        fn.currentVersion.addAlias("live");
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            fn.node.addDependency(updaterCR);
        }
        return fn.currentVersion;
    }
    createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode) {
        const { defaultFunctionProps: fnProps } = this.props;
        // If app region is NOT us-east-1, create a Function in us-east-1
        // using a Custom Resource
        // Create a S3 bucket in us-east-1 to store Lambda code. Create
        // 1 bucket for all Edge functions.
        const bucketCR = crossRegionHelper.getOrCreateBucket(this);
        const bucketName = bucketCR.getAttString("BucketName");
        // Create a Lambda function in us-east-1
        const functionCR = crossRegionHelper.createFunction(this, name, this.edgeLambdaRole, bucketName, {
            Description: `handler for Next.js`,
            Handler: "index.handler",
            Code: {
                S3Bucket: asset.s3BucketName,
                S3Key: asset.s3ObjectKey,
            },
            Runtime: lambda.Runtime.NODEJS_12_X.name,
            MemorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 512,
            Timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 10).toSeconds(),
            Role: this.edgeLambdaRole.roleArn,
        });
        const functionArn = functionCR.getAttString("FunctionArn");
        // Create a Lambda function version in us-east-1
        const versionCR = crossRegionHelper.createVersion(this, name, functionArn);
        const versionId = versionCR.getAttString("Version");
        crossRegionHelper.updateVersionLogicalId(functionCR, versionCR);
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            functionCR.node.addDependency(updaterCR);
        }
        return lambda.Version.fromVersionArn(this, `${name}FunctionVersion`, `${functionArn}:${versionId}`);
    }
    createEdgeFunctionRole() {
        const { defaultFunctionProps: fnProps } = this.props;
        // Create function role
        const role = new iam.Role(this, `EdgeLambdaRole`, {
            assumedBy: new iam.CompositePrincipal(new iam.ServicePrincipal("lambda.amazonaws.com"), new iam.ServicePrincipal("edgelambda.amazonaws.com")),
            managedPolicies: [
                iam.ManagedPolicy.fromManagedPolicyArn(this, "EdgeLambdaPolicy", "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"),
            ],
        });
        // Attach permission
        this.s3Bucket.grantReadWrite(role);
        this.sqsRegenerationQueue.grantSendMessages(role);
        this.regenerationFunction.grantInvoke(role);
        if (fnProps === null || fnProps === void 0 ? void 0 : fnProps.permissions) {
            permission_1.attachPermissionsToRole(role, fnProps.permissions);
        }
        return role;
    }
    createRegenerationQueue() {
        const { sqsRegenerationQueue } = this.props;
        return new sqs.Queue(this, "RegenerationQueue", Object.assign(Object.assign({}, (sqsRegenerationQueue || {})), { 
            // We call the queue the same name as the bucket so that we can easily
            // reference it from within the lambda@edge, given we can't use env vars
            // in a lambda@edge
            queueName: `${this.s3Bucket.bucketName}.fifo`, fifo: true, removalPolicy: cdk.RemovalPolicy.DESTROY }));
    }
    createRegenerationFunction() {
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        let code;
        let updaterCR;
        if (this.buildOutDir &&
            fs.pathExistsSync(path.join(this.buildOutDir, "regeneration-lambda", "index.js"))) {
            const asset = new s3Assets.Asset(this, `RegenerationFunctionAsset`, {
                path: path.join(this.buildOutDir, "regeneration-lambda"),
            });
            code = lambda.Code.fromAsset(path.join(this.buildOutDir, "regeneration-lambda"));
            updaterCR = this.createLambdaCodeReplacer("Regeneration", asset);
        }
        else {
            code = lambda.Code.fromInline("  ");
        }
        // Create function
        const { defaultFunctionProps: fnProps } = this.props;
        const fn = new lambda.Function(this, "RegenerationFunction", {
            handler: "index.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            memorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 1024,
            timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 30),
            code,
        });
        fn.addEventSource(new lambdaEventSources.SqsEventSource(this.sqsRegenerationQueue));
        // Grant permissions
        this.s3Bucket.grantReadWrite(fn);
        // Deploy after the code is updated
        if (updaterCR) {
            fn.node.addDependency(updaterCR);
        }
        return fn;
    }
    createLambdaCodeReplacer(name, asset) {
        // Note: Source code for the Lambda functions have "{{ ENV_KEY }}" in them.
        //       They need to be replaced with real values before the Lambda
        //       functions get deployed.
        var _a;
        const providerId = "LambdaCodeReplacerProvider";
        const resId = `${name}LambdaCodeReplacer`;
        const stack = cdk.Stack.of(this);
        let provider = stack.node.tryFindChild(providerId);
        // Create provider if not already created
        if (!provider) {
            provider = new lambda.Function(stack, providerId, {
                code: lambda.Code.fromAsset(path.join(__dirname, "../assets/NextjsSite/custom-resource")),
                layers: [this.awsCliLayer],
                runtime: lambda.Runtime.PYTHON_3_7,
                handler: "lambda-code-updater.handler",
                timeout: cdk.Duration.minutes(15),
                memorySize: 1024,
            });
        }
        // Allow provider to perform search/replace on the asset
        (_a = provider.role) === null || _a === void 0 ? void 0 : _a.addToPrincipalPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["s3:*"],
            resources: [`arn:aws:s3:::${asset.s3BucketName}/${asset.s3ObjectKey}`],
        }));
        // Create custom resource
        const resource = new cdk.CustomResource(this, resId, {
            serviceToken: provider.functionArn,
            resourceType: "Custom::SSTLambdaCodeUpdater",
            properties: {
                Source: {
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                },
                ReplaceValues: this.getLambdaContentReplaceValues(),
            },
        });
        return resource;
    }
    buildApp() {
        const { path: sitePath } = this.props;
        // validate site path exists
        if (!fs.existsSync(sitePath)) {
            throw new Error(`No path found at "${path.resolve(sitePath)}" for the "${this.node.id}" NextjsSite.`);
        }
        // Build command
        // Note: probably could pass JSON string also, but this felt safer.
        const root = this.node.root;
        const pathHash = builder_1.getHandlerHash(sitePath);
        const buildOutput = path.join(root.buildDir, pathHash);
        const configBuffer = Buffer.from(JSON.stringify({
            cwd: path.resolve(sitePath),
            args: ["build"],
        }));
        const cmd = [
            "node",
            path.join(__dirname, "../assets/NextjsSite/build.js"),
            "--path",
            path.resolve(sitePath),
            "--output",
            path.resolve(buildOutput),
            "--config",
            configBuffer.toString("base64"),
        ].join(" ");
        // Run build
        try {
            console.log(chalk_1.default.grey(`Building Next.js site ${sitePath}`));
            child_process_1.execSync(cmd, {
                cwd: sitePath,
                stdio: "inherit",
                env: Object.assign(Object.assign({}, process.env), BaseSite_1.getBuildCmdEnvironment(this.props.environment)),
            });
        }
        catch (e) {
            throw new Error(`There was a problem building the "${this.node.id}" NextjsSite.`);
        }
        return buildOutput;
    }
    createS3Bucket() {
        const { s3Bucket } = this.props;
        return new s3.Bucket(this, "Bucket", Object.assign({ publicReadAccess: true, autoDeleteObjects: true, removalPolicy: cdk.RemovalPolicy.DESTROY }, (s3Bucket || {})));
    }
    createS3Deployment() {
        // Create a Lambda function that will be doing the uploading
        const uploader = new lambda.Function(this, "S3Uploader", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-upload.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        this.s3Bucket.grantReadWrite(uploader);
        this.assets.forEach((asset) => asset.grantRead(uploader));
        // Create the custom resource function
        const handler = new lambda.Function(this, "S3Handler", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-handler.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            environment: {
                UPLOADER_FUNCTION_NAME: uploader.functionName,
            },
        });
        this.s3Bucket.grantReadWrite(handler);
        uploader.grantInvoke(handler);
        // Create custom resource
        const fileOptions = [
            {
                exclude: "*",
                include: "public/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static-pages/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/data/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/static/*",
                cacheControl: "public,max-age=31536000,immutable",
            },
        ];
        return new cdk.CustomResource(this, "S3Deployment", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTBucketDeployment",
            properties: {
                Sources: this.assets.map((asset) => ({
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                })),
                DestinationBucketName: this.s3Bucket.bucketName,
                DestinationBucketKeyPrefix: this.deployId,
                FileOptions: (fileOptions || []).map(({ exclude, include, cacheControl }) => {
                    return [
                        "--exclude",
                        exclude,
                        "--include",
                        include,
                        "--cache-control",
                        cacheControl,
                    ];
                }),
                ReplaceValues: this.getS3ContentReplaceValues(),
            },
        });
    }
    /////////////////////
    // CloudFront Distribution
    /////////////////////
    createCloudFrontDistribution() {
        var _a, _b, _c, _d;
        const { cfCachePolicies, cfDistribution, customDomain } = this.props;
        const cfDistributionProps = cfDistribution || {};
        // Validate input
        if (cfDistributionProps.certificate) {
            throw new Error(`Do not configure the "cfDistribution.certificate". Use the "customDomain" to configure the NextjsSite domain certificate.`);
        }
        if (cfDistributionProps.domainNames) {
            throw new Error(`Do not configure the "cfDistribution.domainNames". Use the "customDomain" to configure the NextjsSite domain.`);
        }
        // Build domainNames
        const domainNames = [];
        if (!customDomain) {
            // no domain
        }
        else if (typeof customDomain === "string") {
            domainNames.push(customDomain);
        }
        else {
            domainNames.push(customDomain.domainName);
        }
        // Build behavior
        const origin = new origins.S3Origin(this.s3Bucket, {
            originPath: this.deployId,
        });
        const viewerProtocolPolicy = cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS;
        if (this.isPlaceholder) {
            return new cloudfront.Distribution(this, "Distribution", {
                defaultRootObject: "index.html",
                errorResponses: BaseSite_1.buildErrorResponsesForRedirectToIndex("index.html"),
                domainNames,
                certificate: this.acmCertificate,
                defaultBehavior: {
                    origin,
                    viewerProtocolPolicy,
                },
            });
        }
        // Build Edge functions
        const edgeLambdas = [
            {
                includeBody: true,
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                functionVersion: this.mainFunctionVersion,
            },
            {
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_RESPONSE,
                functionVersion: this.mainFunctionVersion,
            },
        ];
        // Build cache policy
        const staticCachePolicy = (_a = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.staticCachePolicy) !== null && _a !== void 0 ? _a : this.createCloudFrontStaticCachePolicy();
        const imageCachePolicy = (_b = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.imageCachePolicy) !== null && _b !== void 0 ? _b : this.createCloudFrontImageCachePolicy();
        const lambdaCachePolicy = (_c = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.lambdaCachePolicy) !== null && _c !== void 0 ? _c : this.createCloudFrontLambdaCachePolicy();
        // Create Distribution
        return new cloudfront.Distribution(this, "Distribution", Object.assign(Object.assign({ 
            // these values can be overwritten by cfDistributionProps
            defaultRootObject: "" }, cfDistributionProps), { 
            // these values can NOT be overwritten by cfDistributionProps
            domainNames, certificate: this.acmCertificate, defaultBehavior: Object.assign(Object.assign({ viewerProtocolPolicy,
                origin, allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS, cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS, compress: true, cachePolicy: lambdaCachePolicy }, (cfDistributionProps.defaultBehavior || {})), { 
                // concatenate edgeLambdas
                edgeLambdas: [
                    ...edgeLambdas,
                    ...(((_d = cfDistributionProps.defaultBehavior) === null || _d === void 0 ? void 0 : _d.edgeLambdas) || []),
                ] }), additionalBehaviors: Object.assign({ [this.pathPattern("_next/image*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: imageCachePolicy,
                    originRequestPolicy: new cloudfront.OriginRequestPolicy(this, "ImageOriginRequest", {
                        queryStringBehavior: cloudfront.OriginRequestQueryStringBehavior.all(),
                    }),
                    edgeLambdas: [
                        {
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.imageFunctionVersion,
                        },
                    ],
                }, [this.pathPattern("_next/data/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas,
                }, [this.pathPattern("_next/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("static/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("api/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas: [
                        {
                            includeBody: true,
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.apiFunctionVersion,
                        },
                    ],
                } }, (cfDistributionProps.additionalBehaviors || {})) }));
    }
    createCloudFrontStaticCachePolicy() {
        return new cloudfront.CachePolicy(this, "StaticsCache", NextjsSite.staticCachePolicyProps);
    }
    createCloudFrontImageCachePolicy() {
        return new cloudfront.CachePolicy(this, "ImageCache", NextjsSite.imageCachePolicyProps);
    }
    createCloudFrontLambdaCachePolicy() {
        return new cloudfront.CachePolicy(this, "LambdaCache", NextjsSite.lambdaCachePolicyProps);
    }
    createCloudFrontInvalidation() {
        // Create a Lambda function that will be doing the invalidation
        const invalidator = new lambda.Function(this, "CloudFrontInvalidator", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "cf-invalidate.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        // Grant permissions to invalidate CF Distribution
        invalidator.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "cloudfront:GetInvalidation",
                "cloudfront:CreateInvalidation",
            ],
            resources: ["*"],
        }));
        // Create custom resource
        return new cdk.CustomResource(this, "CloudFrontInvalidation", {
            serviceToken: invalidator.functionArn,
            resourceType: "Custom::SSTCloudFrontInvalidation",
            properties: {
                // need the DeployId field so this CR gets updated on each deploy
                DeployId: this.deployId,
                DistributionId: this.cfDistribution.distributionId,
                DistributionPaths: ["/*"],
            },
        });
    }
    /////////////////////
    // Custom Domain
    /////////////////////
    validateCustomDomainSettings() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return;
        }
        if (customDomain.isExternalDomain === true) {
            if (!customDomain.certificate) {
                throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
            }
            if (customDomain.domainAlias) {
                throw new Error(`Domain alias is only supported for domains hosted on Amazon Route 53. Do not set the "customDomain.domainAlias" when "isExternalDomain" is enabled.`);
            }
            if (customDomain.hostedZone) {
                throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
            }
        }
    }
    lookupHostedZone() {
        const { customDomain } = this.props;
        // Skip if customDomain is not configured
        if (!customDomain) {
            return;
        }
        let hostedZone;
        if (typeof customDomain === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain,
            });
        }
        else if (Construct_1.isCDKConstruct(customDomain.hostedZone)) {
            hostedZone = customDomain.hostedZone;
        }
        else if (typeof customDomain.hostedZone === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.hostedZone,
            });
        }
        else if (typeof customDomain.domainName === "string") {
            // Skip if domain is not a Route53 domain
            if (customDomain.isExternalDomain === true) {
                return;
            }
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.domainName,
            });
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        return hostedZone;
    }
    createCertificate() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        let acmCertificate;
        // HostedZone is set for Route 53 domains
        if (this.hostedZone) {
            if (typeof customDomain === "string") {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
            else if (customDomain.certificate) {
                acmCertificate = customDomain.certificate;
            }
            else {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain.domainName,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
        }
        // HostedZone is NOT set for non-Route 53 domains
        else {
            if (typeof customDomain !== "string") {
                acmCertificate = customDomain.certificate;
            }
        }
        return acmCertificate;
    }
    createRoute53Records() {
        const { customDomain } = this.props;
        if (!customDomain || !this.hostedZone) {
            return;
        }
        let recordName;
        let domainAlias;
        if (typeof customDomain === "string") {
            recordName = customDomain;
        }
        else {
            recordName = customDomain.domainName;
            domainAlias = customDomain.domainAlias;
        }
        // Create DNS record
        new route53.ARecord(this, "AliasRecord", {
            recordName,
            zone: this.hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.CloudFrontTarget(this.cfDistribution)),
        });
        // Create Alias redirect record
        if (domainAlias) {
            new route53Patterns.HttpsRedirect(this, "Redirect", {
                zone: this.hostedZone,
                recordNames: [domainAlias],
                targetDomain: recordName,
            });
        }
    }
    /////////////////////
    // Helper Functions
    /////////////////////
    pathPattern(pattern) {
        const { basePath } = this.routesManifest || {};
        return basePath && basePath.length > 0
            ? `${basePath.slice(1)}/${pattern}`
            : pattern;
    }
    readRoutesManifest() {
        return fs.readJSONSync(path.join(this.buildOutDir, "default-lambda/routes-manifest.json"));
    }
    getS3ContentReplaceValues() {
        const replaceValues = [];
        Object.entries(this.props.environment || {})
            .filter(([, value]) => cdk.Token.isUnresolved(value))
            .forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
        });
        return replaceValues;
    }
    getLambdaContentReplaceValues() {
        const replaceValues = [];
        // The Next.js app can have environment variables like
        // `process.env.API_URL` in the JS code. `process.env.API_URL` might or
        // might not get resolved on `next build` if it is used in
        // server-side functions, ie. getServerSideProps().
        // Because Lambda@Edge does not support environment variables, we will
        // use the trick of replacing "{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}" with
        // a JSON encoded string of all environment key-value pairs. This string
        // will then get decoded at run time.
        const lambdaEnvs = {};
        Object.entries(this.props.environment || {}).forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
            lambdaEnvs[key] = value;
        });
        replaceValues.push({
            files: "**/*.js",
            search: '"{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}"',
            replace: JSON.stringify(lambdaEnvs),
        });
        return replaceValues;
    }
    registerSiteEnvironment() {
        const environmentOutputs = {};
        for (const [key, value] of Object.entries(this.props.environment || {})) {
            const outputId = `SstSiteEnv_${key}`;
            const output = new cdk.CfnOutput(this, outputId, { value });
            environmentOutputs[key] = cdk.Stack.of(this).getLogicalId(output);
        }
        const root = this.node.root;
        root.registerSiteEnvironment({
            id: this.node.id,
            path: this.props.path,
            stack: cdk.Stack.of(this).node.id,
            environmentOutputs,
        });
    }
}
exports.NextjsSite = NextjsSite;
NextjsSite.staticCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: cdk.Duration.days(30),
    maxTtl: cdk.Duration.days(30),
    minTtl: cdk.Duration.days(30),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Static Default Cache Policy",
};
NextjsSite.imageCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.allowList("Accept"),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: cdk.Duration.days(1),
    maxTtl: cdk.Duration.days(365),
    minTtl: cdk.Duration.days(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Image Default Cache Policy",
};
NextjsSite.lambdaCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.all(),
    defaultTtl: cdk.Duration.seconds(0),
    maxTtl: cdk.Duration.days(365),
    minTtl: cdk.Duration.seconds(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Lambda Default Cache Policy",
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzU2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9OZXh0anNTaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxrREFBMEI7QUFDMUIsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQixpREFBeUM7QUFFekMsMkNBQXVDO0FBQ3ZDLGlEQUFtQztBQUNuQyx1REFBeUM7QUFDekMseURBQTJDO0FBQzNDLHlEQUEyQztBQUMzQywyREFBNkM7QUFDN0MsK0RBQWlEO0FBQ2pELGlFQUFtRDtBQUNuRCxvRUFBc0Q7QUFDdEQsdUVBQXlEO0FBQ3pELHdFQUEwRDtBQUMxRCx5RUFBOEQ7QUFDOUQsNEVBQThEO0FBQzlELGdGQUFrRTtBQUNsRSxrRkFBb0U7QUFDcEUseUZBQTJFO0FBSTNFLDJDQUEyRDtBQUMzRCx5Q0FPb0I7QUFDcEIsa0RBQXlFO0FBQ3pFLDRDQUFnRDtBQUNoRCxxRkFBdUU7QUE2QnZFLE1BQWEsVUFBVyxTQUFRLHNCQUFTO0lBdUR2QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXNCO1FBQzlELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsZ0RBQWdEO1FBQ2hELElBQUksQ0FBQyxhQUFhO1lBQ2hCLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDOUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMvQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3JDLENBQUMsQ0FBQyw2REFBNkQ7Z0JBQzdELCtEQUErRDtnQkFDL0QsS0FBSyxDQUFDLHlCQUF5QixJQUFJLEdBQUc7WUFDeEMsQ0FBQyxD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QyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2hDLE1BQU0sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDOUIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM1QiwwQkFBMEIsRUFBRSxJQUFJO0lBQ2hDLHdCQUF3QixFQUFFLElBQUk7SUFDOUIsT0FBTyxFQUFFLDJDQUEyQztDQUNyRCxDQUFDO0FBRVksaUNBQXNCLEdBQWdDO0lBQ2xFLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLEVBQUU7SUFDOUQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7SUFDckQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUU7SUFDcEQsVUFBVSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUNuQyxNQUFNLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQzlCLE1BQU0sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDL0IsMEJBQTBCLEVBQUUsSUFBSTtJQUNoQyx3QkFBd0IsRUFBRSxJQUFJO0lBQzlCLE9BQU8sRUFBRSw0Q0FBNEM7Q0FDdEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFsayBmcm9tIFwiY2hhbGtcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBzcXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zcXNcIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgKiBhcyBzM0Fzc2V0cyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXMzLWFzc2V0c1wiO1xuaW1wb3J0ICogYXMgY2xvdWRmcm9udCBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNsb3VkZnJvbnRcIjtcbmltcG9ydCAqIGFzIGFjbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNlcnRpZmljYXRlbWFuYWdlclwiO1xuaW1wb3J0IHsgQXdzQ2xpTGF5ZXIgfSBmcm9tIFwiYXdzLWNkay1saWIvbGFtYmRhLWxheWVyLWF3c2NsaVwiO1xuaW1wb3J0ICogYXMgb3JpZ2lucyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNsb3VkZnJvbnQtb3JpZ2luc1wiO1xuaW1wb3J0ICogYXMgcm91dGU1M1RhcmdldHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yb3V0ZTUzLXRhcmdldHNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNQYXR0ZXJucyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTMtcGF0dGVybnNcIjtcbmltcG9ydCAqIGFzIGxhbWJkYUV2ZW50U291cmNlcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ldmVudC1zb3VyY2VzXCI7XG5pbXBvcnQgeyBSb3V0ZXNNYW5pZmVzdCB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9uZXh0anMtbGFtYmRhXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHtcbiAgQmFzZVNpdGVEb21haW5Qcm9wcyxcbiAgQmFzZVNpdGVSZXBsYWNlUHJvcHMsXG4gIEJhc2VTaXRlQ2RrRGlzdHJpYnV0aW9uUHJvcHMsXG4gIEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyxcbiAgZ2V0QnVpbGRDbWRFbnZpcm9ubWVudCxcbiAgYnVpbGRFcnJvclJlc3BvbnNlc0ZvclJlZGlyZWN0VG9JbmRleCxcbn0gZnJvbSBcIi4vQmFzZVNpdGVcIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zLCBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuaW1wb3J0IHsgZ2V0SGFuZGxlckhhc2ggfSBmcm9tIFwiLi91dGlsL2J1aWxkZXJcIjtcbmltcG9ydCAqIGFzIGNyb3NzUmVnaW9uSGVscGVyIGZyb20gXCIuL25leHRqcy1zaXRlL2Nyb3NzLXJlZ2lvbi1oZWxwZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNTaXRlUHJvcHMge1xuICBwYXRoOiBzdHJpbmc7XG4gIHMzQnVja2V0PzogczMuQnVja2V0UHJvcHM7XG4gIHNxc1JlZ2VuZXJhdGlvblF1ZXVlPzogc3FzLlF1ZXVlUHJvcHM7XG4gIGN1c3RvbURvbWFpbj86IHN0cmluZyB8IE5leHRqc1NpdGVEb21haW5Qcm9wcztcbiAgY2ZDYWNoZVBvbGljaWVzPzogTmV4dGpzU2l0ZUNhY2hlUG9saWN5UHJvcHM7XG4gIGNmRGlzdHJpYnV0aW9uPzogTmV4dGpzU2l0ZUNka0Rpc3RyaWJ1dGlvblByb3BzO1xuICBlbnZpcm9ubWVudD86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG4gIGRlZmF1bHRGdW5jdGlvblByb3BzPzogTmV4dGpzU2l0ZUZ1bmN0aW9uUHJvcHM7XG4gIGRpc2FibGVQbGFjZWhvbGRlcj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmV4dGpzU2l0ZUZ1bmN0aW9uUHJvcHMge1xuICB0aW1lb3V0PzogbnVtYmVyO1xuICBtZW1vcnlTaXplPzogbnVtYmVyO1xuICBwZXJtaXNzaW9ucz86IFBlcm1pc3Npb25zO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc1NpdGVDYWNoZVBvbGljeVByb3BzIHtcbiAgc3RhdGljQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbiAgaW1hZ2VDYWNoZVBvbGljeT86IGNsb3VkZnJvbnQuSUNhY2hlUG9saWN5O1xuICBsYW1iZGFDYWNoZVBvbGljeT86IGNsb3VkZnJvbnQuSUNhY2hlUG9saWN5O1xufVxuXG5leHBvcnQgdHlwZSBOZXh0anNTaXRlRG9tYWluUHJvcHMgPSBCYXNlU2l0ZURvbWFpblByb3BzO1xuZXhwb3J0IHR5cGUgTmV4dGpzU2l0ZUNka0Rpc3RyaWJ1dGlvblByb3BzID0gQmFzZVNpdGVDZGtEaXN0cmlidXRpb25Qcm9wcztcblxuZXhwb3J0IGNsYXNzIE5leHRqc1NpdGUgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgc3RhdGljIHN0YXRpY0NhY2hlUG9saWN5UHJvcHM6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3lQcm9wcyA9IHtcbiAgICBxdWVyeVN0cmluZ0JlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlUXVlcnlTdHJpbmdCZWhhdmlvci5ub25lKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5ub25lKCksXG4gICAgY29va2llQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVDb29raWVCZWhhdmlvci5ub25lKCksXG4gICAgZGVmYXVsdFR0bDogY2RrLkR1cmF0aW9uLmRheXMoMzApLFxuICAgIG1heFR0bDogY2RrLkR1cmF0aW9uLmRheXMoMzApLFxuICAgIG1pblR0bDogY2RrLkR1cmF0aW9uLmRheXMoMzApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiBcIlNTVCBOZXh0anNTaXRlIFN0YXRpYyBEZWZhdWx0IENhY2hlIFBvbGljeVwiLFxuICB9O1xuXG4gIHB1YmxpYyBzdGF0aWMgaW1hZ2VDYWNoZVBvbGljeVByb3BzOiBjbG91ZGZyb250LkNhY2hlUG9saWN5UHJvcHMgPSB7XG4gICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZVF1ZXJ5U3RyaW5nQmVoYXZpb3IuYWxsKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5hbGxvd0xpc3QoXCJBY2NlcHRcIiksXG4gICAgY29va2llQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVDb29raWVCZWhhdmlvci5ub25lKCksXG4gICAgZGVmYXVsdFR0bDogY2RrLkR1cmF0aW9uLmRheXMoMSksXG4gICAgbWF4VHRsOiBjZGsuRHVyYXRpb24uZGF5cygzNjUpLFxuICAgIG1pblR0bDogY2RrLkR1cmF0aW9uLmRheXMoMCksXG4gICAgZW5hYmxlQWNjZXB0RW5jb2RpbmdCcm90bGk6IHRydWUsXG4gICAgZW5hYmxlQWNjZXB0RW5jb2RpbmdHemlwOiB0cnVlLFxuICAgIGNvbW1lbnQ6IFwiU1NUIE5leHRqc1NpdGUgSW1hZ2UgRGVmYXVsdCBDYWNoZSBQb2xpY3lcIixcbiAgfTtcblxuICBwdWJsaWMgc3RhdGljIGxhbWJkYUNhY2hlUG9saWN5UHJvcHM6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3lQcm9wcyA9IHtcbiAgICBxdWVyeVN0cmluZ0JlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlUXVlcnlTdHJpbmdCZWhhdmlvci5hbGwoKSxcbiAgICBoZWFkZXJCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZUhlYWRlckJlaGF2aW9yLm5vbmUoKSxcbiAgICBjb29raWVCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZUNvb2tpZUJlaGF2aW9yLmFsbCgpLFxuICAgIGRlZmF1bHRUdGw6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDApLFxuICAgIG1heFR0bDogY2RrLkR1cmF0aW9uLmRheXMoMzY1KSxcbiAgICBtaW5UdGw6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiBcIlNTVCBOZXh0anNTaXRlIExhbWJkYSBEZWZhdWx0IENhY2hlIFBvbGljeVwiLFxuICB9O1xuXG4gIHB1YmxpYyByZWFkb25seSBzM0J1Y2tldDogczMuQnVja2V0O1xuICBwdWJsaWMgcmVhZG9ubHkgc3FzUmVnZW5lcmF0aW9uUXVldWU6IHNxcy5RdWV1ZTtcbiAgcHVibGljIHJlYWRvbmx5IGNmRGlzdHJpYnV0aW9uOiBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbjtcbiAgcHVibGljIHJlYWRvbmx5IGhvc3RlZFpvbmU/OiByb3V0ZTUzLklIb3N0ZWRab25lO1xuICBwdWJsaWMgcmVhZG9ubHkgYWNtQ2VydGlmaWNhdGU/OiBhY20uSUNlcnRpZmljYXRlO1xuICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBOZXh0anNTaXRlUHJvcHM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVwbG95SWQ6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBpc1BsYWNlaG9sZGVyOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IGJ1aWxkT3V0RGlyOiBzdHJpbmcgfCBudWxsO1xuICBwcml2YXRlIHJlYWRvbmx5IGFzc2V0czogczNBc3NldHMuQXNzZXRbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBhd3NDbGlMYXllcjogQXdzQ2xpTGF5ZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgcm91dGVzTWFuaWZlc3Q6IFJvdXRlc01hbmlmZXN0IHwgbnVsbDtcbiAgcHJpdmF0ZSByZWFkb25seSBlZGdlTGFtYmRhUm9sZTogaWFtLlJvbGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWFpbkZ1bmN0aW9uVmVyc2lvbjogbGFtYmRhLklWZXJzaW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IGFwaUZ1bmN0aW9uVmVyc2lvbjogbGFtYmRhLklWZXJzaW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IGltYWdlRnVuY3Rpb25WZXJzaW9uOiBsYW1iZGEuSVZlcnNpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVnZW5lcmF0aW9uRnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogTmV4dGpzU2l0ZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIC8vIExvY2FsIGRldmVsb3BtZW50IG9yIHNraXAgYnVpbGQgPT4gc3R1YiBhc3NldFxuICAgIHRoaXMuaXNQbGFjZWhvbGRlciA9XG4gICAgICAocm9vdC5sb2NhbCB8fCByb290LnNraXBCdWlsZCkgJiYgIXByb3BzLmRpc2FibGVQbGFjZWhvbGRlcjtcbiAgICBjb25zdCBidWlsZERpciA9IHJvb3QuYnVpbGREaXI7XG4gICAgY29uc3QgZmlsZVNpemVMaW1pdCA9IHJvb3QuaXNKZXN0VGVzdCgpXG4gICAgICA/IC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcbiAgICAgICAgLy8gQHRzLWlnbm9yZTogXCJqZXN0RmlsZVNpemVMaW1pdE92ZXJyaWRlXCIgbm90IGV4cG9zZWQgaW4gcHJvcHNcbiAgICAgICAgcHJvcHMuamVzdEZpbGVTaXplTGltaXRPdmVycmlkZSB8fCAyMDBcbiAgICAgIDogMjAwO1xuXG4gICAgdGhpcy5wcm9wcyA9IHByb3BzO1xuICAgIHRoaXMuYXdzQ2xpTGF5ZXIgPSBuZXcgQXdzQ2xpTGF5ZXIodGhpcywgXCJBd3NDbGlMYXllclwiKTtcbiAgICB0aGlzLnJlZ2lzdGVyU2l0ZUVudmlyb25tZW50KCk7XG5cbiAgICAvLyBCdWlsZCBhcHBcbiAgICBpZiAodGhpcy5pc1BsYWNlaG9sZGVyKSB7XG4gICAgICB0aGlzLmJ1aWxkT3V0RGlyID0gbnVsbDtcbiAgICAgIHRoaXMuYXNzZXRzID0gdGhpcy56aXBBcHBTdHViQXNzZXRzKCk7XG4gICAgICB0aGlzLmRlcGxveUlkID0gYGRlcGxveS1saXZlYDtcbiAgICAgIHRoaXMucm91dGVzTWFuaWZlc3QgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJ1aWxkT3V0RGlyID0gcm9vdC5pc0plc3RUZXN0KClcbiAgICAgICAgPyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZTogXCJqZXN0QnVpbGRPdXRwdXRQYXRoXCIgbm90IGV4cG9zZWQgaW4gcHJvcHNcbiAgICAgICAgICBwcm9wcy5qZXN0QnVpbGRPdXRwdXRQYXRoIHx8IHRoaXMuYnVpbGRBcHAoKVxuICAgICAgICA6IHRoaXMuYnVpbGRBcHAoKTtcbiAgICAgIGNvbnN0IGJ1aWxkSWRGaWxlID0gcGF0aC5yZXNvbHZlKHRoaXMuYnVpbGRPdXREaXIhLCBcImFzc2V0c1wiLCBcIkJVSUxEX0lEXCIpO1xuICAgICAgY29uc3QgYnVpbGRJZCA9IGZzLnJlYWRGaWxlU3luYyhidWlsZElkRmlsZSkudG9TdHJpbmcoKTtcbiAgICAgIHRoaXMuYXNzZXRzID0gdGhpcy56aXBBcHBBc3NldHMoZmlsZVNpemVMaW1pdCwgYnVpbGREaXIpO1xuICAgICAgdGhpcy5kZXBsb3lJZCA9IGBkZXBsb3ktJHtidWlsZElkfWA7XG4gICAgICB0aGlzLnJvdXRlc01hbmlmZXN0ID0gdGhpcy5yZWFkUm91dGVzTWFuaWZlc3QoKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgQnVja2V0XG4gICAgdGhpcy5zM0J1Y2tldCA9IHRoaXMuY3JlYXRlUzNCdWNrZXQoKTtcblxuICAgIC8vIEhhbmRsZSBJbmNyZW1lbnRhbCBTdGF0aWMgUmVnZW5lcmF0aW9uXG4gICAgdGhpcy5zcXNSZWdlbmVyYXRpb25RdWV1ZSA9IHRoaXMuY3JlYXRlUmVnZW5lcmF0aW9uUXVldWUoKTtcbiAgICB0aGlzLnJlZ2VuZXJhdGlvbkZ1bmN0aW9uID0gdGhpcy5jcmVhdGVSZWdlbmVyYXRpb25GdW5jdGlvbigpO1xuXG4gICAgLy8gQ3JlYXRlIExhbWJkYUBFZGdlIGZ1bmN0aW9ucyAoYWx3YXlzIGNyZWF0ZWQgaW4gdXMtZWFzdC0xKVxuICAgIHRoaXMuZWRnZUxhbWJkYVJvbGUgPSB0aGlzLmNyZWF0ZUVkZ2VGdW5jdGlvblJvbGUoKTtcbiAgICB0aGlzLm1haW5GdW5jdGlvblZlcnNpb24gPSB0aGlzLmNyZWF0ZUVkZ2VGdW5jdGlvbihcbiAgICAgIFwiTWFpblwiLFxuICAgICAgXCJkZWZhdWx0LWxhbWJkYVwiXG4gICAgKTtcbiAgICB0aGlzLmFwaUZ1bmN0aW9uVmVyc2lvbiA9IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uKFwiQXBpXCIsIFwiYXBpLWxhbWJkYVwiKTtcbiAgICB0aGlzLmltYWdlRnVuY3Rpb25WZXJzaW9uID0gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb24oXG4gICAgICBcIkltYWdlXCIsXG4gICAgICBcImltYWdlLWxhbWJkYVwiXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSBDdXN0b20gRG9tYWluXG4gICAgdGhpcy52YWxpZGF0ZUN1c3RvbURvbWFpblNldHRpbmdzKCk7XG4gICAgdGhpcy5ob3N0ZWRab25lID0gdGhpcy5sb29rdXBIb3N0ZWRab25lKCk7XG4gICAgdGhpcy5hY21DZXJ0aWZpY2F0ZSA9IHRoaXMuY3JlYXRlQ2VydGlmaWNhdGUoKTtcblxuICAgIC8vIENyZWF0ZSBTMyBEZXBsb3ltZW50XG4gICAgY29uc3QgczNkZXBsb3lDUiA9IHRoaXMuY3JlYXRlUzNEZXBsb3ltZW50KCk7XG5cbiAgICAvLyBDcmVhdGUgQ2xvdWRGcm9udFxuICAgIHRoaXMuY2ZEaXN0cmlidXRpb24gPSB0aGlzLmNyZWF0ZUNsb3VkRnJvbnREaXN0cmlidXRpb24oKTtcbiAgICB0aGlzLmNmRGlzdHJpYnV0aW9uLm5vZGUuYWRkRGVwZW5kZW5jeShzM2RlcGxveUNSKTtcblxuICAgIC8vIEludmFsaWRhdGUgQ2xvdWRGcm9udFxuICAgIGNvbnN0IGludmFsaWRhdGlvbkNSID0gdGhpcy5jcmVhdGVDbG91ZEZyb250SW52YWxpZGF0aW9uKCk7XG4gICAgaW52YWxpZGF0aW9uQ1Iubm9kZS5hZGREZXBlbmRlbmN5KHRoaXMuY2ZEaXN0cmlidXRpb24pO1xuXG4gICAgLy8gQ29ubmVjdCBDdXN0b20gRG9tYWluIHRvIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gICAgdGhpcy5jcmVhdGVSb3V0ZTUzUmVjb3JkcygpO1xuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYGh0dHBzOi8vJHt0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbkRvbWFpbk5hbWV9YDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIGBodHRwczovLyR7Y3VzdG9tRG9tYWlufWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbi5kb21haW5OYW1lfWA7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBidWNrZXRBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXRBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IGJ1Y2tldE5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXROYW1lO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25JZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbklkO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25Eb21haW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25Eb21haW5OYW1lO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKHRoaXMuZWRnZUxhbWJkYVJvbGUsIHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJOZXh0U2l0ZVwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBkaXN0cmlidXRpb25JZDogdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25JZCxcbiAgICAgICAgY3VzdG9tRG9tYWluVXJsOiB0aGlzLmN1c3RvbURvbWFpblVybCxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgemlwQXBwQXNzZXRzKFxuICAgIGZpbGVTaXplTGltaXQ6IG51bWJlcixcbiAgICBidWlsZERpcjogc3RyaW5nXG4gICk6IHMzQXNzZXRzLkFzc2V0W10ge1xuICAgIC8vIHZhbGlkYXRlIGJ1aWxkT3V0cHV0IGV4aXN0c1xuICAgIGNvbnN0IHNpdGVPdXRwdXRQYXRoID0gcGF0aC5yZXNvbHZlKHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyISwgXCJhc3NldHNcIikpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhzaXRlT3V0cHV0UGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIGJ1aWxkIG91dHB1dCBmb3VuZCBhdCBcIiR7c2l0ZU91dHB1dFBhdGh9XCIgZm9yIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIE5leHRqc1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgemlwIGZpbGVzXG4gICAgY29uc3Qgc2NyaXB0ID0gcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvYXJjaGl2ZXIuanNcIik7XG4gICAgY29uc3QgemlwUGF0aCA9IHBhdGgucmVzb2x2ZShcbiAgICAgIHBhdGguam9pbihidWlsZERpciwgYE5leHRqc1NpdGUtJHt0aGlzLm5vZGUuaWR9LSR7dGhpcy5ub2RlLmFkZHJ9YClcbiAgICApO1xuICAgIC8vIGNsZWFyIHppcCBwYXRoIHRvIGVuc3VyZSBubyBwYXJ0WC56aXAgcmVtYWluIGZyb20gcHJldmlvdXMgYnVpbGRcbiAgICBmcy5yZW1vdmVTeW5jKHppcFBhdGgpO1xuICAgIGNvbnN0IGNtZCA9IFtcIm5vZGVcIiwgc2NyaXB0LCBzaXRlT3V0cHV0UGF0aCwgemlwUGF0aCwgZmlsZVNpemVMaW1pdF0uam9pbihcbiAgICAgIFwiIFwiXG4gICAgKTtcblxuICAgIHRyeSB7XG4gICAgICBleGVjU3luYyhjbWQsIHtcbiAgICAgICAgc3RkaW86IFwiaW5oZXJpdFwiLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlcmUgd2FzIGEgcHJvYmxlbSBnZW5lcmF0aW5nIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIE5leHRqc1NpdGUgcGFja2FnZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBhc3NldHNcbiAgICBjb25zdCBhc3NldHMgPSBbXTtcbiAgICBmb3IgKGxldCBwYXJ0SWQgPSAwOyA7IHBhcnRJZCsrKSB7XG4gICAgICBjb25zdCB6aXBGaWxlUGF0aCA9IHBhdGguam9pbih6aXBQYXRoLCBgcGFydCR7cGFydElkfS56aXBgKTtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyh6aXBGaWxlUGF0aCkpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGFzc2V0cy5wdXNoKFxuICAgICAgICBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYEFzc2V0JHtwYXJ0SWR9YCwge1xuICAgICAgICAgIHBhdGg6IHppcEZpbGVQYXRoLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGFzc2V0cztcbiAgfVxuXG4gIHByaXZhdGUgemlwQXBwU3R1YkFzc2V0cygpOiBzM0Fzc2V0cy5Bc3NldFtdIHtcbiAgICByZXR1cm4gW1xuICAgICAgbmV3IHMzQXNzZXRzLkFzc2V0KHRoaXMsIFwiQXNzZXRcIiwge1xuICAgICAgICBwYXRoOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9OZXh0anNTaXRlL3NpdGUtc3R1YlwiKSxcbiAgICAgIH0pLFxuICAgIF07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVkZ2VGdW5jdGlvbihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgaGFuZGxlclBhdGg6IHN0cmluZ1xuICApOiBsYW1iZGEuSVZlcnNpb24ge1xuICAgIC8vIFVzZSByZWFsIGNvZGUgaWY6XG4gICAgLy8gLSBOZXh0LmpzIGFwcCB3YXMgYnVpbGQ7IEFORFxuICAgIC8vIC0gdGhlIExhbWJkYSBjb2RlIGRpcmVjdG9yeSBpcyBub3QgZW1wdHlcbiAgICBjb25zdCBoYXNSZWFsQ29kZSA9XG4gICAgICB0eXBlb2YgdGhpcy5idWlsZE91dERpciA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgZnMucGF0aEV4aXN0c1N5bmMocGF0aC5qb2luKHRoaXMuYnVpbGRPdXREaXIsIGhhbmRsZXJQYXRoLCBcImluZGV4LmpzXCIpKTtcblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvbiBhc3NldFxuICAgIGNvbnN0IGFzc2V0UGF0aCA9XG4gICAgICBoYXNSZWFsQ29kZSAmJiB0aGlzLmJ1aWxkT3V0RGlyXG4gICAgICAgID8gcGF0aC5qb2luKHRoaXMuYnVpbGRPdXREaXIsIGhhbmRsZXJQYXRoKVxuICAgICAgICA6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL05leHRqc1NpdGUvZWRnZS1sYW1iZGEtc3R1YlwiKTtcbiAgICBjb25zdCBhc3NldCA9IG5ldyBzM0Fzc2V0cy5Bc3NldCh0aGlzLCBgJHtuYW1lfUZ1bmN0aW9uQXNzZXRgLCB7XG4gICAgICBwYXRoOiBhc3NldFBhdGgsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgZnVuY3Rpb24gYmFzZWQgb24gcmVnaW9uXG4gICAgY29uc3Qgcm9vdCA9IHRoaXMubm9kZS5yb290IGFzIEFwcDtcbiAgICByZXR1cm4gcm9vdC5yZWdpb24gPT09IFwidXMtZWFzdC0xXCJcbiAgICAgID8gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb25JblVFMShuYW1lLCBhc3NldFBhdGgsIGFzc2V0LCBoYXNSZWFsQ29kZSlcbiAgICAgIDogdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb25Jbk5vblVFMShuYW1lLCBhc3NldFBhdGgsIGFzc2V0LCBoYXNSZWFsQ29kZSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVkZ2VGdW5jdGlvbkluVUUxKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBhc3NldFBhdGg6IHN0cmluZyxcbiAgICBhc3NldDogczNBc3NldHMuQXNzZXQsXG4gICAgaGFzUmVhbENvZGU6IGJvb2xlYW5cbiAgKTogbGFtYmRhLklWZXJzaW9uIHtcbiAgICBjb25zdCB7IGRlZmF1bHRGdW5jdGlvblByb3BzOiBmblByb3BzIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uXG4gICAgY29uc3QgZm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIGAke25hbWV9RnVuY3Rpb25gLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYCR7bmFtZX0gaGFuZGxlciBmb3IgTmV4dC5qc2AsXG4gICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgIGN1cnJlbnRWZXJzaW9uT3B0aW9uczoge1xuICAgICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgfSxcbiAgICAgIGxvZ1JldGVudGlvbjogbG9ncy5SZXRlbnRpb25EYXlzLlRIUkVFX0RBWVMsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoYXNzZXRQYXRoKSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgbWVtb3J5U2l6ZTogZm5Qcm9wcz8ubWVtb3J5U2l6ZSB8fCA1MTIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyhmblByb3BzPy50aW1lb3V0IHx8IDEwKSxcbiAgICAgIHJvbGU6IHRoaXMuZWRnZUxhbWJkYVJvbGUsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgYWxpYXNcbiAgICBmbi5jdXJyZW50VmVyc2lvbi5hZGRBbGlhcyhcImxpdmVcIik7XG5cbiAgICAvLyBEZXBsb3kgYWZ0ZXIgdGhlIGNvZGUgaXMgdXBkYXRlZFxuICAgIGlmIChoYXNSZWFsQ29kZSkge1xuICAgICAgY29uc3QgdXBkYXRlckNSID0gdGhpcy5jcmVhdGVMYW1iZGFDb2RlUmVwbGFjZXIobmFtZSwgYXNzZXQpO1xuICAgICAgZm4ubm9kZS5hZGREZXBlbmRlbmN5KHVwZGF0ZXJDUik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZuLmN1cnJlbnRWZXJzaW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb25Jbk5vblVFMShcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXNzZXRQYXRoOiBzdHJpbmcsXG4gICAgYXNzZXQ6IHMzQXNzZXRzLkFzc2V0LFxuICAgIGhhc1JlYWxDb2RlOiBib29sZWFuXG4gICk6IGxhbWJkYS5JVmVyc2lvbiB7XG4gICAgY29uc3QgeyBkZWZhdWx0RnVuY3Rpb25Qcm9wczogZm5Qcm9wcyB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIElmIGFwcCByZWdpb24gaXMgTk9UIHVzLWVhc3QtMSwgY3JlYXRlIGEgRnVuY3Rpb24gaW4gdXMtZWFzdC0xXG4gICAgLy8gdXNpbmcgYSBDdXN0b20gUmVzb3VyY2VcblxuICAgIC8vIENyZWF0ZSBhIFMzIGJ1Y2tldCBpbiB1cy1lYXN0LTEgdG8gc3RvcmUgTGFtYmRhIGNvZGUuIENyZWF0ZVxuICAgIC8vIDEgYnVja2V0IGZvciBhbGwgRWRnZSBmdW5jdGlvbnMuXG4gICAgY29uc3QgYnVja2V0Q1IgPSBjcm9zc1JlZ2lvbkhlbHBlci5nZXRPckNyZWF0ZUJ1Y2tldCh0aGlzKTtcbiAgICBjb25zdCBidWNrZXROYW1lID0gYnVja2V0Q1IuZ2V0QXR0U3RyaW5nKFwiQnVja2V0TmFtZVwiKTtcblxuICAgIC8vIENyZWF0ZSBhIExhbWJkYSBmdW5jdGlvbiBpbiB1cy1lYXN0LTFcbiAgICBjb25zdCBmdW5jdGlvbkNSID0gY3Jvc3NSZWdpb25IZWxwZXIuY3JlYXRlRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgbmFtZSxcbiAgICAgIHRoaXMuZWRnZUxhbWJkYVJvbGUsXG4gICAgICBidWNrZXROYW1lLFxuICAgICAge1xuICAgICAgICBEZXNjcmlwdGlvbjogYGhhbmRsZXIgZm9yIE5leHQuanNgLFxuICAgICAgICBIYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgICAgQ29kZToge1xuICAgICAgICAgIFMzQnVja2V0OiBhc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICAgICAgUzNLZXk6IGFzc2V0LnMzT2JqZWN0S2V5LFxuICAgICAgICB9LFxuICAgICAgICBSdW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWC5uYW1lLFxuICAgICAgICBNZW1vcnlTaXplOiBmblByb3BzPy5tZW1vcnlTaXplIHx8IDUxMixcbiAgICAgICAgVGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoZm5Qcm9wcz8udGltZW91dCB8fCAxMCkudG9TZWNvbmRzKCksXG4gICAgICAgIFJvbGU6IHRoaXMuZWRnZUxhbWJkYVJvbGUucm9sZUFybixcbiAgICAgIH1cbiAgICApO1xuICAgIGNvbnN0IGZ1bmN0aW9uQXJuID0gZnVuY3Rpb25DUi5nZXRBdHRTdHJpbmcoXCJGdW5jdGlvbkFyblwiKTtcblxuICAgIC8vIENyZWF0ZSBhIExhbWJkYSBmdW5jdGlvbiB2ZXJzaW9uIGluIHVzLWVhc3QtMVxuICAgIGNvbnN0IHZlcnNpb25DUiA9IGNyb3NzUmVnaW9uSGVscGVyLmNyZWF0ZVZlcnNpb24odGhpcywgbmFtZSwgZnVuY3Rpb25Bcm4pO1xuICAgIGNvbnN0IHZlcnNpb25JZCA9IHZlcnNpb25DUi5nZXRBdHRTdHJpbmcoXCJWZXJzaW9uXCIpO1xuICAgIGNyb3NzUmVnaW9uSGVscGVyLnVwZGF0ZVZlcnNpb25Mb2dpY2FsSWQoZnVuY3Rpb25DUiwgdmVyc2lvbkNSKTtcblxuICAgIC8vIERlcGxveSBhZnRlciB0aGUgY29kZSBpcyB1cGRhdGVkXG4gICAgaWYgKGhhc1JlYWxDb2RlKSB7XG4gICAgICBjb25zdCB1cGRhdGVyQ1IgPSB0aGlzLmNyZWF0ZUxhbWJkYUNvZGVSZXBsYWNlcihuYW1lLCBhc3NldCk7XG4gICAgICBmdW5jdGlvbkNSLm5vZGUuYWRkRGVwZW5kZW5jeSh1cGRhdGVyQ1IpO1xuICAgIH1cblxuICAgIHJldHVybiBsYW1iZGEuVmVyc2lvbi5mcm9tVmVyc2lvbkFybihcbiAgICAgIHRoaXMsXG4gICAgICBgJHtuYW1lfUZ1bmN0aW9uVmVyc2lvbmAsXG4gICAgICBgJHtmdW5jdGlvbkFybn06JHt2ZXJzaW9uSWR9YFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVkZ2VGdW5jdGlvblJvbGUoKTogaWFtLlJvbGUge1xuICAgIGNvbnN0IHsgZGVmYXVsdEZ1bmN0aW9uUHJvcHM6IGZuUHJvcHMgfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBDcmVhdGUgZnVuY3Rpb24gcm9sZVxuICAgIGNvbnN0IHJvbGUgPSBuZXcgaWFtLlJvbGUodGhpcywgYEVkZ2VMYW1iZGFSb2xlYCwge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLkNvbXBvc2l0ZVByaW5jaXBhbChcbiAgICAgICAgbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwibGFtYmRhLmFtYXpvbmF3cy5jb21cIiksXG4gICAgICAgIG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcImVkZ2VsYW1iZGEuYW1hem9uYXdzLmNvbVwiKVxuICAgICAgKSxcbiAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tTWFuYWdlZFBvbGljeUFybihcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIFwiRWRnZUxhbWJkYVBvbGljeVwiLFxuICAgICAgICAgIFwiYXJuOmF3czppYW06OmF3czpwb2xpY3kvc2VydmljZS1yb2xlL0FXU0xhbWJkYUJhc2ljRXhlY3V0aW9uUm9sZVwiXG4gICAgICAgICksXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgLy8gQXR0YWNoIHBlcm1pc3Npb25cbiAgICB0aGlzLnMzQnVja2V0LmdyYW50UmVhZFdyaXRlKHJvbGUpO1xuICAgIHRoaXMuc3FzUmVnZW5lcmF0aW9uUXVldWUuZ3JhbnRTZW5kTWVzc2FnZXMocm9sZSk7XG4gICAgdGhpcy5yZWdlbmVyYXRpb25GdW5jdGlvbi5ncmFudEludm9rZShyb2xlKTtcbiAgICBpZiAoZm5Qcm9wcz8ucGVybWlzc2lvbnMpIHtcbiAgICAgIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKHJvbGUsIGZuUHJvcHMucGVybWlzc2lvbnMpO1xuICAgIH1cblxuICAgIHJldHVybiByb2xlO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVSZWdlbmVyYXRpb25RdWV1ZSgpOiBzcXMuUXVldWUge1xuICAgIGNvbnN0IHsgc3FzUmVnZW5lcmF0aW9uUXVldWUgfSA9IHRoaXMucHJvcHM7XG5cbiAgICByZXR1cm4gbmV3IHNxcy5RdWV1ZSh0aGlzLCBcIlJlZ2VuZXJhdGlvblF1ZXVlXCIsIHtcbiAgICAgIC4uLihzcXNSZWdlbmVyYXRpb25RdWV1ZSB8fCB7fSksXG4gICAgICAvLyBXZSBjYWxsIHRoZSBxdWV1ZSB0aGUgc2FtZSBuYW1lIGFzIHRoZSBidWNrZXQgc28gdGhhdCB3ZSBjYW4gZWFzaWx5XG4gICAgICAvLyByZWZlcmVuY2UgaXQgZnJvbSB3aXRoaW4gdGhlIGxhbWJkYUBlZGdlLCBnaXZlbiB3ZSBjYW4ndCB1c2UgZW52IHZhcnNcbiAgICAgIC8vIGluIGEgbGFtYmRhQGVkZ2VcbiAgICAgIHF1ZXVlTmFtZTogYCR7dGhpcy5zM0J1Y2tldC5idWNrZXROYW1lfS5maWZvYCxcbiAgICAgIGZpZm86IHRydWUsXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVSZWdlbmVyYXRpb25GdW5jdGlvbigpOiBsYW1iZGEuRnVuY3Rpb24ge1xuICAgIC8vIFVzZSByZWFsIGNvZGUgaWY6XG4gICAgLy8gLSBOZXh0LmpzIGFwcCB3YXMgYnVpbGQ7IEFORFxuICAgIC8vIC0gdGhlIExhbWJkYSBjb2RlIGRpcmVjdG9yeSBpcyBub3QgZW1wdHlcbiAgICBsZXQgY29kZTtcbiAgICBsZXQgdXBkYXRlckNSO1xuICAgIGlmIChcbiAgICAgIHRoaXMuYnVpbGRPdXREaXIgJiZcbiAgICAgIGZzLnBhdGhFeGlzdHNTeW5jKFxuICAgICAgICBwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciwgXCJyZWdlbmVyYXRpb24tbGFtYmRhXCIsIFwiaW5kZXguanNcIilcbiAgICAgIClcbiAgICApIHtcbiAgICAgIGNvbnN0IGFzc2V0ID0gbmV3IHMzQXNzZXRzLkFzc2V0KHRoaXMsIGBSZWdlbmVyYXRpb25GdW5jdGlvbkFzc2V0YCwge1xuICAgICAgICBwYXRoOiBwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciwgXCJyZWdlbmVyYXRpb24tbGFtYmRhXCIpLFxuICAgICAgfSk7XG4gICAgICBjb2RlID0gbGFtYmRhLkNvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciwgXCJyZWdlbmVyYXRpb24tbGFtYmRhXCIpXG4gICAgICApO1xuICAgICAgdXBkYXRlckNSID0gdGhpcy5jcmVhdGVMYW1iZGFDb2RlUmVwbGFjZXIoXCJSZWdlbmVyYXRpb25cIiwgYXNzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb2RlID0gbGFtYmRhLkNvZGUuZnJvbUlubGluZShcIiAgXCIpO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IHsgZGVmYXVsdEZ1bmN0aW9uUHJvcHM6IGZuUHJvcHMgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgZm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUmVnZW5lcmF0aW9uRnVuY3Rpb25cIiwge1xuICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgIG1lbW9yeVNpemU6IGZuUHJvcHM/Lm1lbW9yeVNpemUgfHwgMTAyNCxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKGZuUHJvcHM/LnRpbWVvdXQgfHwgMzApLFxuICAgICAgY29kZSxcbiAgICB9KTtcblxuICAgIGZuLmFkZEV2ZW50U291cmNlKFxuICAgICAgbmV3IGxhbWJkYUV2ZW50U291cmNlcy5TcXNFdmVudFNvdXJjZSh0aGlzLnNxc1JlZ2VuZXJhdGlvblF1ZXVlKVxuICAgICk7XG5cbiAgICAvLyBHcmFudCBwZXJtaXNzaW9uc1xuICAgIHRoaXMuczNCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoZm4pO1xuXG4gICAgLy8gRGVwbG95IGFmdGVyIHRoZSBjb2RlIGlzIHVwZGF0ZWRcbiAgICBpZiAodXBkYXRlckNSKSB7XG4gICAgICBmbi5ub2RlLmFkZERlcGVuZGVuY3kodXBkYXRlckNSKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZm47XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxhbWJkYUNvZGVSZXBsYWNlcihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXNzZXQ6IHMzQXNzZXRzLkFzc2V0XG4gICk6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gICAgLy8gTm90ZTogU291cmNlIGNvZGUgZm9yIHRoZSBMYW1iZGEgZnVuY3Rpb25zIGhhdmUgXCJ7eyBFTlZfS0VZIH19XCIgaW4gdGhlbS5cbiAgICAvLyAgICAgICBUaGV5IG5lZWQgdG8gYmUgcmVwbGFjZWQgd2l0aCByZWFsIHZhbHVlcyBiZWZvcmUgdGhlIExhbWJkYVxuICAgIC8vICAgICAgIGZ1bmN0aW9ucyBnZXQgZGVwbG95ZWQuXG5cbiAgICBjb25zdCBwcm92aWRlcklkID0gXCJMYW1iZGFDb2RlUmVwbGFjZXJQcm92aWRlclwiO1xuICAgIGNvbnN0IHJlc0lkID0gYCR7bmFtZX1MYW1iZGFDb2RlUmVwbGFjZXJgO1xuICAgIGNvbnN0IHN0YWNrID0gY2RrLlN0YWNrLm9mKHRoaXMpO1xuICAgIGxldCBwcm92aWRlciA9IHN0YWNrLm5vZGUudHJ5RmluZENoaWxkKHByb3ZpZGVySWQpIGFzIGxhbWJkYS5GdW5jdGlvbjtcblxuICAgIC8vIENyZWF0ZSBwcm92aWRlciBpZiBub3QgYWxyZWFkeSBjcmVhdGVkXG4gICAgaWYgKCFwcm92aWRlcikge1xuICAgICAgcHJvdmlkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCBwcm92aWRlcklkLCB7XG4gICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9OZXh0anNTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgICApLFxuICAgICAgICBsYXllcnM6IFt0aGlzLmF3c0NsaUxheWVyXSxcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgICAgaGFuZGxlcjogXCJsYW1iZGEtY29kZS11cGRhdGVyLmhhbmRsZXJcIixcbiAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQWxsb3cgcHJvdmlkZXIgdG8gcGVyZm9ybSBzZWFyY2gvcmVwbGFjZSBvbiB0aGUgYXNzZXRcbiAgICBwcm92aWRlci5yb2xlPy5hZGRUb1ByaW5jaXBhbFBvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXCJzMzoqXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtgYXJuOmF3czpzMzo6OiR7YXNzZXQuczNCdWNrZXROYW1lfS8ke2Fzc2V0LnMzT2JqZWN0S2V5fWBdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICAgIGNvbnN0IHJlc291cmNlID0gbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCByZXNJZCwge1xuICAgICAgc2VydmljZVRva2VuOiBwcm92aWRlci5mdW5jdGlvbkFybixcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVExhbWJkYUNvZGVVcGRhdGVyXCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFNvdXJjZToge1xuICAgICAgICAgIEJ1Y2tldE5hbWU6IGFzc2V0LnMzQnVja2V0TmFtZSxcbiAgICAgICAgICBPYmplY3RLZXk6IGFzc2V0LnMzT2JqZWN0S2V5LFxuICAgICAgICB9LFxuICAgICAgICBSZXBsYWNlVmFsdWVzOiB0aGlzLmdldExhbWJkYUNvbnRlbnRSZXBsYWNlVmFsdWVzKCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc291cmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEFwcCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgcGF0aDogc2l0ZVBhdGggfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyB2YWxpZGF0ZSBzaXRlIHBhdGggZXhpc3RzXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHNpdGVQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gcGF0aCBmb3VuZCBhdCBcIiR7cGF0aC5yZXNvbHZlKHNpdGVQYXRoKX1cIiBmb3IgdGhlIFwiJHtcbiAgICAgICAgICB0aGlzLm5vZGUuaWRcbiAgICAgICAgfVwiIE5leHRqc1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBCdWlsZCBjb21tYW5kXG4gICAgLy8gTm90ZTogcHJvYmFibHkgY291bGQgcGFzcyBKU09OIHN0cmluZyBhbHNvLCBidXQgdGhpcyBmZWx0IHNhZmVyLlxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgcGF0aEhhc2ggPSBnZXRIYW5kbGVySGFzaChzaXRlUGF0aCk7XG4gICAgY29uc3QgYnVpbGRPdXRwdXQgPSBwYXRoLmpvaW4ocm9vdC5idWlsZERpciwgcGF0aEhhc2gpO1xuICAgIGNvbnN0IGNvbmZpZ0J1ZmZlciA9IEJ1ZmZlci5mcm9tKFxuICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBjd2Q6IHBhdGgucmVzb2x2ZShzaXRlUGF0aCksXG4gICAgICAgIGFyZ3M6IFtcImJ1aWxkXCJdLFxuICAgICAgfSlcbiAgICApO1xuICAgIGNvbnN0IGNtZCA9IFtcbiAgICAgIFwibm9kZVwiLFxuICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvTmV4dGpzU2l0ZS9idWlsZC5qc1wiKSxcbiAgICAgIFwiLS1wYXRoXCIsXG4gICAgICBwYXRoLnJlc29sdmUoc2l0ZVBhdGgpLFxuICAgICAgXCItLW91dHB1dFwiLFxuICAgICAgcGF0aC5yZXNvbHZlKGJ1aWxkT3V0cHV0KSxcbiAgICAgIFwiLS1jb25maWdcIixcbiAgICAgIGNvbmZpZ0J1ZmZlci50b1N0cmluZyhcImJhc2U2NFwiKSxcbiAgICBdLmpvaW4oXCIgXCIpO1xuXG4gICAgLy8gUnVuIGJ1aWxkXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZXkoYEJ1aWxkaW5nIE5leHQuanMgc2l0ZSAke3NpdGVQYXRofWApKTtcbiAgICAgIGV4ZWNTeW5jKGNtZCwge1xuICAgICAgICBjd2Q6IHNpdGVQYXRoLFxuICAgICAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgICAgIGVudjoge1xuICAgICAgICAgIC4uLnByb2Nlc3MuZW52LFxuICAgICAgICAgIC4uLmdldEJ1aWxkQ21kRW52aXJvbm1lbnQodGhpcy5wcm9wcy5lbnZpcm9ubWVudCksXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGVyZSB3YXMgYSBwcm9ibGVtIGJ1aWxkaW5nIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIE5leHRqc1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYnVpbGRPdXRwdXQ7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVMzQnVja2V0KCk6IHMzLkJ1Y2tldCB7XG4gICAgY29uc3QgeyBzM0J1Y2tldCB9ID0gdGhpcy5wcm9wcztcblxuICAgIHJldHVybiBuZXcgczMuQnVja2V0KHRoaXMsIFwiQnVja2V0XCIsIHtcbiAgICAgIHB1YmxpY1JlYWRBY2Nlc3M6IHRydWUsXG4gICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICAuLi4oczNCdWNrZXQgfHwge30pLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVTM0RlcGxveW1lbnQoKTogY2RrLkN1c3RvbVJlc291cmNlIHtcbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGRvaW5nIHRoZSB1cGxvYWRpbmdcbiAgICBjb25zdCB1cGxvYWRlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJTM1VwbG9hZGVyXCIsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvY3VzdG9tLXJlc291cmNlXCIpXG4gICAgICApLFxuICAgICAgbGF5ZXJzOiBbdGhpcy5hd3NDbGlMYXllcl0sXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM183LFxuICAgICAgaGFuZGxlcjogXCJzMy11cGxvYWQuaGFuZGxlclwiLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICB9KTtcbiAgICB0aGlzLnMzQnVja2V0LmdyYW50UmVhZFdyaXRlKHVwbG9hZGVyKTtcbiAgICB0aGlzLmFzc2V0cy5mb3JFYWNoKChhc3NldCkgPT4gYXNzZXQuZ3JhbnRSZWFkKHVwbG9hZGVyKSk7XG5cbiAgICAvLyBDcmVhdGUgdGhlIGN1c3RvbSByZXNvdXJjZSBmdW5jdGlvblxuICAgIGNvbnN0IGhhbmRsZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUzNIYW5kbGVyXCIsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvY3VzdG9tLXJlc291cmNlXCIpXG4gICAgICApLFxuICAgICAgbGF5ZXJzOiBbdGhpcy5hd3NDbGlMYXllcl0sXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM183LFxuICAgICAgaGFuZGxlcjogXCJzMy1oYW5kbGVyLmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBVUExPQURFUl9GVU5DVElPTl9OQU1FOiB1cGxvYWRlci5mdW5jdGlvbk5hbWUsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIHRoaXMuczNCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoaGFuZGxlcik7XG4gICAgdXBsb2FkZXIuZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlXG4gICAgY29uc3QgZmlsZU9wdGlvbnMgPSBbXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcInB1YmxpYy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0zMTUzNjAwMCxtdXN0LXJldmFsaWRhdGVcIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcInN0YXRpYy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0zMTUzNjAwMCxtdXN0LXJldmFsaWRhdGVcIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcInN0YXRpYy1wYWdlcy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0wLHMtbWF4YWdlPTI2Nzg0MDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJfbmV4dC9kYXRhLypcIixcbiAgICAgICAgY2FjaGVDb250cm9sOiBcInB1YmxpYyxtYXgtYWdlPTAscy1tYXhhZ2U9MjY3ODQwMCxtdXN0LXJldmFsaWRhdGVcIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcIl9uZXh0L3N0YXRpYy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0zMTUzNjAwMCxpbW11dGFibGVcIixcbiAgICAgIH0sXG4gICAgXTtcbiAgICByZXR1cm4gbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCBcIlMzRGVwbG95bWVudFwiLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGhhbmRsZXIuZnVuY3Rpb25Bcm4sXG4gICAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RCdWNrZXREZXBsb3ltZW50XCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFNvdXJjZXM6IHRoaXMuYXNzZXRzLm1hcCgoYXNzZXQpID0+ICh7XG4gICAgICAgICAgQnVja2V0TmFtZTogYXNzZXQuczNCdWNrZXROYW1lLFxuICAgICAgICAgIE9iamVjdEtleTogYXNzZXQuczNPYmplY3RLZXksXG4gICAgICAgIH0pKSxcbiAgICAgICAgRGVzdGluYXRpb25CdWNrZXROYW1lOiB0aGlzLnMzQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIERlc3RpbmF0aW9uQnVja2V0S2V5UHJlZml4OiB0aGlzLmRlcGxveUlkLFxuICAgICAgICBGaWxlT3B0aW9uczogKGZpbGVPcHRpb25zIHx8IFtdKS5tYXAoXG4gICAgICAgICAgKHsgZXhjbHVkZSwgaW5jbHVkZSwgY2FjaGVDb250cm9sIH0pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgIFwiLS1leGNsdWRlXCIsXG4gICAgICAgICAgICAgIGV4Y2x1ZGUsXG4gICAgICAgICAgICAgIFwiLS1pbmNsdWRlXCIsXG4gICAgICAgICAgICAgIGluY2x1ZGUsXG4gICAgICAgICAgICAgIFwiLS1jYWNoZS1jb250cm9sXCIsXG4gICAgICAgICAgICAgIGNhY2hlQ29udHJvbCxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgfVxuICAgICAgICApLFxuICAgICAgICBSZXBsYWNlVmFsdWVzOiB0aGlzLmdldFMzQ29udGVudFJlcGxhY2VWYWx1ZXMoKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gQ2xvdWRGcm9udCBEaXN0cmlidXRpb25cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250RGlzdHJpYnV0aW9uKCk6IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uIHtcbiAgICBjb25zdCB7IGNmQ2FjaGVQb2xpY2llcywgY2ZEaXN0cmlidXRpb24sIGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBjZkRpc3RyaWJ1dGlvblByb3BzID0gY2ZEaXN0cmlidXRpb24gfHwge307XG5cbiAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgIGlmIChjZkRpc3RyaWJ1dGlvblByb3BzLmNlcnRpZmljYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcImNmRGlzdHJpYnV0aW9uLmNlcnRpZmljYXRlXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIE5leHRqc1NpdGUgZG9tYWluIGNlcnRpZmljYXRlLmBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChjZkRpc3RyaWJ1dGlvblByb3BzLmRvbWFpbk5hbWVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcImNmRGlzdHJpYnV0aW9uLmRvbWFpbk5hbWVzXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIE5leHRqc1NpdGUgZG9tYWluLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgZG9tYWluTmFtZXNcbiAgICBjb25zdCBkb21haW5OYW1lcyA9IFtdO1xuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICAvLyBubyBkb21haW5cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGRvbWFpbk5hbWVzLnB1c2goY3VzdG9tRG9tYWluKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZG9tYWluTmFtZXMucHVzaChjdXN0b21Eb21haW4uZG9tYWluTmFtZSk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgYmVoYXZpb3JcbiAgICBjb25zdCBvcmlnaW4gPSBuZXcgb3JpZ2lucy5TM09yaWdpbih0aGlzLnMzQnVja2V0LCB7XG4gICAgICBvcmlnaW5QYXRoOiB0aGlzLmRlcGxveUlkLFxuICAgIH0pO1xuICAgIGNvbnN0IHZpZXdlclByb3RvY29sUG9saWN5ID1cbiAgICAgIGNsb3VkZnJvbnQuVmlld2VyUHJvdG9jb2xQb2xpY3kuUkVESVJFQ1RfVE9fSFRUUFM7XG5cbiAgICBpZiAodGhpcy5pc1BsYWNlaG9sZGVyKSB7XG4gICAgICByZXR1cm4gbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHRoaXMsIFwiRGlzdHJpYnV0aW9uXCIsIHtcbiAgICAgICAgZGVmYXVsdFJvb3RPYmplY3Q6IFwiaW5kZXguaHRtbFwiLFxuICAgICAgICBlcnJvclJlc3BvbnNlczogYnVpbGRFcnJvclJlc3BvbnNlc0ZvclJlZGlyZWN0VG9JbmRleChcImluZGV4Lmh0bWxcIiksXG4gICAgICAgIGRvbWFpbk5hbWVzLFxuICAgICAgICBjZXJ0aWZpY2F0ZTogdGhpcy5hY21DZXJ0aWZpY2F0ZSxcbiAgICAgICAgZGVmYXVsdEJlaGF2aW9yOiB7XG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgRWRnZSBmdW5jdGlvbnNcbiAgICBjb25zdCBlZGdlTGFtYmRhczogY2xvdWRmcm9udC5FZGdlTGFtYmRhW10gPSBbXG4gICAgICB7XG4gICAgICAgIGluY2x1ZGVCb2R5OiB0cnVlLFxuICAgICAgICBldmVudFR5cGU6IGNsb3VkZnJvbnQuTGFtYmRhRWRnZUV2ZW50VHlwZS5PUklHSU5fUkVRVUVTVCxcbiAgICAgICAgZnVuY3Rpb25WZXJzaW9uOiB0aGlzLm1haW5GdW5jdGlvblZlcnNpb24sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBldmVudFR5cGU6IGNsb3VkZnJvbnQuTGFtYmRhRWRnZUV2ZW50VHlwZS5PUklHSU5fUkVTUE9OU0UsXG4gICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5tYWluRnVuY3Rpb25WZXJzaW9uLFxuICAgICAgfSxcbiAgICBdO1xuXG4gICAgLy8gQnVpbGQgY2FjaGUgcG9saWN5XG4gICAgY29uc3Qgc3RhdGljQ2FjaGVQb2xpY3kgPVxuICAgICAgY2ZDYWNoZVBvbGljaWVzPy5zdGF0aWNDYWNoZVBvbGljeSA/P1xuICAgICAgdGhpcy5jcmVhdGVDbG91ZEZyb250U3RhdGljQ2FjaGVQb2xpY3koKTtcbiAgICBjb25zdCBpbWFnZUNhY2hlUG9saWN5ID1cbiAgICAgIGNmQ2FjaGVQb2xpY2llcz8uaW1hZ2VDYWNoZVBvbGljeSA/P1xuICAgICAgdGhpcy5jcmVhdGVDbG91ZEZyb250SW1hZ2VDYWNoZVBvbGljeSgpO1xuICAgIGNvbnN0IGxhbWJkYUNhY2hlUG9saWN5ID1cbiAgICAgIGNmQ2FjaGVQb2xpY2llcz8ubGFtYmRhQ2FjaGVQb2xpY3kgPz9cbiAgICAgIHRoaXMuY3JlYXRlQ2xvdWRGcm9udExhbWJkYUNhY2hlUG9saWN5KCk7XG5cbiAgICAvLyBDcmVhdGUgRGlzdHJpYnV0aW9uXG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCBcIkRpc3RyaWJ1dGlvblwiLCB7XG4gICAgICAvLyB0aGVzZSB2YWx1ZXMgY2FuIGJlIG92ZXJ3cml0dGVuIGJ5IGNmRGlzdHJpYnV0aW9uUHJvcHNcbiAgICAgIGRlZmF1bHRSb290T2JqZWN0OiBcIlwiLFxuICAgICAgLy8gT3ZlcnJpZGUgcHJvcHMuXG4gICAgICAuLi5jZkRpc3RyaWJ1dGlvblByb3BzLFxuICAgICAgLy8gdGhlc2UgdmFsdWVzIGNhbiBOT1QgYmUgb3ZlcndyaXR0ZW4gYnkgY2ZEaXN0cmlidXRpb25Qcm9wc1xuICAgICAgZG9tYWluTmFtZXMsXG4gICAgICBjZXJ0aWZpY2F0ZTogdGhpcy5hY21DZXJ0aWZpY2F0ZSxcbiAgICAgIGRlZmF1bHRCZWhhdmlvcjoge1xuICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgb3JpZ2luLFxuICAgICAgICBhbGxvd2VkTWV0aG9kczogY2xvdWRmcm9udC5BbGxvd2VkTWV0aG9kcy5BTExPV19HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICBjYWNoZWRNZXRob2RzOiBjbG91ZGZyb250LkNhY2hlZE1ldGhvZHMuQ0FDSEVfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgIGNhY2hlUG9saWN5OiBsYW1iZGFDYWNoZVBvbGljeSxcbiAgICAgICAgLi4uKGNmRGlzdHJpYnV0aW9uUHJvcHMuZGVmYXVsdEJlaGF2aW9yIHx8IHt9KSxcbiAgICAgICAgLy8gY29uY2F0ZW5hdGUgZWRnZUxhbWJkYXNcbiAgICAgICAgZWRnZUxhbWJkYXM6IFtcbiAgICAgICAgICAuLi5lZGdlTGFtYmRhcyxcbiAgICAgICAgICAuLi4oY2ZEaXN0cmlidXRpb25Qcm9wcy5kZWZhdWx0QmVoYXZpb3I/LmVkZ2VMYW1iZGFzIHx8IFtdKSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgICBhZGRpdGlvbmFsQmVoYXZpb3JzOiB7XG4gICAgICAgIFt0aGlzLnBhdGhQYXR0ZXJuKFwiX25leHQvaW1hZ2UqXCIpXToge1xuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgICAgIG9yaWdpbixcbiAgICAgICAgICBhbGxvd2VkTWV0aG9kczogY2xvdWRmcm9udC5BbGxvd2VkTWV0aG9kcy5BTExPV19BTEwsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IGltYWdlQ2FjaGVQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luUmVxdWVzdFBvbGljeTogbmV3IGNsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdFBvbGljeShcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBcIkltYWdlT3JpZ2luUmVxdWVzdFwiLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBxdWVyeVN0cmluZ0JlaGF2aW9yOlxuICAgICAgICAgICAgICAgIGNsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdFF1ZXJ5U3RyaW5nQmVoYXZpb3IuYWxsKCksXG4gICAgICAgICAgICB9XG4gICAgICAgICAgKSxcbiAgICAgICAgICBlZGdlTGFtYmRhczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBldmVudFR5cGU6IGNsb3VkZnJvbnQuTGFtYmRhRWRnZUV2ZW50VHlwZS5PUklHSU5fUkVRVUVTVCxcbiAgICAgICAgICAgICAgZnVuY3Rpb25WZXJzaW9uOiB0aGlzLmltYWdlRnVuY3Rpb25WZXJzaW9uLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcIl9uZXh0L2RhdGEvKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgICBjYWNoZWRNZXRob2RzOiBjbG91ZGZyb250LkNhY2hlZE1ldGhvZHMuQ0FDSEVfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgICBjb21wcmVzczogdHJ1ZSxcbiAgICAgICAgICBjYWNoZVBvbGljeTogbGFtYmRhQ2FjaGVQb2xpY3ksXG4gICAgICAgICAgZWRnZUxhbWJkYXMsXG4gICAgICAgIH0sXG4gICAgICAgIFt0aGlzLnBhdGhQYXR0ZXJuKFwiX25leHQvKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgICBjYWNoZWRNZXRob2RzOiBjbG91ZGZyb250LkNhY2hlZE1ldGhvZHMuQ0FDSEVfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgICBjb21wcmVzczogdHJ1ZSxcbiAgICAgICAgICBjYWNoZVBvbGljeTogc3RhdGljQ2FjaGVQb2xpY3ksXG4gICAgICAgIH0sXG4gICAgICAgIFt0aGlzLnBhdGhQYXR0ZXJuKFwic3RhdGljLypcIildOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IHN0YXRpY0NhY2hlUG9saWN5LFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcImFwaS8qXCIpXToge1xuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgICAgIG9yaWdpbixcbiAgICAgICAgICBhbGxvd2VkTWV0aG9kczogY2xvdWRmcm9udC5BbGxvd2VkTWV0aG9kcy5BTExPV19BTEwsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IGxhbWJkYUNhY2hlUG9saWN5LFxuICAgICAgICAgIGVkZ2VMYW1iZGFzOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGluY2x1ZGVCb2R5OiB0cnVlLFxuICAgICAgICAgICAgICBldmVudFR5cGU6IGNsb3VkZnJvbnQuTGFtYmRhRWRnZUV2ZW50VHlwZS5PUklHSU5fUkVRVUVTVCxcbiAgICAgICAgICAgICAgZnVuY3Rpb25WZXJzaW9uOiB0aGlzLmFwaUZ1bmN0aW9uVmVyc2lvbixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgLi4uKGNmRGlzdHJpYnV0aW9uUHJvcHMuYWRkaXRpb25hbEJlaGF2aW9ycyB8fCB7fSksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250U3RhdGljQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgIFwiU3RhdGljc0NhY2hlXCIsXG4gICAgICBOZXh0anNTaXRlLnN0YXRpY0NhY2hlUG9saWN5UHJvcHNcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250SW1hZ2VDYWNoZVBvbGljeSgpOiBjbG91ZGZyb250LkNhY2hlUG9saWN5IHtcbiAgICByZXR1cm4gbmV3IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3koXG4gICAgICB0aGlzLFxuICAgICAgXCJJbWFnZUNhY2hlXCIsXG4gICAgICBOZXh0anNTaXRlLmltYWdlQ2FjaGVQb2xpY3lQcm9wc1xuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNsb3VkRnJvbnRMYW1iZGFDYWNoZVBvbGljeSgpOiBjbG91ZGZyb250LkNhY2hlUG9saWN5IHtcbiAgICByZXR1cm4gbmV3IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3koXG4gICAgICB0aGlzLFxuICAgICAgXCJMYW1iZGFDYWNoZVwiLFxuICAgICAgTmV4dGpzU2l0ZS5sYW1iZGFDYWNoZVBvbGljeVByb3BzXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udEludmFsaWRhdGlvbigpOiBjZGsuQ3VzdG9tUmVzb3VyY2Uge1xuICAgIC8vIENyZWF0ZSBhIExhbWJkYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZG9pbmcgdGhlIGludmFsaWRhdGlvblxuICAgIGNvbnN0IGludmFsaWRhdG9yID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIkNsb3VkRnJvbnRJbnZhbGlkYXRvclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiY2YtaW52YWxpZGF0ZS5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgIH0pO1xuXG4gICAgLy8gR3JhbnQgcGVybWlzc2lvbnMgdG8gaW52YWxpZGF0ZSBDRiBEaXN0cmlidXRpb25cbiAgICBpbnZhbGlkYXRvci5hZGRUb1JvbGVQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwiY2xvdWRmcm9udDpHZXRJbnZhbGlkYXRpb25cIixcbiAgICAgICAgICBcImNsb3VkZnJvbnQ6Q3JlYXRlSW52YWxpZGF0aW9uXCIsXG4gICAgICAgIF0sXG4gICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSBjdXN0b20gcmVzb3VyY2VcbiAgICByZXR1cm4gbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCBcIkNsb3VkRnJvbnRJbnZhbGlkYXRpb25cIiwge1xuICAgICAgc2VydmljZVRva2VuOiBpbnZhbGlkYXRvci5mdW5jdGlvbkFybixcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVENsb3VkRnJvbnRJbnZhbGlkYXRpb25cIixcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgLy8gbmVlZCB0aGUgRGVwbG95SWQgZmllbGQgc28gdGhpcyBDUiBnZXRzIHVwZGF0ZWQgb24gZWFjaCBkZXBsb3lcbiAgICAgICAgRGVwbG95SWQ6IHRoaXMuZGVwbG95SWQsXG4gICAgICAgIERpc3RyaWJ1dGlvbklkOiB0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbklkLFxuICAgICAgICBEaXN0cmlidXRpb25QYXRoczogW1wiLypcIl0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEN1c3RvbSBEb21haW5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJvdGVjdGVkIHZhbGlkYXRlQ3VzdG9tRG9tYWluU2V0dGluZ3MoKSB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluID09PSB0cnVlKSB7XG4gICAgICBpZiAoIWN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEEgdmFsaWQgY2VydGlmaWNhdGUgaXMgcmVxdWlyZWQgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBzZXQgdG8gXCJ0cnVlXCIuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbi5kb21haW5BbGlhcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYERvbWFpbiBhbGlhcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgZG9tYWlucyBob3N0ZWQgb24gQW1hem9uIFJvdXRlIDUzLiBEbyBub3Qgc2V0IHRoZSBcImN1c3RvbURvbWFpbi5kb21haW5BbGlhc1wiIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgZW5hYmxlZC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBIb3N0ZWQgem9uZXMgY2FuIG9ubHkgYmUgY29uZmlndXJlZCBmb3IgZG9tYWlucyBob3N0ZWQgb24gQW1hem9uIFJvdXRlIDUzLiBEbyBub3Qgc2V0IHRoZSBcImN1c3RvbURvbWFpbi5ob3N0ZWRab25lXCIgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBlbmFibGVkLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgbG9va3VwSG9zdGVkWm9uZSgpOiByb3V0ZTUzLklIb3N0ZWRab25lIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIFNraXAgaWYgY3VzdG9tRG9tYWluIGlzIG5vdCBjb25maWd1cmVkXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgaG9zdGVkWm9uZTtcblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChpc0NES0NvbnN0cnVjdChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSBhcyByb3V0ZTUzLklIb3N0ZWRab25lO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgLy8gU2tpcCBpZiBkb21haW4gaXMgbm90IGEgUm91dGU1MyBkb21haW5cbiAgICAgIGlmIChjdXN0b21Eb21haW4uaXNFeHRlcm5hbERvbWFpbiA9PT0gdHJ1ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGhvc3RlZFpvbmUgPSByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cCh0aGlzLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhvc3RlZFpvbmU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNlcnRpZmljYXRlKCk6IGFjbS5JQ2VydGlmaWNhdGUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgYWNtQ2VydGlmaWNhdGU7XG5cbiAgICAvLyBIb3N0ZWRab25lIGlzIHNldCBmb3IgUm91dGUgNTMgZG9tYWluc1xuICAgIGlmICh0aGlzLmhvc3RlZFpvbmUpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4sXG4gICAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICAgIHJlZ2lvbjogXCJ1cy1lYXN0LTFcIixcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSxcbiAgICAgICAgICBob3N0ZWRab25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICAgICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gSG9zdGVkWm9uZSBpcyBOT1Qgc2V0IGZvciBub24tUm91dGUgNTMgZG9tYWluc1xuICAgIGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgYWNtQ2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGFjbUNlcnRpZmljYXRlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVJvdXRlNTNSZWNvcmRzKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4gfHwgIXRoaXMuaG9zdGVkWm9uZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCByZWNvcmROYW1lO1xuICAgIGxldCBkb21haW5BbGlhcztcbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmVjb3JkTmFtZSA9IGN1c3RvbURvbWFpbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVjb3JkTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lO1xuICAgICAgZG9tYWluQWxpYXMgPSBjdXN0b21Eb21haW4uZG9tYWluQWxpYXM7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIEROUyByZWNvcmRcbiAgICBuZXcgcm91dGU1My5BUmVjb3JkKHRoaXMsIFwiQWxpYXNSZWNvcmRcIiwge1xuICAgICAgcmVjb3JkTmFtZSxcbiAgICAgIHpvbmU6IHRoaXMuaG9zdGVkWm9uZSxcbiAgICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgICBuZXcgcm91dGU1M1RhcmdldHMuQ2xvdWRGcm9udFRhcmdldCh0aGlzLmNmRGlzdHJpYnV0aW9uKVxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBBbGlhcyByZWRpcmVjdCByZWNvcmRcbiAgICBpZiAoZG9tYWluQWxpYXMpIHtcbiAgICAgIG5ldyByb3V0ZTUzUGF0dGVybnMuSHR0cHNSZWRpcmVjdCh0aGlzLCBcIlJlZGlyZWN0XCIsIHtcbiAgICAgICAgem9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICByZWNvcmROYW1lczogW2RvbWFpbkFsaWFzXSxcbiAgICAgICAgdGFyZ2V0RG9tYWluOiByZWNvcmROYW1lLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEhlbHBlciBGdW5jdGlvbnNcbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBwYXRoUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgYmFzZVBhdGggfSA9IHRoaXMucm91dGVzTWFuaWZlc3QgfHwge307XG4gICAgcmV0dXJuIGJhc2VQYXRoICYmIGJhc2VQYXRoLmxlbmd0aCA+IDBcbiAgICAgID8gYCR7YmFzZVBhdGguc2xpY2UoMSl9LyR7cGF0dGVybn1gXG4gICAgICA6IHBhdHRlcm47XG4gIH1cblxuICBwcml2YXRlIHJlYWRSb3V0ZXNNYW5pZmVzdCgpOiBSb3V0ZXNNYW5pZmVzdCB7XG4gICAgcmV0dXJuIGZzLnJlYWRKU09OU3luYyhcbiAgICAgIHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyISwgXCJkZWZhdWx0LWxhbWJkYS9yb3V0ZXMtbWFuaWZlc3QuanNvblwiKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFMzQ29udGVudFJlcGxhY2VWYWx1ZXMoKTogQmFzZVNpdGVSZXBsYWNlUHJvcHNbXSB7XG4gICAgY29uc3QgcmVwbGFjZVZhbHVlczogQmFzZVNpdGVSZXBsYWNlUHJvcHNbXSA9IFtdO1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5lbnZpcm9ubWVudCB8fCB7fSlcbiAgICAgIC5maWx0ZXIoKFssIHZhbHVlXSkgPT4gY2RrLlRva2VuLmlzVW5yZXNvbHZlZCh2YWx1ZSkpXG4gICAgICAuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gYHt7ICR7a2V5fSB9fWA7XG4gICAgICAgIHJlcGxhY2VWYWx1ZXMucHVzaChcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCIqKi8qLmh0bWxcIixcbiAgICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGZpbGVzOiBcIioqLyouanNcIixcbiAgICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGZpbGVzOiBcIioqLyouanNvblwiLFxuICAgICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIHJldHVybiByZXBsYWNlVmFsdWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMYW1iZGFDb250ZW50UmVwbGFjZVZhbHVlcygpOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdIHtcbiAgICBjb25zdCByZXBsYWNlVmFsdWVzOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdID0gW107XG5cbiAgICAvLyBUaGUgTmV4dC5qcyBhcHAgY2FuIGhhdmUgZW52aXJvbm1lbnQgdmFyaWFibGVzIGxpa2VcbiAgICAvLyBgcHJvY2Vzcy5lbnYuQVBJX1VSTGAgaW4gdGhlIEpTIGNvZGUuIGBwcm9jZXNzLmVudi5BUElfVVJMYCBtaWdodCBvclxuICAgIC8vIG1pZ2h0IG5vdCBnZXQgcmVzb2x2ZWQgb24gYG5leHQgYnVpbGRgIGlmIGl0IGlzIHVzZWQgaW5cbiAgICAvLyBzZXJ2ZXItc2lkZSBmdW5jdGlvbnMsIGllLiBnZXRTZXJ2ZXJTaWRlUHJvcHMoKS5cbiAgICAvLyBCZWNhdXNlIExhbWJkYUBFZGdlIGRvZXMgbm90IHN1cHBvcnQgZW52aXJvbm1lbnQgdmFyaWFibGVzLCB3ZSB3aWxsXG4gICAgLy8gdXNlIHRoZSB0cmljayBvZiByZXBsYWNpbmcgXCJ7eyBfU1NUX05FWFRKU19TSVRFX0VOVklST05NRU5UXyB9fVwiIHdpdGhcbiAgICAvLyBhIEpTT04gZW5jb2RlZCBzdHJpbmcgb2YgYWxsIGVudmlyb25tZW50IGtleS12YWx1ZSBwYWlycy4gVGhpcyBzdHJpbmdcbiAgICAvLyB3aWxsIHRoZW4gZ2V0IGRlY29kZWQgYXQgcnVuIHRpbWUuXG4gICAgY29uc3QgbGFtYmRhRW52czogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5lbnZpcm9ubWVudCB8fCB7fSkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICBjb25zdCB0b2tlbiA9IGB7eyAke2tleX0gfX1gO1xuICAgICAgcmVwbGFjZVZhbHVlcy5wdXNoKFxuICAgICAgICB7XG4gICAgICAgICAgZmlsZXM6IFwiKiovKi5odG1sXCIsXG4gICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGZpbGVzOiBcIioqLyouanNcIixcbiAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgZmlsZXM6IFwiKiovKi5qc29uXCIsXG4gICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIGxhbWJkYUVudnNba2V5XSA9IHZhbHVlO1xuICAgIH0pO1xuXG4gICAgcmVwbGFjZVZhbHVlcy5wdXNoKHtcbiAgICAgIGZpbGVzOiBcIioqLyouanNcIixcbiAgICAgIHNlYXJjaDogJ1wie3sgX1NTVF9ORVhUSlNfU0lURV9FTlZJUk9OTUVOVF8gfX1cIicsXG4gICAgICByZXBsYWNlOiBKU09OLnN0cmluZ2lmeShsYW1iZGFFbnZzKSxcbiAgICB9KTtcblxuICAgIHJldHVybiByZXBsYWNlVmFsdWVzO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlclNpdGVFbnZpcm9ubWVudCgpIHtcbiAgICBjb25zdCBlbnZpcm9ubWVudE91dHB1dHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnByb3BzLmVudmlyb25tZW50IHx8IHt9KSkge1xuICAgICAgY29uc3Qgb3V0cHV0SWQgPSBgU3N0U2l0ZUVudl8ke2tleX1gO1xuICAgICAgY29uc3Qgb3V0cHV0ID0gbmV3IGNkay5DZm5PdXRwdXQodGhpcywgb3V0cHV0SWQsIHsgdmFsdWUgfSk7XG4gICAgICBlbnZpcm9ubWVudE91dHB1dHNba2V5XSA9IGNkay5TdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQob3V0cHV0KTtcbiAgICB9XG5cbiAgICBjb25zdCByb290ID0gdGhpcy5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIHJvb3QucmVnaXN0ZXJTaXRlRW52aXJvbm1lbnQoe1xuICAgICAgaWQ6IHRoaXMubm9kZS5pZCxcbiAgICAgIHBhdGg6IHRoaXMucHJvcHMucGF0aCxcbiAgICAgIHN0YWNrOiBjZGsuU3RhY2sub2YodGhpcykubm9kZS5pZCxcbiAgICAgIGVudmlyb25tZW50T3V0cHV0cyxcbiAgICB9IGFzIEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyk7XG4gIH1cbn1cbiJdfQ==