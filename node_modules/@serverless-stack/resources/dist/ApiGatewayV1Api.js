"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApiGatewayV1Api = void 0;
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
const apig = __importStar(require("aws-cdk-lib/aws-apigateway"));
const apigV1AccessLog = __importStar(require("./util/apiGatewayV1AccessLog"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const allowedMethods = [
    "ANY",
    "GET",
    "PUT",
    "POST",
    "HEAD",
    "PATCH",
    "DELETE",
    "OPTIONS",
];
/////////////////////
// Construct
/////////////////////
class ApiGatewayV1Api extends constructs_1.Construct {
    constructor(scope, id, props) {
        var _a, _b, _c, _d, _e, _f, _g;
        super(scope, id);
        const root = scope.node.root;
        const { restApi, routes, cors, accessLog, customDomain, importedPaths, defaultFunctionProps, defaultAuthorizer, defaultAuthorizationType, defaultAuthorizationScopes, } = props || {};
        this.functions = {};
        this.importedResources = {};
        this.permissionsAttachedForAllRoutes = [];
        this.defaultFunctionProps = defaultFunctionProps;
        this.defaultAuthorizer = defaultAuthorizer;
        this.defaultAuthorizationType = defaultAuthorizationType;
        this.defaultAuthorizationScopes = defaultAuthorizationScopes;
        ////////////////////
        // Create Api
        ////////////////////
        if (Construct_1.isCDKConstruct(restApi)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when the "restApi" is imported`);
            }
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when the "restApi" is imported`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when the "restApi" is imported`);
            }
            this.restApi = restApi;
            // Create an API Gateway deployment resource to trigger a deployment
            this._deployment = new apig.Deployment(this, "Deployment", {
                api: this.restApi,
            });
            const cfnDeployment = this._deployment.node
                .defaultChild;
            cfnDeployment.stageName = root.stage;
            if (importedPaths) {
                this.importResources(importedPaths);
            }
        }
        else {
            const restApiProps = (restApi || {});
            // Validate input
            if (importedPaths !== undefined) {
                throw new Error(`Cannot import route paths when creating a new API.`);
            }
            if (customDomain !== undefined && restApiProps.domainName !== undefined) {
                throw new Error(`Use either the "customDomain" or the "restApi.domainName" to configure the Api domain. Do not use both.`);
            }
            if (cors !== undefined &&
                restApiProps.defaultCorsPreflightOptions !== undefined) {
                throw new Error(`Use either the "cors" or the "restApi.defaultCorsPreflightOptions" to configure the Api's CORS config. Do not use both.`);
            }
            if (accessLog !== undefined &&
                ((_a = restApiProps.deployOptions) === null || _a === void 0 ? void 0 : _a.accessLogDestination) !== undefined) {
                throw new Error(`Use either the "accessLog" or the "restApi.deployOptions.accessLogDestination" to configure the Api's access log. Do not use both.`);
            }
            if (accessLog !== undefined &&
                ((_b = restApiProps.deployOptions) === null || _b === void 0 ? void 0 : _b.accessLogFormat) !== undefined) {
                throw new Error(`Use either the "accessLog" or the "restApi.deployOptions.accessLogFormat" to configure the Api's access log. Do not use both.`);
            }
            const stageName = ((_c = restApiProps.deployOptions) === null || _c === void 0 ? void 0 : _c.stageName) || this.node.root.stage;
            const accessLogData = apigV1AccessLog.buildAccessLogData(this, accessLog);
            this.accessLogGroup = accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.logGroup;
            this.restApi = new apig.RestApi(this, "Api", Object.assign(Object.assign({}, restApiProps), { restApiName: root.logicalPrefixedName(id), domainName: restApiProps.domainName, defaultCorsPreflightOptions: restApiProps.defaultCorsPreflightOptions ||
                    this.buildCorsConfig(cors), deployOptions: Object.assign(Object.assign({}, (restApiProps.deployOptions || {})), { accessLogDestination: ((_d = restApiProps.deployOptions) === null || _d === void 0 ? void 0 : _d.accessLogDestination) ||
                        (accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.destination), accessLogFormat: ((_e = restApiProps.deployOptions) === null || _e === void 0 ? void 0 : _e.accessLogFormat) ||
                        (accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.format), 
                    // default to the name of the sage
                    stageName: stageName, 
                    // default to true
                    tracingEnabled: ((_f = restApiProps.deployOptions) === null || _f === void 0 ? void 0 : _f.tracingEnabled) === undefined
                        ? true
                        : (_g = restApiProps.deployOptions) === null || _g === void 0 ? void 0 : _g.tracingEnabled }) }));
            this.createCustomDomain(customDomain);
            this.createGatewayResponseForCors(cors);
        }
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        if (routes) {
            Object.keys(routes).forEach((routeKey) => this.addRoute(this, routeKey, routes[routeKey]));
        }
    }
    get url() {
        return this.restApi.url;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.functions);
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            // add route
            const fn = this.addRoute(scope, routeKey, routes[routeKey]);
            // attached existing permissions
            this.permissionsAttachedForAllRoutes.forEach((permissions) => fn.attachPermissions(permissions));
        });
    }
    getFunction(routeKey) {
        return this.functions[this.normalizeRouteKey(routeKey)];
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    getConstructMetadata() {
        return {
            type: "ApiGatewayV1Api",
            data: {
                customDomainUrl: this._customDomainUrl,
                restApiId: this.restApi.restApiId,
                routes: Object.entries(this.functions).map(([key, data]) => {
                    return {
                        route: key,
                        fn: Construct_1.getFunctionRef(data),
                    };
                }),
            },
        };
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    buildCorsConfig(cors) {
        // Case: cors is false
        if (cors === false) {
            return undefined;
        }
        // Case: cors is true or undefined
        return {
            allowOrigins: apig.Cors.ALL_ORIGINS,
        };
    }
    createGatewayResponseForCors(cors) {
        if (!cors) {
            return;
        }
        this.restApi.addGatewayResponse("GatewayResponseDefault4XX", {
            type: apig.ResponseType.DEFAULT_4XX,
            responseHeaders: {
                "Access-Control-Allow-Origin": "'*'",
                "Access-Control-Allow-Headers": "'*'",
            },
        });
        this.restApi.addGatewayResponse("GatewayResponseDefault5XX", {
            type: apig.ResponseType.DEFAULT_5XX,
            responseHeaders: {
                "Access-Control-Allow-Origin": "'*'",
                "Access-Control-Allow-Headers": "'*'",
            },
        });
    }
    createCustomDomain(customDomain) {
        // Case: customDomain is not set
        if (customDomain === undefined) {
            return;
        }
        // To be implemented: to allow more flexible use cases, SST should support 3 more use cases:
        //  1. Allow user passing in `hostedZone` object. The use case is when there are multiple
        //     HostedZones with the same domain, but one is public, and one is private.
        //  2. Allow user passing in `certificate` object. The use case is for user to create wildcard
        //     certificate or using an imported certificate.
        //  3. Allow user passing in `apigDomainName` object. The use case is a user creates multiple API
        //     endpoints, and is mapping them under the same custom domain. `sst.Api` needs to expose the
        //     `apigDomainName` construct created in the first Api, and lets user pass it in when creating
        //     the second Api.
        let domainName, hostedZone, hostedZoneDomain, certificate, apigDomainName, basePath, endpointType, mtls, securityPolicy;
        /////////////////////
        // Parse input
        /////////////////////
        // Case: customDomain is a string
        if (typeof customDomain === "string") {
            // validate: customDomain is a TOKEN string
            // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
            if (cdk.Token.isUnresolved(customDomain)) {
                throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
            }
            domainName = customDomain;
            this.assertDomainNameIsLowerCase(domainName);
            hostedZoneDomain = customDomain.split(".").slice(1).join(".");
        }
        // Case: customDomain.domainName not exists
        else if (!customDomain.domainName) {
            throw new Error(`Missing "domainName" in Api's customDomain setting`);
        }
        // Case: customDomain.domainName is a string
        else if (typeof customDomain.domainName === "string") {
            domainName = customDomain.domainName;
            // parse customDomain.domainName
            if (cdk.Token.isUnresolved(customDomain.domainName)) {
                // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
                // is because "hostedZone" cannot be parsed from a TOKEN value.
                if (!customDomain.hostedZone) {
                    throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
                }
                domainName = customDomain.domainName;
            }
            else {
                domainName = customDomain.domainName;
                this.assertDomainNameIsLowerCase(domainName);
            }
            // parse customDomain.hostedZone
            if (!customDomain.hostedZone) {
                hostedZoneDomain = domainName.split(".").slice(1).join(".");
            }
            else if (typeof customDomain.hostedZone === "string") {
                hostedZoneDomain = customDomain.hostedZone;
            }
            else {
                hostedZone = customDomain.hostedZone;
            }
            certificate = customDomain.certificate;
            basePath = customDomain.path;
            endpointType = customDomain.endpointType;
            mtls = customDomain.mtls;
            securityPolicy = customDomain.securityPolicy;
        }
        // Case: customDomain.domainName is a construct
        else {
            apigDomainName = customDomain.domainName;
            // customDomain.domainName is imported
            if (apigDomainName && customDomain.hostedZone) {
                throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.certificate) {
                throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.endpointType) {
                throw new Error(`Cannot configure the "endpointType" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.mtls) {
                throw new Error(`Cannot configure the "mtls" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.securityPolicy) {
                throw new Error(`Cannot configure the "securityPolicy" when the "domainName" is a construct`);
            }
            basePath = customDomain.path;
        }
        /////////////////////
        // Find hosted zone
        /////////////////////
        if (!apigDomainName && !hostedZone) {
            // Look up hosted zone
            if (!hostedZone && hostedZoneDomain) {
                hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                    domainName: hostedZoneDomain,
                });
            }
        }
        /////////////////////
        // Create certificate
        /////////////////////
        if (!apigDomainName && !certificate) {
            if (endpointType === apig.EndpointType.EDGE) {
                certificate = new acm.DnsValidatedCertificate(this, "CrossRegionCertificate", {
                    domainName: domainName,
                    hostedZone: hostedZone,
                    region: "us-east-1",
                });
            }
            else {
                certificate = new acm.Certificate(this, "Certificate", {
                    domainName: domainName,
                    validation: acm.CertificateValidation.fromDns(hostedZone),
                });
            }
            this.acmCertificate = certificate;
        }
        /////////////////////
        // Create API Gateway domain name
        /////////////////////
        if (!apigDomainName && domainName) {
            // Create custom domain in API Gateway
            apigDomainName = new apig.DomainName(this, "DomainName", {
                domainName,
                certificate: certificate,
                endpointType,
                mtls,
                securityPolicy,
            });
            this.apiGatewayDomain = apigDomainName;
            // Create DNS record
            const record = new route53.ARecord(this, "AliasRecord", {
                recordName: domainName,
                zone: hostedZone,
                target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayDomain(apigDomainName)),
            });
            // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
            //       construct will append ".${hostedZoneName}" to the end of the domain.
            //       This is because the construct tries to check if the record name
            //       ends with the domain name. If not, it will append the domain name.
            //       So, we need remove this behavior.
            if (cdk.Token.isUnresolved(domainName)) {
                const cfnRecord = record.node.defaultChild;
                cfnRecord.name = domainName;
            }
        }
        /////////////////////
        // Create base mapping
        /////////////////////
        if (apigDomainName) {
            new apig.BasePathMapping(this, "BasePath", {
                domainName: apigDomainName,
                restApi: this.restApi,
                basePath,
            });
        }
        // Note: We only know the full custom domain if domainName is a string.
        //       _customDomainUrl will be undefined if apigDomainName is imported.
        if (domainName && !cdk.Token.isUnresolved(domainName)) {
            this._customDomainUrl = basePath
                ? `https://${domainName}/${basePath}/`
                : `https://${domainName}`;
        }
    }
    importResources(resources) {
        Object.keys(resources).forEach((path) => {
            const resource = apig.Resource.fromResourceAttributes(this, `Resource_${path}`, {
                path,
                resourceId: resources[path],
                restApi: this.restApi,
            });
            this.importedResources[path] = resource;
        });
    }
    getResourceForPath(path) {
        // Lookup exact match imported resource
        if (this.importedResources[path]) {
            return this.importedResources[path];
        }
        // Lookup parents matching imported resource first
        const parts = path.split("/");
        for (let i = parts.length; i >= 1; i--) {
            const partialPath = parts.slice(0, i).join("/");
            if (this.importedResources[partialPath]) {
                return this.importedResources[partialPath].resourceForPath(parts.slice(i).join("/"));
            }
        }
        // Not child of imported resources, create off the root
        return this.restApi.root.resourceForPath(path);
    }
    addRoute(scope, routeKey, routeValue) {
        // Normalize routeProps
        const routeProps = (this.isInstanceOfApiRouteProps(routeValue)
            ? routeValue
            : {
                function: routeValue,
            });
        // Normalize routeKey
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.functions[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Get path and method
        ///////////////////
        const routeKeyParts = routeKey.split(" ");
        if (routeKeyParts.length !== 2) {
            throw new Error(`Invalid route ${routeKey}`);
        }
        const methodStr = routeKeyParts[0].toUpperCase();
        const path = routeKeyParts[1];
        const method = allowedMethods.find((per) => per === methodStr);
        if (!method) {
            throw new Error(`Invalid method defined for "${routeKey}"`);
        }
        if (path.length === 0) {
            throw new Error(`Invalid path defined for "${routeKey}"`);
        }
        ///////////////////
        // Create Resources
        ///////////////////
        let resource;
        if (path.endsWith("/{proxy+}")) {
            const parentResource = this.getResourceForPath(path.split("/").slice(0, -1).join("/"));
            resource = parentResource.addProxy({ anyMethod: false });
        }
        else {
            resource = this.getResourceForPath(path);
        }
        ///////////////////
        // Create Method
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, `Lambda_${methodStr}_${path}`, routeProps.function, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        const integration = new apig.LambdaIntegration(lambda, routeProps.integrationOptions);
        const methodOptions = this.buildRouteMethodOptions(routeProps.methodOptions);
        const apigMethod = resource.addMethod(method, integration, methodOptions);
        // Add an environment variable to determine if the function is an Api route.
        // If it is, when "sst start" is not connected, we want to return an 500
        // status code and a descriptive error message.
        const root = scope.node.root;
        if (root.local) {
            lambda.addEnvironment("SST_DEBUG_IS_API_ROUTE", "1", {
                removeInEdge: true,
            });
        }
        ///////////////////
        // Handle manually created Deployment resource (ie. imported REST API)
        ///////////////////
        if (this._deployment) {
            this._deployment.addToLogicalId({ route: { routeKey, routeValue } });
            this._deployment.node.addDependency(apigMethod);
        }
        ///////////////////
        // Store function
        ///////////////////
        this.functions[routeKey] = lambda;
        return lambda;
    }
    buildRouteMethodOptions(options) {
        // Merge method options
        const methodOptions = Object.assign({ authorizationType: this.defaultAuthorizationType }, (options || {}));
        // Set authorization info
        if (methodOptions.authorizationType !== apig.AuthorizationType.NONE &&
            methodOptions.authorizationType !== apig.AuthorizationType.IAM) {
            methodOptions.authorizer =
                methodOptions.authorizer || this.defaultAuthorizer;
            methodOptions.authorizationScopes =
                methodOptions.authorizationScopes || this.defaultAuthorizationScopes;
        }
        return methodOptions;
    }
    isInstanceOfApiRouteProps(object) {
        return object.function !== undefined;
    }
    normalizeRouteKey(routeKey) {
        return routeKey.split(/\s+/).join(" ");
    }
    assertDomainNameIsLowerCase(domainName) {
        if (domainName !== domainName.toLowerCase()) {
            throw new Error(`The domain name needs to be in lowercase`);
        }
    }
}
exports.ApiGatewayV1Api = ApiGatewayV1Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBpR2F0ZXdheVYxQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwaUdhdGV3YXlWMUFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBQ3ZDLGlEQUFtQztBQUVuQyxpRUFBbUQ7QUFDbkQsZ0ZBQWtFO0FBQ2xFLHdFQUEwRDtBQUMxRCxpRUFBbUQ7QUFDbkQsOEVBQWdFO0FBR2hFLDJDQUEyRTtBQUMzRSx5Q0FBK0U7QUFHL0UsTUFBTSxjQUFjLEdBQUc7SUFDckIsS0FBSztJQUNMLEtBQUs7SUFDTCxLQUFLO0lBQ0wsTUFBTTtJQUNOLE1BQU07SUFDTixPQUFPO0lBQ1AsUUFBUTtJQUNSLFNBQVM7Q0FDVixDQUFDO0FBd0NGLHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCLE1BQWEsZUFBZ0IsU0FBUSxzQkFBUztJQWU1QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQTRCOztRQUNwRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sRUFDSixPQUFPLEVBQ1AsTUFBTSxFQUNOLElBQUksRUFDSixTQUFTLEVBQ1QsWUFBWSxFQUNaLGFBQWEsRUFDYixvQkFBb0IsRUFDcEIsaUJBQWlCLEVBQ2pCLHdCQUF3QixFQUN4QiwwQkFBMEIsR0FDM0IsR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLCtCQUErQixHQUFHLEVBQUUsQ0FBQztRQUMxQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUM7UUFDakQsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlC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QixDQUFDO0lBRU8seUJBQXlCLENBQy9CLE1BQWlDO1FBRWpDLE9BQU8sTUFBTSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUM7SUFDdkMsQ0FBQztJQUVPLGlCQUFpQixDQUFDLFFBQWdCO1FBQ3hDLE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLDJCQUEyQixDQUFDLFVBQWtCO1FBQ3BELElBQUksVUFBVSxLQUFLLFVBQVUsQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUMzQyxNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7U0FDN0Q7SUFDSCxDQUFDO0NBQ0Y7QUFob0JELDBDQWdvQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxvZ3NcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzVGFyZ2V0cyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTMtdGFyZ2V0c1wiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheVwiO1xuaW1wb3J0ICogYXMgYXBpZ1YxQWNjZXNzTG9nIGZyb20gXCIuL3V0aWwvYXBpR2F0ZXdheVYxQWNjZXNzTG9nXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuY29uc3QgYWxsb3dlZE1ldGhvZHMgPSBbXG4gIFwiQU5ZXCIsXG4gIFwiR0VUXCIsXG4gIFwiUFVUXCIsXG4gIFwiUE9TVFwiLFxuICBcIkhFQURcIixcbiAgXCJQQVRDSFwiLFxuICBcIkRFTEVURVwiLFxuICBcIk9QVElPTlNcIixcbl07XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gSW50ZXJmYWNlc1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpR2F0ZXdheVYxQXBpUHJvcHMge1xuICByZWFkb25seSByZXN0QXBpPzogYXBpZy5JUmVzdEFwaSB8IGFwaWcuUmVzdEFwaVByb3BzO1xuICByZWFkb25seSByb3V0ZXM/OiB7XG4gICAgW2tleTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcztcbiAgfTtcbiAgcmVhZG9ubHkgY29ycz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGFjY2Vzc0xvZz86IGJvb2xlYW4gfCBzdHJpbmcgfCBBcGlHYXRld2F5VjFBcGlBY2NjZXNzTG9nUHJvcHM7XG4gIHJlYWRvbmx5IGN1c3RvbURvbWFpbj86IHN0cmluZyB8IEFwaUdhdGV3YXlWMUFwaUN1c3RvbURvbWFpblByb3BzO1xuICByZWFkb25seSBpbXBvcnRlZFBhdGhzPzogeyBbcGF0aDogc3RyaW5nXTogc3RyaW5nIH07XG5cbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICByZWFkb25seSBkZWZhdWx0QXV0aG9yaXplcj86IGFwaWcuSUF1dGhvcml6ZXI7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZT86IGFwaWcuQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IG1ldGhvZE9wdGlvbnM/OiBhcGlnLk1ldGhvZE9wdGlvbnM7XG4gIHJlYWRvbmx5IGludGVncmF0aW9uT3B0aW9ucz86IGFwaWcuTGFtYmRhSW50ZWdyYXRpb25PcHRpb25zO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUdhdGV3YXlWMUFwaUN1c3RvbURvbWFpblByb3BzIHtcbiAgcmVhZG9ubHkgZG9tYWluTmFtZTogc3RyaW5nIHwgYXBpZy5JRG9tYWluTmFtZTtcbiAgcmVhZG9ubHkgaG9zdGVkWm9uZT86IHN0cmluZyB8IHJvdXRlNTMuSUhvc3RlZFpvbmU7XG4gIHJlYWRvbmx5IGNlcnRpZmljYXRlPzogYWNtLklDZXJ0aWZpY2F0ZTtcbiAgcmVhZG9ubHkgcGF0aD86IHN0cmluZztcbiAgcmVhZG9ubHkgZW5kcG9pbnRUeXBlPzogYXBpZy5FbmRwb2ludFR5cGU7XG4gIHJlYWRvbmx5IG10bHM/OiBhcGlnLk1UTFNDb25maWc7XG4gIHJlYWRvbmx5IHNlY3VyaXR5UG9saWN5PzogYXBpZy5TZWN1cml0eVBvbGljeTtcbn1cblxuZXhwb3J0IHR5cGUgQXBpR2F0ZXdheVYxQXBpQWNjY2Vzc0xvZ1Byb3BzID0gYXBpZ1YxQWNjZXNzTG9nLkFjY2Vzc0xvZ1Byb3BzO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBBcGlHYXRld2F5VjFBcGkgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgcmVzdEFwaTogYXBpZy5SZXN0QXBpO1xuICBwdWJsaWMgYWNjZXNzTG9nR3JvdXA/OiBsb2dzLkxvZ0dyb3VwO1xuICBwdWJsaWMgYXBpR2F0ZXdheURvbWFpbj86IGFwaWcuRG9tYWluTmFtZTtcbiAgcHVibGljIGFjbUNlcnRpZmljYXRlPzogYWNtLkNlcnRpZmljYXRlIHwgYWNtLkRuc1ZhbGlkYXRlZENlcnRpZmljYXRlO1xuICBwcml2YXRlIF9kZXBsb3ltZW50PzogYXBpZy5EZXBsb3ltZW50O1xuICBwcml2YXRlIF9jdXN0b21Eb21haW5Vcmw/OiBzdHJpbmc7XG4gIHByaXZhdGUgaW1wb3J0ZWRSZXNvdXJjZXM6IHsgW3BhdGg6IHN0cmluZ106IGFwaWcuSVJlc291cmNlIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25zOiB7IFtrZXk6IHN0cmluZ106IEZuIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlczogUGVybWlzc2lvbnNbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6ZXI/OiBhcGlnLklBdXRob3JpemVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZT86IGFwaWcuQXV0aG9yaXphdGlvblR5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM/OiBzdHJpbmdbXTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEFwaUdhdGV3YXlWMUFwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHtcbiAgICAgIHJlc3RBcGksXG4gICAgICByb3V0ZXMsXG4gICAgICBjb3JzLFxuICAgICAgYWNjZXNzTG9nLFxuICAgICAgY3VzdG9tRG9tYWluLFxuICAgICAgaW1wb3J0ZWRQYXRocyxcbiAgICAgIGRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgZGVmYXVsdEF1dGhvcml6ZXIsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblR5cGUsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcyxcbiAgICB9ID0gcHJvcHMgfHwge307XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLmltcG9ydGVkUmVzb3VyY2VzID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6ZXIgPSBkZWZhdWx0QXV0aG9yaXplcjtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uVHlwZSA9IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZTtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzID0gZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBBcGlcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KHJlc3RBcGkpKSB7XG4gICAgICBpZiAoY29ycyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjb3JzXCIgd2hlbiB0aGUgXCJyZXN0QXBpXCIgaXMgaW1wb3J0ZWRgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoYWNjZXNzTG9nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImFjY2Vzc0xvZ1wiIHdoZW4gdGhlIFwicmVzdEFwaVwiIGlzIGltcG9ydGVkYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjdXN0b21Eb21haW5cIiB3aGVuIHRoZSBcInJlc3RBcGlcIiBpcyBpbXBvcnRlZGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVzdEFwaSA9IHJlc3RBcGkgYXMgYXBpZy5SZXN0QXBpO1xuXG4gICAgICAvLyBDcmVhdGUgYW4gQVBJIEdhdGV3YXkgZGVwbG95bWVudCByZXNvdXJjZSB0byB0cmlnZ2VyIGEgZGVwbG95bWVudFxuICAgICAgdGhpcy5fZGVwbG95bWVudCA9IG5ldyBhcGlnLkRlcGxveW1lbnQodGhpcywgXCJEZXBsb3ltZW50XCIsIHtcbiAgICAgICAgYXBpOiB0aGlzLnJlc3RBcGksXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGNmbkRlcGxveW1lbnQgPSB0aGlzLl9kZXBsb3ltZW50Lm5vZGVcbiAgICAgICAgLmRlZmF1bHRDaGlsZCBhcyBhcGlnLkNmbkRlcGxveW1lbnQ7XG4gICAgICBjZm5EZXBsb3ltZW50LnN0YWdlTmFtZSA9IHJvb3Quc3RhZ2U7XG5cbiAgICAgIGlmIChpbXBvcnRlZFBhdGhzKSB7XG4gICAgICAgIHRoaXMuaW1wb3J0UmVzb3VyY2VzKGltcG9ydGVkUGF0aHMpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZXN0QXBpUHJvcHMgPSAocmVzdEFwaSB8fCB7fSkgYXMgYXBpZy5SZXN0QXBpUHJvcHM7XG5cbiAgICAgIC8vIFZhbGlkYXRlIGlucHV0XG4gICAgICBpZiAoaW1wb3J0ZWRQYXRocyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGltcG9ydCByb3V0ZSBwYXRocyB3aGVuIGNyZWF0aW5nIGEgbmV3IEFQSS5gKTtcbiAgICAgIH1cbiAgICAgIGlmIChjdXN0b21Eb21haW4gIT09IHVuZGVmaW5lZCAmJiByZXN0QXBpUHJvcHMuZG9tYWluTmFtZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVXNlIGVpdGhlciB0aGUgXCJjdXN0b21Eb21haW5cIiBvciB0aGUgXCJyZXN0QXBpLmRvbWFpbk5hbWVcIiB0byBjb25maWd1cmUgdGhlIEFwaSBkb21haW4uIERvIG5vdCB1c2UgYm90aC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGNvcnMgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICByZXN0QXBpUHJvcHMuZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zICE9PSB1bmRlZmluZWRcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFVzZSBlaXRoZXIgdGhlIFwiY29yc1wiIG9yIHRoZSBcInJlc3RBcGkuZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zXCIgdG8gY29uZmlndXJlIHRoZSBBcGkncyBDT1JTIGNvbmZpZy4gRG8gbm90IHVzZSBib3RoLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgYWNjZXNzTG9nICE9PSB1bmRlZmluZWQgJiZcbiAgICAgICAgcmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnM/LmFjY2Vzc0xvZ0Rlc3RpbmF0aW9uICE9PSB1bmRlZmluZWRcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFVzZSBlaXRoZXIgdGhlIFwiYWNjZXNzTG9nXCIgb3IgdGhlIFwicmVzdEFwaS5kZXBsb3lPcHRpb25zLmFjY2Vzc0xvZ0Rlc3RpbmF0aW9uXCIgdG8gY29uZmlndXJlIHRoZSBBcGkncyBhY2Nlc3MgbG9nLiBEbyBub3QgdXNlIGJvdGguYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBhY2Nlc3NMb2cgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uYWNjZXNzTG9nRm9ybWF0ICE9PSB1bmRlZmluZWRcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFVzZSBlaXRoZXIgdGhlIFwiYWNjZXNzTG9nXCIgb3IgdGhlIFwicmVzdEFwaS5kZXBsb3lPcHRpb25zLmFjY2Vzc0xvZ0Zvcm1hdFwiIHRvIGNvbmZpZ3VyZSB0aGUgQXBpJ3MgYWNjZXNzIGxvZy4gRG8gbm90IHVzZSBib3RoLmBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc3RhZ2VOYW1lID1cbiAgICAgICAgcmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnM/LnN0YWdlTmFtZSB8fCAodGhpcy5ub2RlLnJvb3QgYXMgQXBwKS5zdGFnZTtcblxuICAgICAgY29uc3QgYWNjZXNzTG9nRGF0YSA9IGFwaWdWMUFjY2Vzc0xvZy5idWlsZEFjY2Vzc0xvZ0RhdGEodGhpcywgYWNjZXNzTG9nKTtcblxuICAgICAgdGhpcy5hY2Nlc3NMb2dHcm91cCA9IGFjY2Vzc0xvZ0RhdGE/LmxvZ0dyb3VwO1xuXG4gICAgICB0aGlzLnJlc3RBcGkgPSBuZXcgYXBpZy5SZXN0QXBpKHRoaXMsIFwiQXBpXCIsIHtcbiAgICAgICAgLi4ucmVzdEFwaVByb3BzLFxuICAgICAgICByZXN0QXBpTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgZG9tYWluTmFtZTogcmVzdEFwaVByb3BzLmRvbWFpbk5hbWUsXG4gICAgICAgIGRlZmF1bHRDb3JzUHJlZmxpZ2h0T3B0aW9uczpcbiAgICAgICAgICByZXN0QXBpUHJvcHMuZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zIHx8XG4gICAgICAgICAgdGhpcy5idWlsZENvcnNDb25maWcoY29ycyksXG4gICAgICAgIGRlcGxveU9wdGlvbnM6IHtcbiAgICAgICAgICAuLi4ocmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnMgfHwge30pLFxuICAgICAgICAgIGFjY2Vzc0xvZ0Rlc3RpbmF0aW9uOlxuICAgICAgICAgICAgcmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnM/LmFjY2Vzc0xvZ0Rlc3RpbmF0aW9uIHx8XG4gICAgICAgICAgICBhY2Nlc3NMb2dEYXRhPy5kZXN0aW5hdGlvbixcbiAgICAgICAgICBhY2Nlc3NMb2dGb3JtYXQ6XG4gICAgICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uYWNjZXNzTG9nRm9ybWF0IHx8XG4gICAgICAgICAgICBhY2Nlc3NMb2dEYXRhPy5mb3JtYXQsXG5cbiAgICAgICAgICAvLyBkZWZhdWx0IHRvIHRoZSBuYW1lIG9mIHRoZSBzYWdlXG4gICAgICAgICAgc3RhZ2VOYW1lOiBzdGFnZU5hbWUsXG5cbiAgICAgICAgICAvLyBkZWZhdWx0IHRvIHRydWVcbiAgICAgICAgICB0cmFjaW5nRW5hYmxlZDpcbiAgICAgICAgICAgIHJlc3RBcGlQcm9wcy5kZXBsb3lPcHRpb25zPy50cmFjaW5nRW5hYmxlZCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgID8gdHJ1ZVxuICAgICAgICAgICAgICA6IHJlc3RBcGlQcm9wcy5kZXBsb3lPcHRpb25zPy50cmFjaW5nRW5hYmxlZCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNyZWF0ZUN1c3RvbURvbWFpbihjdXN0b21Eb21haW4pO1xuICAgICAgdGhpcy5jcmVhdGVHYXRld2F5UmVzcG9uc2VGb3JDb3JzKGNvcnMpO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSByb3V0ZXNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChyb3V0ZXMpIHtcbiAgICAgIE9iamVjdC5rZXlzKHJvdXRlcykuZm9yRWFjaCgocm91dGVLZXk6IHN0cmluZykgPT5cbiAgICAgICAgdGhpcy5hZGRSb3V0ZSh0aGlzLCByb3V0ZUtleSwgcm91dGVzW3JvdXRlS2V5XSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5yZXN0QXBpLnVybDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuX2N1c3RvbURvbWFpblVybDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcm91dGVzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5mdW5jdGlvbnMpO1xuICB9XG5cbiAgcHVibGljIGFkZFJvdXRlcyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlczoge1xuICAgICAgW2tleTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcztcbiAgICB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKHJvdXRlcykuZm9yRWFjaCgocm91dGVLZXk6IHN0cmluZykgPT4ge1xuICAgICAgLy8gYWRkIHJvdXRlXG4gICAgICBjb25zdCBmbiA9IHRoaXMuYWRkUm91dGUoc2NvcGUsIHJvdXRlS2V5LCByb3V0ZXNbcm91dGVLZXldKTtcblxuICAgICAgLy8gYXR0YWNoZWQgZXhpc3RpbmcgcGVybWlzc2lvbnNcbiAgICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldEZ1bmN0aW9uKHJvdXRlS2V5OiBzdHJpbmcpOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuZnVuY3Rpb25zW3RoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpXTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBPYmplY3QudmFsdWVzKHRoaXMuZnVuY3Rpb25zKS5mb3JFYWNoKChmbikgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIkFwaUdhdGV3YXlWMUFwaVwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBjdXN0b21Eb21haW5Vcmw6IHRoaXMuX2N1c3RvbURvbWFpblVybCxcbiAgICAgICAgcmVzdEFwaUlkOiB0aGlzLnJlc3RBcGkucmVzdEFwaUlkLFxuICAgICAgICByb3V0ZXM6IE9iamVjdC5lbnRyaWVzKHRoaXMuZnVuY3Rpb25zKS5tYXAoKFtrZXksIGRhdGFdKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJvdXRlOiBrZXksXG4gICAgICAgICAgICBmbjogZ2V0RnVuY3Rpb25SZWYoZGF0YSksXG4gICAgICAgICAgfTtcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1JvdXRlKFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gdGhpcy5nZXRGdW5jdGlvbihyb3V0ZUtleSk7XG4gICAgaWYgKCFmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGF0dGFjaCBwZXJtaXNzaW9ucy4gUm91dGUgXCIke3JvdXRlS2V5fVwiIGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvcnNDb25maWcoY29ycz86IGJvb2xlYW4pOiBhcGlnLkNvcnNPcHRpb25zIHwgdW5kZWZpbmVkIHtcbiAgICAvLyBDYXNlOiBjb3JzIGlzIGZhbHNlXG4gICAgaWYgKGNvcnMgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIENhc2U6IGNvcnMgaXMgdHJ1ZSBvciB1bmRlZmluZWRcbiAgICByZXR1cm4ge1xuICAgICAgYWxsb3dPcmlnaW5zOiBhcGlnLkNvcnMuQUxMX09SSUdJTlMsXG4gICAgfSBhcyBhcGlnLkNvcnNPcHRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVHYXRld2F5UmVzcG9uc2VGb3JDb3JzKGNvcnM/OiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKCFjb3JzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5yZXN0QXBpLmFkZEdhdGV3YXlSZXNwb25zZShcIkdhdGV3YXlSZXNwb25zZURlZmF1bHQ0WFhcIiwge1xuICAgICAgdHlwZTogYXBpZy5SZXNwb25zZVR5cGUuREVGQVVMVF80WFgsXG4gICAgICByZXNwb25zZUhlYWRlcnM6IHtcbiAgICAgICAgXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW5cIjogXCInKidcIixcbiAgICAgICAgXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzXCI6IFwiJyonXCIsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5yZXN0QXBpLmFkZEdhdGV3YXlSZXNwb25zZShcIkdhdGV3YXlSZXNwb25zZURlZmF1bHQ1WFhcIiwge1xuICAgICAgdHlwZTogYXBpZy5SZXNwb25zZVR5cGUuREVGQVVMVF81WFgsXG4gICAgICByZXNwb25zZUhlYWRlcnM6IHtcbiAgICAgICAgXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW5cIjogXCInKidcIixcbiAgICAgICAgXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzXCI6IFwiJyonXCIsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDdXN0b21Eb21haW4oXG4gICAgY3VzdG9tRG9tYWluPzogc3RyaW5nIHwgQXBpR2F0ZXdheVYxQXBpQ3VzdG9tRG9tYWluUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gQ2FzZTogY3VzdG9tRG9tYWluIGlzIG5vdCBzZXRcbiAgICBpZiAoY3VzdG9tRG9tYWluID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBUbyBiZSBpbXBsZW1lbnRlZDogdG8gYWxsb3cgbW9yZSBmbGV4aWJsZSB1c2UgY2FzZXMsIFNTVCBzaG91bGQgc3VwcG9ydCAzIG1vcmUgdXNlIGNhc2VzOlxuICAgIC8vICAxLiBBbGxvdyB1c2VyIHBhc3NpbmcgaW4gYGhvc3RlZFpvbmVgIG9iamVjdC4gVGhlIHVzZSBjYXNlIGlzIHdoZW4gdGhlcmUgYXJlIG11bHRpcGxlXG4gICAgLy8gICAgIEhvc3RlZFpvbmVzIHdpdGggdGhlIHNhbWUgZG9tYWluLCBidXQgb25lIGlzIHB1YmxpYywgYW5kIG9uZSBpcyBwcml2YXRlLlxuICAgIC8vICAyLiBBbGxvdyB1c2VyIHBhc3NpbmcgaW4gYGNlcnRpZmljYXRlYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyBmb3IgdXNlciB0byBjcmVhdGUgd2lsZGNhcmRcbiAgICAvLyAgICAgY2VydGlmaWNhdGUgb3IgdXNpbmcgYW4gaW1wb3J0ZWQgY2VydGlmaWNhdGUuXG4gICAgLy8gIDMuIEFsbG93IHVzZXIgcGFzc2luZyBpbiBgYXBpZ0RvbWFpbk5hbWVgIG9iamVjdC4gVGhlIHVzZSBjYXNlIGlzIGEgdXNlciBjcmVhdGVzIG11bHRpcGxlIEFQSVxuICAgIC8vICAgICBlbmRwb2ludHMsIGFuZCBpcyBtYXBwaW5nIHRoZW0gdW5kZXIgdGhlIHNhbWUgY3VzdG9tIGRvbWFpbi4gYHNzdC5BcGlgIG5lZWRzIHRvIGV4cG9zZSB0aGVcbiAgICAvLyAgICAgYGFwaWdEb21haW5OYW1lYCBjb25zdHJ1Y3QgY3JlYXRlZCBpbiB0aGUgZmlyc3QgQXBpLCBhbmQgbGV0cyB1c2VyIHBhc3MgaXQgaW4gd2hlbiBjcmVhdGluZ1xuICAgIC8vICAgICB0aGUgc2Vjb25kIEFwaS5cblxuICAgIGxldCBkb21haW5OYW1lLFxuICAgICAgaG9zdGVkWm9uZSxcbiAgICAgIGhvc3RlZFpvbmVEb21haW4sXG4gICAgICBjZXJ0aWZpY2F0ZSxcbiAgICAgIGFwaWdEb21haW5OYW1lLFxuICAgICAgYmFzZVBhdGgsXG4gICAgICBlbmRwb2ludFR5cGUsXG4gICAgICBtdGxzLFxuICAgICAgc2VjdXJpdHlQb2xpY3k7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBQYXJzZSBpbnB1dFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgLy8gQ2FzZTogY3VzdG9tRG9tYWluIGlzIGEgc3RyaW5nXG4gICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIC8vIHZhbGlkYXRlOiBjdXN0b21Eb21haW4gaXMgYSBUT0tFTiBzdHJpbmdcbiAgICAgIC8vIGllLiBpbXBvcnRlZCBTU00gdmFsdWU6IHNzbS5TdHJpbmdQYXJhbWV0ZXIudmFsdWVGb3JTdHJpbmdQYXJhbWV0ZXIoKVxuICAgICAgaWYgKGNkay5Ub2tlbi5pc1VucmVzb2x2ZWQoY3VzdG9tRG9tYWluKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFlvdSBhbHNvIG5lZWQgdG8gc3BlY2lmeSB0aGUgXCJob3N0ZWRab25lXCIgaWYgdGhlIFwiZG9tYWluTmFtZVwiIGlzIHBhc3NlZCBpbiBhcyBhIHJlZmVyZW5jZS5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW47XG4gICAgICB0aGlzLmFzc2VydERvbWFpbk5hbWVJc0xvd2VyQ2FzZShkb21haW5OYW1lKTtcbiAgICAgIGhvc3RlZFpvbmVEb21haW4gPSBjdXN0b21Eb21haW4uc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuICAgIH1cblxuICAgIC8vIENhc2U6IGN1c3RvbURvbWFpbi5kb21haW5OYW1lIG5vdCBleGlzdHNcbiAgICBlbHNlIGlmICghY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBcImRvbWFpbk5hbWVcIiBpbiBBcGkncyBjdXN0b21Eb21haW4gc2V0dGluZ2ApO1xuICAgIH1cblxuICAgIC8vIENhc2U6IGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGlzIGEgc3RyaW5nXG4gICAgZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5kb21haW5OYW1lID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG5cbiAgICAgIC8vIHBhcnNlIGN1c3RvbURvbWFpbi5kb21haW5OYW1lXG4gICAgICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChjdXN0b21Eb21haW4uZG9tYWluTmFtZSkpIHtcbiAgICAgICAgLy8gSWYgY3VzdG9tRG9tYWluIGlzIGEgVE9LRU4gc3RyaW5nLCBcImhvc3RlZFpvbmVcIiBoYXMgdG8gYmUgcGFzc2VkIGluLiBUaGlzXG4gICAgICAgIC8vIGlzIGJlY2F1c2UgXCJob3N0ZWRab25lXCIgY2Fubm90IGJlIHBhcnNlZCBmcm9tIGEgVE9LRU4gdmFsdWUuXG4gICAgICAgIGlmICghY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgWW91IGFsc28gbmVlZCB0byBzcGVjaWZ5IHRoZSBcImhvc3RlZFpvbmVcIiBpZiB0aGUgXCJkb21haW5OYW1lXCIgaXMgcGFzc2VkIGluIGFzIGEgcmVmZXJlbmNlLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcbiAgICAgICAgdGhpcy5hc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHBhcnNlIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lXG4gICAgICBpZiAoIWN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICAgIGhvc3RlZFpvbmVEb21haW4gPSBkb21haW5OYW1lLnNwbGl0KFwiLlwiKS5zbGljZSgxKS5qb2luKFwiLlwiKTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGhvc3RlZFpvbmVEb21haW4gPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZTtcbiAgICAgIH1cblxuICAgICAgY2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gICAgICBiYXNlUGF0aCA9IGN1c3RvbURvbWFpbi5wYXRoO1xuICAgICAgZW5kcG9pbnRUeXBlID0gY3VzdG9tRG9tYWluLmVuZHBvaW50VHlwZTtcbiAgICAgIG10bHMgPSBjdXN0b21Eb21haW4ubXRscztcbiAgICAgIHNlY3VyaXR5UG9saWN5ID0gY3VzdG9tRG9tYWluLnNlY3VyaXR5UG9saWN5O1xuICAgIH1cblxuICAgIC8vIENhc2U6IGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGlzIGEgY29uc3RydWN0XG4gICAgZWxzZSB7XG4gICAgICBhcGlnRG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lO1xuXG4gICAgICAvLyBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBpcyBpbXBvcnRlZFxuICAgICAgaWYgKGFwaWdEb21haW5OYW1lICYmIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJob3N0ZWRab25lXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoYXBpZ0RvbWFpbk5hbWUgJiYgY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjZXJ0aWZpY2F0ZVwiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFwaWdEb21haW5OYW1lICYmIGN1c3RvbURvbWFpbi5lbmRwb2ludFR5cGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImVuZHBvaW50VHlwZVwiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFwaWdEb21haW5OYW1lICYmIGN1c3RvbURvbWFpbi5tdGxzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJtdGxzXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoYXBpZ0RvbWFpbk5hbWUgJiYgY3VzdG9tRG9tYWluLnNlY3VyaXR5UG9saWN5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJzZWN1cml0eVBvbGljeVwiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBiYXNlUGF0aCA9IGN1c3RvbURvbWFpbi5wYXRoO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEZpbmQgaG9zdGVkIHpvbmVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAoIWFwaWdEb21haW5OYW1lICYmICFob3N0ZWRab25lKSB7XG4gICAgICAvLyBMb29rIHVwIGhvc3RlZCB6b25lXG4gICAgICBpZiAoIWhvc3RlZFpvbmUgJiYgaG9zdGVkWm9uZURvbWFpbikge1xuICAgICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBob3N0ZWRab25lRG9tYWluLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgY2VydGlmaWNhdGVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAoIWFwaWdEb21haW5OYW1lICYmICFjZXJ0aWZpY2F0ZSkge1xuICAgICAgaWYgKGVuZHBvaW50VHlwZSA9PT0gYXBpZy5FbmRwb2ludFR5cGUuRURHRSkge1xuICAgICAgICBjZXJ0aWZpY2F0ZSA9IG5ldyBhY20uRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGUoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIkNyb3NzUmVnaW9uQ2VydGlmaWNhdGVcIixcbiAgICAgICAgICB7XG4gICAgICAgICAgICBkb21haW5OYW1lOiBkb21haW5OYW1lIGFzIHN0cmluZyxcbiAgICAgICAgICAgIGhvc3RlZFpvbmU6IGhvc3RlZFpvbmUgYXMgcm91dGU1My5JSG9zdGVkWm9uZSxcbiAgICAgICAgICAgIHJlZ2lvbjogXCJ1cy1lYXN0LTFcIixcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjZXJ0aWZpY2F0ZSA9IG5ldyBhY20uQ2VydGlmaWNhdGUodGhpcywgXCJDZXJ0aWZpY2F0ZVwiLCB7XG4gICAgICAgICAgZG9tYWluTmFtZTogZG9tYWluTmFtZSBhcyBzdHJpbmcsXG4gICAgICAgICAgdmFsaWRhdGlvbjogYWNtLkNlcnRpZmljYXRlVmFsaWRhdGlvbi5mcm9tRG5zKGhvc3RlZFpvbmUpLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYWNtQ2VydGlmaWNhdGUgPSBjZXJ0aWZpY2F0ZTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgQVBJIEdhdGV3YXkgZG9tYWluIG5hbWVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAoIWFwaWdEb21haW5OYW1lICYmIGRvbWFpbk5hbWUpIHtcbiAgICAgIC8vIENyZWF0ZSBjdXN0b20gZG9tYWluIGluIEFQSSBHYXRld2F5XG4gICAgICBhcGlnRG9tYWluTmFtZSA9IG5ldyBhcGlnLkRvbWFpbk5hbWUodGhpcywgXCJEb21haW5OYW1lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZSxcbiAgICAgICAgY2VydGlmaWNhdGU6IGNlcnRpZmljYXRlIGFzIGFjbS5JQ2VydGlmaWNhdGUsXG4gICAgICAgIGVuZHBvaW50VHlwZSxcbiAgICAgICAgbXRscyxcbiAgICAgICAgc2VjdXJpdHlQb2xpY3ksXG4gICAgICB9KTtcbiAgICAgIHRoaXMuYXBpR2F0ZXdheURvbWFpbiA9IGFwaWdEb21haW5OYW1lO1xuXG4gICAgICAvLyBDcmVhdGUgRE5TIHJlY29yZFxuICAgICAgY29uc3QgcmVjb3JkID0gbmV3IHJvdXRlNTMuQVJlY29yZCh0aGlzLCBcIkFsaWFzUmVjb3JkXCIsIHtcbiAgICAgICAgcmVjb3JkTmFtZTogZG9tYWluTmFtZSxcbiAgICAgICAgem9uZTogaG9zdGVkWm9uZSBhcyByb3V0ZTUzLklIb3N0ZWRab25lLFxuICAgICAgICB0YXJnZXQ6IHJvdXRlNTMuUmVjb3JkVGFyZ2V0LmZyb21BbGlhcyhcbiAgICAgICAgICBuZXcgcm91dGU1M1RhcmdldHMuQXBpR2F0ZXdheURvbWFpbihhcGlnRG9tYWluTmFtZSlcbiAgICAgICAgKSxcbiAgICAgIH0pO1xuICAgICAgLy8gbm90ZTogSWYgZG9tYWluTmFtZSBpcyBhIFRPS0VOIHN0cmluZyBpZS4gJHtUT0tFTi4ufSwgdGhlIHJvdXRlNTMuQVJlY29yZFxuICAgICAgLy8gICAgICAgY29uc3RydWN0IHdpbGwgYXBwZW5kIFwiLiR7aG9zdGVkWm9uZU5hbWV9XCIgdG8gdGhlIGVuZCBvZiB0aGUgZG9tYWluLlxuICAgICAgLy8gICAgICAgVGhpcyBpcyBiZWNhdXNlIHRoZSBjb25zdHJ1Y3QgdHJpZXMgdG8gY2hlY2sgaWYgdGhlIHJlY29yZCBuYW1lXG4gICAgICAvLyAgICAgICBlbmRzIHdpdGggdGhlIGRvbWFpbiBuYW1lLiBJZiBub3QsIGl0IHdpbGwgYXBwZW5kIHRoZSBkb21haW4gbmFtZS5cbiAgICAgIC8vICAgICAgIFNvLCB3ZSBuZWVkIHJlbW92ZSB0aGlzIGJlaGF2aW9yLlxuICAgICAgaWYgKGNkay5Ub2tlbi5pc1VucmVzb2x2ZWQoZG9tYWluTmFtZSkpIHtcbiAgICAgICAgY29uc3QgY2ZuUmVjb3JkID0gcmVjb3JkLm5vZGUuZGVmYXVsdENoaWxkIGFzIHJvdXRlNTMuQ2ZuUmVjb3JkU2V0O1xuICAgICAgICBjZm5SZWNvcmQubmFtZSA9IGRvbWFpbk5hbWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGJhc2UgbWFwcGluZ1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGlmIChhcGlnRG9tYWluTmFtZSkge1xuICAgICAgbmV3IGFwaWcuQmFzZVBhdGhNYXBwaW5nKHRoaXMsIFwiQmFzZVBhdGhcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBhcGlnRG9tYWluTmFtZSxcbiAgICAgICAgcmVzdEFwaTogdGhpcy5yZXN0QXBpLFxuICAgICAgICBiYXNlUGF0aCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIE5vdGU6IFdlIG9ubHkga25vdyB0aGUgZnVsbCBjdXN0b20gZG9tYWluIGlmIGRvbWFpbk5hbWUgaXMgYSBzdHJpbmcuXG4gICAgLy8gICAgICAgX2N1c3RvbURvbWFpblVybCB3aWxsIGJlIHVuZGVmaW5lZCBpZiBhcGlnRG9tYWluTmFtZSBpcyBpbXBvcnRlZC5cbiAgICBpZiAoZG9tYWluTmFtZSAmJiAhY2RrLlRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgICAgdGhpcy5fY3VzdG9tRG9tYWluVXJsID0gYmFzZVBhdGhcbiAgICAgICAgPyBgaHR0cHM6Ly8ke2RvbWFpbk5hbWV9LyR7YmFzZVBhdGh9L2BcbiAgICAgICAgOiBgaHR0cHM6Ly8ke2RvbWFpbk5hbWV9YDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGltcG9ydFJlc291cmNlcyhyZXNvdXJjZXM6IHsgW3BhdGg6IHN0cmluZ106IHN0cmluZyB9KTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMocmVzb3VyY2VzKS5mb3JFYWNoKChwYXRoKSA9PiB7XG4gICAgICBjb25zdCByZXNvdXJjZSA9IGFwaWcuUmVzb3VyY2UuZnJvbVJlc291cmNlQXR0cmlidXRlcyhcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYFJlc291cmNlXyR7cGF0aH1gLFxuICAgICAgICB7XG4gICAgICAgICAgcGF0aCxcbiAgICAgICAgICByZXNvdXJjZUlkOiByZXNvdXJjZXNbcGF0aF0sXG4gICAgICAgICAgcmVzdEFwaTogdGhpcy5yZXN0QXBpLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgdGhpcy5pbXBvcnRlZFJlc291cmNlc1twYXRoXSA9IHJlc291cmNlO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZXNvdXJjZUZvclBhdGgocGF0aDogc3RyaW5nKTogYXBpZy5JUmVzb3VyY2Uge1xuICAgIC8vIExvb2t1cCBleGFjdCBtYXRjaCBpbXBvcnRlZCByZXNvdXJjZVxuICAgIGlmICh0aGlzLmltcG9ydGVkUmVzb3VyY2VzW3BhdGhdKSB7XG4gICAgICByZXR1cm4gdGhpcy5pbXBvcnRlZFJlc291cmNlc1twYXRoXTtcbiAgICB9XG5cbiAgICAvLyBMb29rdXAgcGFyZW50cyBtYXRjaGluZyBpbXBvcnRlZCByZXNvdXJjZSBmaXJzdFxuICAgIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdChcIi9cIik7XG4gICAgZm9yIChsZXQgaSA9IHBhcnRzLmxlbmd0aDsgaSA+PSAxOyBpLS0pIHtcbiAgICAgIGNvbnN0IHBhcnRpYWxQYXRoID0gcGFydHMuc2xpY2UoMCwgaSkuam9pbihcIi9cIik7XG4gICAgICBpZiAodGhpcy5pbXBvcnRlZFJlc291cmNlc1twYXJ0aWFsUGF0aF0pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1wb3J0ZWRSZXNvdXJjZXNbcGFydGlhbFBhdGhdLnJlc291cmNlRm9yUGF0aChcbiAgICAgICAgICBwYXJ0cy5zbGljZShpKS5qb2luKFwiL1wiKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdCBjaGlsZCBvZiBpbXBvcnRlZCByZXNvdXJjZXMsIGNyZWF0ZSBvZmYgdGhlIHJvb3RcbiAgICByZXR1cm4gdGhpcy5yZXN0QXBpLnJvb3QucmVzb3VyY2VGb3JQYXRoKHBhdGgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSb3V0ZShcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVWYWx1ZTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wc1xuICApOiBGbiB7XG4gICAgLy8gTm9ybWFsaXplIHJvdXRlUHJvcHNcbiAgICBjb25zdCByb3V0ZVByb3BzID0gKFxuICAgICAgdGhpcy5pc0luc3RhbmNlT2ZBcGlSb3V0ZVByb3BzKHJvdXRlVmFsdWUgYXMgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcylcbiAgICAgICAgPyByb3V0ZVZhbHVlXG4gICAgICAgIDoge1xuICAgICAgICAgICAgZnVuY3Rpb246IHJvdXRlVmFsdWUgYXMgRnVuY3Rpb25EZWZpbml0aW9uLFxuICAgICAgICAgIH1cbiAgICApIGFzIEFwaUdhdGV3YXlWMUFwaVJvdXRlUHJvcHM7XG5cbiAgICAvLyBOb3JtYWxpemUgcm91dGVLZXlcbiAgICByb3V0ZUtleSA9IHRoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpO1xuICAgIGlmICh0aGlzLmZ1bmN0aW9uc1tyb3V0ZUtleV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSByb3V0ZSBhbHJlYWR5IGV4aXN0cyBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEdldCBwYXRoIGFuZCBtZXRob2RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3Qgcm91dGVLZXlQYXJ0cyA9IHJvdXRlS2V5LnNwbGl0KFwiIFwiKTtcbiAgICBpZiAocm91dGVLZXlQYXJ0cy5sZW5ndGggIT09IDIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByb3V0ZSAke3JvdXRlS2V5fWApO1xuICAgIH1cbiAgICBjb25zdCBtZXRob2RTdHIgPSByb3V0ZUtleVBhcnRzWzBdLnRvVXBwZXJDYXNlKCk7XG4gICAgY29uc3QgcGF0aCA9IHJvdXRlS2V5UGFydHNbMV07XG4gICAgY29uc3QgbWV0aG9kID0gYWxsb3dlZE1ldGhvZHMuZmluZCgocGVyKSA9PiBwZXIgPT09IG1ldGhvZFN0cik7XG4gICAgaWYgKCFtZXRob2QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBtZXRob2QgZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBhdGggZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBSZXNvdXJjZXNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgbGV0IHJlc291cmNlO1xuICAgIGlmIChwYXRoLmVuZHNXaXRoKFwiL3twcm94eSt9XCIpKSB7XG4gICAgICBjb25zdCBwYXJlbnRSZXNvdXJjZSA9IHRoaXMuZ2V0UmVzb3VyY2VGb3JQYXRoKFxuICAgICAgICBwYXRoLnNwbGl0KFwiL1wiKS5zbGljZSgwLCAtMSkuam9pbihcIi9cIilcbiAgICAgICk7XG4gICAgICByZXNvdXJjZSA9IHBhcmVudFJlc291cmNlLmFkZFByb3h5KHsgYW55TWV0aG9kOiBmYWxzZSB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzb3VyY2UgPSB0aGlzLmdldFJlc291cmNlRm9yUGF0aChwYXRoKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIE1ldGhvZFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgYExhbWJkYV8ke21ldGhvZFN0cn1fJHtwYXRofWAsXG4gICAgICByb3V0ZVByb3BzLmZ1bmN0aW9uLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIHJvdXRlcyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgQXBpIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuICAgIGNvbnN0IGludGVncmF0aW9uID0gbmV3IGFwaWcuTGFtYmRhSW50ZWdyYXRpb24oXG4gICAgICBsYW1iZGEsXG4gICAgICByb3V0ZVByb3BzLmludGVncmF0aW9uT3B0aW9uc1xuICAgICk7XG4gICAgY29uc3QgbWV0aG9kT3B0aW9ucyA9IHRoaXMuYnVpbGRSb3V0ZU1ldGhvZE9wdGlvbnMoXG4gICAgICByb3V0ZVByb3BzLm1ldGhvZE9wdGlvbnNcbiAgICApO1xuICAgIGNvbnN0IGFwaWdNZXRob2QgPSByZXNvdXJjZS5hZGRNZXRob2QobWV0aG9kLCBpbnRlZ3JhdGlvbiwgbWV0aG9kT3B0aW9ucyk7XG5cbiAgICAvLyBBZGQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBmdW5jdGlvbiBpcyBhbiBBcGkgcm91dGUuXG4gICAgLy8gSWYgaXQgaXMsIHdoZW4gXCJzc3Qgc3RhcnRcIiBpcyBub3QgY29ubmVjdGVkLCB3ZSB3YW50IHRvIHJldHVybiBhbiA1MDBcbiAgICAvLyBzdGF0dXMgY29kZSBhbmQgYSBkZXNjcmlwdGl2ZSBlcnJvciBtZXNzYWdlLlxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGlmIChyb290LmxvY2FsKSB7XG4gICAgICBsYW1iZGEuYWRkRW52aXJvbm1lbnQoXCJTU1RfREVCVUdfSVNfQVBJX1JPVVRFXCIsIFwiMVwiLCB7XG4gICAgICAgIHJlbW92ZUluRWRnZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBIYW5kbGUgbWFudWFsbHkgY3JlYXRlZCBEZXBsb3ltZW50IHJlc291cmNlIChpZS4gaW1wb3J0ZWQgUkVTVCBBUEkpXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGlmICh0aGlzLl9kZXBsb3ltZW50KSB7XG4gICAgICB0aGlzLl9kZXBsb3ltZW50LmFkZFRvTG9naWNhbElkKHsgcm91dGU6IHsgcm91dGVLZXksIHJvdXRlVmFsdWUgfSB9KTtcbiAgICAgIHRoaXMuX2RlcGxveW1lbnQubm9kZS5hZGREZXBlbmRlbmN5KGFwaWdNZXRob2QpO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBTdG9yZSBmdW5jdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICB0aGlzLmZ1bmN0aW9uc1tyb3V0ZUtleV0gPSBsYW1iZGE7XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFJvdXRlTWV0aG9kT3B0aW9ucyhcbiAgICBvcHRpb25zPzogYXBpZy5NZXRob2RPcHRpb25zXG4gICk6IGFwaWcuTWV0aG9kT3B0aW9ucyB7XG4gICAgLy8gTWVyZ2UgbWV0aG9kIG9wdGlvbnNcbiAgICBjb25zdCBtZXRob2RPcHRpb25zID0ge1xuICAgICAgYXV0aG9yaXphdGlvblR5cGU6IHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlLFxuICAgICAgLi4uKG9wdGlvbnMgfHwge30pLFxuICAgIH07XG5cbiAgICAvLyBTZXQgYXV0aG9yaXphdGlvbiBpbmZvXG4gICAgaWYgKFxuICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemF0aW9uVHlwZSAhPT0gYXBpZy5BdXRob3JpemF0aW9uVHlwZS5OT05FICYmXG4gICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25UeXBlICE9PSBhcGlnLkF1dGhvcml6YXRpb25UeXBlLklBTVxuICAgICkge1xuICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemVyID1cbiAgICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemVyIHx8IHRoaXMuZGVmYXVsdEF1dGhvcml6ZXI7XG4gICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25TY29wZXMgPVxuICAgICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25TY29wZXMgfHwgdGhpcy5kZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcztcbiAgICB9XG5cbiAgICByZXR1cm4gbWV0aG9kT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgaXNJbnN0YW5jZU9mQXBpUm91dGVQcm9wcyhcbiAgICBvYmplY3Q6IEFwaUdhdGV3YXlWMUFwaVJvdXRlUHJvcHNcbiAgKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9iamVjdC5mdW5jdGlvbiAhPT0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcm91dGVLZXkuc3BsaXQoL1xccysvKS5qb2luKFwiIFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGRvbWFpbk5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChkb21haW5OYW1lICE9PSBkb21haW5OYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGRvbWFpbiBuYW1lIG5lZWRzIHRvIGJlIGluIGxvd2VyY2FzZWApO1xuICAgIH1cbiAgfVxufVxuIl19