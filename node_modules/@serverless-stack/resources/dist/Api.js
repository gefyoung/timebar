"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Api = exports.ApiPayloadFormatVersion = exports.ApiAuthorizationType = void 0;
const constructs_1 = require("constructs");
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const apigIntegrations = __importStar(require("@aws-cdk/aws-apigatewayv2-integrations-alpha"));
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const apigV2Domain = __importStar(require("./util/apiGatewayV2Domain"));
const apigV2AccessLog = __importStar(require("./util/apiGatewayV2AccessLog"));
const allowedMethods = [
    apig.HttpMethod.ANY,
    apig.HttpMethod.GET,
    apig.HttpMethod.PUT,
    apig.HttpMethod.POST,
    apig.HttpMethod.HEAD,
    apig.HttpMethod.PATCH,
    apig.HttpMethod.DELETE,
    apig.HttpMethod.OPTIONS,
];
var ApiAuthorizationType;
(function (ApiAuthorizationType) {
    ApiAuthorizationType["JWT"] = "JWT";
    ApiAuthorizationType["NONE"] = "NONE";
    ApiAuthorizationType["CUSTOM"] = "CUSTOM";
    ApiAuthorizationType["AWS_IAM"] = "AWS_IAM";
})(ApiAuthorizationType = exports.ApiAuthorizationType || (exports.ApiAuthorizationType = {}));
var ApiPayloadFormatVersion;
(function (ApiPayloadFormatVersion) {
    ApiPayloadFormatVersion["V1"] = "1.0";
    ApiPayloadFormatVersion["V2"] = "2.0";
})(ApiPayloadFormatVersion = exports.ApiPayloadFormatVersion || (exports.ApiPayloadFormatVersion = {}));
/////////////////////
// Construct
/////////////////////
class Api extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        props = props || {};
        const { httpApi, routes, cors, accessLog, customDomain, defaultFunctionProps, defaultAuthorizer, defaultAuthorizationType, defaultAuthorizationScopes, defaultPayloadFormatVersion, defaultThrottlingBurstLimit, defaultThrottlingRateLimit, } = props;
        this.routesData = {};
        this.permissionsAttachedForAllRoutes = [];
        this.defaultFunctionProps = defaultFunctionProps;
        this.defaultAuthorizer = defaultAuthorizer;
        this.defaultAuthorizationType = defaultAuthorizationType;
        this.defaultAuthorizationScopes = defaultAuthorizationScopes;
        this.defaultPayloadFormatVersion = defaultPayloadFormatVersion;
        ////////////////////
        // Create Api
        ////////////////////
        if (Construct_1.isCDKConstruct(httpApi)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when "httpApi" is a construct`);
            }
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when "httpApi" is a construct`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "httpApi" is a construct`);
            }
            if (props.stages !== undefined) {
                throw new Error(`Cannot configure the "stages" when "httpApi" is a construct`);
            }
            this.httpApi = httpApi;
        }
        else {
            const httpApiProps = (httpApi || {});
            // Validate input
            if (httpApiProps.corsPreflight !== undefined) {
                throw new Error(`Cannot configure the "httpApi.corsPreflight" in the Api`);
            }
            if (httpApiProps.defaultDomainMapping !== undefined) {
                throw new Error(`Cannot configure the "httpApi.defaultDomainMapping" in the Api`);
            }
            // Handle CORS
            const corsPreflight = this.buildCorsConfig(cors);
            // Handle Custom Domain
            const customDomainData = apigV2Domain.buildCustomDomainData(this, customDomain);
            let defaultDomainMapping;
            if (customDomainData) {
                if (customDomainData.isApigDomainCreated) {
                    this.apiGatewayDomain =
                        customDomainData.apigDomain;
                }
                if (customDomainData.isCertificatedCreated) {
                    this.acmCertificate = customDomainData.certificate;
                }
                defaultDomainMapping = {
                    domainName: customDomainData.apigDomain,
                    mappingKey: customDomainData.mappingKey,
                };
                this._customDomainUrl = `https://${customDomainData.url}`;
            }
            this.httpApi = new apig.HttpApi(this, "Api", Object.assign({ apiName: root.logicalPrefixedName(id), corsPreflight,
                defaultDomainMapping }, httpApiProps));
            const httpStage = this.httpApi.defaultStage;
            // Configure throttling
            if (defaultThrottlingBurstLimit &&
                defaultThrottlingRateLimit &&
                httpStage.node.defaultChild) {
                const cfnStage = httpStage.node.defaultChild;
                cfnStage.defaultRouteSettings = Object.assign(Object.assign({}, (cfnStage.routeSettings || {})), { throttlingBurstLimit: defaultThrottlingBurstLimit, throttlingRateLimit: defaultThrottlingRateLimit });
                this.defaultThrottlingBurstLimit = defaultThrottlingBurstLimit;
                this.defaultThrottlingRateLimit = defaultThrottlingRateLimit;
            }
            // Configure access log
            for (const def of props.stages || []) {
                const stage = new apig.HttpStage(this, "Stage" + def.stageName, Object.assign(Object.assign({}, def), { httpApi: this.httpApi }));
                apigV2AccessLog.buildAccessLogData(this, accessLog, stage, false);
            }
            if (this.httpApi.defaultStage)
                this.accessLogGroup = apigV2AccessLog.buildAccessLogData(this, accessLog, this.httpApi.defaultStage, true);
        }
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        this.addRoutes(this, routes || {});
    }
    get url() {
        return this.httpApi.apiEndpoint;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.routesData);
    }
    get httpApiArn() {
        const stack = Stack_1.Stack.of(this);
        return `arn:${stack.partition}:apigateway:${stack.region}::/apis/${this.httpApi.apiId}`;
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            this.addRoute(scope, routeKey, routes[routeKey]);
        });
    }
    getFunction(routeKey) {
        const route = this.routesData[this.normalizeRouteKey(routeKey)];
        return route instanceof Function_1.Function ? route : undefined;
    }
    attachPermissions(permissions) {
        Object.values(this.routesData)
            .filter((route) => route instanceof Function_1.Function)
            .forEach((route) => route.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "Api",
            data: {
                httpApiId: this.httpApi.apiId,
                customDomainUrl: this._customDomainUrl,
                routes: Object.entries(this.routesData).map(([key, data]) => {
                    return {
                        route: key,
                        fn: Construct_1.getFunctionRef(data),
                    };
                }),
            },
        };
    }
    buildCorsConfig(cors) {
        // Handle cors: false
        if (cors === false) {
            return;
        }
        // Handle cors: true | undefined
        else if (cors === undefined || cors === true) {
            return {
                allowHeaders: ["*"],
                allowMethods: [apig.CorsHttpMethod.ANY],
                allowOrigins: ["*"],
            };
        }
        // Handle cors: apig.CorsPreflightOptions
        else {
            return cors;
        }
    }
    addRoute(scope, routeKey, routeValue) {
        ///////////////////
        // Normalize routeProps
        ///////////////////
        let routeProps;
        if (routeValue.albListener) {
            routeProps = routeValue;
        }
        else if (routeValue.url) {
            routeProps = routeValue;
        }
        else if (routeValue.function) {
            routeProps = routeValue;
        }
        else {
            routeProps = {
                function: routeValue,
            };
        }
        ///////////////////
        // Normalize routeKey
        ///////////////////
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.routesData[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Get path and method
        ///////////////////
        let postfixName;
        let httpRouteKey;
        let methodStr;
        let path;
        if (routeKey === "$default") {
            postfixName = "default";
            httpRouteKey = apig.HttpRouteKey.DEFAULT;
            methodStr = "ANY";
            path = routeKey;
        }
        else {
            const routeKeyParts = routeKey.split(" ");
            if (routeKeyParts.length !== 2) {
                throw new Error(`Invalid route ${routeKey}`);
            }
            methodStr = routeKeyParts[0].toUpperCase();
            path = routeKeyParts[1];
            const method = allowedMethods.find((per) => per === methodStr);
            if (!method) {
                throw new Error(`Invalid method defined for "${routeKey}"`);
            }
            if (path.length === 0) {
                throw new Error(`Invalid path defined for "${routeKey}"`);
            }
            postfixName = `${methodStr}_${path}`;
            httpRouteKey = apig.HttpRouteKey.with(path, method);
        }
        ///////////////////
        // Get authorization
        ///////////////////
        const { authorizationType, authorizer, authorizationScopes } = this.buildRouteAuth(routeKey, routeProps);
        ///////////////////
        // Create route
        ///////////////////
        let integration;
        if (routeProps.albListener) {
            routeProps = routeProps;
            integration = this.createAlbIntegration(scope, routeKey, routeProps, postfixName);
        }
        else if (routeProps.url) {
            routeProps = routeProps;
            integration = this.createHttpIntegration(scope, routeKey, routeProps, postfixName);
        }
        else {
            routeProps = routeProps;
            integration = this.createFunctionIntegration(scope, routeKey, routeProps, postfixName);
        }
        const route = new apig.HttpRoute(scope, `Route_${postfixName}`, {
            httpApi: this.httpApi,
            routeKey: httpRouteKey,
            integration,
            authorizer,
            authorizationScopes,
        });
        ////////////////////
        // Configure route authorization type
        ////////////////////
        // Note: we need to explicitly set `cfnRoute.authorizationType` to `NONE`
        //       because if it were set to `AWS_IAM`, and then it is removed from
        //       the CloudFormation template (ie. set to undefined), CloudFormation
        //       doesn't updates the route. The route's authorizationType would still
        //       be `AWS_IAM`.
        if (authorizationType === ApiAuthorizationType.AWS_IAM ||
            authorizationType === ApiAuthorizationType.NONE) {
            if (!route.node.defaultChild) {
                throw new Error(`Failed to define the default route for "${routeKey}"`);
            }
            const cfnRoute = route.node.defaultChild;
            cfnRoute.authorizationType = authorizationType;
        }
    }
    createHttpIntegration(scope, routeKey, routeProps, postfixName) {
        ///////////////////
        // Create integration
        ///////////////////
        const errorMessage = `Invalid HTTP integration method defined for "${routeKey}"`;
        const integration = new apigIntegrations.HttpUrlIntegration(`Integration_${postfixName}`, routeProps.url, {
            method: this.buildHttpMethod(routeProps.method, errorMessage),
        });
        // Store route
        this.routesData[routeKey] = routeProps.url;
        return integration;
    }
    createAlbIntegration(scope, routeKey, routeProps, postfixName) {
        ///////////////////
        // Create integration
        ///////////////////
        const errorMessage = `Invalid ALB integration method defined for "${routeKey}"`;
        const integration = new apigIntegrations.HttpAlbIntegration(`Integration_${postfixName}`, routeProps.albListener, {
            method: this.buildHttpMethod(routeProps.method, errorMessage),
            vpcLink: routeProps.vpcLink,
        });
        // Store route
        this.routesData[routeKey] = routeProps.albListener;
        return integration;
    }
    createFunctionIntegration(scope, routeKey, routeProps, postfixName) {
        ///////////////////
        // Get payload format
        ///////////////////
        const payloadFormatVersion = routeProps.payloadFormatVersion ||
            this.defaultPayloadFormatVersion ||
            ApiPayloadFormatVersion.V2;
        if (!Object.values(ApiPayloadFormatVersion).includes(payloadFormatVersion)) {
            throw new Error(`sst.Api does not currently support ${payloadFormatVersion} payload format version. Only "V1" and "V2" are currently supported.`);
        }
        const integrationPayloadFormatVersion = payloadFormatVersion === ApiPayloadFormatVersion.V1
            ? apig.PayloadFormatVersion.VERSION_1_0
            : apig.PayloadFormatVersion.VERSION_2_0;
        ///////////////////
        // Create Function
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, `Lambda_${postfixName}`, routeProps.function, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        // Add an environment variable to determine if the function is an Api route.
        // If it is, when "sst start" is not connected, we want to return an 500
        // status code and a descriptive error message.
        const root = scope.node.root;
        if (root.local) {
            lambda.addEnvironment("SST_DEBUG_IS_API_ROUTE", "1", {
                removeInEdge: true,
            });
        }
        ///////////////////
        // Create integration
        ///////////////////
        const integration = new apigIntegrations.HttpLambdaIntegration(`Integration_${postfixName}`, lambda, {
            payloadFormatVersion: integrationPayloadFormatVersion,
        });
        // Store route
        this.routesData[routeKey] = lambda;
        // Attached existing permissions
        this.permissionsAttachedForAllRoutes.forEach((permissions) => lambda.attachPermissions(permissions));
        return integration;
    }
    buildRouteAuth(routeKey, routeProps) {
        let authorizer, authorizationScopes;
        const authorizationType = routeProps.authorizationType ||
            this.defaultAuthorizationType ||
            ApiAuthorizationType.NONE;
        if (!Object.values(ApiAuthorizationType).includes(authorizationType)) {
            throw new Error(`sst.Api does not currently support ${authorizationType}. Only "AWS_IAM", "JWT" and "CUSTOM" are currently supported.`);
        }
        // Handle JWT Auth
        if (authorizationType === ApiAuthorizationType.JWT) {
            authorizer = routeProps.authorizer || this.defaultAuthorizer;
            authorizationScopes =
                routeProps.authorizationScopes || this.defaultAuthorizationScopes;
            if (!authorizer) {
                throw new Error(`Missing JWT authorizer for "${routeKey}"`);
            }
        }
        // Handle CUSTOM Auth
        else if (authorizationType === ApiAuthorizationType.CUSTOM) {
            authorizer = routeProps.authorizer || this.defaultAuthorizer;
            if (!authorizer) {
                throw new Error(`Missing custom Lambda authorizer for "${routeKey}"`);
            }
        }
        return { authorizationType, authorizer, authorizationScopes };
    }
    normalizeRouteKey(routeKey) {
        return routeKey.split(/\s+/).join(" ");
    }
    buildHttpMethod(method, errorMessage) {
        if (method === undefined) {
            return undefined;
        }
        if (typeof method === "string") {
            method = method.toUpperCase();
            method = allowedMethods.find((per) => per === method);
            if (!method) {
                throw new Error(errorMessage);
            }
        }
        return method;
    }
}
exports.Api = Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBR3ZDLHNFQUF3RDtBQUV4RCwrRkFBaUY7QUFLakYsbUNBQWdDO0FBQ2hDLDJDQUEyRTtBQUMzRSx5Q0FBK0U7QUFFL0Usd0VBQTBEO0FBQzFELDhFQUFnRTtBQUVoRSxNQUFNLGNBQWMsR0FBRztJQUNyQixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7SUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO0lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRztJQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUk7SUFDcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJO0lBQ3BCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSztJQUNyQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU07SUFDdEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPO0NBQ3hCLENBQUM7QUFFRixJQUFZLG9CQUtYO0FBTEQsV0FBWSxvQkFBb0I7SUFDOUIsbUNBQVcsQ0FBQTtJQUNYLHFDQUFhLENBQUE7SUFDYix5Q0FBaUIsQ0FBQTtJQUNqQiwyQ0FBbUIsQ0FBQTtBQUNyQixDQUFDLEVBTFcsb0JBQW9CLEdBQXBCLDRCQUFvQixLQUFwQiw0QkFBb0IsUUFLL0I7QUFFRCxJQUFZLHVCQUdYO0FBSEQsV0FBWSx1QkFBdUI7SUFDakMscUNBQVUsQ0FBQTtJQUNWLHFDQUFVLENBQUE7QUFDWixDQUFDLEVBSFcsdUJBQXVCLEdBQXZCLCtCQUF1QixLQUF2QiwrQkFBdUIsUUFHbEM7QUFxRUQscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxHQUFJLFNBQVEsc0JBQVM7SUFxQmhDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBZ0I7UUFDeEQsS0FBSyxDQUFDLEtBQUss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LGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxNQUFNLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDL0I7U0FDRjtRQUVELE9BQU8sTUFBeUIsQ0FBQztJQUNuQyxDQUFDO0NBQ0Y7QUFuakJELGtCQW1qQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgKiBhcyBjZm5BcGlnIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyLWFscGhhXCI7XG5pbXBvcnQgKiBhcyBhcGlnQXV0aG9yaXplcnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItYXV0aG9yaXplcnMtYWxwaGFcIjtcbmltcG9ydCAqIGFzIGFwaWdJbnRlZ3JhdGlvbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zLWFscGhhXCI7XG5pbXBvcnQgKiBhcyBlbGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lbGFzdGljbG9hZGJhbGFuY2luZ3YyXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbG9nc1wiO1xuXG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSBcIi4vU3RhY2tcIjtcbmltcG9ydCB7IGdldEZ1bmN0aW9uUmVmLCBTU1RDb25zdHJ1Y3QsIGlzQ0RLQ29uc3RydWN0IH0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5pbXBvcnQgeyBGdW5jdGlvbiBhcyBGbiwgRnVuY3Rpb25Qcm9wcywgRnVuY3Rpb25EZWZpbml0aW9uIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5pbXBvcnQgKiBhcyBhcGlnVjJEb21haW4gZnJvbSBcIi4vdXRpbC9hcGlHYXRld2F5VjJEb21haW5cIjtcbmltcG9ydCAqIGFzIGFwaWdWMkFjY2Vzc0xvZyBmcm9tIFwiLi91dGlsL2FwaUdhdGV3YXlWMkFjY2Vzc0xvZ1wiO1xuXG5jb25zdCBhbGxvd2VkTWV0aG9kcyA9IFtcbiAgYXBpZy5IdHRwTWV0aG9kLkFOWSxcbiAgYXBpZy5IdHRwTWV0aG9kLkdFVCxcbiAgYXBpZy5IdHRwTWV0aG9kLlBVVCxcbiAgYXBpZy5IdHRwTWV0aG9kLlBPU1QsXG4gIGFwaWcuSHR0cE1ldGhvZC5IRUFELFxuICBhcGlnLkh0dHBNZXRob2QuUEFUQ0gsXG4gIGFwaWcuSHR0cE1ldGhvZC5ERUxFVEUsXG4gIGFwaWcuSHR0cE1ldGhvZC5PUFRJT05TLFxuXTtcblxuZXhwb3J0IGVudW0gQXBpQXV0aG9yaXphdGlvblR5cGUge1xuICBKV1QgPSBcIkpXVFwiLFxuICBOT05FID0gXCJOT05FXCIsXG4gIENVU1RPTSA9IFwiQ1VTVE9NXCIsXG4gIEFXU19JQU0gPSBcIkFXU19JQU1cIixcbn1cblxuZXhwb3J0IGVudW0gQXBpUGF5bG9hZEZvcm1hdFZlcnNpb24ge1xuICBWMSA9IFwiMS4wXCIsXG4gIFYyID0gXCIyLjBcIixcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBBcGlQcm9wcyB7XG4gIHJlYWRvbmx5IGh0dHBBcGk/OiBhcGlnLklIdHRwQXBpIHwgYXBpZy5IdHRwQXBpUHJvcHM7XG4gIHJlYWRvbmx5IHJvdXRlcz86IHtcbiAgICBba2V5OiBzdHJpbmddOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzXG4gICAgICB8IEFwaUh0dHBSb3V0ZVByb3BzXG4gICAgICB8IEFwaUFsYlJvdXRlUHJvcHM7XG4gIH07XG4gIHJlYWRvbmx5IGNvcnM/OiBib29sZWFuIHwgYXBpZy5Db3JzUHJlZmxpZ2h0T3B0aW9ucztcbiAgcmVhZG9ubHkgYWNjZXNzTG9nPzogYm9vbGVhbiB8IHN0cmluZyB8IEFwaUFjY2Vzc0xvZ1Byb3BzO1xuICByZWFkb25seSBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBBcGlDdXN0b21Eb21haW5Qcm9wcztcblxuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICByZWFkb25seSBkZWZhdWx0QXV0aG9yaXplcj86XG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cEp3dEF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwTGFtYmRhQXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBVc2VyUG9vbEF1dGhvcml6ZXI7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG4gIHJlYWRvbmx5IGRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbj86IEFwaVBheWxvYWRGb3JtYXRWZXJzaW9uO1xuICByZWFkb25seSBkZWZhdWx0VGhyb3R0bGluZ0J1cnN0TGltaXQ/OiBudW1iZXI7XG4gIHJlYWRvbmx5IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0PzogbnVtYmVyO1xuICByZWFkb25seSBzdGFnZXM/OiBPbWl0PGFwaWcuSHR0cFN0YWdlUHJvcHMsIFwiaHR0cEFwaVwiPltdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUZ1bmN0aW9uUm91dGVQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHBheWxvYWRGb3JtYXRWZXJzaW9uPzogQXBpUGF5bG9hZEZvcm1hdFZlcnNpb247XG4gIHJlYWRvbmx5IGF1dGhvcml6YXRpb25UeXBlPzogQXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cExhbWJkYUF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwVXNlclBvb2xBdXRob3JpemVyO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpSHR0cFJvdXRlUHJvcHMge1xuICByZWFkb25seSB1cmw6IHN0cmluZztcbiAgcmVhZG9ubHkgbWV0aG9kPzogc3RyaW5nIHwgYXBpZy5IdHRwTWV0aG9kO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICByZWFkb25seSBhdXRob3JpemVyPzpcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwSnd0QXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBMYW1iZGFBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUFsYlJvdXRlUHJvcHMge1xuICByZWFkb25seSBhbGJMaXN0ZW5lcjogZWxiLklBcHBsaWNhdGlvbkxpc3RlbmVyO1xuICByZWFkb25seSBtZXRob2Q/OiBzdHJpbmcgfCBhcGlnLkh0dHBNZXRob2Q7XG4gIHJlYWRvbmx5IHZwY0xpbms/OiBhcGlnLklWcGNMaW5rO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICByZWFkb25seSBhdXRob3JpemVyPzpcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwSnd0QXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBMYW1iZGFBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgdHlwZSBBcGlDdXN0b21Eb21haW5Qcm9wcyA9IGFwaWdWMkRvbWFpbi5DdXN0b21Eb21haW5Qcm9wcztcbmV4cG9ydCB0eXBlIEFwaUFjY2Vzc0xvZ1Byb3BzID0gYXBpZ1YyQWNjZXNzTG9nLkFjY2Vzc0xvZ1Byb3BzO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBBcGkgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgaHR0cEFwaTogYXBpZy5IdHRwQXBpO1xuICBwdWJsaWMgcmVhZG9ubHkgYWNjZXNzTG9nR3JvdXA/OiBsb2dzLkxvZ0dyb3VwO1xuICBwdWJsaWMgcmVhZG9ubHkgYXBpR2F0ZXdheURvbWFpbj86IGFwaWcuRG9tYWluTmFtZTtcbiAgcHVibGljIHJlYWRvbmx5IGFjbUNlcnRpZmljYXRlPzogYWNtLkNlcnRpZmljYXRlO1xuICBwcml2YXRlIHJlYWRvbmx5IF9jdXN0b21Eb21haW5Vcmw/OiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcm91dGVzRGF0YToge1xuICAgIFtrZXk6IHN0cmluZ106IEZuIHwgc3RyaW5nIHwgZWxiLklBcHBsaWNhdGlvbkxpc3RlbmVyO1xuICB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemVyPzpcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwSnd0QXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBMYW1iZGFBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0QXV0aG9yaXphdGlvblR5cGU/OiBBcGlBdXRob3JpemF0aW9uVHlwZTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbj86IEFwaVBheWxvYWRGb3JtYXRWZXJzaW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdD86IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdD86IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEFwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIHByb3BzID0gcHJvcHMgfHwge307XG4gICAgY29uc3Qge1xuICAgICAgaHR0cEFwaSxcbiAgICAgIHJvdXRlcyxcbiAgICAgIGNvcnMsXG4gICAgICBhY2Nlc3NMb2csXG4gICAgICBjdXN0b21Eb21haW4sXG4gICAgICBkZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGRlZmF1bHRBdXRob3JpemVyLFxuICAgICAgZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlLFxuICAgICAgZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXMsXG4gICAgICBkZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb24sXG4gICAgICBkZWZhdWx0VGhyb3R0bGluZ0J1cnN0TGltaXQsXG4gICAgICBkZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdCxcbiAgICB9ID0gcHJvcHM7XG4gICAgdGhpcy5yb3V0ZXNEYXRhID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6ZXIgPSBkZWZhdWx0QXV0aG9yaXplcjtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uVHlwZSA9IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZTtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzID0gZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM7XG4gICAgdGhpcy5kZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb24gPSBkZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb247XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBBcGlcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KGh0dHBBcGkpKSB7XG4gICAgICBpZiAoY29ycyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjb3JzXCIgd2hlbiBcImh0dHBBcGlcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhY2Nlc3NMb2cgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiYWNjZXNzTG9nXCIgd2hlbiBcImh0dHBBcGlcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChjdXN0b21Eb21haW4gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY3VzdG9tRG9tYWluXCIgd2hlbiBcImh0dHBBcGlcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChwcm9wcy5zdGFnZXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwic3RhZ2VzXCIgd2hlbiBcImh0dHBBcGlcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuaHR0cEFwaSA9IGh0dHBBcGkgYXMgYXBpZy5IdHRwQXBpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBodHRwQXBpUHJvcHMgPSAoaHR0cEFwaSB8fCB7fSkgYXMgYXBpZy5IdHRwQXBpUHJvcHM7XG5cbiAgICAgIC8vIFZhbGlkYXRlIGlucHV0XG4gICAgICBpZiAoaHR0cEFwaVByb3BzLmNvcnNQcmVmbGlnaHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaHR0cEFwaS5jb3JzUHJlZmxpZ2h0XCIgaW4gdGhlIEFwaWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChodHRwQXBpUHJvcHMuZGVmYXVsdERvbWFpbk1hcHBpbmcgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaHR0cEFwaS5kZWZhdWx0RG9tYWluTWFwcGluZ1wiIGluIHRoZSBBcGlgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEhhbmRsZSBDT1JTXG4gICAgICBjb25zdCBjb3JzUHJlZmxpZ2h0ID0gdGhpcy5idWlsZENvcnNDb25maWcoY29ycyk7XG5cbiAgICAgIC8vIEhhbmRsZSBDdXN0b20gRG9tYWluXG4gICAgICBjb25zdCBjdXN0b21Eb21haW5EYXRhID0gYXBpZ1YyRG9tYWluLmJ1aWxkQ3VzdG9tRG9tYWluRGF0YShcbiAgICAgICAgdGhpcyxcbiAgICAgICAgY3VzdG9tRG9tYWluXG4gICAgICApO1xuICAgICAgbGV0IGRlZmF1bHREb21haW5NYXBwaW5nO1xuICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEpIHtcbiAgICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEuaXNBcGlnRG9tYWluQ3JlYXRlZCkge1xuICAgICAgICAgIHRoaXMuYXBpR2F0ZXdheURvbWFpbiA9XG4gICAgICAgICAgICBjdXN0b21Eb21haW5EYXRhLmFwaWdEb21haW4gYXMgYXBpZy5Eb21haW5OYW1lO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjdXN0b21Eb21haW5EYXRhLmlzQ2VydGlmaWNhdGVkQ3JlYXRlZCkge1xuICAgICAgICAgIHRoaXMuYWNtQ2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW5EYXRhLmNlcnRpZmljYXRlIGFzIGFjbS5DZXJ0aWZpY2F0ZTtcbiAgICAgICAgfVxuICAgICAgICBkZWZhdWx0RG9tYWluTWFwcGluZyA9IHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW5EYXRhLmFwaWdEb21haW4sXG4gICAgICAgICAgbWFwcGluZ0tleTogY3VzdG9tRG9tYWluRGF0YS5tYXBwaW5nS2V5LFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9jdXN0b21Eb21haW5VcmwgPSBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbkRhdGEudXJsfWA7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuaHR0cEFwaSA9IG5ldyBhcGlnLkh0dHBBcGkodGhpcywgXCJBcGlcIiwge1xuICAgICAgICBhcGlOYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICBjb3JzUHJlZmxpZ2h0LFxuICAgICAgICBkZWZhdWx0RG9tYWluTWFwcGluZyxcbiAgICAgICAgLi4uaHR0cEFwaVByb3BzLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGh0dHBTdGFnZSA9IHRoaXMuaHR0cEFwaS5kZWZhdWx0U3RhZ2UgYXMgYXBpZy5IdHRwU3RhZ2U7XG5cbiAgICAgIC8vIENvbmZpZ3VyZSB0aHJvdHRsaW5nXG4gICAgICBpZiAoXG4gICAgICAgIGRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdCAmJlxuICAgICAgICBkZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdCAmJlxuICAgICAgICBodHRwU3RhZ2Uubm9kZS5kZWZhdWx0Q2hpbGRcbiAgICAgICkge1xuICAgICAgICBjb25zdCBjZm5TdGFnZSA9IGh0dHBTdGFnZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBjZm5BcGlnLkNmblN0YWdlO1xuICAgICAgICBjZm5TdGFnZS5kZWZhdWx0Um91dGVTZXR0aW5ncyA9IHtcbiAgICAgICAgICAuLi4oY2ZuU3RhZ2Uucm91dGVTZXR0aW5ncyB8fCB7fSksXG4gICAgICAgICAgdGhyb3R0bGluZ0J1cnN0TGltaXQ6IGRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdCxcbiAgICAgICAgICB0aHJvdHRsaW5nUmF0ZUxpbWl0OiBkZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdCxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5kZWZhdWx0VGhyb3R0bGluZ0J1cnN0TGltaXQgPSBkZWZhdWx0VGhyb3R0bGluZ0J1cnN0TGltaXQ7XG4gICAgICAgIHRoaXMuZGVmYXVsdFRocm90dGxpbmdSYXRlTGltaXQgPSBkZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdDtcbiAgICAgIH1cblxuICAgICAgLy8gQ29uZmlndXJlIGFjY2VzcyBsb2dcbiAgICAgIGZvciAoY29uc3QgZGVmIG9mIHByb3BzLnN0YWdlcyB8fCBbXSkge1xuICAgICAgICBjb25zdCBzdGFnZSA9IG5ldyBhcGlnLkh0dHBTdGFnZSh0aGlzLCBcIlN0YWdlXCIgKyBkZWYuc3RhZ2VOYW1lLCB7XG4gICAgICAgICAgLi4uZGVmLFxuICAgICAgICAgIGh0dHBBcGk6IHRoaXMuaHR0cEFwaSxcbiAgICAgICAgfSk7XG4gICAgICAgIGFwaWdWMkFjY2Vzc0xvZy5idWlsZEFjY2Vzc0xvZ0RhdGEodGhpcywgYWNjZXNzTG9nLCBzdGFnZSwgZmFsc2UpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5odHRwQXBpLmRlZmF1bHRTdGFnZSlcbiAgICAgICAgdGhpcy5hY2Nlc3NMb2dHcm91cCA9IGFwaWdWMkFjY2Vzc0xvZy5idWlsZEFjY2Vzc0xvZ0RhdGEoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBhY2Nlc3NMb2csXG4gICAgICAgICAgdGhpcy5odHRwQXBpLmRlZmF1bHRTdGFnZSBhcyBhcGlnLkh0dHBTdGFnZSxcbiAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIHJvdXRlc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgdGhpcy5hZGRSb3V0ZXModGhpcywgcm91dGVzIHx8IHt9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cEFwaS5hcGlFbmRwb2ludDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuX2N1c3RvbURvbWFpblVybDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcm91dGVzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5yb3V0ZXNEYXRhKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgaHR0cEFwaUFybigpOiBzdHJpbmcge1xuICAgIGNvbnN0IHN0YWNrID0gU3RhY2sub2YodGhpcyk7XG4gICAgcmV0dXJuIGBhcm46JHtzdGFjay5wYXJ0aXRpb259OmFwaWdhdGV3YXk6JHtzdGFjay5yZWdpb259OjovYXBpcy8ke3RoaXMuaHR0cEFwaS5hcGlJZH1gO1xuICB9XG5cbiAgcHVibGljIGFkZFJvdXRlcyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlczoge1xuICAgICAgW2tleTogc3RyaW5nXTpcbiAgICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgICAgfCBBcGlGdW5jdGlvblJvdXRlUHJvcHNcbiAgICAgICAgfCBBcGlIdHRwUm91dGVQcm9wc1xuICAgICAgICB8IEFwaUFsYlJvdXRlUHJvcHM7XG4gICAgfVxuICApOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhyb3V0ZXMpLmZvckVhY2goKHJvdXRlS2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuYWRkUm91dGUoc2NvcGUsIHJvdXRlS2V5LCByb3V0ZXNbcm91dGVLZXldKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGdW5jdGlvbihyb3V0ZUtleTogc3RyaW5nKTogRm4gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHJvdXRlID0gdGhpcy5yb3V0ZXNEYXRhW3RoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpXTtcbiAgICByZXR1cm4gcm91dGUgaW5zdGFuY2VvZiBGbiA/IHJvdXRlIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5yb3V0ZXNEYXRhKVxuICAgICAgLmZpbHRlcigocm91dGUpID0+IHJvdXRlIGluc3RhbmNlb2YgRm4pXG4gICAgICAuZm9yRWFjaCgocm91dGUpID0+IChyb3V0ZSBhcyBGbikuYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1JvdXRlKFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gdGhpcy5nZXRGdW5jdGlvbihyb3V0ZUtleSk7XG4gICAgaWYgKCFmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGF0dGFjaCBwZXJtaXNzaW9ucy4gUm91dGUgXCIke3JvdXRlS2V5fVwiIGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIkFwaVwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBodHRwQXBpSWQ6IHRoaXMuaHR0cEFwaS5hcGlJZCxcbiAgICAgICAgY3VzdG9tRG9tYWluVXJsOiB0aGlzLl9jdXN0b21Eb21haW5VcmwsXG4gICAgICAgIHJvdXRlczogT2JqZWN0LmVudHJpZXModGhpcy5yb3V0ZXNEYXRhKS5tYXAoKFtrZXksIGRhdGFdKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJvdXRlOiBrZXksXG4gICAgICAgICAgICBmbjogZ2V0RnVuY3Rpb25SZWYoZGF0YSksXG4gICAgICAgICAgfTtcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQ29yc0NvbmZpZyhcbiAgICBjb3JzOiBib29sZWFuIHwgYXBpZy5Db3JzUHJlZmxpZ2h0T3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiBhcGlnLkNvcnNQcmVmbGlnaHRPcHRpb25zIHwgdW5kZWZpbmVkIHtcbiAgICAvLyBIYW5kbGUgY29yczogZmFsc2VcbiAgICBpZiAoY29ycyA9PT0gZmFsc2UpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgY29yczogdHJ1ZSB8IHVuZGVmaW5lZFxuICAgIGVsc2UgaWYgKGNvcnMgPT09IHVuZGVmaW5lZCB8fCBjb3JzID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhbGxvd0hlYWRlcnM6IFtcIipcIl0sXG4gICAgICAgIGFsbG93TWV0aG9kczogW2FwaWcuQ29yc0h0dHBNZXRob2QuQU5ZXSxcbiAgICAgICAgYWxsb3dPcmlnaW5zOiBbXCIqXCJdLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgY29yczogYXBpZy5Db3JzUHJlZmxpZ2h0T3B0aW9uc1xuICAgIGVsc2Uge1xuICAgICAgcmV0dXJuIGNvcnM7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRSb3V0ZShcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVWYWx1ZTpcbiAgICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgICB8IEFwaUZ1bmN0aW9uUm91dGVQcm9wc1xuICAgICAgfCBBcGlIdHRwUm91dGVQcm9wc1xuICAgICAgfCBBcGlBbGJSb3V0ZVByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBOb3JtYWxpemUgcm91dGVQcm9wc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBsZXQgcm91dGVQcm9wcztcbiAgICBpZiAoKHJvdXRlVmFsdWUgYXMgQXBpQWxiUm91dGVQcm9wcykuYWxiTGlzdGVuZXIpIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVZhbHVlIGFzIEFwaUFsYlJvdXRlUHJvcHM7XG4gICAgfSBlbHNlIGlmICgocm91dGVWYWx1ZSBhcyBBcGlIdHRwUm91dGVQcm9wcykudXJsKSB7XG4gICAgICByb3V0ZVByb3BzID0gcm91dGVWYWx1ZSBhcyBBcGlIdHRwUm91dGVQcm9wcztcbiAgICB9IGVsc2UgaWYgKChyb3V0ZVZhbHVlIGFzIEFwaUZ1bmN0aW9uUm91dGVQcm9wcykuZnVuY3Rpb24pIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVZhbHVlIGFzIEFwaUZ1bmN0aW9uUm91dGVQcm9wcztcbiAgICB9IGVsc2Uge1xuICAgICAgcm91dGVQcm9wcyA9IHtcbiAgICAgICAgZnVuY3Rpb246IHJvdXRlVmFsdWUgYXMgRnVuY3Rpb25EZWZpbml0aW9uLFxuICAgICAgfSBhcyBBcGlGdW5jdGlvblJvdXRlUHJvcHM7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIE5vcm1hbGl6ZSByb3V0ZUtleVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICByb3V0ZUtleSA9IHRoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpO1xuICAgIGlmICh0aGlzLnJvdXRlc0RhdGFbcm91dGVLZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEEgcm91dGUgYWxyZWFkeSBleGlzdHMgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBHZXQgcGF0aCBhbmQgbWV0aG9kXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGxldCBwb3N0Zml4TmFtZTtcbiAgICBsZXQgaHR0cFJvdXRlS2V5O1xuICAgIGxldCBtZXRob2RTdHI6IHN0cmluZztcbiAgICBsZXQgcGF0aDtcbiAgICBpZiAocm91dGVLZXkgPT09IFwiJGRlZmF1bHRcIikge1xuICAgICAgcG9zdGZpeE5hbWUgPSBcImRlZmF1bHRcIjtcbiAgICAgIGh0dHBSb3V0ZUtleSA9IGFwaWcuSHR0cFJvdXRlS2V5LkRFRkFVTFQ7XG4gICAgICBtZXRob2RTdHIgPSBcIkFOWVwiO1xuICAgICAgcGF0aCA9IHJvdXRlS2V5O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByb3V0ZUtleVBhcnRzID0gcm91dGVLZXkuc3BsaXQoXCIgXCIpO1xuICAgICAgaWYgKHJvdXRlS2V5UGFydHMubGVuZ3RoICE9PSAyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByb3V0ZSAke3JvdXRlS2V5fWApO1xuICAgICAgfVxuICAgICAgbWV0aG9kU3RyID0gcm91dGVLZXlQYXJ0c1swXS50b1VwcGVyQ2FzZSgpO1xuICAgICAgcGF0aCA9IHJvdXRlS2V5UGFydHNbMV07XG4gICAgICBjb25zdCBtZXRob2QgPSBhbGxvd2VkTWV0aG9kcy5maW5kKChwZXIpID0+IHBlciA9PT0gbWV0aG9kU3RyKTtcbiAgICAgIGlmICghbWV0aG9kKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBtZXRob2QgZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgICB9XG4gICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBhdGggZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgICB9XG5cbiAgICAgIHBvc3RmaXhOYW1lID0gYCR7bWV0aG9kU3RyfV8ke3BhdGh9YDtcbiAgICAgIGh0dHBSb3V0ZUtleSA9IGFwaWcuSHR0cFJvdXRlS2V5LndpdGgocGF0aCwgbWV0aG9kKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gR2V0IGF1dGhvcml6YXRpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgeyBhdXRob3JpemF0aW9uVHlwZSwgYXV0aG9yaXplciwgYXV0aG9yaXphdGlvblNjb3BlcyB9ID1cbiAgICAgIHRoaXMuYnVpbGRSb3V0ZUF1dGgocm91dGVLZXksIHJvdXRlUHJvcHMpO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSByb3V0ZVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBsZXQgaW50ZWdyYXRpb247XG4gICAgaWYgKChyb3V0ZVByb3BzIGFzIEFwaUFsYlJvdXRlUHJvcHMpLmFsYkxpc3RlbmVyKSB7XG4gICAgICByb3V0ZVByb3BzID0gcm91dGVQcm9wcyBhcyBBcGlBbGJSb3V0ZVByb3BzO1xuICAgICAgaW50ZWdyYXRpb24gPSB0aGlzLmNyZWF0ZUFsYkludGVncmF0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgcm91dGVLZXksXG4gICAgICAgIHJvdXRlUHJvcHMsXG4gICAgICAgIHBvc3RmaXhOYW1lXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoKHJvdXRlUHJvcHMgYXMgQXBpSHR0cFJvdXRlUHJvcHMpLnVybCkge1xuICAgICAgcm91dGVQcm9wcyA9IHJvdXRlUHJvcHMgYXMgQXBpSHR0cFJvdXRlUHJvcHM7XG4gICAgICBpbnRlZ3JhdGlvbiA9IHRoaXMuY3JlYXRlSHR0cEludGVncmF0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgcm91dGVLZXksXG4gICAgICAgIHJvdXRlUHJvcHMsXG4gICAgICAgIHBvc3RmaXhOYW1lXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByb3V0ZVByb3BzID0gcm91dGVQcm9wcyBhcyBBcGlGdW5jdGlvblJvdXRlUHJvcHM7XG4gICAgICBpbnRlZ3JhdGlvbiA9IHRoaXMuY3JlYXRlRnVuY3Rpb25JbnRlZ3JhdGlvbihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIHJvdXRlS2V5LFxuICAgICAgICByb3V0ZVByb3BzLFxuICAgICAgICBwb3N0Zml4TmFtZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByb3V0ZSA9IG5ldyBhcGlnLkh0dHBSb3V0ZShzY29wZSwgYFJvdXRlXyR7cG9zdGZpeE5hbWV9YCwge1xuICAgICAgaHR0cEFwaTogdGhpcy5odHRwQXBpLFxuICAgICAgcm91dGVLZXk6IGh0dHBSb3V0ZUtleSxcbiAgICAgIGludGVncmF0aW9uLFxuICAgICAgYXV0aG9yaXplcixcbiAgICAgIGF1dGhvcml6YXRpb25TY29wZXMsXG4gICAgfSk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSByb3V0ZSBhdXRob3JpemF0aW9uIHR5cGVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIE5vdGU6IHdlIG5lZWQgdG8gZXhwbGljaXRseSBzZXQgYGNmblJvdXRlLmF1dGhvcml6YXRpb25UeXBlYCB0byBgTk9ORWBcbiAgICAvLyAgICAgICBiZWNhdXNlIGlmIGl0IHdlcmUgc2V0IHRvIGBBV1NfSUFNYCwgYW5kIHRoZW4gaXQgaXMgcmVtb3ZlZCBmcm9tXG4gICAgLy8gICAgICAgdGhlIENsb3VkRm9ybWF0aW9uIHRlbXBsYXRlIChpZS4gc2V0IHRvIHVuZGVmaW5lZCksIENsb3VkRm9ybWF0aW9uXG4gICAgLy8gICAgICAgZG9lc24ndCB1cGRhdGVzIHRoZSByb3V0ZS4gVGhlIHJvdXRlJ3MgYXV0aG9yaXphdGlvblR5cGUgd291bGQgc3RpbGxcbiAgICAvLyAgICAgICBiZSBgQVdTX0lBTWAuXG4gICAgaWYgKFxuICAgICAgYXV0aG9yaXphdGlvblR5cGUgPT09IEFwaUF1dGhvcml6YXRpb25UeXBlLkFXU19JQU0gfHxcbiAgICAgIGF1dGhvcml6YXRpb25UeXBlID09PSBBcGlBdXRob3JpemF0aW9uVHlwZS5OT05FXG4gICAgKSB7XG4gICAgICBpZiAoIXJvdXRlLm5vZGUuZGVmYXVsdENoaWxkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRlZmluZSB0aGUgZGVmYXVsdCByb3V0ZSBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBjZm5Sb3V0ZSA9IHJvdXRlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGNmbkFwaWcuQ2ZuUm91dGU7XG4gICAgICBjZm5Sb3V0ZS5hdXRob3JpemF0aW9uVHlwZSA9IGF1dGhvcml6YXRpb25UeXBlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlSHR0cEludGVncmF0aW9uKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICByb3V0ZVByb3BzOiBBcGlIdHRwUm91dGVQcm9wcyxcbiAgICBwb3N0Zml4TmFtZTogc3RyaW5nXG4gICk6IGFwaWcuSHR0cFJvdXRlSW50ZWdyYXRpb24ge1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgaW50ZWdyYXRpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYEludmFsaWQgSFRUUCBpbnRlZ3JhdGlvbiBtZXRob2QgZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYDtcbiAgICBjb25zdCBpbnRlZ3JhdGlvbiA9IG5ldyBhcGlnSW50ZWdyYXRpb25zLkh0dHBVcmxJbnRlZ3JhdGlvbihcbiAgICAgIGBJbnRlZ3JhdGlvbl8ke3Bvc3RmaXhOYW1lfWAsXG4gICAgICByb3V0ZVByb3BzLnVybCxcbiAgICAgIHtcbiAgICAgICAgbWV0aG9kOiB0aGlzLmJ1aWxkSHR0cE1ldGhvZChyb3V0ZVByb3BzLm1ldGhvZCwgZXJyb3JNZXNzYWdlKSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gU3RvcmUgcm91dGVcbiAgICB0aGlzLnJvdXRlc0RhdGFbcm91dGVLZXldID0gcm91dGVQcm9wcy51cmw7XG5cbiAgICByZXR1cm4gaW50ZWdyYXRpb247XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUFsYkludGVncmF0aW9uKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICByb3V0ZVByb3BzOiBBcGlBbGJSb3V0ZVByb3BzLFxuICAgIHBvc3RmaXhOYW1lOiBzdHJpbmdcbiAgKTogYXBpZy5IdHRwUm91dGVJbnRlZ3JhdGlvbiB7XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBpbnRlZ3JhdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgSW52YWxpZCBBTEIgaW50ZWdyYXRpb24gbWV0aG9kIGRlZmluZWQgZm9yIFwiJHtyb3V0ZUtleX1cImA7XG4gICAgY29uc3QgaW50ZWdyYXRpb24gPSBuZXcgYXBpZ0ludGVncmF0aW9ucy5IdHRwQWxiSW50ZWdyYXRpb24oXG4gICAgICBgSW50ZWdyYXRpb25fJHtwb3N0Zml4TmFtZX1gLFxuICAgICAgcm91dGVQcm9wcy5hbGJMaXN0ZW5lcixcbiAgICAgIHtcbiAgICAgICAgbWV0aG9kOiB0aGlzLmJ1aWxkSHR0cE1ldGhvZChyb3V0ZVByb3BzLm1ldGhvZCwgZXJyb3JNZXNzYWdlKSxcbiAgICAgICAgdnBjTGluazogcm91dGVQcm9wcy52cGNMaW5rLFxuICAgICAgfVxuICAgICk7XG5cbiAgICAvLyBTdG9yZSByb3V0ZVxuICAgIHRoaXMucm91dGVzRGF0YVtyb3V0ZUtleV0gPSByb3V0ZVByb3BzLmFsYkxpc3RlbmVyO1xuXG4gICAgcmV0dXJuIGludGVncmF0aW9uO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZUZ1bmN0aW9uSW50ZWdyYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHJvdXRlUHJvcHM6IEFwaUZ1bmN0aW9uUm91dGVQcm9wcyxcbiAgICBwb3N0Zml4TmFtZTogc3RyaW5nXG4gICk6IGFwaWcuSHR0cFJvdXRlSW50ZWdyYXRpb24ge1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBHZXQgcGF5bG9hZCBmb3JtYXRcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgcGF5bG9hZEZvcm1hdFZlcnNpb24gPVxuICAgICAgcm91dGVQcm9wcy5wYXlsb2FkRm9ybWF0VmVyc2lvbiB8fFxuICAgICAgdGhpcy5kZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb24gfHxcbiAgICAgIEFwaVBheWxvYWRGb3JtYXRWZXJzaW9uLlYyO1xuICAgIGlmIChcbiAgICAgICFPYmplY3QudmFsdWVzKEFwaVBheWxvYWRGb3JtYXRWZXJzaW9uKS5pbmNsdWRlcyhwYXlsb2FkRm9ybWF0VmVyc2lvbilcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHNzdC5BcGkgZG9lcyBub3QgY3VycmVudGx5IHN1cHBvcnQgJHtwYXlsb2FkRm9ybWF0VmVyc2lvbn0gcGF5bG9hZCBmb3JtYXQgdmVyc2lvbi4gT25seSBcIlYxXCIgYW5kIFwiVjJcIiBhcmUgY3VycmVudGx5IHN1cHBvcnRlZC5gXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBpbnRlZ3JhdGlvblBheWxvYWRGb3JtYXRWZXJzaW9uID1cbiAgICAgIHBheWxvYWRGb3JtYXRWZXJzaW9uID09PSBBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbi5WMVxuICAgICAgICA/IGFwaWcuUGF5bG9hZEZvcm1hdFZlcnNpb24uVkVSU0lPTl8xXzBcbiAgICAgICAgOiBhcGlnLlBheWxvYWRGb3JtYXRWZXJzaW9uLlZFUlNJT05fMl8wO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBGdW5jdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgYExhbWJkYV8ke3Bvc3RmaXhOYW1lfWAsXG4gICAgICByb3V0ZVByb3BzLmZ1bmN0aW9uLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIHJvdXRlcyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgQXBpIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuICAgIC8vIEFkZCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSB0byBkZXRlcm1pbmUgaWYgdGhlIGZ1bmN0aW9uIGlzIGFuIEFwaSByb3V0ZS5cbiAgICAvLyBJZiBpdCBpcywgd2hlbiBcInNzdCBzdGFydFwiIGlzIG5vdCBjb25uZWN0ZWQsIHdlIHdhbnQgdG8gcmV0dXJuIGFuIDUwMFxuICAgIC8vIHN0YXR1cyBjb2RlIGFuZCBhIGRlc2NyaXB0aXZlIGVycm9yIG1lc3NhZ2UuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgaWYgKHJvb3QubG9jYWwpIHtcbiAgICAgIGxhbWJkYS5hZGRFbnZpcm9ubWVudChcIlNTVF9ERUJVR19JU19BUElfUk9VVEVcIiwgXCIxXCIsIHtcbiAgICAgICAgcmVtb3ZlSW5FZGdlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBpbnRlZ3JhdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBpbnRlZ3JhdGlvbiA9IG5ldyBhcGlnSW50ZWdyYXRpb25zLkh0dHBMYW1iZGFJbnRlZ3JhdGlvbihcbiAgICAgIGBJbnRlZ3JhdGlvbl8ke3Bvc3RmaXhOYW1lfWAsXG4gICAgICBsYW1iZGEsXG4gICAgICB7XG4gICAgICAgIHBheWxvYWRGb3JtYXRWZXJzaW9uOiBpbnRlZ3JhdGlvblBheWxvYWRGb3JtYXRWZXJzaW9uLFxuICAgICAgfVxuICAgICk7XG5cbiAgICAvLyBTdG9yZSByb3V0ZVxuICAgIHRoaXMucm91dGVzRGF0YVtyb3V0ZUtleV0gPSBsYW1iZGE7XG5cbiAgICAvLyBBdHRhY2hlZCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgIGxhbWJkYS5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuXG4gICAgcmV0dXJuIGludGVncmF0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFJvdXRlQXV0aChcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHJvdXRlUHJvcHM6IEFwaUZ1bmN0aW9uUm91dGVQcm9wcyB8IEFwaUh0dHBSb3V0ZVByb3BzIHwgQXBpQWxiUm91dGVQcm9wc1xuICApIHtcbiAgICBsZXQgYXV0aG9yaXplciwgYXV0aG9yaXphdGlvblNjb3BlcztcbiAgICBjb25zdCBhdXRob3JpemF0aW9uVHlwZSA9XG4gICAgICByb3V0ZVByb3BzLmF1dGhvcml6YXRpb25UeXBlIHx8XG4gICAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uVHlwZSB8fFxuICAgICAgQXBpQXV0aG9yaXphdGlvblR5cGUuTk9ORTtcblxuICAgIGlmICghT2JqZWN0LnZhbHVlcyhBcGlBdXRob3JpemF0aW9uVHlwZSkuaW5jbHVkZXMoYXV0aG9yaXphdGlvblR5cGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBzc3QuQXBpIGRvZXMgbm90IGN1cnJlbnRseSBzdXBwb3J0ICR7YXV0aG9yaXphdGlvblR5cGV9LiBPbmx5IFwiQVdTX0lBTVwiLCBcIkpXVFwiIGFuZCBcIkNVU1RPTVwiIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIEpXVCBBdXRoXG4gICAgaWYgKGF1dGhvcml6YXRpb25UeXBlID09PSBBcGlBdXRob3JpemF0aW9uVHlwZS5KV1QpIHtcbiAgICAgIGF1dGhvcml6ZXIgPSByb3V0ZVByb3BzLmF1dGhvcml6ZXIgfHwgdGhpcy5kZWZhdWx0QXV0aG9yaXplcjtcbiAgICAgIGF1dGhvcml6YXRpb25TY29wZXMgPVxuICAgICAgICByb3V0ZVByb3BzLmF1dGhvcml6YXRpb25TY29wZXMgfHwgdGhpcy5kZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcztcbiAgICAgIGlmICghYXV0aG9yaXplcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgSldUIGF1dGhvcml6ZXIgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEhhbmRsZSBDVVNUT00gQXV0aFxuICAgIGVsc2UgaWYgKGF1dGhvcml6YXRpb25UeXBlID09PSBBcGlBdXRob3JpemF0aW9uVHlwZS5DVVNUT00pIHtcbiAgICAgIGF1dGhvcml6ZXIgPSByb3V0ZVByb3BzLmF1dGhvcml6ZXIgfHwgdGhpcy5kZWZhdWx0QXV0aG9yaXplcjtcbiAgICAgIGlmICghYXV0aG9yaXplcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgY3VzdG9tIExhbWJkYSBhdXRob3JpemVyIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBhdXRob3JpemF0aW9uVHlwZSwgYXV0aG9yaXplciwgYXV0aG9yaXphdGlvblNjb3BlcyB9O1xuICB9XG5cbiAgcHJpdmF0ZSBub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcm91dGVLZXkuc3BsaXQoL1xccysvKS5qb2luKFwiIFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRIdHRwTWV0aG9kKFxuICAgIG1ldGhvZDogc3RyaW5nIHwgYXBpZy5IdHRwTWV0aG9kIHwgdW5kZWZpbmVkLFxuICAgIGVycm9yTWVzc2FnZTogc3RyaW5nXG4gICk6IGFwaWcuSHR0cE1ldGhvZCB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKG1ldGhvZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBtZXRob2QgPSBtZXRob2QudG9VcHBlckNhc2UoKTtcbiAgICAgIG1ldGhvZCA9IGFsbG93ZWRNZXRob2RzLmZpbmQoKHBlcikgPT4gcGVyID09PSBtZXRob2QpO1xuICAgICAgaWYgKCFtZXRob2QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1ldGhvZCBhcyBhcGlnLkh0dHBNZXRob2Q7XG4gIH1cbn1cbiJdfQ==