"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventBus = void 0;
const constructs_1 = require("constructs");
const events = __importStar(require("aws-cdk-lib/aws-events"));
const eventsTargets = __importStar(require("aws-cdk-lib/aws-events-targets"));
const Queue_1 = require("./Queue");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class EventBus extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { eventBridgeEventBus, rules, defaultFunctionProps } = props || {};
        this.targetsData = {};
        this.permissionsAttachedForAllTargets = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create EventBus
        ////////////////////
        if (Construct_1.isCDKConstruct(eventBridgeEventBus)) {
            this.eventBridgeEventBus = eventBridgeEventBus;
        }
        else {
            const ebProps = (eventBridgeEventBus || {});
            this.eventBridgeEventBus = new events.EventBus(this, "EventBus", Object.assign({ 
                // Note: Set default eventBusName only if eventSourceName is not configured.
                //       This is because both cannot be configured at the same time.
                eventBusName: ebProps.eventSourceName
                    ? undefined
                    : root.logicalPrefixedName(id) }, ebProps));
        }
        ///////////////////////////
        // Create Targets
        ///////////////////////////
        this.addRules(this, rules || {});
    }
    get eventBusArn() {
        return this.eventBridgeEventBus.eventBusArn;
    }
    get eventBusName() {
        return this.eventBridgeEventBus.eventBusName;
    }
    addRules(scope, rules) {
        Object.entries(rules).forEach(([ruleKey, rule]) => this.addRule(scope, ruleKey, rule));
    }
    attachPermissions(permissions) {
        Object.keys(this.targetsData).forEach((ruleKey) => {
            this.targetsData[ruleKey]
                .filter((target) => target instanceof Function_1.Function)
                .forEach((target) => target.attachPermissions(permissions));
        });
        this.permissionsAttachedForAllTargets.push(permissions);
    }
    attachPermissionsToTarget(ruleKey, targetIndex, permissions) {
        const rule = this.targetsData[ruleKey];
        if (!rule) {
            throw new Error(`Cannot find the rule "${ruleKey}" in the "${this.node.id}" EventBus.`);
        }
        const target = rule[targetIndex];
        if (!(target instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" EventBus target because it's not a Lambda function`);
        }
        target.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "EventBus",
            data: {
                eventBusName: this.eventBridgeEventBus.eventBusName,
                rules: Object.entries(this.targetsData).map(([key, targets]) => ({
                    key: key,
                    targets: targets.map(Construct_1.getFunctionRef).filter(Boolean),
                })),
            },
        };
    }
    addRule(scope, ruleKey, rule) {
        // Validate input
        // @ts-expect-error "eventBus" is not a prop
        if (rule.eventBus) {
            throw new Error(`Cannot configure the "rule.eventBus" in the "${this.node.id}" EventBus`);
        }
        // Validate rule not redefined
        if (this.targetsData[ruleKey]) {
            throw new Error(`A rule already exists for "${ruleKey}"`);
        }
        // Create Rule
        const root = this.node.root;
        const eventsRule = new events.Rule(scope, ruleKey, Object.assign(Object.assign({ ruleName: root.logicalPrefixedName(ruleKey) }, rule), { eventBus: this.eventBridgeEventBus, targets: [] }));
        // Create Targets
        (rule.targets || []).forEach((target) => this.addTarget(scope, ruleKey, eventsRule, target));
    }
    addTarget(scope, ruleKey, eventsRule, target) {
        if (target instanceof Queue_1.Queue || target.queue) {
            target = target;
            this.addQueueTarget(scope, ruleKey, eventsRule, target);
        }
        else {
            target = target;
            this.addFunctionTarget(scope, ruleKey, eventsRule, target);
        }
    }
    addQueueTarget(scope, ruleKey, eventsRule, target) {
        // Parse target props
        let targetProps;
        let queue;
        if (target instanceof Queue_1.Queue) {
            target = target;
            queue = target;
        }
        else {
            target = target;
            targetProps = target.targetProps;
            queue = target.queue;
        }
        this.targetsData[ruleKey] = this.targetsData[ruleKey] || [];
        this.targetsData[ruleKey].push(queue);
        // Create target
        eventsRule.addTarget(new eventsTargets.SqsQueue(queue.sqsQueue, targetProps));
    }
    addFunctionTarget(scope, ruleKey, eventsRule, target) {
        // Parse target props
        let targetProps;
        let functionDefinition;
        if (target.function) {
            target = target;
            targetProps = target.targetProps;
            functionDefinition = target.function;
        }
        else {
            target = target;
            functionDefinition = target;
        }
        // Create function
        this.targetsData[ruleKey] = this.targetsData[ruleKey] || [];
        const i = this.targetsData[ruleKey].length;
        const fn = Function_1.Function.fromDefinition(scope, `${ruleKey}_target_${i}`, functionDefinition, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the targets using FunctionProps, so the EventBus construct can apply the "defaultFunctionProps" to them.`);
        this.targetsData[ruleKey].push(fn);
        // Create target
        eventsRule.addTarget(new eventsTargets.LambdaFunction(fn, targetProps));
        // Attach existing permissions
        this.permissionsAttachedForAllTargets.forEach((permissions) => fn.attachPermissions(permissions));
    }
}
exports.EventBus = EventBus;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnRCdXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvRXZlbnRCdXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2QywrREFBaUQ7QUFDakQsOEVBQWdFO0FBRWhFLG1DQUFnQztBQUNoQywyQ0FBMkU7QUFDM0UseUNBQStFO0FBbUMvRSxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLFFBQVMsU0FBUSxzQkFBUztJQU1yQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXFCO1FBQzdELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsTUFBTSxFQUFFLG1CQUFtQixFQUFFLEtBQUssRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDekUsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLGdDQUFnQyxHQUFHLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUM7UUFFakQsb0JBQW9CO1FBQ3BCLGtCQUFrQjtRQUNsQixvQkFBb0I7UUFFcEIsSUFBSSwwQkFBYyxDQUFDLG1CQUFtQixDQUFDLEVBQUU7WUFDdkMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLG1CQUFzQyxDQUFDO1NBQ25FO2FBQU07WUFDTCxNQUFNLE9BQU8sR0FBRyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBeUIsQ0FBQztZQUNwRSxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxVQUFVO2dCQUM3RCw0RUFBNEU7Z0JBQzVFLG9FQUFvRTtnQkFDcEUsWUFBWSxFQUFFLE9BQU8sQ0FBQyxlQUFlO29C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TCxNQUFNLEdBQUcsTUFBNEIsQ0FBQztZQUN0QyxrQkFBa0IsR0FBRyxNQUFNLENBQUM7U0FDN0I7UUFFRCxrQkFBa0I7UUFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM1RCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUMzQyxNQUFNLEVBQUUsR0FBRyxtQkFBRSxDQUFDLGNBQWMsQ0FDMUIsS0FBSyxFQUNMLEdBQUcsT0FBTyxXQUFXLENBQUMsRUFBRSxFQUN4QixrQkFBa0IsRUFDbEIsSUFBSSxDQUFDLG9CQUFvQixFQUN6QixvT0FBb08sQ0FDck8sQ0FBQztRQUNGLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRW5DLGdCQUFnQjtRQUNoQixVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksYUFBYSxDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUV4RSw4QkFBOEI7UUFDOUIsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQzVELEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FDbEMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXpORCw0QkF5TkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgZXZlbnRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZXZlbnRzXCI7XG5pbXBvcnQgKiBhcyBldmVudHNUYXJnZXRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZXZlbnRzLXRhcmdldHNcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgUXVldWUgfSBmcm9tIFwiLi9RdWV1ZVwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IHR5cGUgRXZlbnRCdXNQcm9wcyA9IHtcbiAgcmVhZG9ubHkgZXZlbnRCcmlkZ2VFdmVudEJ1cz86IGV2ZW50cy5JRXZlbnRCdXMgfCBldmVudHMuRXZlbnRCdXNQcm9wcztcbiAgcmVhZG9ubHkgcnVsZXM/OiB7IFtrZXk6IHN0cmluZ106IEV2ZW50QnVzQ2RrUnVsZVByb3BzIH07XG4gIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbn07XG5cbmV4cG9ydCB0eXBlIEV2ZW50QnVzQ2RrUnVsZVByb3BzID0gT21pdDxcbiAgZXZlbnRzLlJ1bGVQcm9wcyxcbiAgXCJldmVudEJ1c1wiIHwgXCJ0YXJnZXRzXCJcbj4gJiB7XG4gIHJlYWRvbmx5IHRhcmdldHM/OiAoXG4gICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICB8IEV2ZW50QnVzRnVuY3Rpb25UYXJnZXRQcm9wc1xuICAgIHwgUXVldWVcbiAgICB8IEV2ZW50QnVzUXVldWVUYXJnZXRQcm9wc1xuICApW107XG59O1xuXG5leHBvcnQgdHlwZSBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHMgPSB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHRhcmdldFByb3BzPzogZXZlbnRzVGFyZ2V0cy5MYW1iZGFGdW5jdGlvblByb3BzO1xufTtcblxuZXhwb3J0IHR5cGUgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzID0ge1xuICByZWFkb25seSBxdWV1ZTogUXVldWU7XG4gIHJlYWRvbmx5IHRhcmdldFByb3BzPzogZXZlbnRzVGFyZ2V0cy5TcXNRdWV1ZVByb3BzO1xufTtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgRXZlbnRCdXMgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgZXZlbnRCcmlkZ2VFdmVudEJ1czogZXZlbnRzLklFdmVudEJ1cztcbiAgcHJpdmF0ZSByZWFkb25seSB0YXJnZXRzRGF0YTogeyBba2V5OiBzdHJpbmddOiAoRm4gfCBRdWV1ZSlbXSB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUYXJnZXRzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEV2ZW50QnVzUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgeyBldmVudEJyaWRnZUV2ZW50QnVzLCBydWxlcywgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfSA9IHByb3BzIHx8IHt9O1xuICAgIHRoaXMudGFyZ2V0c0RhdGEgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUYXJnZXRzID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgRXZlbnRCdXNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KGV2ZW50QnJpZGdlRXZlbnRCdXMpKSB7XG4gICAgICB0aGlzLmV2ZW50QnJpZGdlRXZlbnRCdXMgPSBldmVudEJyaWRnZUV2ZW50QnVzIGFzIGV2ZW50cy5FdmVudEJ1cztcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZWJQcm9wcyA9IChldmVudEJyaWRnZUV2ZW50QnVzIHx8IHt9KSBhcyBldmVudHMuRXZlbnRCdXNQcm9wcztcbiAgICAgIHRoaXMuZXZlbnRCcmlkZ2VFdmVudEJ1cyA9IG5ldyBldmVudHMuRXZlbnRCdXModGhpcywgXCJFdmVudEJ1c1wiLCB7XG4gICAgICAgIC8vIE5vdGU6IFNldCBkZWZhdWx0IGV2ZW50QnVzTmFtZSBvbmx5IGlmIGV2ZW50U291cmNlTmFtZSBpcyBub3QgY29uZmlndXJlZC5cbiAgICAgICAgLy8gICAgICAgVGhpcyBpcyBiZWNhdXNlIGJvdGggY2Fubm90IGJlIGNvbmZpZ3VyZWQgYXQgdGhlIHNhbWUgdGltZS5cbiAgICAgICAgZXZlbnRCdXNOYW1lOiBlYlByb3BzLmV2ZW50U291cmNlTmFtZVxuICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICAuLi5lYlByb3BzLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIFRhcmdldHNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIHRoaXMuYWRkUnVsZXModGhpcywgcnVsZXMgfHwge30pO1xuICB9XG5cbiAgcHVibGljIGdldCBldmVudEJ1c0FybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmV2ZW50QnJpZGdlRXZlbnRCdXMuZXZlbnRCdXNBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IGV2ZW50QnVzTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmV2ZW50QnJpZGdlRXZlbnRCdXMuZXZlbnRCdXNOYW1lO1xuICB9XG5cbiAgcHVibGljIGFkZFJ1bGVzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcnVsZXM6IHsgW2tleTogc3RyaW5nXTogRXZlbnRCdXNDZGtSdWxlUHJvcHMgfVxuICApOiB2b2lkIHtcbiAgICBPYmplY3QuZW50cmllcyhydWxlcykuZm9yRWFjaCgoW3J1bGVLZXksIHJ1bGVdKSA9PlxuICAgICAgdGhpcy5hZGRSdWxlKHNjb3BlLCBydWxlS2V5LCBydWxlKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXModGhpcy50YXJnZXRzRGF0YSkuZm9yRWFjaCgocnVsZUtleTogc3RyaW5nKSA9PiB7XG4gICAgICB0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldXG4gICAgICAgIC5maWx0ZXIoKHRhcmdldCkgPT4gdGFyZ2V0IGluc3RhbmNlb2YgRm4pXG4gICAgICAgIC5mb3JFYWNoKCh0YXJnZXQpID0+IHRhcmdldC5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucykpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsVGFyZ2V0cy5wdXNoKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc1RvVGFyZ2V0KFxuICAgIHJ1bGVLZXk6IHN0cmluZyxcbiAgICB0YXJnZXRJbmRleDogbnVtYmVyLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBydWxlID0gdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XTtcbiAgICBpZiAoIXJ1bGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBmaW5kIHRoZSBydWxlIFwiJHtydWxlS2V5fVwiIGluIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIEV2ZW50QnVzLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgdGFyZ2V0ID0gcnVsZVt0YXJnZXRJbmRleF07XG4gICAgaWYgKCEodGFyZ2V0IGluc3RhbmNlb2YgRm4pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgYXR0YWNoIHBlcm1pc3Npb25zIHRvIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIEV2ZW50QnVzIHRhcmdldCBiZWNhdXNlIGl0J3Mgbm90IGEgTGFtYmRhIGZ1bmN0aW9uYFxuICAgICAgKTtcbiAgICB9XG4gICAgdGFyZ2V0LmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJFdmVudEJ1c1wiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBldmVudEJ1c05hbWU6IHRoaXMuZXZlbnRCcmlkZ2VFdmVudEJ1cy5ldmVudEJ1c05hbWUsXG4gICAgICAgIHJ1bGVzOiBPYmplY3QuZW50cmllcyh0aGlzLnRhcmdldHNEYXRhKS5tYXAoKFtrZXksIHRhcmdldHNdKSA9PiAoe1xuICAgICAgICAgIGtleToga2V5LFxuICAgICAgICAgIHRhcmdldHM6IHRhcmdldHMubWFwKGdldEZ1bmN0aW9uUmVmKS5maWx0ZXIoQm9vbGVhbiksXG4gICAgICAgIH0pKSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkUnVsZShcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJ1bGVLZXk6IHN0cmluZyxcbiAgICBydWxlOiBFdmVudEJ1c0Nka1J1bGVQcm9wc1xuICApOiB2b2lkIHtcbiAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgXCJldmVudEJ1c1wiIGlzIG5vdCBhIHByb3BcbiAgICBpZiAocnVsZS5ldmVudEJ1cykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJydWxlLmV2ZW50QnVzXCIgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgRXZlbnRCdXNgXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIHJ1bGUgbm90IHJlZGVmaW5lZFxuICAgIGlmICh0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEEgcnVsZSBhbHJlYWR5IGV4aXN0cyBmb3IgXCIke3J1bGVLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgUnVsZVxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgZXZlbnRzUnVsZSA9IG5ldyBldmVudHMuUnVsZShzY29wZSwgcnVsZUtleSwge1xuICAgICAgcnVsZU5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShydWxlS2V5KSxcbiAgICAgIC4uLnJ1bGUsXG4gICAgICBldmVudEJ1czogdGhpcy5ldmVudEJyaWRnZUV2ZW50QnVzLFxuICAgICAgdGFyZ2V0czogW10sXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgVGFyZ2V0c1xuICAgIChydWxlLnRhcmdldHMgfHwgW10pLmZvckVhY2goKHRhcmdldCkgPT5cbiAgICAgIHRoaXMuYWRkVGFyZ2V0KHNjb3BlLCBydWxlS2V5LCBldmVudHNSdWxlLCB0YXJnZXQpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVGFyZ2V0KFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcnVsZUtleTogc3RyaW5nLFxuICAgIGV2ZW50c1J1bGU6IGV2ZW50cy5SdWxlLFxuICAgIHRhcmdldDpcbiAgICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgICB8IEV2ZW50QnVzRnVuY3Rpb25UYXJnZXRQcm9wc1xuICAgICAgfCBRdWV1ZVxuICAgICAgfCBFdmVudEJ1c1F1ZXVlVGFyZ2V0UHJvcHNcbiAgKTogdm9pZCB7XG4gICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIFF1ZXVlIHx8ICh0YXJnZXQgYXMgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzKS5xdWV1ZSkge1xuICAgICAgdGFyZ2V0ID0gdGFyZ2V0IGFzIFF1ZXVlIHwgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzO1xuICAgICAgdGhpcy5hZGRRdWV1ZVRhcmdldChzY29wZSwgcnVsZUtleSwgZXZlbnRzUnVsZSwgdGFyZ2V0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGFyZ2V0ID0gdGFyZ2V0IGFzIEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEV2ZW50QnVzRnVuY3Rpb25UYXJnZXRQcm9wcztcbiAgICAgIHRoaXMuYWRkRnVuY3Rpb25UYXJnZXQoc2NvcGUsIHJ1bGVLZXksIGV2ZW50c1J1bGUsIHRhcmdldCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRRdWV1ZVRhcmdldChcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJ1bGVLZXk6IHN0cmluZyxcbiAgICBldmVudHNSdWxlOiBldmVudHMuUnVsZSxcbiAgICB0YXJnZXQ6IFF1ZXVlIHwgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIFBhcnNlIHRhcmdldCBwcm9wc1xuICAgIGxldCB0YXJnZXRQcm9wcztcbiAgICBsZXQgcXVldWU7XG4gICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIFF1ZXVlKSB7XG4gICAgICB0YXJnZXQgPSB0YXJnZXQgYXMgUXVldWU7XG4gICAgICBxdWV1ZSA9IHRhcmdldDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGFyZ2V0ID0gdGFyZ2V0IGFzIEV2ZW50QnVzUXVldWVUYXJnZXRQcm9wcztcbiAgICAgIHRhcmdldFByb3BzID0gdGFyZ2V0LnRhcmdldFByb3BzO1xuICAgICAgcXVldWUgPSB0YXJnZXQucXVldWU7XG4gICAgfVxuICAgIHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV0gPSB0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldIHx8IFtdO1xuICAgIHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV0ucHVzaChxdWV1ZSk7XG5cbiAgICAvLyBDcmVhdGUgdGFyZ2V0XG4gICAgZXZlbnRzUnVsZS5hZGRUYXJnZXQoXG4gICAgICBuZXcgZXZlbnRzVGFyZ2V0cy5TcXNRdWV1ZShxdWV1ZS5zcXNRdWV1ZSwgdGFyZ2V0UHJvcHMpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRnVuY3Rpb25UYXJnZXQoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBydWxlS2V5OiBzdHJpbmcsXG4gICAgZXZlbnRzUnVsZTogZXZlbnRzLlJ1bGUsXG4gICAgdGFyZ2V0OiBGdW5jdGlvbkRlZmluaXRpb24gfCBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gUGFyc2UgdGFyZ2V0IHByb3BzXG4gICAgbGV0IHRhcmdldFByb3BzO1xuICAgIGxldCBmdW5jdGlvbkRlZmluaXRpb247XG4gICAgaWYgKCh0YXJnZXQgYXMgRXZlbnRCdXNGdW5jdGlvblRhcmdldFByb3BzKS5mdW5jdGlvbikge1xuICAgICAgdGFyZ2V0ID0gdGFyZ2V0IGFzIEV2ZW50QnVzRnVuY3Rpb25UYXJnZXRQcm9wcztcbiAgICAgIHRhcmdldFByb3BzID0gdGFyZ2V0LnRhcmdldFByb3BzO1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gdGFyZ2V0LmZ1bmN0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICB0YXJnZXQgPSB0YXJnZXQgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gdGFyZ2V0O1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV0gPSB0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldIHx8IFtdO1xuICAgIGNvbnN0IGkgPSB0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldLmxlbmd0aDtcbiAgICBjb25zdCBmbiA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgJHtydWxlS2V5fV90YXJnZXRfJHtpfWAsXG4gICAgICBmdW5jdGlvbkRlZmluaXRpb24sXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgdGFyZ2V0cyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgRXZlbnRCdXMgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG4gICAgdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XS5wdXNoKGZuKTtcblxuICAgIC8vIENyZWF0ZSB0YXJnZXRcbiAgICBldmVudHNSdWxlLmFkZFRhcmdldChuZXcgZXZlbnRzVGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihmbiwgdGFyZ2V0UHJvcHMpKTtcblxuICAgIC8vIEF0dGFjaCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRhcmdldHMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICB9XG59XG4iXX0=