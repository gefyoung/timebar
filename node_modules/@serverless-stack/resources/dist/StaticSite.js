"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StaticSite = exports.StaticSiteErrorOptions = void 0;
const chalk_1 = __importDefault(require("chalk"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const crypto = __importStar(require("crypto"));
const child_process_1 = require("child_process");
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const s3Assets = __importStar(require("aws-cdk-lib/aws-s3-assets"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const route53Patterns = __importStar(require("aws-cdk-lib/aws-route53-patterns"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const cloudfront = __importStar(require("aws-cdk-lib/aws-cloudfront"));
const cfOrigins = __importStar(require("aws-cdk-lib/aws-cloudfront-origins"));
const lambda_layer_awscli_1 = require("aws-cdk-lib/lambda-layer-awscli");
const BaseSite_1 = require("./BaseSite");
const Construct_1 = require("./Construct");
var StaticSiteErrorOptions;
(function (StaticSiteErrorOptions) {
    StaticSiteErrorOptions["REDIRECT_TO_INDEX_PAGE"] = "REDIRECT_TO_INDEX_PAGE";
})(StaticSiteErrorOptions = exports.StaticSiteErrorOptions || (exports.StaticSiteErrorOptions = {}));
class StaticSite extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        // Local development or skip build => stub asset
        this.isPlaceholder =
            (root.local || root.skipBuild) && !props.disablePlaceholder;
        const buildDir = root.buildDir;
        const fileSizeLimit = root.isJestTest()
            ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: "jestFileSizeLimitOverride" not exposed in props
                props.jestFileSizeLimitOverride || 200
            : 200;
        this.props = props;
        this.awsCliLayer = new lambda_layer_awscli_1.AwsCliLayer(this, "AwsCliLayer");
        this.registerSiteEnvironment();
        // Validate input
        this.validateCustomDomainSettings();
        // Build app
        this.assets = this.buildApp(fileSizeLimit, buildDir);
        const assetsHash = crypto
            .createHash("md5")
            .update(this.assets.map(({ assetHash }) => assetHash).join(""))
            .digest("hex");
        this.deployId = this.isPlaceholder ? `deploy-live` : `deploy-${assetsHash}`;
        // Create Bucket
        this.s3Bucket = this.createS3Bucket();
        // Create Custom Domain
        this.hostedZone = this.lookupHostedZone();
        this.acmCertificate = this.createCertificate();
        // Create S3 Deployment
        const s3deployCR = this.createS3Deployment();
        // Create CloudFront
        this.cfDistribution = this.createCfDistribution();
        this.cfDistribution.node.addDependency(s3deployCR);
        // Invalidate CloudFront
        const invalidationCR = this.createCloudFrontInvalidation();
        invalidationCR.node.addDependency(this.cfDistribution);
        // Connect Custom Domain to CloudFront Distribution
        this.createRoute53Records();
    }
    get url() {
        return `https://${this.cfDistribution.distributionDomainName}`;
    }
    get customDomainUrl() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return `https://${customDomain}`;
        }
        else {
            return `https://${customDomain.domainName}`;
        }
    }
    get bucketArn() {
        return this.s3Bucket.bucketArn;
    }
    get bucketName() {
        return this.s3Bucket.bucketName;
    }
    get distributionId() {
        return this.cfDistribution.distributionId;
    }
    get distributionDomain() {
        return this.cfDistribution.distributionDomainName;
    }
    getConstructMetadata() {
        return {
            type: "StaticSite",
            data: {
                distributionId: this.cfDistribution.distributionId,
                customDomainUrl: this.customDomainUrl,
            },
        };
    }
    buildApp(fileSizeLimit, buildDir) {
        if (this.isPlaceholder) {
            return [
                new s3Assets.Asset(this, "Asset", {
                    path: path.resolve(__dirname, "../assets/StaticSite/stub"),
                }),
            ];
        }
        const { path: sitePath, buildCommand } = this.props;
        const buildOutput = this.props.buildOutput || ".";
        // validate site path exists
        if (!fs.existsSync(sitePath)) {
            throw new Error(`No path found at "${path.resolve(sitePath)}" for the "${this.node.id}" StaticSite.`);
        }
        // Build and package user's website
        // build
        if (buildCommand) {
            try {
                console.log(chalk_1.default.grey(`Building static site ${sitePath}`));
                child_process_1.execSync(buildCommand, {
                    cwd: sitePath,
                    stdio: "inherit",
                    env: Object.assign(Object.assign({}, process.env), BaseSite_1.getBuildCmdEnvironment(this.props.environment)),
                });
            }
            catch (e) {
                throw new Error(`There was a problem building the "${this.node.id}" StaticSite.`);
            }
        }
        // validate buildOutput exists
        const siteOutputPath = path.resolve(path.join(sitePath, buildOutput));
        if (!fs.existsSync(siteOutputPath)) {
            throw new Error(`No build output found at "${siteOutputPath}" for the "${this.node.id}" StaticSite.`);
        }
        // create zip files
        const script = path.join(__dirname, "../assets/BaseSite/archiver.js");
        const zipPath = path.resolve(path.join(buildDir, `StaticSite-${this.node.id}-${this.node.addr}`));
        // clear zip path to ensure no partX.zip remain from previous build
        fs.removeSync(zipPath);
        const cmd = ["node", script, siteOutputPath, zipPath, fileSizeLimit].join(" ");
        try {
            child_process_1.execSync(cmd, {
                cwd: sitePath,
                stdio: "inherit",
            });
        }
        catch (e) {
            throw new Error(`There was a problem generating the "${this.node.id}" StaticSite package.`);
        }
        // create assets
        const assets = [];
        for (let partId = 0;; partId++) {
            const zipFilePath = path.join(zipPath, `part${partId}.zip`);
            if (!fs.existsSync(zipFilePath)) {
                break;
            }
            assets.push(new s3Assets.Asset(this, `Asset${partId}`, {
                path: zipFilePath,
            }));
        }
        return assets;
    }
    createS3Bucket() {
        let { s3Bucket } = this.props;
        s3Bucket = s3Bucket || {};
        // Validate s3Bucket
        if (s3Bucket.websiteIndexDocument) {
            throw new Error(`Do not configure the "s3Bucket.websiteIndexDocument". Use the "indexPage" to configure the StaticSite index page.`);
        }
        if (s3Bucket.websiteErrorDocument) {
            throw new Error(`Do not configure the "s3Bucket.websiteErrorDocument". Use the "errorPage" to configure the StaticSite index page.`);
        }
        return new s3.Bucket(this, "Bucket", Object.assign({ autoDeleteObjects: true, removalPolicy: cdk.RemovalPolicy.DESTROY }, s3Bucket));
    }
    createS3Deployment() {
        const { fileOptions } = this.props;
        // Create a Lambda function that will be doing the uploading
        const uploader = new lambda.Function(this, "S3Uploader", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-upload.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        this.s3Bucket.grantReadWrite(uploader);
        this.assets.forEach((asset) => asset.grantRead(uploader));
        // Create the custom resource function
        const handler = new lambda.Function(this, "S3Handler", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-handler.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            environment: {
                UPLOADER_FUNCTION_NAME: uploader.functionName,
            },
        });
        this.s3Bucket.grantReadWrite(handler);
        uploader.grantInvoke(handler);
        // Create custom resource
        return new cdk.CustomResource(this, "S3Deployment", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTBucketDeployment",
            properties: {
                Sources: this.assets.map((asset) => ({
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                })),
                DestinationBucketName: this.s3Bucket.bucketName,
                DestinationBucketKeyPrefix: this.deployId,
                FileOptions: (fileOptions || []).map(({ exclude, include, cacheControl }) => {
                    if (typeof exclude === "string") {
                        exclude = [exclude];
                    }
                    if (typeof include === "string") {
                        include = [include];
                    }
                    const options = [];
                    exclude.forEach((per) => options.push("--exclude", per));
                    include.forEach((per) => options.push("--include", per));
                    options.push("--cache-control", cacheControl);
                    return options;
                }),
                ReplaceValues: this.getS3ContentReplaceValues(),
            },
        });
    }
    /////////////////////
    // CloudFront Distribution
    /////////////////////
    createCfDistribution() {
        const { cfDistribution, customDomain } = this.props;
        const indexPage = this.props.indexPage || "index.html";
        const errorPage = this.props.errorPage;
        const cfDistributionProps = cfDistribution || {};
        // Validate input
        if (cfDistributionProps.certificate) {
            throw new Error(`Do not configure the "cfDistribution.certificate". Use the "customDomain" to configure the StaticSite domain certificate.`);
        }
        if (cfDistributionProps.domainNames) {
            throw new Error(`Do not configure the "cfDistribution.domainNames". Use the "customDomain" to configure the StaticSite domain.`);
        }
        // Build domainNames
        const domainNames = [];
        if (!customDomain) {
            // no domain
        }
        else if (typeof customDomain === "string") {
            domainNames.push(customDomain);
        }
        else {
            domainNames.push(customDomain.domainName);
            if (customDomain.alternateNames) {
                if (!customDomain.certificate)
                    throw new Error("Certificates for alternate domains cannot be automatically created. Please specify certificate to use");
                domainNames.push(...customDomain.alternateNames);
            }
        }
        // Build errorResponses
        let errorResponses;
        // case: sst start => showing stub site, and redirect all routes to the index page
        if (this.isPlaceholder) {
            errorResponses = BaseSite_1.buildErrorResponsesForRedirectToIndex(indexPage);
        }
        else if (errorPage) {
            if (cfDistributionProps.errorResponses) {
                throw new Error(`Cannot configure the "cfDistribution.errorResponses" when "errorPage" is passed in. Use one or the other to configure the behavior for error pages.`);
            }
            errorResponses =
                errorPage === StaticSiteErrorOptions.REDIRECT_TO_INDEX_PAGE
                    ? BaseSite_1.buildErrorResponsesForRedirectToIndex(indexPage)
                    : BaseSite_1.buildErrorResponsesFor404ErrorPage(errorPage);
        }
        // Create CloudFront distribution
        return new cloudfront.Distribution(this, "Distribution", Object.assign(Object.assign({ 
            // these values can be overwritten by cfDistributionProps
            defaultRootObject: indexPage, errorResponses }, cfDistributionProps), { 
            // these values can NOT be overwritten by cfDistributionProps
            domainNames, certificate: this.acmCertificate, defaultBehavior: Object.assign({ origin: new cfOrigins.S3Origin(this.s3Bucket, {
                    originPath: this.deployId,
                }), viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS }, (cfDistributionProps.defaultBehavior || {})) }));
    }
    createCloudFrontInvalidation() {
        // Create a Lambda function that will be doing the invalidation
        const invalidator = new lambda.Function(this, "CloudFrontInvalidator", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "cf-invalidate.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        // Grant permissions to invalidate CF Distribution
        invalidator.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "cloudfront:GetInvalidation",
                "cloudfront:CreateInvalidation",
            ],
            resources: ["*"],
        }));
        // Create custom resource
        return new cdk.CustomResource(this, "CloudFrontInvalidation", {
            serviceToken: invalidator.functionArn,
            resourceType: "Custom::SSTCloudFrontInvalidation",
            properties: {
                // need the DeployId field so this CR gets updated on each deploy
                DeployId: this.deployId,
                DistributionId: this.cfDistribution.distributionId,
                DistributionPaths: ["/*"],
            },
        });
    }
    /////////////////////
    // Custom Domain
    /////////////////////
    validateCustomDomainSettings() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return;
        }
        if (customDomain.isExternalDomain === true) {
            if (!customDomain.certificate) {
                throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
            }
            if (customDomain.domainAlias) {
                throw new Error(`Domain alias is only supported for domains hosted on Amazon Route 53. Do not set the "customDomain.domainAlias" when "isExternalDomain" is enabled.`);
            }
            if (customDomain.hostedZone) {
                throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
            }
        }
    }
    lookupHostedZone() {
        const { customDomain } = this.props;
        // Skip if customDomain is not configured
        if (!customDomain) {
            return;
        }
        let hostedZone;
        if (typeof customDomain === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain,
            });
        }
        else if (Construct_1.isCDKConstruct(customDomain.hostedZone)) {
            hostedZone = customDomain.hostedZone;
        }
        else if (typeof customDomain.hostedZone === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.hostedZone,
            });
        }
        else if (typeof customDomain.domainName === "string") {
            // Skip if domain is not a Route53 domain
            if (customDomain.isExternalDomain === true) {
                return;
            }
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.domainName,
            });
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        return hostedZone;
    }
    createCertificate() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        let acmCertificate;
        // HostedZone is set for Route 53 domains
        if (this.hostedZone) {
            if (typeof customDomain === "string") {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
            else if (customDomain.certificate) {
                acmCertificate = customDomain.certificate;
            }
            else {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain.domainName,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
        }
        // HostedZone is NOT set for non-Route 53 domains
        else {
            if (typeof customDomain !== "string") {
                acmCertificate = customDomain.certificate;
            }
        }
        return acmCertificate;
    }
    createRoute53Records() {
        const { customDomain } = this.props;
        if (!customDomain || !this.hostedZone) {
            return;
        }
        let recordName;
        let domainAlias;
        if (typeof customDomain === "string") {
            recordName = customDomain;
        }
        else {
            recordName = customDomain.domainName;
            domainAlias = customDomain.domainAlias;
        }
        // Create DNS record
        new route53.ARecord(this, "AliasRecord", {
            recordName,
            zone: this.hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.CloudFrontTarget(this.cfDistribution)),
        });
        // Create Alias redirect record
        if (domainAlias) {
            new route53Patterns.HttpsRedirect(this, "Redirect", {
                zone: this.hostedZone,
                recordNames: [domainAlias],
                targetDomain: recordName,
            });
        }
    }
    /////////////////////
    // Helper Functions
    /////////////////////
    getS3ContentReplaceValues() {
        const replaceValues = this.props.replaceValues || [];
        Object.entries(this.props.environment || {})
            .filter(([, value]) => cdk.Token.isUnresolved(value))
            .forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "index.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            });
        });
        return replaceValues;
    }
    registerSiteEnvironment() {
        const environmentOutputs = {};
        for (const [key, value] of Object.entries(this.props.environment || {})) {
            const outputId = `SstSiteEnv_${key}`;
            const output = new cdk.CfnOutput(this, outputId, { value });
            environmentOutputs[key] = cdk.Stack.of(this).getLogicalId(output);
        }
        const root = this.node.root;
        root.registerSiteEnvironment({
            id: this.node.id,
            path: this.props.path,
            stack: cdk.Stack.of(this).node.id,
            environmentOutputs,
        });
    }
}
exports.StaticSite = StaticSite;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhdGljU2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9TdGF0aWNTaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxrREFBMEI7QUFDMUIsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQiwrQ0FBaUM7QUFDakMsaURBQXlDO0FBRXpDLDJDQUF1QztBQUN2QyxpREFBbUM7QUFDbkMsdURBQXlDO0FBQ3pDLG9FQUFzRDtBQUN0RCx3RUFBMEQ7QUFDMUQseURBQTJDO0FBQzNDLCtEQUFpRDtBQUNqRCxpRUFBbUQ7QUFDbkQsa0ZBQW9FO0FBQ3BFLGdGQUFrRTtBQUNsRSx1RUFBeUQ7QUFDekQsOEVBQWdFO0FBQ2hFLHlFQUE4RDtBQUc5RCx5Q0FRb0I7QUFDcEIsMkNBQTJEO0FBRTNELElBQVksc0JBRVg7QUFGRCxXQUFZLHNCQUFzQjtJQUNoQywyRUFBaUQsQ0FBQTtBQUNuRCxDQUFDLEVBRlcsc0JBQXNCLEdBQXRCLDhCQUFzQixLQUF0Qiw4QkFBc0IsUUFFakM7QUEyQkQsTUFBYSxVQUFXLFNBQVEsc0JBQVM7SUFXdkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLGdEQUFnRDtRQUNoRCxJQUFJLENBQUMsYUFBYTtZQUNoQixDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBQzlELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDL0IsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNyQyxDQUFDLENBQUMsNkRBQTZEO2dCQUM3RCwrREFBK0Q7Z0JBQy9E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QWtCLEdBQTJCLEVBQUUsQ0FBQztRQUN0RCxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUMsRUFBRTtZQUN2RSxNQUFNLFFBQVEsR0FBRyxjQUFjLEdBQUcsRUFBRSxDQUFDO1lBQ3JDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUM1RCxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkU7UUFFRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNuQyxJQUFJLENBQUMsdUJBQXVCLENBQUM7WUFDM0IsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNoQixJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQ3JCLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNqQyxrQkFBa0I7U0FDZSxDQUFDLENBQUM7SUFDdkMsQ0FBQztDQUNGO0FBeGtCRCxnQ0F3a0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgczNBc3NldHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zMy1hc3NldHNcIjtcbmltcG9ydCAqIGFzIGFjbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNlcnRpZmljYXRlbWFuYWdlclwiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzUGF0dGVybnMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yb3V0ZTUzLXBhdHRlcm5zXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzVGFyZ2V0cyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTMtdGFyZ2V0c1wiO1xuaW1wb3J0ICogYXMgY2xvdWRmcm9udCBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNsb3VkZnJvbnRcIjtcbmltcG9ydCAqIGFzIGNmT3JpZ2lucyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNsb3VkZnJvbnQtb3JpZ2luc1wiO1xuaW1wb3J0IHsgQXdzQ2xpTGF5ZXIgfSBmcm9tIFwiYXdzLWNkay1saWIvbGFtYmRhLWxheWVyLWF3c2NsaVwiO1xuXG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7XG4gIEJhc2VTaXRlRG9tYWluUHJvcHMsXG4gIEJhc2VTaXRlUmVwbGFjZVByb3BzLFxuICBCYXNlU2l0ZUNka0Rpc3RyaWJ1dGlvblByb3BzLFxuICBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm8sXG4gIGdldEJ1aWxkQ21kRW52aXJvbm1lbnQsXG4gIGJ1aWxkRXJyb3JSZXNwb25zZXNGb3I0MDRFcnJvclBhZ2UsXG4gIGJ1aWxkRXJyb3JSZXNwb25zZXNGb3JSZWRpcmVjdFRvSW5kZXgsXG59IGZyb20gXCIuL0Jhc2VTaXRlXCI7XG5pbXBvcnQgeyBTU1RDb25zdHJ1Y3QsIGlzQ0RLQ29uc3RydWN0IH0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5cbmV4cG9ydCBlbnVtIFN0YXRpY1NpdGVFcnJvck9wdGlvbnMge1xuICBSRURJUkVDVF9UT19JTkRFWF9QQUdFID0gXCJSRURJUkVDVF9UT19JTkRFWF9QQUdFXCIsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGljU2l0ZVByb3BzIHtcbiAgcmVhZG9ubHkgcGF0aDogc3RyaW5nO1xuICByZWFkb25seSBpbmRleFBhZ2U/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGVycm9yUGFnZT86IHN0cmluZyB8IFN0YXRpY1NpdGVFcnJvck9wdGlvbnM7XG4gIHJlYWRvbmx5IGJ1aWxkQ29tbWFuZD86IHN0cmluZztcbiAgcmVhZG9ubHkgYnVpbGRPdXRwdXQ/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGZpbGVPcHRpb25zPzogU3RhdGljU2l0ZUZpbGVPcHRpb25bXTtcbiAgcmVhZG9ubHkgcmVwbGFjZVZhbHVlcz86IFN0YXRpY1NpdGVSZXBsYWNlUHJvcHNbXTtcbiAgcmVhZG9ubHkgY3VzdG9tRG9tYWluPzogc3RyaW5nIHwgU3RhdGljU2l0ZURvbWFpblByb3BzO1xuICByZWFkb25seSBzM0J1Y2tldD86IHMzLkJ1Y2tldFByb3BzO1xuICByZWFkb25seSBjZkRpc3RyaWJ1dGlvbj86IFN0YXRpY1NpdGVDZGtEaXN0cmlidXRpb25Qcm9wcztcbiAgcmVhZG9ubHkgZW52aXJvbm1lbnQ/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xuICByZWFkb25seSBkaXNhYmxlUGxhY2Vob2xkZXI/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN0YXRpY1NpdGVGaWxlT3B0aW9uIHtcbiAgcmVhZG9ubHkgZXhjbHVkZTogc3RyaW5nIHwgc3RyaW5nW107XG4gIHJlYWRvbmx5IGluY2x1ZGU6IHN0cmluZyB8IHN0cmluZ1tdO1xuICByZWFkb25seSBjYWNoZUNvbnRyb2w6IHN0cmluZztcbn1cblxuZXhwb3J0IHR5cGUgU3RhdGljU2l0ZURvbWFpblByb3BzID0gQmFzZVNpdGVEb21haW5Qcm9wcztcbmV4cG9ydCB0eXBlIFN0YXRpY1NpdGVSZXBsYWNlUHJvcHMgPSBCYXNlU2l0ZVJlcGxhY2VQcm9wcztcbmV4cG9ydCB0eXBlIFN0YXRpY1NpdGVDZGtEaXN0cmlidXRpb25Qcm9wcyA9IEJhc2VTaXRlQ2RrRGlzdHJpYnV0aW9uUHJvcHM7XG5cbmV4cG9ydCBjbGFzcyBTdGF0aWNTaXRlIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IHMzQnVja2V0OiBzMy5CdWNrZXQ7XG4gIHB1YmxpYyByZWFkb25seSBjZkRpc3RyaWJ1dGlvbjogY2xvdWRmcm9udC5EaXN0cmlidXRpb247XG4gIHB1YmxpYyByZWFkb25seSBob3N0ZWRab25lPzogcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgcHVibGljIHJlYWRvbmx5IGFjbUNlcnRpZmljYXRlPzogYWNtLklDZXJ0aWZpY2F0ZTtcbiAgcHVibGljIHJlYWRvbmx5IGRlcGxveUlkOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IFN0YXRpY1NpdGVQcm9wcztcbiAgcHJpdmF0ZSByZWFkb25seSBpc1BsYWNlaG9sZGVyOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IGFzc2V0czogczNBc3NldHMuQXNzZXRbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBhd3NDbGlMYXllcjogQXdzQ2xpTGF5ZXI7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFN0YXRpY1NpdGVQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICAvLyBMb2NhbCBkZXZlbG9wbWVudCBvciBza2lwIGJ1aWxkID0+IHN0dWIgYXNzZXRcbiAgICB0aGlzLmlzUGxhY2Vob2xkZXIgPVxuICAgICAgKHJvb3QubG9jYWwgfHwgcm9vdC5za2lwQnVpbGQpICYmICFwcm9wcy5kaXNhYmxlUGxhY2Vob2xkZXI7XG4gICAgY29uc3QgYnVpbGREaXIgPSByb290LmJ1aWxkRGlyO1xuICAgIGNvbnN0IGZpbGVTaXplTGltaXQgPSByb290LmlzSmVzdFRlc3QoKVxuICAgICAgPyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG4gICAgICAgIC8vIEB0cy1pZ25vcmU6IFwiamVzdEZpbGVTaXplTGltaXRPdmVycmlkZVwiIG5vdCBleHBvc2VkIGluIHByb3BzXG4gICAgICAgIHByb3BzLmplc3RGaWxlU2l6ZUxpbWl0T3ZlcnJpZGUgfHwgMjAwXG4gICAgICA6IDIwMDtcblxuICAgIHRoaXMucHJvcHMgPSBwcm9wcztcbiAgICB0aGlzLmF3c0NsaUxheWVyID0gbmV3IEF3c0NsaUxheWVyKHRoaXMsIFwiQXdzQ2xpTGF5ZXJcIik7XG4gICAgdGhpcy5yZWdpc3RlclNpdGVFbnZpcm9ubWVudCgpO1xuXG4gICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICB0aGlzLnZhbGlkYXRlQ3VzdG9tRG9tYWluU2V0dGluZ3MoKTtcblxuICAgIC8vIEJ1aWxkIGFwcFxuICAgIHRoaXMuYXNzZXRzID0gdGhpcy5idWlsZEFwcChmaWxlU2l6ZUxpbWl0LCBidWlsZERpcik7XG4gICAgY29uc3QgYXNzZXRzSGFzaCA9IGNyeXB0b1xuICAgICAgLmNyZWF0ZUhhc2goXCJtZDVcIilcbiAgICAgIC51cGRhdGUodGhpcy5hc3NldHMubWFwKCh7IGFzc2V0SGFzaCB9KSA9PiBhc3NldEhhc2gpLmpvaW4oXCJcIikpXG4gICAgICAuZGlnZXN0KFwiaGV4XCIpO1xuICAgIHRoaXMuZGVwbG95SWQgPSB0aGlzLmlzUGxhY2Vob2xkZXIgPyBgZGVwbG95LWxpdmVgIDogYGRlcGxveS0ke2Fzc2V0c0hhc2h9YDtcblxuICAgIC8vIENyZWF0ZSBCdWNrZXRcbiAgICB0aGlzLnMzQnVja2V0ID0gdGhpcy5jcmVhdGVTM0J1Y2tldCgpO1xuXG4gICAgLy8gQ3JlYXRlIEN1c3RvbSBEb21haW5cbiAgICB0aGlzLmhvc3RlZFpvbmUgPSB0aGlzLmxvb2t1cEhvc3RlZFpvbmUoKTtcbiAgICB0aGlzLmFjbUNlcnRpZmljYXRlID0gdGhpcy5jcmVhdGVDZXJ0aWZpY2F0ZSgpO1xuXG4gICAgLy8gQ3JlYXRlIFMzIERlcGxveW1lbnRcbiAgICBjb25zdCBzM2RlcGxveUNSID0gdGhpcy5jcmVhdGVTM0RlcGxveW1lbnQoKTtcblxuICAgIC8vIENyZWF0ZSBDbG91ZEZyb250XG4gICAgdGhpcy5jZkRpc3RyaWJ1dGlvbiA9IHRoaXMuY3JlYXRlQ2ZEaXN0cmlidXRpb24oKTtcbiAgICB0aGlzLmNmRGlzdHJpYnV0aW9uLm5vZGUuYWRkRGVwZW5kZW5jeShzM2RlcGxveUNSKTtcblxuICAgIC8vIEludmFsaWRhdGUgQ2xvdWRGcm9udFxuICAgIGNvbnN0IGludmFsaWRhdGlvbkNSID0gdGhpcy5jcmVhdGVDbG91ZEZyb250SW52YWxpZGF0aW9uKCk7XG4gICAgaW52YWxpZGF0aW9uQ1Iubm9kZS5hZGREZXBlbmRlbmN5KHRoaXMuY2ZEaXN0cmlidXRpb24pO1xuXG4gICAgLy8gQ29ubmVjdCBDdXN0b20gRG9tYWluIHRvIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gICAgdGhpcy5jcmVhdGVSb3V0ZTUzUmVjb3JkcygpO1xuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYGh0dHBzOi8vJHt0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbkRvbWFpbk5hbWV9YDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIGBodHRwczovLyR7Y3VzdG9tRG9tYWlufWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbi5kb21haW5OYW1lfWA7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBidWNrZXRBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXRBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IGJ1Y2tldE5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXROYW1lO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25JZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbklkO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25Eb21haW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25Eb21haW5OYW1lO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIlN0YXRpY1NpdGVcIiBhcyBjb25zdCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZGlzdHJpYnV0aW9uSWQ6IHRoaXMuY2ZEaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uSWQsXG4gICAgICAgIGN1c3RvbURvbWFpblVybDogdGhpcy5jdXN0b21Eb21haW5VcmwsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQXBwKGZpbGVTaXplTGltaXQ6IG51bWJlciwgYnVpbGREaXI6IHN0cmluZyk6IHMzQXNzZXRzLkFzc2V0W10ge1xuICAgIGlmICh0aGlzLmlzUGxhY2Vob2xkZXIpIHtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIG5ldyBzM0Fzc2V0cy5Bc3NldCh0aGlzLCBcIkFzc2V0XCIsIHtcbiAgICAgICAgICBwYXRoOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9TdGF0aWNTaXRlL3N0dWJcIiksXG4gICAgICAgIH0pLFxuICAgICAgXTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBhdGg6IHNpdGVQYXRoLCBidWlsZENvbW1hbmQgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgYnVpbGRPdXRwdXQgPSB0aGlzLnByb3BzLmJ1aWxkT3V0cHV0IHx8IFwiLlwiO1xuXG4gICAgLy8gdmFsaWRhdGUgc2l0ZSBwYXRoIGV4aXN0c1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhzaXRlUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIHBhdGggZm91bmQgYXQgXCIke3BhdGgucmVzb2x2ZShzaXRlUGF0aCl9XCIgZm9yIHRoZSBcIiR7XG4gICAgICAgICAgdGhpcy5ub2RlLmlkXG4gICAgICAgIH1cIiBTdGF0aWNTaXRlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgYW5kIHBhY2thZ2UgdXNlcidzIHdlYnNpdGVcblxuICAgIC8vIGJ1aWxkXG4gICAgaWYgKGJ1aWxkQ29tbWFuZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JleShgQnVpbGRpbmcgc3RhdGljIHNpdGUgJHtzaXRlUGF0aH1gKSk7XG4gICAgICAgIGV4ZWNTeW5jKGJ1aWxkQ29tbWFuZCwge1xuICAgICAgICAgIGN3ZDogc2l0ZVBhdGgsXG4gICAgICAgICAgc3RkaW86IFwiaW5oZXJpdFwiLFxuICAgICAgICAgIGVudjoge1xuICAgICAgICAgICAgLi4ucHJvY2Vzcy5lbnYsXG4gICAgICAgICAgICAuLi5nZXRCdWlsZENtZEVudmlyb25tZW50KHRoaXMucHJvcHMuZW52aXJvbm1lbnQpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRoZXJlIHdhcyBhIHByb2JsZW0gYnVpbGRpbmcgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgU3RhdGljU2l0ZS5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gdmFsaWRhdGUgYnVpbGRPdXRwdXQgZXhpc3RzXG4gICAgY29uc3Qgc2l0ZU91dHB1dFBhdGggPSBwYXRoLnJlc29sdmUocGF0aC5qb2luKHNpdGVQYXRoLCBidWlsZE91dHB1dCkpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhzaXRlT3V0cHV0UGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIGJ1aWxkIG91dHB1dCBmb3VuZCBhdCBcIiR7c2l0ZU91dHB1dFBhdGh9XCIgZm9yIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFN0YXRpY1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgemlwIGZpbGVzXG4gICAgY29uc3Qgc2NyaXB0ID0gcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvYXJjaGl2ZXIuanNcIik7XG4gICAgY29uc3QgemlwUGF0aCA9IHBhdGgucmVzb2x2ZShcbiAgICAgIHBhdGguam9pbihidWlsZERpciwgYFN0YXRpY1NpdGUtJHt0aGlzLm5vZGUuaWR9LSR7dGhpcy5ub2RlLmFkZHJ9YClcbiAgICApO1xuICAgIC8vIGNsZWFyIHppcCBwYXRoIHRvIGVuc3VyZSBubyBwYXJ0WC56aXAgcmVtYWluIGZyb20gcHJldmlvdXMgYnVpbGRcbiAgICBmcy5yZW1vdmVTeW5jKHppcFBhdGgpO1xuICAgIGNvbnN0IGNtZCA9IFtcIm5vZGVcIiwgc2NyaXB0LCBzaXRlT3V0cHV0UGF0aCwgemlwUGF0aCwgZmlsZVNpemVMaW1pdF0uam9pbihcbiAgICAgIFwiIFwiXG4gICAgKTtcblxuICAgIHRyeSB7XG4gICAgICBleGVjU3luYyhjbWQsIHtcbiAgICAgICAgY3dkOiBzaXRlUGF0aCxcbiAgICAgICAgc3RkaW86IFwiaW5oZXJpdFwiLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlcmUgd2FzIGEgcHJvYmxlbSBnZW5lcmF0aW5nIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFN0YXRpY1NpdGUgcGFja2FnZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBhc3NldHNcbiAgICBjb25zdCBhc3NldHMgPSBbXTtcbiAgICBmb3IgKGxldCBwYXJ0SWQgPSAwOyA7IHBhcnRJZCsrKSB7XG4gICAgICBjb25zdCB6aXBGaWxlUGF0aCA9IHBhdGguam9pbih6aXBQYXRoLCBgcGFydCR7cGFydElkfS56aXBgKTtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyh6aXBGaWxlUGF0aCkpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGFzc2V0cy5wdXNoKFxuICAgICAgICBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYEFzc2V0JHtwYXJ0SWR9YCwge1xuICAgICAgICAgIHBhdGg6IHppcEZpbGVQYXRoLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGFzc2V0cztcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUzNCdWNrZXQoKTogczMuQnVja2V0IHtcbiAgICBsZXQgeyBzM0J1Y2tldCB9ID0gdGhpcy5wcm9wcztcbiAgICBzM0J1Y2tldCA9IHMzQnVja2V0IHx8IHt9O1xuXG4gICAgLy8gVmFsaWRhdGUgczNCdWNrZXRcbiAgICBpZiAoczNCdWNrZXQud2Vic2l0ZUluZGV4RG9jdW1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwiczNCdWNrZXQud2Vic2l0ZUluZGV4RG9jdW1lbnRcIi4gVXNlIHRoZSBcImluZGV4UGFnZVwiIHRvIGNvbmZpZ3VyZSB0aGUgU3RhdGljU2l0ZSBpbmRleCBwYWdlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHMzQnVja2V0LndlYnNpdGVFcnJvckRvY3VtZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcInMzQnVja2V0LndlYnNpdGVFcnJvckRvY3VtZW50XCIuIFVzZSB0aGUgXCJlcnJvclBhZ2VcIiB0byBjb25maWd1cmUgdGhlIFN0YXRpY1NpdGUgaW5kZXggcGFnZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgczMuQnVja2V0KHRoaXMsIFwiQnVja2V0XCIsIHtcbiAgICAgIGF1dG9EZWxldGVPYmplY3RzOiB0cnVlLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgIC4uLnMzQnVja2V0LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVTM0RlcGxveW1lbnQoKTogY2RrLkN1c3RvbVJlc291cmNlIHtcbiAgICBjb25zdCB7IGZpbGVPcHRpb25zIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gQ3JlYXRlIGEgTGFtYmRhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBkb2luZyB0aGUgdXBsb2FkaW5nXG4gICAgY29uc3QgdXBsb2FkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUzNVcGxvYWRlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiczMtdXBsb2FkLmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgfSk7XG4gICAgdGhpcy5zM0J1Y2tldC5ncmFudFJlYWRXcml0ZSh1cGxvYWRlcik7XG4gICAgdGhpcy5hc3NldHMuZm9yRWFjaCgoYXNzZXQpID0+IGFzc2V0LmdyYW50UmVhZCh1cGxvYWRlcikpO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSBjdXN0b20gcmVzb3VyY2UgZnVuY3Rpb25cbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIlMzSGFuZGxlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiczMtaGFuZGxlci5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgVVBMT0FERVJfRlVOQ1RJT05fTkFNRTogdXBsb2FkZXIuZnVuY3Rpb25OYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICB0aGlzLnMzQnVja2V0LmdyYW50UmVhZFdyaXRlKGhhbmRsZXIpO1xuICAgIHVwbG9hZGVyLmdyYW50SW52b2tlKGhhbmRsZXIpO1xuXG4gICAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICAgIHJldHVybiBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsIFwiUzNEZXBsb3ltZW50XCIsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogaGFuZGxlci5mdW5jdGlvbkFybixcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVEJ1Y2tldERlcGxveW1lbnRcIixcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgU291cmNlczogdGhpcy5hc3NldHMubWFwKChhc3NldCkgPT4gKHtcbiAgICAgICAgICBCdWNrZXROYW1lOiBhc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICAgICAgT2JqZWN0S2V5OiBhc3NldC5zM09iamVjdEtleSxcbiAgICAgICAgfSkpLFxuICAgICAgICBEZXN0aW5hdGlvbkJ1Y2tldE5hbWU6IHRoaXMuczNCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgRGVzdGluYXRpb25CdWNrZXRLZXlQcmVmaXg6IHRoaXMuZGVwbG95SWQsXG4gICAgICAgIEZpbGVPcHRpb25zOiAoZmlsZU9wdGlvbnMgfHwgW10pLm1hcChcbiAgICAgICAgICAoeyBleGNsdWRlLCBpbmNsdWRlLCBjYWNoZUNvbnRyb2wgfSkgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBleGNsdWRlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgIGV4Y2x1ZGUgPSBbZXhjbHVkZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodHlwZW9mIGluY2x1ZGUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgaW5jbHVkZSA9IFtpbmNsdWRlXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBbXTtcbiAgICAgICAgICAgIGV4Y2x1ZGUuZm9yRWFjaCgocGVyKSA9PiBvcHRpb25zLnB1c2goXCItLWV4Y2x1ZGVcIiwgcGVyKSk7XG4gICAgICAgICAgICBpbmNsdWRlLmZvckVhY2goKHBlcikgPT4gb3B0aW9ucy5wdXNoKFwiLS1pbmNsdWRlXCIsIHBlcikpO1xuICAgICAgICAgICAgb3B0aW9ucy5wdXNoKFwiLS1jYWNoZS1jb250cm9sXCIsIGNhY2hlQ29udHJvbCk7XG4gICAgICAgICAgICByZXR1cm4gb3B0aW9ucztcbiAgICAgICAgICB9XG4gICAgICAgICksXG4gICAgICAgIFJlcGxhY2VWYWx1ZXM6IHRoaXMuZ2V0UzNDb250ZW50UmVwbGFjZVZhbHVlcygpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBDbG91ZEZyb250IERpc3RyaWJ1dGlvblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBwcml2YXRlIGNyZWF0ZUNmRGlzdHJpYnV0aW9uKCk6IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uIHtcbiAgICBjb25zdCB7IGNmRGlzdHJpYnV0aW9uLCBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgaW5kZXhQYWdlID0gdGhpcy5wcm9wcy5pbmRleFBhZ2UgfHwgXCJpbmRleC5odG1sXCI7XG4gICAgY29uc3QgZXJyb3JQYWdlID0gdGhpcy5wcm9wcy5lcnJvclBhZ2U7XG5cbiAgICBjb25zdCBjZkRpc3RyaWJ1dGlvblByb3BzID0gY2ZEaXN0cmlidXRpb24gfHwge307XG5cbiAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgIGlmIChjZkRpc3RyaWJ1dGlvblByb3BzLmNlcnRpZmljYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcImNmRGlzdHJpYnV0aW9uLmNlcnRpZmljYXRlXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIFN0YXRpY1NpdGUgZG9tYWluIGNlcnRpZmljYXRlLmBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChjZkRpc3RyaWJ1dGlvblByb3BzLmRvbWFpbk5hbWVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcImNmRGlzdHJpYnV0aW9uLmRvbWFpbk5hbWVzXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIFN0YXRpY1NpdGUgZG9tYWluLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgZG9tYWluTmFtZXNcbiAgICBjb25zdCBkb21haW5OYW1lcyA9IFtdO1xuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICAvLyBubyBkb21haW5cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGRvbWFpbk5hbWVzLnB1c2goY3VzdG9tRG9tYWluKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZG9tYWluTmFtZXMucHVzaChjdXN0b21Eb21haW4uZG9tYWluTmFtZSk7XG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmFsdGVybmF0ZU5hbWVzKSB7XG4gICAgICAgIGlmICghY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKVxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIFwiQ2VydGlmaWNhdGVzIGZvciBhbHRlcm5hdGUgZG9tYWlucyBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjcmVhdGVkLiBQbGVhc2Ugc3BlY2lmeSBjZXJ0aWZpY2F0ZSB0byB1c2VcIlxuICAgICAgICAgICk7XG4gICAgICAgIGRvbWFpbk5hbWVzLnB1c2goLi4uY3VzdG9tRG9tYWluLmFsdGVybmF0ZU5hbWVzKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBCdWlsZCBlcnJvclJlc3BvbnNlc1xuICAgIGxldCBlcnJvclJlc3BvbnNlcztcbiAgICAvLyBjYXNlOiBzc3Qgc3RhcnQgPT4gc2hvd2luZyBzdHViIHNpdGUsIGFuZCByZWRpcmVjdCBhbGwgcm91dGVzIHRvIHRoZSBpbmRleCBwYWdlXG4gICAgaWYgKHRoaXMuaXNQbGFjZWhvbGRlcikge1xuICAgICAgZXJyb3JSZXNwb25zZXMgPSBidWlsZEVycm9yUmVzcG9uc2VzRm9yUmVkaXJlY3RUb0luZGV4KGluZGV4UGFnZSk7XG4gICAgfSBlbHNlIGlmIChlcnJvclBhZ2UpIHtcbiAgICAgIGlmIChjZkRpc3RyaWJ1dGlvblByb3BzLmVycm9yUmVzcG9uc2VzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjZkRpc3RyaWJ1dGlvbi5lcnJvclJlc3BvbnNlc1wiIHdoZW4gXCJlcnJvclBhZ2VcIiBpcyBwYXNzZWQgaW4uIFVzZSBvbmUgb3IgdGhlIG90aGVyIHRvIGNvbmZpZ3VyZSB0aGUgYmVoYXZpb3IgZm9yIGVycm9yIHBhZ2VzLmBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgZXJyb3JSZXNwb25zZXMgPVxuICAgICAgICBlcnJvclBhZ2UgPT09IFN0YXRpY1NpdGVFcnJvck9wdGlvbnMuUkVESVJFQ1RfVE9fSU5ERVhfUEFHRVxuICAgICAgICAgID8gYnVpbGRFcnJvclJlc3BvbnNlc0ZvclJlZGlyZWN0VG9JbmRleChpbmRleFBhZ2UpXG4gICAgICAgICAgOiBidWlsZEVycm9yUmVzcG9uc2VzRm9yNDA0RXJyb3JQYWdlKGVycm9yUGFnZSk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIENsb3VkRnJvbnQgZGlzdHJpYnV0aW9uXG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCBcIkRpc3RyaWJ1dGlvblwiLCB7XG4gICAgICAvLyB0aGVzZSB2YWx1ZXMgY2FuIGJlIG92ZXJ3cml0dGVuIGJ5IGNmRGlzdHJpYnV0aW9uUHJvcHNcbiAgICAgIGRlZmF1bHRSb290T2JqZWN0OiBpbmRleFBhZ2UsXG4gICAgICBlcnJvclJlc3BvbnNlcyxcbiAgICAgIC4uLmNmRGlzdHJpYnV0aW9uUHJvcHMsXG4gICAgICAvLyB0aGVzZSB2YWx1ZXMgY2FuIE5PVCBiZSBvdmVyd3JpdHRlbiBieSBjZkRpc3RyaWJ1dGlvblByb3BzXG4gICAgICBkb21haW5OYW1lcyxcbiAgICAgIGNlcnRpZmljYXRlOiB0aGlzLmFjbUNlcnRpZmljYXRlLFxuICAgICAgZGVmYXVsdEJlaGF2aW9yOiB7XG4gICAgICAgIG9yaWdpbjogbmV3IGNmT3JpZ2lucy5TM09yaWdpbih0aGlzLnMzQnVja2V0LCB7XG4gICAgICAgICAgb3JpZ2luUGF0aDogdGhpcy5kZXBsb3lJZCxcbiAgICAgICAgfSksXG4gICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5OiBjbG91ZGZyb250LlZpZXdlclByb3RvY29sUG9saWN5LlJFRElSRUNUX1RPX0hUVFBTLFxuICAgICAgICAuLi4oY2ZEaXN0cmlidXRpb25Qcm9wcy5kZWZhdWx0QmVoYXZpb3IgfHwge30pLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udEludmFsaWRhdGlvbigpOiBjZGsuQ3VzdG9tUmVzb3VyY2Uge1xuICAgIC8vIENyZWF0ZSBhIExhbWJkYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZG9pbmcgdGhlIGludmFsaWRhdGlvblxuICAgIGNvbnN0IGludmFsaWRhdG9yID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIkNsb3VkRnJvbnRJbnZhbGlkYXRvclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiY2YtaW52YWxpZGF0ZS5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgIH0pO1xuXG4gICAgLy8gR3JhbnQgcGVybWlzc2lvbnMgdG8gaW52YWxpZGF0ZSBDRiBEaXN0cmlidXRpb25cbiAgICBpbnZhbGlkYXRvci5hZGRUb1JvbGVQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwiY2xvdWRmcm9udDpHZXRJbnZhbGlkYXRpb25cIixcbiAgICAgICAgICBcImNsb3VkZnJvbnQ6Q3JlYXRlSW52YWxpZGF0aW9uXCIsXG4gICAgICAgIF0sXG4gICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSBjdXN0b20gcmVzb3VyY2VcbiAgICByZXR1cm4gbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCBcIkNsb3VkRnJvbnRJbnZhbGlkYXRpb25cIiwge1xuICAgICAgc2VydmljZVRva2VuOiBpbnZhbGlkYXRvci5mdW5jdGlvbkFybixcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVENsb3VkRnJvbnRJbnZhbGlkYXRpb25cIixcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgLy8gbmVlZCB0aGUgRGVwbG95SWQgZmllbGQgc28gdGhpcyBDUiBnZXRzIHVwZGF0ZWQgb24gZWFjaCBkZXBsb3lcbiAgICAgICAgRGVwbG95SWQ6IHRoaXMuZGVwbG95SWQsXG4gICAgICAgIERpc3RyaWJ1dGlvbklkOiB0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbklkLFxuICAgICAgICBEaXN0cmlidXRpb25QYXRoczogW1wiLypcIl0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEN1c3RvbSBEb21haW5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJvdGVjdGVkIHZhbGlkYXRlQ3VzdG9tRG9tYWluU2V0dGluZ3MoKSB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluID09PSB0cnVlKSB7XG4gICAgICBpZiAoIWN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEEgdmFsaWQgY2VydGlmaWNhdGUgaXMgcmVxdWlyZWQgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBzZXQgdG8gXCJ0cnVlXCIuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbi5kb21haW5BbGlhcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYERvbWFpbiBhbGlhcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgZG9tYWlucyBob3N0ZWQgb24gQW1hem9uIFJvdXRlIDUzLiBEbyBub3Qgc2V0IHRoZSBcImN1c3RvbURvbWFpbi5kb21haW5BbGlhc1wiIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgZW5hYmxlZC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBIb3N0ZWQgem9uZXMgY2FuIG9ubHkgYmUgY29uZmlndXJlZCBmb3IgZG9tYWlucyBob3N0ZWQgb24gQW1hem9uIFJvdXRlIDUzLiBEbyBub3Qgc2V0IHRoZSBcImN1c3RvbURvbWFpbi5ob3N0ZWRab25lXCIgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBlbmFibGVkLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgbG9va3VwSG9zdGVkWm9uZSgpOiByb3V0ZTUzLklIb3N0ZWRab25lIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIFNraXAgaWYgY3VzdG9tRG9tYWluIGlzIG5vdCBjb25maWd1cmVkXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgaG9zdGVkWm9uZTtcblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChpc0NES0NvbnN0cnVjdChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSBhcyByb3V0ZTUzLklIb3N0ZWRab25lO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgLy8gU2tpcCBpZiBkb21haW4gaXMgbm90IGEgUm91dGU1MyBkb21haW5cbiAgICAgIGlmIChjdXN0b21Eb21haW4uaXNFeHRlcm5hbERvbWFpbiA9PT0gdHJ1ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGhvc3RlZFpvbmUgPSByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cCh0aGlzLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhvc3RlZFpvbmU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNlcnRpZmljYXRlKCk6IGFjbS5JQ2VydGlmaWNhdGUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgYWNtQ2VydGlmaWNhdGU7XG5cbiAgICAvLyBIb3N0ZWRab25lIGlzIHNldCBmb3IgUm91dGUgNTMgZG9tYWluc1xuICAgIGlmICh0aGlzLmhvc3RlZFpvbmUpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4sXG4gICAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICAgIHJlZ2lvbjogXCJ1cy1lYXN0LTFcIixcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSxcbiAgICAgICAgICBob3N0ZWRab25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICAgICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gSG9zdGVkWm9uZSBpcyBOT1Qgc2V0IGZvciBub24tUm91dGUgNTMgZG9tYWluc1xuICAgIGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgYWNtQ2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGFjbUNlcnRpZmljYXRlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVJvdXRlNTNSZWNvcmRzKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4gfHwgIXRoaXMuaG9zdGVkWm9uZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCByZWNvcmROYW1lO1xuICAgIGxldCBkb21haW5BbGlhcztcbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmVjb3JkTmFtZSA9IGN1c3RvbURvbWFpbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVjb3JkTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lO1xuICAgICAgZG9tYWluQWxpYXMgPSBjdXN0b21Eb21haW4uZG9tYWluQWxpYXM7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIEROUyByZWNvcmRcbiAgICBuZXcgcm91dGU1My5BUmVjb3JkKHRoaXMsIFwiQWxpYXNSZWNvcmRcIiwge1xuICAgICAgcmVjb3JkTmFtZSxcbiAgICAgIHpvbmU6IHRoaXMuaG9zdGVkWm9uZSxcbiAgICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgICBuZXcgcm91dGU1M1RhcmdldHMuQ2xvdWRGcm9udFRhcmdldCh0aGlzLmNmRGlzdHJpYnV0aW9uKVxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBBbGlhcyByZWRpcmVjdCByZWNvcmRcbiAgICBpZiAoZG9tYWluQWxpYXMpIHtcbiAgICAgIG5ldyByb3V0ZTUzUGF0dGVybnMuSHR0cHNSZWRpcmVjdCh0aGlzLCBcIlJlZGlyZWN0XCIsIHtcbiAgICAgICAgem9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICByZWNvcmROYW1lczogW2RvbWFpbkFsaWFzXSxcbiAgICAgICAgdGFyZ2V0RG9tYWluOiByZWNvcmROYW1lLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEhlbHBlciBGdW5jdGlvbnNcbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBnZXRTM0NvbnRlbnRSZXBsYWNlVmFsdWVzKCk6IEJhc2VTaXRlUmVwbGFjZVByb3BzW10ge1xuICAgIGNvbnN0IHJlcGxhY2VWYWx1ZXM6IEJhc2VTaXRlUmVwbGFjZVByb3BzW10gPVxuICAgICAgdGhpcy5wcm9wcy5yZXBsYWNlVmFsdWVzIHx8IFtdO1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5lbnZpcm9ubWVudCB8fCB7fSlcbiAgICAgIC5maWx0ZXIoKFssIHZhbHVlXSkgPT4gY2RrLlRva2VuLmlzVW5yZXNvbHZlZCh2YWx1ZSkpXG4gICAgICAuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gYHt7ICR7a2V5fSB9fWA7XG4gICAgICAgIHJlcGxhY2VWYWx1ZXMucHVzaChcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCJpbmRleC5odG1sXCIsXG4gICAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCIqKi8qLmpzXCIsXG4gICAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgcmV0dXJuIHJlcGxhY2VWYWx1ZXM7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyU2l0ZUVudmlyb25tZW50KCkge1xuICAgIGNvbnN0IGVudmlyb25tZW50T3V0cHV0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQgfHwge30pKSB7XG4gICAgICBjb25zdCBvdXRwdXRJZCA9IGBTc3RTaXRlRW52XyR7a2V5fWA7XG4gICAgICBjb25zdCBvdXRwdXQgPSBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBvdXRwdXRJZCwgeyB2YWx1ZSB9KTtcbiAgICAgIGVudmlyb25tZW50T3V0cHV0c1trZXldID0gY2RrLlN0YWNrLm9mKHRoaXMpLmdldExvZ2ljYWxJZChvdXRwdXQpO1xuICAgIH1cblxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcm9vdC5yZWdpc3RlclNpdGVFbnZpcm9ubWVudCh7XG4gICAgICBpZDogdGhpcy5ub2RlLmlkLFxuICAgICAgcGF0aDogdGhpcy5wcm9wcy5wYXRoLFxuICAgICAgc3RhY2s6IGNkay5TdGFjay5vZih0aGlzKS5ub2RlLmlkLFxuICAgICAgZW52aXJvbm1lbnRPdXRwdXRzLFxuICAgIH0gYXMgQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvKTtcbiAgfVxufVxuIl19