"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.App = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const core_1 = require("@serverless-stack/core");
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
function exitWithMessage(message) {
    console.error(message);
    process.exit(1);
}
class App extends cdk.App {
    constructor(deployProps = {}, props = {}) {
        super(props);
        /**
         * Is the app being deployed locally
         */
        this.local = false;
        /**
         * A list of Lambda functions in the app
         */
        this.lambdaHandlers = [];
        this.siteEnvironments = [];
        this.appPath = process.cwd();
        this.stage = deployProps.stage || "dev";
        this.name = deployProps.name || "my-app";
        this.region =
            deployProps.region || process.env.CDK_DEFAULT_REGION || "us-east-1";
        this.lint = deployProps.lint === false ? false : true;
        this.account = process.env.CDK_DEFAULT_ACCOUNT || "my-account";
        this.typeCheck = deployProps.typeCheck === false ? false : true;
        this.esbuildConfig = deployProps.esbuildConfig;
        this.buildDir = deployProps.buildDir || ".build";
        this.skipBuild = deployProps.skipBuild || false;
        this.defaultFunctionProps = [];
        this.synthCallback = deployProps.synthCallback;
        core_1.State.init(this.appPath);
        if (deployProps.debugEndpoint) {
            this.local = true;
            core_1.State.Function.reset(this.appPath);
            this.debugEndpoint = deployProps.debugEndpoint;
            this.debugBucketArn = deployProps.debugBucketArn;
            this.debugBucketName = deployProps.debugBucketName;
            this.debugStartedAt = deployProps.debugStartedAt;
            this.debugIncreaseTimeout = deployProps.debugIncreaseTimeout;
            if (deployProps.debugBridge) {
                this.debugBridge = deployProps.debugBridge;
            }
        }
    }
    get defaultRemovalPolicy() {
        return this._defaultRemovalPolicy;
    }
    logicalPrefixedName(logicalName) {
        const namePrefix = this.name === "" ? "" : `${this.name}-`;
        return `${this.stage}-${namePrefix}${logicalName}`;
    }
    setDefaultRemovalPolicy(policy) {
        this._defaultRemovalPolicy = policy;
    }
    setDefaultFunctionProps(props) {
        if (this.lambdaHandlers.length > 0)
            throw new Error("Cannot call 'setDefaultFunctionProps' after a stack with functions has been created. Please use 'addDefaultFunctionEnv' or 'addDefaultFunctionPermissions' to add more default properties. Read more about this change here: https://docs.serverless-stack.com/constructs/App#upgrading-to-v0420");
        this.defaultFunctionProps.push(props);
    }
    addDefaultFunctionPermissions(permissions) {
        this.defaultFunctionProps.push({
            permissions,
        });
    }
    addDefaultFunctionEnv(environment) {
        this.defaultFunctionProps.push({
            environment,
        });
    }
    addDefaultFunctionLayers(layers) {
        this.defaultFunctionProps.push({
            layers,
        });
    }
    synth(options = {}) {
        this.buildConstructsMetadata();
        for (const child of this.node.children) {
            if (Construct_1.isStackConstruct(child)) {
                // Tag stacks
                cdk.Tags.of(child).add("sst:app", this.name);
                cdk.Tags.of(child).add("sst:stage", this.stage);
                // Set removal policy
                if (this._defaultRemovalPolicy)
                    this.applyRemovalPolicy(child, this._defaultRemovalPolicy);
                // Stack names need to be parameterized with the stage name
                if (!child.stackName.startsWith(`${this.stage}-`) &&
                    !child.stackName.endsWith(`-${this.stage}`) &&
                    child.stackName.indexOf(`-${this.stage}-`) === -1) {
                    throw new Error(`Stack "${child.stackName}" is not parameterized with the stage name. The stack name needs to either start with "$stage-", end in "-$stage", or contain the stage name "-$stage-".`);
                }
            }
        }
        const cloudAssembly = super.synth(options);
        // Run callback after synth has finished
        if (this.synthCallback) {
            this.synthCallback(this.lambdaHandlers, this.siteEnvironments);
        }
        return cloudAssembly;
    }
    isJestTest() {
        // Check the env var set inside test/setup-tests.js
        return process.env.JEST_RESOURCES_TESTS === "enabled";
    }
    registerLambdaHandler(handler) {
        this.lambdaHandlers.push(handler);
    }
    registerSiteEnvironment(environment) {
        this.siteEnvironments.push(environment);
    }
    getInputFilesFromEsbuildMetafile(file) {
        let metaJson;
        try {
            metaJson = fs.readJsonSync(file);
        }
        catch (e) {
            exitWithMessage("There was a problem reading the esbuild metafile.");
        }
        return Object.keys(metaJson.inputs).map((input) => path.resolve(input));
    }
    buildConstructsMetadata() {
        const constructs = this.buildConstructsMetadata_collectConstructs(this);
        const byStack = {};
        const local = [];
        for (const c of constructs) {
            const stack = Stack_1.Stack.of(c);
            const list = byStack[stack.node.id] || [];
            const metadata = c.getConstructMetadata();
            const item = Object.assign({ id: c.node.id, addr: c.node.addr, stack: Stack_1.Stack.of(c).stackName }, metadata);
            local.push(item);
            list.push(Object.assign(Object.assign({}, item), { local: undefined }));
            byStack[stack.node.id] = list;
        }
        // Register constructs
        for (const child of this.node.children) {
            if (child instanceof Stack_1.Stack) {
                const stackName = child.node.id;
                child.addConstructsMetadata(byStack[stackName] || []);
            }
        }
        fs.writeJSONSync(core_1.State.resolve(this.appPath, "constructs.json"), local);
    }
    buildConstructsMetadata_collectConstructs(construct) {
        return [
            Construct_1.isSSTConstruct(construct) ? construct : undefined,
            ...construct.node.children.flatMap((c) => this.buildConstructsMetadata_collectConstructs(c)),
        ].filter((c) => Boolean(c));
    }
    applyRemovalPolicy(current, policy) {
        if (current instanceof cdk.CfnResource)
            current.applyRemovalPolicy(policy);
        // Had to copy this in to enable deleting objects in bucket
        // https://github.com/aws/aws-cdk/blob/master/packages/%40aws-cdk/aws-s3/lib/bucket.ts#L1910
        if (current instanceof s3.Bucket &&
            !current.node.tryFindChild("AutoDeleteObjectsCustomResource")) {
            const AUTO_DELETE_OBJECTS_RESOURCE_TYPE = "Custom::S3AutoDeleteObjects";
            const provider = cdk.CustomResourceProvider.getOrCreateProvider(current, AUTO_DELETE_OBJECTS_RESOURCE_TYPE, {
                codeDirectory: path.join(require.resolve("aws-cdk-lib/aws-s3"), "../lib/auto-delete-objects-handler"),
                runtime: cdk.CustomResourceProviderRuntime.NODEJS_12_X,
                description: `Lambda function for auto-deleting objects in ${current.bucketName} S3 bucket.`,
            });
            // Use a bucket policy to allow the custom resource to delete
            // objects in the bucket
            current.addToResourcePolicy(new iam.PolicyStatement({
                actions: [
                    // list objects
                    "s3:GetBucket*",
                    "s3:List*",
                    // and then delete them
                    "s3:DeleteObject*",
                ],
                resources: [current.bucketArn, current.arnForObjects("*")],
                principals: [new iam.ArnPrincipal(provider.roleArn)],
            }));
            const customResource = new cdk.CustomResource(current, "AutoDeleteObjectsCustomResource", {
                resourceType: AUTO_DELETE_OBJECTS_RESOURCE_TYPE,
                serviceToken: provider.serviceToken,
                properties: {
                    BucketName: current.bucketName,
                },
            });
            // Ensure bucket policy is deleted AFTER the custom resource otherwise
            // we don't have permissions to list and delete in the bucket.
            // (add a `if` to make TS happy)
            if (current.policy) {
                customResource.node.addDependency(current.policy);
            }
        }
        current.node.children.forEach((resource) => this.applyRemovalPolicy(resource, policy));
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQixpREFBbUM7QUFFbkMsdURBQXlDO0FBQ3pDLHlEQUEyQztBQUczQyxpREFBK0M7QUFDL0MsbUNBQWdDO0FBQ2hDLDJDQUtxQjtBQUtyQixTQUFTLGVBQWUsQ0FBQyxPQUFlO0lBQ3RDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsQixDQUFDO0FBc0RELE1BQWEsR0FBSSxTQUFRLEdBQUcsQ0FBQyxHQUFHO0lBNEQ5QixZQUFZLGNBQThCLEVBQUUsRUFBRSxRQUFrQixFQUFFO1FBQ2hFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQTVEZjs7V0FFRztRQUNhLFVBQUssR0FBWSxLQUFLLENBQUM7UUFzQ3ZDOztXQUVHO1FBQ2MsbUJBQWMsR0FBMkIsRUFBRSxDQUFDO1FBQzVDLHFCQUFnQixHQUFxQyxFQUFFLENBQUM7UUFnQnZFLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRTdCLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUM7UUFDeEMsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxJQUFJLFFBQVEsQ0FBQztRQUN6QyxJQUFJLENBQUMsTUFBTTtZQUNULFdBQVcsQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSxXQUFXLENBQUM7UUFDdEUsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDdEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLFlBQVksQ0FBQztRQUMvRCxJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQyxTQUFTLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNoRSxJQUFJLENBQUMsYUFBYSxHQUFHLFdBQVcsQ0FBQyxhQUFhLENBQUM7UUFDL0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxXQUFXLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQztRQUNqRCxJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQyxTQUFTLElBQUksS0FBSyxDQUFDO1FBQ2hELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFDO1FBRS9DLFlBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3pCLElBQUksV0FBVyxDQUFDLGFBQWEsRUFBRTtZQUM3QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztZQUNsQixZQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFDO1lBQy9DLElBQUksQ0FBQyxjQUFjLEdBQUcsV0FBVyxDQUFDLGNBQWMsQ0FBQztZQUNqRCxJQUFJLENBQUMsZUFBZSxHQUFHLFdBQVcsQ0FBQyxlQUFlLENBQUM7WUFDbkQsSUFBSSxDQUFDLGNBQWMsR0FBRyxXQUFXLENBQUMsY0FBYyxDQUFDO1lBQ2pELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxXQUFXLENBQUMsb0JBQW9CLENBQUM7WUFDN0QsSUFBSSxXQUFXLENBQUMsV0FBVyxFQUFFO2dCQUMzQixJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUM7YUFDNUM7U0FDRjtJQUNILENBQUM7SUE1REQsSUFBVyxvQkFBb0I7UUFDN0IsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUM7SUFDcEMsQ0FBQztJQTRERCxtQkFBbUIsQ0FBQyxXQUFtQjtRQUNyQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQztRQUMzRCxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxVQUFVLEdBQUcsV0FBVyxFQUFFLENBQUM7SUFDckQsQ0FBQztJQUVELHVCQUF1QixDQUFDLE1BQXlCO1FBQy9DLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxNQUFNLENBQUM7SUFDdEMsQ0FBQztJQUVELHVCQUF1QixDQUNyQixLQUE0RDtRQUU1RCxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxHQUFHLENBQUM7WUFDaEMsTUFBTSxJQUFJLEtBQUssQ0FDYixrU0FBa1MsQ0FDblMsQ0FBQztRQUNKLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELDZCQUE2QixDQUFDLFdBQXdCO1FBQ3BELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUM7WUFDN0IsV0FBVztTQUNaLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxXQUFtQztRQUN2RCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDO1lBQzdCLFdBQVc7U0FDWixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsd0JBQXdCLENBQUMsTUFBdUI7UUFDOUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQztZQUM3QixNQUFNO1NBQ1AsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFxQyxFQUFFO1FBQzNDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBRS9CLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDdEMsSUFBSSw0QkFBZ0IsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDM0IsYUFBYTtnQkFDYixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDN0MsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBRWhELHFCQUFxQjtnQkFDckIsSUFBSSxJQUFJLENBQUMscUJBQXFCO29CQUM1QixJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2dCQUU3RCwyREFBMkQ7Z0JBQzNELElBQ0UsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQztvQkFDN0MsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDM0MsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFDakQ7b0JBQ0EsTUFBTSxJQUFJLEtBQUssQ0FDYixVQUFVLEtBQUssQ0FBQyxTQUFTLDBKQUEwSixDQUNwTCxDQUFDO2lCQUNIO2FBQ0Y7U0FDRjtRQUVELE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFM0Msd0NBQXdDO1FBQ3hDLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7U0FDaEU7UUFFRCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRUQsVUFBVTtRQUNSLG1EQUFtRDtRQUNuRCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEtBQUssU0FBUyxDQUFDO0lBQ3hELENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxPQUE2QjtRQUNqRCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsdUJBQXVCLENBQUMsV0FBMkM7UUFDakUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsZ0NBQWdDLENBQUMsSUFBWTtRQUMzQyxJQUFJLFFBQVEsQ0FBQztRQUViLElBQUk7WUFDRixRQUFRLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNsQztRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsZUFBZSxDQUFDLG1EQUFtRCxDQUFDLENBQUM7U0FDdEU7UUFFRCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLHlDQUF5QyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBTXhFLE1BQU0sT0FBTyxHQUFnQyxFQUFFLENBQUM7UUFDaEQsTUFBTSxLQUFLLEdBQWdCLEVBQUUsQ0FBQztRQUM5QixLQUFLLE1BQU0sQ0FBQyxJQUFJLFVBQVUsRUFBRTtZQUMxQixNQUFNLEtBQUssR0FBRyxhQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMxQyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUMxQyxNQUFNLElBQUksbUJBQ1IsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUNiLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFDakIsS0FBSyxFQUFFLGFBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxJQUN6QixRQUFRLENBQ1osQ0FBQztZQUNGLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakIsSUFBSSxDQUFDLElBQUksaUNBQ0osSUFBSSxLQUNQLEtBQUssRUFBRSxTQUFTLElBQ2hCLENBQUM7WUFDSCxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDL0I7UUFFRCxzQkFBc0I7UUFDdEIsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN0QyxJQUFJLEtBQUssWUFBWSxhQUFLLEVBQUU7Z0JBQzFCLE1BQU0sU0FBUyxHQUFJLEtBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUMxQyxLQUFlLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO2FBQ2xFO1NBQ0Y7UUFDRCxFQUFFLENBQUMsYUFBYSxDQUFDLFlBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxpQkFBaUIsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFTyx5Q0FBeUMsQ0FDL0MsU0FBcUI7UUFFckIsT0FBTztZQUNMLDBCQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNqRCxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ3ZDLElBQUksQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDLENBQUMsQ0FDbEQ7U0FDRixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBa0MsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxPQUFtQixFQUFFLE1BQXlCO1FBQ3ZFLElBQUksT0FBTyxZQUFZLEdBQUcsQ0FBQyxXQUFXO1lBQUUsT0FBTyxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTNFLDJEQUEyRDtRQUMzRCw0RkFBNEY7UUFDNUYsSUFDRSxPQUFPLFlBQVksRUFBRSxDQUFDLE1BQU07WUFDNUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxpQ0FBaUMsQ0FBQyxFQUM3RDtZQUNBLE1BQU0saUNBQWlDLEdBQUcsNkJBQTZCLENBQUM7WUFDeEUsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLHNCQUFzQixDQUFDLG1CQUFtQixDQUM3RCxPQUFPLEVBQ1AsaUNBQWlDLEVBQ2pDO2dCQUNFLGFBQWEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUN0QixPQUFPLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLEVBQ3JDLG9DQUFvQyxDQUNyQztnQkFDRCxPQUFPLEVBQUUsR0FBRyxDQUFDLDZCQUE2QixDQUFDLFdBQVc7Z0JBQ3RELFdBQVcsRUFBRSxnREFBZ0QsT0FBTyxDQUFDLFVBQVUsYUFBYTthQUM3RixDQUNGLENBQUM7WUFFRiw2REFBNkQ7WUFDN0Qsd0JBQXdCO1lBQ3hCLE9BQU8sQ0FBQyxtQkFBbUIsQ0FDekIsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO2dCQUN0QixPQUFPLEVBQUU7b0JBQ1AsZUFBZTtvQkFDZixlQUFlO29CQUNmLFVBQVU7b0JBQ1YsdUJBQXVCO29CQUN2QixrQkFBa0I7aUJBQ25CO2dCQUNELFNBQVMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUQsVUFBVSxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNyRCxDQUFDLENBQ0gsQ0FBQztZQUVGLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLGNBQWMsQ0FDM0MsT0FBTyxFQUNQLGlDQUFpQyxFQUNqQztnQkFDRSxZQUFZLEVBQUUsaUNBQWlDO2dCQUMvQyxZQUFZLEVBQUUsUUFBUSxDQUFDLFlBQVk7Z0JBQ25DLFVBQVUsRUFBRTtvQkFDVixVQUFVLEVBQUUsT0FBTyxDQUFDLFVBQVU7aUJBQy9CO2FBQ0YsQ0FDRixDQUFDO1lBRUYsc0VBQXNFO1lBQ3RFLDhEQUE4RDtZQUM5RCxnQ0FBZ0M7WUFDaEMsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO2dCQUNsQixjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDbkQ7U0FDRjtRQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQ3pDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQzFDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1U0Qsa0JBNFNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtczNcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHsgSUxheWVyVmVyc2lvbiB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBjeGFwaSBmcm9tIFwiYXdzLWNkay1saWIvY3gtYXBpXCI7XG5pbXBvcnQgeyBTdGF0ZSB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9jb3JlXCI7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gXCIuL1N0YWNrXCI7XG5pbXBvcnQge1xuICBTU1RDb25zdHJ1Y3QsXG4gIFNTVENvbnN0cnVjdE1ldGFkYXRhLFxuICBpc1NTVENvbnN0cnVjdCxcbiAgaXNTdGFja0NvbnN0cnVjdCxcbn0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5pbXBvcnQgeyBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkhhbmRsZXJQcm9wcyB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm8gfSBmcm9tIFwiLi9CYXNlU2l0ZVwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuZnVuY3Rpb24gZXhpdFdpdGhNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZykge1xuICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xuICBwcm9jZXNzLmV4aXQoMSk7XG59XG5cbmV4cG9ydCB0eXBlIERlcGxveVByb3BzID0gQXBwRGVwbG95UHJvcHM7XG5cbi8qKlxuICogRGVwbG95IHByb3BzIGZvciBhcHBzLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFwcERlcGxveVByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBhcHAgbmFtZSwgdXNlZCB0byBwcmVmaXggc3RhY2tzLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIERlZmF1bHRzIHRvIGVtcHR5IHN0cmluZ1xuICAgKi9cbiAgcmVhZG9ubHkgbmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHN0YWdlIHRvIGRlcGxveSB0aGlzIGFwcCB0by5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBEZWZhdWx0cyB0byBkZXZcbiAgICovXG4gIHJlYWRvbmx5IHN0YWdlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgcmVnaW9uIHRvIGRlcGxveSB0aGlzIGFwcCB0by5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBEZWZhdWx0cyB0byB1cy1lYXN0LTFcbiAgICovXG4gIHJlYWRvbmx5IHJlZ2lvbj86IHN0cmluZztcblxuICByZWFkb25seSBsaW50PzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgdHlwZUNoZWNrPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgYnVpbGREaXI/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNraXBCdWlsZD86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGVzYnVpbGRDb25maWc/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlYnVnRW5kcG9pbnQ/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlYnVnQnVja2V0QXJuPzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z0J1Y2tldE5hbWU/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlYnVnU3RhcnRlZEF0PzogbnVtYmVyO1xuICByZWFkb25seSBkZWJ1Z0JyaWRnZT86IHN0cmluZztcbiAgcmVhZG9ubHkgZGVidWdJbmNyZWFzZVRpbWVvdXQ/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBUaGUgY2FsbGJhY2sgYWZ0ZXIgc3ludGggY29tcGxldGVzLCB1c2VkIGJ5IGBzc3Qgc3RhcnRgLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIERlZmF1bHRzIHRvIHVuZGVmaW5lZFxuICAgKi9cbiAgcmVhZG9ubHkgc3ludGhDYWxsYmFjaz86IChcbiAgICBsYW1iZGFIYW5kbGVyczogRnVuY3Rpb25IYW5kbGVyUHJvcHNbXSxcbiAgICBzaXRlRW52aXJvbm1lbnRzOiBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm9bXVxuICApID0+IHZvaWQ7XG59XG5cbmV4cG9ydCB0eXBlIEFwcFByb3BzID0gY2RrLkFwcFByb3BzO1xuXG5leHBvcnQgY2xhc3MgQXBwIGV4dGVuZHMgY2RrLkFwcCB7XG4gIC8qKlxuICAgKiBJcyB0aGUgYXBwIGJlaW5nIGRlcGxveWVkIGxvY2FsbHlcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBsb2NhbDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBUaGUgYXBwIG5hbWVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBzdGFnZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgcmVnaW9uOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBsaW50OiBib29sZWFuO1xuICBwdWJsaWMgcmVhZG9ubHkgYWNjb3VudDogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgdHlwZUNoZWNrOiBib29sZWFuO1xuICBwdWJsaWMgcmVhZG9ubHkgYnVpbGREaXI6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGVzYnVpbGRDb25maWc/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0JyaWRnZT86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGRlYnVnRW5kcG9pbnQ/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0J1Y2tldEFybj86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGRlYnVnQnVja2V0TmFtZT86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGRlYnVnU3RhcnRlZEF0PzogbnVtYmVyO1xuICBwdWJsaWMgcmVhZG9ubHkgZGVidWdJbmNyZWFzZVRpbWVvdXQ/OiBib29sZWFuO1xuICBwdWJsaWMgcmVhZG9ubHkgYXBwUGF0aDogc3RyaW5nO1xuXG4gIHB1YmxpYyBkZWZhdWx0RnVuY3Rpb25Qcm9wczogKFxuICAgIHwgRnVuY3Rpb25Qcm9wc1xuICAgIHwgKChzdGFjazogY2RrLlN0YWNrKSA9PiBGdW5jdGlvblByb3BzKVxuICApW107XG4gIHByaXZhdGUgX2RlZmF1bHRSZW1vdmFsUG9saWN5PzogY2RrLlJlbW92YWxQb2xpY3k7XG4gIHB1YmxpYyBnZXQgZGVmYXVsdFJlbW92YWxQb2xpY3koKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RlZmF1bHRSZW1vdmFsUG9saWN5O1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBjYWxsYmFjayBhZnRlciBzeW50aCBjb21wbGV0ZXMuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHN5bnRoQ2FsbGJhY2s/OiAoXG4gICAgbGFtYmRhSGFuZGxlcnM6IEZ1bmN0aW9uSGFuZGxlclByb3BzW10sXG4gICAgc2l0ZUVudmlyb25tZW50czogQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvW11cbiAgKSA9PiB2b2lkO1xuXG4gIC8qKlxuICAgKiBBIGxpc3Qgb2YgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgYXBwXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGxhbWJkYUhhbmRsZXJzOiBGdW5jdGlvbkhhbmRsZXJQcm9wc1tdID0gW107XG4gIHByaXZhdGUgcmVhZG9ubHkgc2l0ZUVudmlyb25tZW50czogQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvW10gPSBbXTtcblxuICAvKipcbiAgICogU2tpcCBidWlsZGluZyBGdW5jdGlvbiBjb2RlXG4gICAqIE5vdGUgdGhhdCBvbiBgc3N0IHJlbW92ZWAsIHdlIGRvIG5vdCB3YW50IHRvIGJ1bmRsZSB0aGUgTGFtYmRhIGZ1bmN0aW9ucy5cbiAgICogICAgICBDREsgZGlzYWJsZXMgYnVuZGxpbmcgKGllLiB6aXBwaW5nKSBmb3IgYGNkayBkZXN0cm95YCBjb21tYW5kLlxuICAgKiAgICAgIEJ1dCBTU1QgcnVucyBgY2RrIHN5bnRoYCBmaXJzdCB0aGVuIG1hbnVhbGx5IHJlbW92ZSBlYWNoIHN0YWNrLiBIZW5jZVxuICAgKiAgICAgIHdlIGNhbm5vdCByZWx5IG9uIENESyB0byBkaXNhYmxlIGJ1bmRsaW5nLCBhbmQgd2UgZGlzYWJsZSBpdCBtYW51YWxseS5cbiAgICogICAgICBUaGlzIGFsbG93cyB1cyB0byBkaXNhYmxlIEJPVEggYnVpbGRpbmcgYW5kIGJ1bmRsaW5nLCB3aGVyZSBhcyBDREtcbiAgICogICAgICB3b3VsZCBvbmx5IGRpc2FibGUgdGhlIGxhdHRlci4gRm9yIGV4YW1wbGUsIGBjZGsgZGVzdHJveWAgc3RpbGwgdHJ5c1xuICAgKiAgICAgIHRvIGluc3RhbGwgUHl0aG9uIGRlcGVuZGVuY2llcyBpbiBEb2NrZXIuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgc2tpcEJ1aWxkOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKGRlcGxveVByb3BzOiBBcHBEZXBsb3lQcm9wcyA9IHt9LCBwcm9wczogQXBwUHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLmFwcFBhdGggPSBwcm9jZXNzLmN3ZCgpO1xuXG4gICAgdGhpcy5zdGFnZSA9IGRlcGxveVByb3BzLnN0YWdlIHx8IFwiZGV2XCI7XG4gICAgdGhpcy5uYW1lID0gZGVwbG95UHJvcHMubmFtZSB8fCBcIm15LWFwcFwiO1xuICAgIHRoaXMucmVnaW9uID1cbiAgICAgIGRlcGxveVByb3BzLnJlZ2lvbiB8fCBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9SRUdJT04gfHwgXCJ1cy1lYXN0LTFcIjtcbiAgICB0aGlzLmxpbnQgPSBkZXBsb3lQcm9wcy5saW50ID09PSBmYWxzZSA/IGZhbHNlIDogdHJ1ZTtcbiAgICB0aGlzLmFjY291bnQgPSBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5UIHx8IFwibXktYWNjb3VudFwiO1xuICAgIHRoaXMudHlwZUNoZWNrID0gZGVwbG95UHJvcHMudHlwZUNoZWNrID09PSBmYWxzZSA/IGZhbHNlIDogdHJ1ZTtcbiAgICB0aGlzLmVzYnVpbGRDb25maWcgPSBkZXBsb3lQcm9wcy5lc2J1aWxkQ29uZmlnO1xuICAgIHRoaXMuYnVpbGREaXIgPSBkZXBsb3lQcm9wcy5idWlsZERpciB8fCBcIi5idWlsZFwiO1xuICAgIHRoaXMuc2tpcEJ1aWxkID0gZGVwbG95UHJvcHMuc2tpcEJ1aWxkIHx8IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgPSBbXTtcbiAgICB0aGlzLnN5bnRoQ2FsbGJhY2sgPSBkZXBsb3lQcm9wcy5zeW50aENhbGxiYWNrO1xuXG4gICAgU3RhdGUuaW5pdCh0aGlzLmFwcFBhdGgpO1xuICAgIGlmIChkZXBsb3lQcm9wcy5kZWJ1Z0VuZHBvaW50KSB7XG4gICAgICB0aGlzLmxvY2FsID0gdHJ1ZTtcbiAgICAgIFN0YXRlLkZ1bmN0aW9uLnJlc2V0KHRoaXMuYXBwUGF0aCk7XG4gICAgICB0aGlzLmRlYnVnRW5kcG9pbnQgPSBkZXBsb3lQcm9wcy5kZWJ1Z0VuZHBvaW50O1xuICAgICAgdGhpcy5kZWJ1Z0J1Y2tldEFybiA9IGRlcGxveVByb3BzLmRlYnVnQnVja2V0QXJuO1xuICAgICAgdGhpcy5kZWJ1Z0J1Y2tldE5hbWUgPSBkZXBsb3lQcm9wcy5kZWJ1Z0J1Y2tldE5hbWU7XG4gICAgICB0aGlzLmRlYnVnU3RhcnRlZEF0ID0gZGVwbG95UHJvcHMuZGVidWdTdGFydGVkQXQ7XG4gICAgICB0aGlzLmRlYnVnSW5jcmVhc2VUaW1lb3V0ID0gZGVwbG95UHJvcHMuZGVidWdJbmNyZWFzZVRpbWVvdXQ7XG4gICAgICBpZiAoZGVwbG95UHJvcHMuZGVidWdCcmlkZ2UpIHtcbiAgICAgICAgdGhpcy5kZWJ1Z0JyaWRnZSA9IGRlcGxveVByb3BzLmRlYnVnQnJpZGdlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGxvZ2ljYWxQcmVmaXhlZE5hbWUobG9naWNhbE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgbmFtZVByZWZpeCA9IHRoaXMubmFtZSA9PT0gXCJcIiA/IFwiXCIgOiBgJHt0aGlzLm5hbWV9LWA7XG4gICAgcmV0dXJuIGAke3RoaXMuc3RhZ2V9LSR7bmFtZVByZWZpeH0ke2xvZ2ljYWxOYW1lfWA7XG4gIH1cblxuICBzZXREZWZhdWx0UmVtb3ZhbFBvbGljeShwb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5KSB7XG4gICAgdGhpcy5fZGVmYXVsdFJlbW92YWxQb2xpY3kgPSBwb2xpY3k7XG4gIH1cblxuICBzZXREZWZhdWx0RnVuY3Rpb25Qcm9wcyhcbiAgICBwcm9wczogRnVuY3Rpb25Qcm9wcyB8ICgoc3RhY2s6IGNkay5TdGFjaykgPT4gRnVuY3Rpb25Qcm9wcylcbiAgKTogdm9pZCB7XG4gICAgaWYgKHRoaXMubGFtYmRhSGFuZGxlcnMubGVuZ3RoID4gMClcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJDYW5ub3QgY2FsbCAnc2V0RGVmYXVsdEZ1bmN0aW9uUHJvcHMnIGFmdGVyIGEgc3RhY2sgd2l0aCBmdW5jdGlvbnMgaGFzIGJlZW4gY3JlYXRlZC4gUGxlYXNlIHVzZSAnYWRkRGVmYXVsdEZ1bmN0aW9uRW52JyBvciAnYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMnIHRvIGFkZCBtb3JlIGRlZmF1bHQgcHJvcGVydGllcy4gUmVhZCBtb3JlIGFib3V0IHRoaXMgY2hhbmdlIGhlcmU6IGh0dHBzOi8vZG9jcy5zZXJ2ZXJsZXNzLXN0YWNrLmNvbS9jb25zdHJ1Y3RzL0FwcCN1cGdyYWRpbmctdG8tdjA0MjBcIlxuICAgICAgKTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLnB1c2gocHJvcHMpO1xuICB9XG5cbiAgYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIHBlcm1pc3Npb25zLFxuICAgIH0pO1xuICB9XG5cbiAgYWRkRGVmYXVsdEZ1bmN0aW9uRW52KGVudmlyb25tZW50OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIGVudmlyb25tZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYWRkRGVmYXVsdEZ1bmN0aW9uTGF5ZXJzKGxheWVyczogSUxheWVyVmVyc2lvbltdKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIGxheWVycyxcbiAgICB9KTtcbiAgfVxuXG4gIHN5bnRoKG9wdGlvbnM6IGNkay5TdGFnZVN5bnRoZXNpc09wdGlvbnMgPSB7fSk6IGN4YXBpLkNsb3VkQXNzZW1ibHkge1xuICAgIHRoaXMuYnVpbGRDb25zdHJ1Y3RzTWV0YWRhdGEoKTtcblxuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5ub2RlLmNoaWxkcmVuKSB7XG4gICAgICBpZiAoaXNTdGFja0NvbnN0cnVjdChjaGlsZCkpIHtcbiAgICAgICAgLy8gVGFnIHN0YWNrc1xuICAgICAgICBjZGsuVGFncy5vZihjaGlsZCkuYWRkKFwic3N0OmFwcFwiLCB0aGlzLm5hbWUpO1xuICAgICAgICBjZGsuVGFncy5vZihjaGlsZCkuYWRkKFwic3N0OnN0YWdlXCIsIHRoaXMuc3RhZ2UpO1xuXG4gICAgICAgIC8vIFNldCByZW1vdmFsIHBvbGljeVxuICAgICAgICBpZiAodGhpcy5fZGVmYXVsdFJlbW92YWxQb2xpY3kpXG4gICAgICAgICAgdGhpcy5hcHBseVJlbW92YWxQb2xpY3koY2hpbGQsIHRoaXMuX2RlZmF1bHRSZW1vdmFsUG9saWN5KTtcblxuICAgICAgICAvLyBTdGFjayBuYW1lcyBuZWVkIHRvIGJlIHBhcmFtZXRlcml6ZWQgd2l0aCB0aGUgc3RhZ2UgbmFtZVxuICAgICAgICBpZiAoXG4gICAgICAgICAgIWNoaWxkLnN0YWNrTmFtZS5zdGFydHNXaXRoKGAke3RoaXMuc3RhZ2V9LWApICYmXG4gICAgICAgICAgIWNoaWxkLnN0YWNrTmFtZS5lbmRzV2l0aChgLSR7dGhpcy5zdGFnZX1gKSAmJlxuICAgICAgICAgIGNoaWxkLnN0YWNrTmFtZS5pbmRleE9mKGAtJHt0aGlzLnN0YWdlfS1gKSA9PT0gLTFcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYFN0YWNrIFwiJHtjaGlsZC5zdGFja05hbWV9XCIgaXMgbm90IHBhcmFtZXRlcml6ZWQgd2l0aCB0aGUgc3RhZ2UgbmFtZS4gVGhlIHN0YWNrIG5hbWUgbmVlZHMgdG8gZWl0aGVyIHN0YXJ0IHdpdGggXCIkc3RhZ2UtXCIsIGVuZCBpbiBcIi0kc3RhZ2VcIiwgb3IgY29udGFpbiB0aGUgc3RhZ2UgbmFtZSBcIi0kc3RhZ2UtXCIuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBjbG91ZEFzc2VtYmx5ID0gc3VwZXIuc3ludGgob3B0aW9ucyk7XG5cbiAgICAvLyBSdW4gY2FsbGJhY2sgYWZ0ZXIgc3ludGggaGFzIGZpbmlzaGVkXG4gICAgaWYgKHRoaXMuc3ludGhDYWxsYmFjaykge1xuICAgICAgdGhpcy5zeW50aENhbGxiYWNrKHRoaXMubGFtYmRhSGFuZGxlcnMsIHRoaXMuc2l0ZUVudmlyb25tZW50cyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNsb3VkQXNzZW1ibHk7XG4gIH1cblxuICBpc0plc3RUZXN0KCk6IGJvb2xlYW4ge1xuICAgIC8vIENoZWNrIHRoZSBlbnYgdmFyIHNldCBpbnNpZGUgdGVzdC9zZXR1cC10ZXN0cy5qc1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5KRVNUX1JFU09VUkNFU19URVNUUyA9PT0gXCJlbmFibGVkXCI7XG4gIH1cblxuICByZWdpc3RlckxhbWJkYUhhbmRsZXIoaGFuZGxlcjogRnVuY3Rpb25IYW5kbGVyUHJvcHMpOiB2b2lkIHtcbiAgICB0aGlzLmxhbWJkYUhhbmRsZXJzLnB1c2goaGFuZGxlcik7XG4gIH1cblxuICByZWdpc3RlclNpdGVFbnZpcm9ubWVudChlbnZpcm9ubWVudDogQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvKTogdm9pZCB7XG4gICAgdGhpcy5zaXRlRW52aXJvbm1lbnRzLnB1c2goZW52aXJvbm1lbnQpO1xuICB9XG5cbiAgZ2V0SW5wdXRGaWxlc0Zyb21Fc2J1aWxkTWV0YWZpbGUoZmlsZTogc3RyaW5nKTogQXJyYXk8c3RyaW5nPiB7XG4gICAgbGV0IG1ldGFKc29uO1xuXG4gICAgdHJ5IHtcbiAgICAgIG1ldGFKc29uID0gZnMucmVhZEpzb25TeW5jKGZpbGUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGV4aXRXaXRoTWVzc2FnZShcIlRoZXJlIHdhcyBhIHByb2JsZW0gcmVhZGluZyB0aGUgZXNidWlsZCBtZXRhZmlsZS5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKG1ldGFKc29uLmlucHV0cykubWFwKChpbnB1dCkgPT4gcGF0aC5yZXNvbHZlKGlucHV0KSk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQ29uc3RydWN0c01ldGFkYXRhKCk6IHZvaWQge1xuICAgIGNvbnN0IGNvbnN0cnVjdHMgPSB0aGlzLmJ1aWxkQ29uc3RydWN0c01ldGFkYXRhX2NvbGxlY3RDb25zdHJ1Y3RzKHRoaXMpO1xuICAgIHR5cGUgQ29uc3RydWN0ID0gU1NUQ29uc3RydWN0TWV0YWRhdGEgJiB7XG4gICAgICBhZGRyOiBzdHJpbmc7XG4gICAgICBpZDogc3RyaW5nO1xuICAgICAgc3RhY2s6IHN0cmluZztcbiAgICB9O1xuICAgIGNvbnN0IGJ5U3RhY2s6IFJlY29yZDxzdHJpbmcsIENvbnN0cnVjdFtdPiA9IHt9O1xuICAgIGNvbnN0IGxvY2FsOiBDb25zdHJ1Y3RbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgYyBvZiBjb25zdHJ1Y3RzKSB7XG4gICAgICBjb25zdCBzdGFjayA9IFN0YWNrLm9mKGMpO1xuICAgICAgY29uc3QgbGlzdCA9IGJ5U3RhY2tbc3RhY2subm9kZS5pZF0gfHwgW107XG4gICAgICBjb25zdCBtZXRhZGF0YSA9IGMuZ2V0Q29uc3RydWN0TWV0YWRhdGEoKTtcbiAgICAgIGNvbnN0IGl0ZW06IENvbnN0cnVjdCA9IHtcbiAgICAgICAgaWQ6IGMubm9kZS5pZCxcbiAgICAgICAgYWRkcjogYy5ub2RlLmFkZHIsXG4gICAgICAgIHN0YWNrOiBTdGFjay5vZihjKS5zdGFja05hbWUsXG4gICAgICAgIC4uLm1ldGFkYXRhLFxuICAgICAgfTtcbiAgICAgIGxvY2FsLnB1c2goaXRlbSk7XG4gICAgICBsaXN0LnB1c2goe1xuICAgICAgICAuLi5pdGVtLFxuICAgICAgICBsb2NhbDogdW5kZWZpbmVkLFxuICAgICAgfSk7XG4gICAgICBieVN0YWNrW3N0YWNrLm5vZGUuaWRdID0gbGlzdDtcbiAgICB9XG5cbiAgICAvLyBSZWdpc3RlciBjb25zdHJ1Y3RzXG4gICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLm5vZGUuY2hpbGRyZW4pIHtcbiAgICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIFN0YWNrKSB7XG4gICAgICAgIGNvbnN0IHN0YWNrTmFtZSA9IChjaGlsZCBhcyBTdGFjaykubm9kZS5pZDtcbiAgICAgICAgKGNoaWxkIGFzIFN0YWNrKS5hZGRDb25zdHJ1Y3RzTWV0YWRhdGEoYnlTdGFja1tzdGFja05hbWVdIHx8IFtdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZnMud3JpdGVKU09OU3luYyhTdGF0ZS5yZXNvbHZlKHRoaXMuYXBwUGF0aCwgXCJjb25zdHJ1Y3RzLmpzb25cIiksIGxvY2FsKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRDb25zdHJ1Y3RzTWV0YWRhdGFfY29sbGVjdENvbnN0cnVjdHMoXG4gICAgY29uc3RydWN0OiBJQ29uc3RydWN0XG4gICk6IChTU1RDb25zdHJ1Y3QgJiBJQ29uc3RydWN0KVtdIHtcbiAgICByZXR1cm4gW1xuICAgICAgaXNTU1RDb25zdHJ1Y3QoY29uc3RydWN0KSA/IGNvbnN0cnVjdCA6IHVuZGVmaW5lZCxcbiAgICAgIC4uLmNvbnN0cnVjdC5ub2RlLmNoaWxkcmVuLmZsYXRNYXAoKGMpID0+XG4gICAgICAgIHRoaXMuYnVpbGRDb25zdHJ1Y3RzTWV0YWRhdGFfY29sbGVjdENvbnN0cnVjdHMoYylcbiAgICAgICksXG4gICAgXS5maWx0ZXIoKGMpOiBjIGlzIFNTVENvbnN0cnVjdCAmIElDb25zdHJ1Y3QgPT4gQm9vbGVhbihjKSk7XG4gIH1cblxuICBwcml2YXRlIGFwcGx5UmVtb3ZhbFBvbGljeShjdXJyZW50OiBJQ29uc3RydWN0LCBwb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5KSB7XG4gICAgaWYgKGN1cnJlbnQgaW5zdGFuY2VvZiBjZGsuQ2ZuUmVzb3VyY2UpIGN1cnJlbnQuYXBwbHlSZW1vdmFsUG9saWN5KHBvbGljeSk7XG5cbiAgICAvLyBIYWQgdG8gY29weSB0aGlzIGluIHRvIGVuYWJsZSBkZWxldGluZyBvYmplY3RzIGluIGJ1Y2tldFxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWNkay9ibG9iL21hc3Rlci9wYWNrYWdlcy8lNDBhd3MtY2RrL2F3cy1zMy9saWIvYnVja2V0LnRzI0wxOTEwXG4gICAgaWYgKFxuICAgICAgY3VycmVudCBpbnN0YW5jZW9mIHMzLkJ1Y2tldCAmJlxuICAgICAgIWN1cnJlbnQubm9kZS50cnlGaW5kQ2hpbGQoXCJBdXRvRGVsZXRlT2JqZWN0c0N1c3RvbVJlc291cmNlXCIpXG4gICAgKSB7XG4gICAgICBjb25zdCBBVVRPX0RFTEVURV9PQkpFQ1RTX1JFU09VUkNFX1RZUEUgPSBcIkN1c3RvbTo6UzNBdXRvRGVsZXRlT2JqZWN0c1wiO1xuICAgICAgY29uc3QgcHJvdmlkZXIgPSBjZGsuQ3VzdG9tUmVzb3VyY2VQcm92aWRlci5nZXRPckNyZWF0ZVByb3ZpZGVyKFxuICAgICAgICBjdXJyZW50LFxuICAgICAgICBBVVRPX0RFTEVURV9PQkpFQ1RTX1JFU09VUkNFX1RZUEUsXG4gICAgICAgIHtcbiAgICAgICAgICBjb2RlRGlyZWN0b3J5OiBwYXRoLmpvaW4oXG4gICAgICAgICAgICByZXF1aXJlLnJlc29sdmUoXCJhd3MtY2RrLWxpYi9hd3MtczNcIiksXG4gICAgICAgICAgICBcIi4uL2xpYi9hdXRvLWRlbGV0ZS1vYmplY3RzLWhhbmRsZXJcIlxuICAgICAgICAgICksXG4gICAgICAgICAgcnVudGltZTogY2RrLkN1c3RvbVJlc291cmNlUHJvdmlkZXJSdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgTGFtYmRhIGZ1bmN0aW9uIGZvciBhdXRvLWRlbGV0aW5nIG9iamVjdHMgaW4gJHtjdXJyZW50LmJ1Y2tldE5hbWV9IFMzIGJ1Y2tldC5gLFxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICAvLyBVc2UgYSBidWNrZXQgcG9saWN5IHRvIGFsbG93IHRoZSBjdXN0b20gcmVzb3VyY2UgdG8gZGVsZXRlXG4gICAgICAvLyBvYmplY3RzIGluIHRoZSBidWNrZXRcbiAgICAgIGN1cnJlbnQuYWRkVG9SZXNvdXJjZVBvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgIC8vIGxpc3Qgb2JqZWN0c1xuICAgICAgICAgICAgXCJzMzpHZXRCdWNrZXQqXCIsXG4gICAgICAgICAgICBcInMzOkxpc3QqXCIsXG4gICAgICAgICAgICAvLyBhbmQgdGhlbiBkZWxldGUgdGhlbVxuICAgICAgICAgICAgXCJzMzpEZWxldGVPYmplY3QqXCIsXG4gICAgICAgICAgXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtjdXJyZW50LmJ1Y2tldEFybiwgY3VycmVudC5hcm5Gb3JPYmplY3RzKFwiKlwiKV0sXG4gICAgICAgICAgcHJpbmNpcGFsczogW25ldyBpYW0uQXJuUHJpbmNpcGFsKHByb3ZpZGVyLnJvbGVBcm4pXSxcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGN1c3RvbVJlc291cmNlID0gbmV3IGNkay5DdXN0b21SZXNvdXJjZShcbiAgICAgICAgY3VycmVudCxcbiAgICAgICAgXCJBdXRvRGVsZXRlT2JqZWN0c0N1c3RvbVJlc291cmNlXCIsXG4gICAgICAgIHtcbiAgICAgICAgICByZXNvdXJjZVR5cGU6IEFVVE9fREVMRVRFX09CSkVDVFNfUkVTT1VSQ0VfVFlQRSxcbiAgICAgICAgICBzZXJ2aWNlVG9rZW46IHByb3ZpZGVyLnNlcnZpY2VUb2tlbixcbiAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBCdWNrZXROYW1lOiBjdXJyZW50LmJ1Y2tldE5hbWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgLy8gRW5zdXJlIGJ1Y2tldCBwb2xpY3kgaXMgZGVsZXRlZCBBRlRFUiB0aGUgY3VzdG9tIHJlc291cmNlIG90aGVyd2lzZVxuICAgICAgLy8gd2UgZG9uJ3QgaGF2ZSBwZXJtaXNzaW9ucyB0byBsaXN0IGFuZCBkZWxldGUgaW4gdGhlIGJ1Y2tldC5cbiAgICAgIC8vIChhZGQgYSBgaWZgIHRvIG1ha2UgVFMgaGFwcHkpXG4gICAgICBpZiAoY3VycmVudC5wb2xpY3kpIHtcbiAgICAgICAgY3VzdG9tUmVzb3VyY2Uubm9kZS5hZGREZXBlbmRlbmN5KGN1cnJlbnQucG9saWN5KTtcbiAgICAgIH1cbiAgICB9XG4gICAgY3VycmVudC5ub2RlLmNoaWxkcmVuLmZvckVhY2goKHJlc291cmNlKSA9PlxuICAgICAgdGhpcy5hcHBseVJlbW92YWxQb2xpY3kocmVzb3VyY2UsIHBvbGljeSlcbiAgICApO1xuICB9XG59XG4iXX0=