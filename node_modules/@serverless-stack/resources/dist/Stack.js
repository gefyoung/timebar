"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Stack = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const cdk = __importStar(require("aws-cdk-lib"));
const Function_1 = require("./Function");
const Construct_1 = require("./Construct");
class Stack extends cdk.Stack {
    constructor(scope, id, props) {
        const root = scope.node.root;
        const stackId = root.logicalPrefixedName(id);
        Stack.checkForPropsIsConstruct(id, props);
        Stack.checkForEnvInProps(id, props);
        super(scope, stackId, Object.assign(Object.assign({}, props), { env: {
                account: process.env.CDK_DEFAULT_ACCOUNT,
                region: root.region,
            } }));
        this.stage = root.stage;
        this.defaultFunctionProps = root.defaultFunctionProps.map((dfp) => typeof dfp === "function" ? dfp(this) : dfp);
        this.metadata = this.createMetadataResource();
    }
    setDefaultFunctionProps(props) {
        const fns = this.getAllFunctions();
        if (fns.length > 0)
            throw new Error("Default function props for the stack must be set before any functions have been added. Use 'addDefaultFunctionEnv' or 'addDefaultFunctionPermissions' instead to add more default properties.");
        this.defaultFunctionProps.push(props);
    }
    addDefaultFunctionPermissions(permissions) {
        this.defaultFunctionProps.push({
            permissions,
        });
    }
    addDefaultFunctionEnv(environment) {
        this.defaultFunctionProps.push({
            environment,
        });
    }
    addDefaultFunctionLayers(layers) {
        this.defaultFunctionProps.push({
            layers,
        });
    }
    getAllFunctions() {
        return this.doGetAllFunctions(this);
    }
    doGetAllFunctions(construct) {
        const results = [];
        for (const child of construct.node.children) {
            if (child instanceof Function_1.Function)
                results.push(child);
            results.push(...this.doGetAllFunctions(child));
        }
        return results;
    }
    addOutputs(outputs) {
        Object.keys(outputs).forEach((key) => {
            const value = outputs[key];
            if (value === undefined) {
                throw new Error(`The stack output "${key}" is undefined`);
            }
            else if (typeof value === "string") {
                new cdk.CfnOutput(this, key, { value });
            }
            else {
                new cdk.CfnOutput(this, key, value);
            }
        });
    }
    addConstructsMetadata(metadata) {
        this.metadata.addMetadata("sst:constructs", metadata);
    }
    createMetadataResource() {
        // Add a placeholder resource to ensure stacks with just an imported construct
        // has at least 1 resource, so the deployment succeeds.
        // For example: users often create a stack and use it to import a VPC. The
        //              stack does not have any resources.
        const res = new cdk.CfnResource(this, "SSTMetadata", {
            type: "AWS::CDK::Metadata",
        });
        // Add verison metadata
        const packageJson = fs.readJsonSync(path.join(__dirname, "..", "package.json"));
        res.addMetadata("sst:version", packageJson.version);
        return res;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForPropsIsConstruct(id, props) {
        // If a construct is passed in as stack props, let's detect it and throw a
        // friendlier error.
        if (props && Construct_1.isConstruct(props)) {
            throw new Error(`Expected an associative array as the stack props while initializing "${id}" stack. Received a construct instead.`);
        }
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForEnvInProps(id, props) {
        if (props && props.env) {
            let envS = "";
            try {
                envS = " (" + JSON.stringify(props.env) + ")";
            }
            catch (e) {
                // Ignore
            }
            throw new Error(`Do not set the "env" prop while initializing "${id}" stack${envS}. Use the "AWS_PROFILE" environment variable and "--region" CLI option instead.`);
        }
    }
}
exports.Stack = Stack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvU3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFFL0IsaURBQW1DO0FBRW5DLHlDQUEyRDtBQUUzRCwyQ0FBMEM7QUFLMUMsTUFBYSxLQUFNLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFLbEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUMxRCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFN0MsS0FBSyxDQUFDLHdCQUF3QixDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMxQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXBDLEtBQUssQ0FBQyxLQUFLLEVBQUUsT0FBTyxrQ0FDZixLQUFLLEtBQ1IsR0FBRyxFQUFFO2dCQUNILE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQjtnQkFDeEMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO2FBQ3BCLElBQ0QsQ0FBQztRQUVILElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN4QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQ2hFLE9BQU8sR0FBRyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQzVDLENBQUM7UUFFRixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBQ2hELENB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OEQ7SUFDdEQsTUFBTSxDQUFDLHdCQUF3QixDQUFDLEVBQVUsRUFBRSxLQUFXO1FBQzdELDBFQUEwRTtRQUMxRSxvQkFBb0I7UUFDcEIsSUFBSSxLQUFLLElBQUksdUJBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUMvQixNQUFNLElBQUksS0FBSyxDQUNiLHdFQUF3RSxFQUFFLHdDQUF3QyxDQUNuSCxDQUFDO1NBQ0g7SUFDSCxDQUFDO0lBRUQsOERBQThEO0lBQ3RELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFVLEVBQUUsS0FBVztRQUN2RCxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQ3RCLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUVkLElBQUk7Z0JBQ0YsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7YUFDL0M7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixTQUFTO2FBQ1Y7WUFFRCxNQUFNLElBQUksS0FBSyxDQUNiLGlEQUFpRCxFQUFFLFVBQVUsSUFBSSxpRkFBaUYsQ0FDbkosQ0FBQztTQUNIO0lBQ0gsQ0FBQztDQUNGO0FBcElELHNCQW9JQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHsgQ29uc3RydWN0LCBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHsgRnVuY3Rpb25Qcm9wcywgRnVuY3Rpb24gYXMgRm4gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBpc0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuZXhwb3J0IHR5cGUgU3RhY2tQcm9wcyA9IGNkay5TdGFja1Byb3BzO1xuXG5leHBvcnQgY2xhc3MgU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhZ2U6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzOiBGdW5jdGlvblByb3BzW107XG4gIHByaXZhdGUgcmVhZG9ubHkgbWV0YWRhdGE6IGNkay5DZm5SZXNvdXJjZTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWNrUHJvcHMpIHtcbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCBzdGFja0lkID0gcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKTtcblxuICAgIFN0YWNrLmNoZWNrRm9yUHJvcHNJc0NvbnN0cnVjdChpZCwgcHJvcHMpO1xuICAgIFN0YWNrLmNoZWNrRm9yRW52SW5Qcm9wcyhpZCwgcHJvcHMpO1xuXG4gICAgc3VwZXIoc2NvcGUsIHN0YWNrSWQsIHtcbiAgICAgIC4uLnByb3BzLFxuICAgICAgZW52OiB7XG4gICAgICAgIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQsXG4gICAgICAgIHJlZ2lvbjogcm9vdC5yZWdpb24sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5zdGFnZSA9IHJvb3Quc3RhZ2U7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IHJvb3QuZGVmYXVsdEZ1bmN0aW9uUHJvcHMubWFwKChkZnApID0+XG4gICAgICB0eXBlb2YgZGZwID09PSBcImZ1bmN0aW9uXCIgPyBkZnAodGhpcykgOiBkZnBcbiAgICApO1xuXG4gICAgdGhpcy5tZXRhZGF0YSA9IHRoaXMuY3JlYXRlTWV0YWRhdGFSZXNvdXJjZSgpO1xuICB9XG5cbiAgcHVibGljIHNldERlZmF1bHRGdW5jdGlvblByb3BzKHByb3BzOiBGdW5jdGlvblByb3BzKTogdm9pZCB7XG4gICAgY29uc3QgZm5zID0gdGhpcy5nZXRBbGxGdW5jdGlvbnMoKTtcbiAgICBpZiAoZm5zLmxlbmd0aCA+IDApXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiRGVmYXVsdCBmdW5jdGlvbiBwcm9wcyBmb3IgdGhlIHN0YWNrIG11c3QgYmUgc2V0IGJlZm9yZSBhbnkgZnVuY3Rpb25zIGhhdmUgYmVlbiBhZGRlZC4gVXNlICdhZGREZWZhdWx0RnVuY3Rpb25FbnYnIG9yICdhZGREZWZhdWx0RnVuY3Rpb25QZXJtaXNzaW9ucycgaW5zdGVhZCB0byBhZGQgbW9yZSBkZWZhdWx0IHByb3BlcnRpZXMuXCJcbiAgICAgICk7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHByb3BzKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGREZWZhdWx0RnVuY3Rpb25QZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpIHtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLnB1c2goe1xuICAgICAgcGVybWlzc2lvbnMsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYWRkRGVmYXVsdEZ1bmN0aW9uRW52KGVudmlyb25tZW50OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIGVudmlyb25tZW50LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZERlZmF1bHRGdW5jdGlvbkxheWVycyhsYXllcnM6IGxhbWJkYS5JTGF5ZXJWZXJzaW9uW10pIHtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLnB1c2goe1xuICAgICAgbGF5ZXJzLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldEFsbEZ1bmN0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy5kb0dldEFsbEZ1bmN0aW9ucyh0aGlzKTtcbiAgfVxuXG4gIHByaXZhdGUgZG9HZXRBbGxGdW5jdGlvbnMoY29uc3RydWN0OiBJQ29uc3RydWN0KSB7XG4gICAgY29uc3QgcmVzdWx0czogRm5bXSA9IFtdO1xuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgY29uc3RydWN0Lm5vZGUuY2hpbGRyZW4pIHtcbiAgICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIEZuKSByZXN1bHRzLnB1c2goY2hpbGQpO1xuICAgICAgcmVzdWx0cy5wdXNoKC4uLnRoaXMuZG9HZXRBbGxGdW5jdGlvbnMoY2hpbGQpKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICBwdWJsaWMgYWRkT3V0cHV0cyhvdXRwdXRzOiB7XG4gICAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgY2RrLkNmbk91dHB1dFByb3BzO1xuICB9KTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMob3V0cHV0cykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBjb25zdCB2YWx1ZSA9IG91dHB1dHNba2V5XTtcbiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHN0YWNrIG91dHB1dCBcIiR7a2V5fVwiIGlzIHVuZGVmaW5lZGApO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywga2V5LCB7IHZhbHVlIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywga2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYWRkQ29uc3RydWN0c01ldGFkYXRhKG1ldGFkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLm1ldGFkYXRhLmFkZE1ldGFkYXRhKFwic3N0OmNvbnN0cnVjdHNcIiwgbWV0YWRhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNZXRhZGF0YVJlc291cmNlKCk6IGNkay5DZm5SZXNvdXJjZSB7XG4gICAgLy8gQWRkIGEgcGxhY2Vob2xkZXIgcmVzb3VyY2UgdG8gZW5zdXJlIHN0YWNrcyB3aXRoIGp1c3QgYW4gaW1wb3J0ZWQgY29uc3RydWN0XG4gICAgLy8gaGFzIGF0IGxlYXN0IDEgcmVzb3VyY2UsIHNvIHRoZSBkZXBsb3ltZW50IHN1Y2NlZWRzLlxuICAgIC8vIEZvciBleGFtcGxlOiB1c2VycyBvZnRlbiBjcmVhdGUgYSBzdGFjayBhbmQgdXNlIGl0IHRvIGltcG9ydCBhIFZQQy4gVGhlXG4gICAgLy8gICAgICAgICAgICAgIHN0YWNrIGRvZXMgbm90IGhhdmUgYW55IHJlc291cmNlcy5cbiAgICBjb25zdCByZXMgPSBuZXcgY2RrLkNmblJlc291cmNlKHRoaXMsIFwiU1NUTWV0YWRhdGFcIiwge1xuICAgICAgdHlwZTogXCJBV1M6OkNESzo6TWV0YWRhdGFcIixcbiAgICB9KTtcblxuICAgIC8vIEFkZCB2ZXJpc29uIG1ldGFkYXRhXG4gICAgY29uc3QgcGFja2FnZUpzb24gPSBmcy5yZWFkSnNvblN5bmMoXG4gICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwicGFja2FnZS5qc29uXCIpXG4gICAgKTtcbiAgICByZXMuYWRkTWV0YWRhdGEoXCJzc3Q6dmVyc2lvblwiLCBwYWNrYWdlSnNvbi52ZXJzaW9uKTtcblxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBwcml2YXRlIHN0YXRpYyBjaGVja0ZvclByb3BzSXNDb25zdHJ1Y3QoaWQ6IHN0cmluZywgcHJvcHM/OiBhbnkpIHtcbiAgICAvLyBJZiBhIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4gYXMgc3RhY2sgcHJvcHMsIGxldCdzIGRldGVjdCBpdCBhbmQgdGhyb3cgYVxuICAgIC8vIGZyaWVuZGxpZXIgZXJyb3IuXG4gICAgaWYgKHByb3BzICYmIGlzQ29uc3RydWN0KHByb3BzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRXhwZWN0ZWQgYW4gYXNzb2NpYXRpdmUgYXJyYXkgYXMgdGhlIHN0YWNrIHByb3BzIHdoaWxlIGluaXRpYWxpemluZyBcIiR7aWR9XCIgc3RhY2suIFJlY2VpdmVkIGEgY29uc3RydWN0IGluc3RlYWQuYFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBwcml2YXRlIHN0YXRpYyBjaGVja0ZvckVudkluUHJvcHMoaWQ6IHN0cmluZywgcHJvcHM/OiBhbnkpIHtcbiAgICBpZiAocHJvcHMgJiYgcHJvcHMuZW52KSB7XG4gICAgICBsZXQgZW52UyA9IFwiXCI7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGVudlMgPSBcIiAoXCIgKyBKU09OLnN0cmluZ2lmeShwcm9wcy5lbnYpICsgXCIpXCI7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIElnbm9yZVxuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3Qgc2V0IHRoZSBcImVudlwiIHByb3Agd2hpbGUgaW5pdGlhbGl6aW5nIFwiJHtpZH1cIiBzdGFjayR7ZW52U30uIFVzZSB0aGUgXCJBV1NfUFJPRklMRVwiIGVudmlyb25tZW50IHZhcmlhYmxlIGFuZCBcIi0tcmVnaW9uXCIgQ0xJIG9wdGlvbiBpbnN0ZWFkLmBcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXX0=