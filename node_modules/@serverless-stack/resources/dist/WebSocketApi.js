"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketApi = exports.WebSocketApiAuthorizationType = void 0;
const constructs_1 = require("constructs");
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const apigIntegrations = __importStar(require("@aws-cdk/aws-apigatewayv2-integrations-alpha"));
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const apigV2Domain = __importStar(require("./util/apiGatewayV2Domain"));
const apigV2AccessLog = __importStar(require("./util/apiGatewayV2AccessLog"));
var WebSocketApiAuthorizationType;
(function (WebSocketApiAuthorizationType) {
    WebSocketApiAuthorizationType["NONE"] = "NONE";
    WebSocketApiAuthorizationType["IAM"] = "AWS_IAM";
    WebSocketApiAuthorizationType["CUSTOM"] = "CUSTOM";
})(WebSocketApiAuthorizationType = exports.WebSocketApiAuthorizationType || (exports.WebSocketApiAuthorizationType = {}));
/////////////////////
// Construct
/////////////////////
class WebSocketApi extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        props = props || {};
        const { webSocketApi, webSocketStage, routes, accessLog, customDomain, authorizationType, authorizer, defaultFunctionProps, } = props;
        this.functions = {};
        this.permissionsAttachedForAllRoutes = [];
        this.authorizationType = authorizationType;
        this.authorizer = authorizer;
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Api
        ////////////////////
        if (Construct_1.isCDKConstruct(webSocketApi)) {
            this.webSocketApi = webSocketApi;
        }
        else {
            // Validate input
            if (Construct_1.isCDKConstruct(webSocketStage)) {
                throw new Error(`Cannot import the "webSocketStage" when the "webSocketApi" is not imported.`);
            }
            const webSocketApiProps = (webSocketApi || {});
            // Create WebSocket API
            this.webSocketApi = new apig.WebSocketApi(this, "Api", Object.assign({ apiName: root.logicalPrefixedName(id) }, webSocketApiProps));
        }
        ////////////////////
        // Create Stage
        ////////////////////
        if (Construct_1.isCDKConstruct(webSocketStage)) {
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when "webSocketStage" is a construct`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "webSocketStage" is a construct`);
            }
            this.webSocketStage = webSocketStage;
        }
        else {
            const webSocketStageProps = (webSocketStage ||
                {});
            // Validate input
            if (webSocketStageProps.domainMapping !== undefined) {
                throw new Error(`Do not configure the "webSocketStage.domainMapping". Use the "customDomain" to configure the Api domain.`);
            }
            // Configure Custom Domain
            const customDomainData = apigV2Domain.buildCustomDomainData(this, customDomain);
            let domainMapping;
            if (customDomainData) {
                if (customDomainData.isApigDomainCreated) {
                    this.apiGatewayDomain =
                        customDomainData.apigDomain;
                }
                if (customDomainData.isCertificatedCreated) {
                    this.acmCertificate = customDomainData.certificate;
                }
                domainMapping = {
                    domainName: customDomainData.apigDomain,
                    mappingKey: customDomainData.mappingKey,
                };
                this._customDomainUrl = `wss://${customDomainData.url}`;
            }
            // Create stage
            this.webSocketStage = new apig.WebSocketStage(this, "Stage", Object.assign({ webSocketApi: this.webSocketApi, stageName: this.node.root.stage, autoDeploy: true, domainMapping }, webSocketStageProps));
            // Configure Access Log
            this.accessLogGroup = apigV2AccessLog.buildAccessLogData(this, accessLog, this.webSocketStage, true);
        }
        ///////////////////////////
        // Configure default permissions
        ///////////////////////////
        // note: this allows functions to make ApiGatewayManagementApi.postToConnection
        //       calls.
        this.attachPermissions([
            new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: ["execute-api:ManageConnections"],
                resources: [this._connectionsArn],
            }),
        ]);
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        if (routes) {
            this.addRoutes(this, routes);
        }
    }
    get url() {
        return this.webSocketStage.url;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.functions);
    }
    get _connectionsArn() {
        return Stack_1.Stack.of(this).formatArn({
            service: "execute-api",
            resourceName: `${this.webSocketStage.stageName}/POST/*`,
            resource: this.webSocketApi.apiId,
        });
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            // add route
            const fn = this.addRoute(scope, routeKey, routes[routeKey]);
            // attached existing permissions
            this.permissionsAttachedForAllRoutes.forEach((permissions) => fn.attachPermissions(permissions));
        });
    }
    getFunction(routeKey) {
        return this.functions[this.normalizeRouteKey(routeKey)];
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "WebSocketApi",
            data: {
                httpApiId: this.webSocketApi.apiId,
                customDomainUrl: this._customDomainUrl,
                routes: Object.entries(this.functions).map(([routeKey, fn]) => ({
                    route: routeKey,
                    fn: Construct_1.getFunctionRef(fn),
                })),
            },
        };
    }
    addRoute(scope, routeKey, routeValue) {
        ///////////////////
        // Normalize routeKey
        ///////////////////
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.functions[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Create Function
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, routeKey, routeValue, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        ///////////////////
        // Get authorization
        ///////////////////
        const { authorizationType, authorizer } = this.buildRouteAuth(routeKey);
        ///////////////////
        // Create route
        ///////////////////
        const route = new apig.WebSocketRoute(scope, `Route_${routeKey}`, {
            webSocketApi: this.webSocketApi,
            routeKey,
            integration: new apigIntegrations.WebSocketLambdaIntegration(`Integration_${routeKey}`, lambda),
            authorizer: routeKey === "$connect" ? authorizer : undefined,
        });
        ///////////////////
        // Configure authorization
        ///////////////////
        // Note: as of CDK v1.138.0, aws-apigatewayv2.WebSocketRoute does not
        //       support IAM authorization type. We need to manually configure it.
        if (routeKey === "$connect") {
            // Configure route authorization type
            // Note: we need to explicitly set `cfnRoute.authorizationType` to `NONE`
            //       because if it were set to `AWS_IAM`, and then it is removed from
            //       the CloudFormation template (ie. set to undefined), CloudFormation
            //       doesn't updates the route. The route's authorizationType would
            //       still be `AWS_IAM`.
            if (authorizationType === WebSocketApiAuthorizationType.CUSTOM ||
                authorizationType === WebSocketApiAuthorizationType.IAM ||
                authorizationType === WebSocketApiAuthorizationType.NONE) {
                if (!route.node.defaultChild) {
                    throw new Error(`Failed to define the default route for "${routeKey}"`);
                }
                const cfnRoute = route.node.defaultChild;
                cfnRoute.authorizationType = authorizationType;
            }
        }
        ///////////////////
        // Store function
        ///////////////////
        this.functions[routeKey] = lambda;
        return lambda;
    }
    buildRouteAuth(routeKey) {
        let authorizer;
        const authorizationType = this.authorizationType || WebSocketApiAuthorizationType.NONE;
        if (!Object.values(WebSocketApiAuthorizationType).includes(authorizationType)) {
            throw new Error(`sst.WebSocketApi does not currently support ${authorizationType}. Only "IAM" and "CUSTOM" are currently supported.`);
        }
        // Handle CUSTOM Auth
        if (authorizationType === WebSocketApiAuthorizationType.CUSTOM) {
            authorizer = this.authorizer;
            if (!authorizer) {
                throw new Error(`Missing custom Lambda authorizer for "${routeKey}"`);
            }
        }
        return { authorizationType, authorizer };
    }
    normalizeRouteKey(routeKey) {
        return routeKey.trim();
    }
}
exports.WebSocketApi = WebSocketApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0QXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1dlYlNvY2tldEFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBQ3ZDLHlEQUEyQztBQUkzQyxzRUFBd0Q7QUFFeEQsK0ZBQWlGO0FBR2pGLG1DQUFnQztBQUNoQywyQ0FBMkU7QUFDM0UseUNBQStFO0FBRS9FLHdFQUEwRDtBQUMxRCw4RUFBZ0U7QUFFaEUsSUFBWSw2QkFJWDtBQUpELFdBQVksNkJBQTZCO0lBQ3ZDLDhDQUFhLENBQUE7SUFDYixnREFBZSxDQUFBO0lBQ2Ysa0RBQWlCLENBQUE7QUFDbkIsQ0FBQyxFQUpXLDZCQUE2QixHQUE3QixxQ0FBNkIsS0FBN0IscUNBQTZCLFFBSXhDO0FBeUJELHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCLE1BQWEsWUFBYSxTQUFRLHNCQUFTO0lBYXpDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBeUI7UUFDakUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNwQixNQUFNLEVBQ0osWUFBWSxFQUNaLGNBQWMsRUFDZCxNQUFNLEVBQ04sU0FBUyxFQUNULFlBQVksRUFDWixpQkFBaUIsRUFDakIsVUFBVSxFQUNWLG9CQUFvQixHQUNyQixHQUFHLEtBQUssQ0FBQztRQUNWLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQywrQkFBK0IsR0FBRyxFQUFFLENBQUM7UUFDMUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO1FBQzNDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FB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QUFpQixDQUFDLEVBQ3pFO1lBQ0EsTUFBTSxJQUFJLEtBQUssQ0FDYiwrQ0FBK0MsaUJBQWlCLG9EQUFvRCxDQUNySCxDQUFDO1NBQ0g7UUFFRCxxQkFBcUI7UUFDckIsSUFBSSxpQkFBaUIsS0FBSyw2QkFBNkIsQ0FBQyxNQUFNLEVBQUU7WUFDOUQsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDN0IsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDZixNQUFNLElBQUksS0FBSyxDQUFDLHlDQUF5QyxRQUFRLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZFO1NBQ0Y7UUFFRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsVUFBVSxFQUFFLENBQUM7SUFDM0MsQ0FBQztJQUVPLGlCQUFpQixDQUFDLFFBQWdCO1FBQ3hDLE9BQU8sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3pCLENBQUM7Q0FDRjtBQXJVRCxvQ0FxVUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgKiBhcyBjZm5BcGlnIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyLWFscGhhXCI7XG5pbXBvcnQgKiBhcyBhcGlnQXV0aG9yaXplcnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItYXV0aG9yaXplcnMtYWxwaGFcIjtcbmltcG9ydCAqIGFzIGFwaWdJbnRlZ3JhdGlvbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zLWFscGhhXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCAqIGFzIGFwaWdWMkRvbWFpbiBmcm9tIFwiLi91dGlsL2FwaUdhdGV3YXlWMkRvbWFpblwiO1xuaW1wb3J0ICogYXMgYXBpZ1YyQWNjZXNzTG9nIGZyb20gXCIuL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nXCI7XG5cbmV4cG9ydCBlbnVtIFdlYlNvY2tldEFwaUF1dGhvcml6YXRpb25UeXBlIHtcbiAgTk9ORSA9IFwiTk9ORVwiLFxuICBJQU0gPSBcIkFXU19JQU1cIixcbiAgQ1VTVE9NID0gXCJDVVNUT01cIixcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBXZWJTb2NrZXRBcGlQcm9wcyB7XG4gIHJlYWRvbmx5IHdlYlNvY2tldEFwaT86IGFwaWcuSVdlYlNvY2tldEFwaSB8IGFwaWcuV2ViU29ja2V0QXBpUHJvcHM7XG4gIHJlYWRvbmx5IHdlYlNvY2tldFN0YWdlPzogYXBpZy5JV2ViU29ja2V0U3RhZ2UgfCBXZWJTb2NrZXRBcGlDZGtTdGFnZVByb3BzO1xuICByZWFkb25seSByb3V0ZXM/OiB7IFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uRGVmaW5pdGlvbiB9O1xuICByZWFkb25seSBhY2Nlc3NMb2c/OiBib29sZWFuIHwgc3RyaW5nIHwgV2ViU29ja2V0QXBpQWNjY2Vzc0xvZ1Byb3BzO1xuICByZWFkb25seSBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBXZWJTb2NrZXRBcGlDdXN0b21Eb21haW5Qcm9wcztcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblR5cGU/OiBXZWJTb2NrZXRBcGlBdXRob3JpemF0aW9uVHlwZTtcbiAgcmVhZG9ubHkgYXV0aG9yaXplcj86IGFwaWdBdXRob3JpemVycy5XZWJTb2NrZXRMYW1iZGFBdXRob3JpemVyO1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCB0eXBlIFdlYlNvY2tldEFwaUN1c3RvbURvbWFpblByb3BzID0gYXBpZ1YyRG9tYWluLkN1c3RvbURvbWFpblByb3BzO1xuZXhwb3J0IHR5cGUgV2ViU29ja2V0QXBpQWNjY2Vzc0xvZ1Byb3BzID0gYXBpZ1YyQWNjZXNzTG9nLkFjY2Vzc0xvZ1Byb3BzO1xuXG5leHBvcnQgaW50ZXJmYWNlIFdlYlNvY2tldEFwaUNka1N0YWdlUHJvcHNcbiAgZXh0ZW5kcyBPbWl0PGFwaWcuV2ViU29ja2V0U3RhZ2VQcm9wcywgXCJ3ZWJTb2NrZXRBcGlcIiB8IFwic3RhZ2VOYW1lXCI+IHtcbiAgcmVhZG9ubHkgc3RhZ2VOYW1lPzogc3RyaW5nO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBXZWJTb2NrZXRBcGkgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgd2ViU29ja2V0QXBpOiBhcGlnLldlYlNvY2tldEFwaTtcbiAgcHVibGljIHJlYWRvbmx5IHdlYlNvY2tldFN0YWdlOiBhcGlnLldlYlNvY2tldFN0YWdlO1xuICBwdWJsaWMgcmVhZG9ubHkgX2N1c3RvbURvbWFpblVybD86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGFjY2Vzc0xvZ0dyb3VwPzogbG9ncy5Mb2dHcm91cDtcbiAgcHVibGljIHJlYWRvbmx5IGFwaUdhdGV3YXlEb21haW4/OiBhcGlnLkRvbWFpbk5hbWU7XG4gIHB1YmxpYyByZWFkb25seSBhY21DZXJ0aWZpY2F0ZT86IGFjbS5DZXJ0aWZpY2F0ZTtcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbnM6IHsgW2tleTogc3RyaW5nXTogRm4gfTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGF1dGhvcml6YXRpb25UeXBlPzogV2ViU29ja2V0QXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXV0aG9yaXplcj86IGFwaWdBdXRob3JpemVycy5XZWJTb2NrZXRMYW1iZGFBdXRob3JpemVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFdlYlNvY2tldEFwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIHByb3BzID0gcHJvcHMgfHwge307XG4gICAgY29uc3Qge1xuICAgICAgd2ViU29ja2V0QXBpLFxuICAgICAgd2ViU29ja2V0U3RhZ2UsXG4gICAgICByb3V0ZXMsXG4gICAgICBhY2Nlc3NMb2csXG4gICAgICBjdXN0b21Eb21haW4sXG4gICAgICBhdXRob3JpemF0aW9uVHlwZSxcbiAgICAgIGF1dGhvcml6ZXIsXG4gICAgICBkZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICB9ID0gcHJvcHM7XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMgPSBbXTtcbiAgICB0aGlzLmF1dGhvcml6YXRpb25UeXBlID0gYXV0aG9yaXphdGlvblR5cGU7XG4gICAgdGhpcy5hdXRob3JpemVyID0gYXV0aG9yaXplcjtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBBcGlcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KHdlYlNvY2tldEFwaSkpIHtcbiAgICAgIHRoaXMud2ViU29ja2V0QXBpID0gd2ViU29ja2V0QXBpIGFzIGFwaWcuV2ViU29ja2V0QXBpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgICAgaWYgKGlzQ0RLQ29uc3RydWN0KHdlYlNvY2tldFN0YWdlKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBpbXBvcnQgdGhlIFwid2ViU29ja2V0U3RhZ2VcIiB3aGVuIHRoZSBcIndlYlNvY2tldEFwaVwiIGlzIG5vdCBpbXBvcnRlZC5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHdlYlNvY2tldEFwaVByb3BzID0gKHdlYlNvY2tldEFwaSB8fCB7fSkgYXMgYXBpZy5XZWJTb2NrZXRBcGlQcm9wcztcblxuICAgICAgLy8gQ3JlYXRlIFdlYlNvY2tldCBBUElcbiAgICAgIHRoaXMud2ViU29ja2V0QXBpID0gbmV3IGFwaWcuV2ViU29ja2V0QXBpKHRoaXMsIFwiQXBpXCIsIHtcbiAgICAgICAgYXBpTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4ud2ViU29ja2V0QXBpUHJvcHMsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBTdGFnZVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoaXNDREtDb25zdHJ1Y3Qod2ViU29ja2V0U3RhZ2UpKSB7XG4gICAgICBpZiAoYWNjZXNzTG9nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImFjY2Vzc0xvZ1wiIHdoZW4gXCJ3ZWJTb2NrZXRTdGFnZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjdXN0b21Eb21haW5cIiB3aGVuIFwid2ViU29ja2V0U3RhZ2VcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMud2ViU29ja2V0U3RhZ2UgPSB3ZWJTb2NrZXRTdGFnZSBhcyBhcGlnLldlYlNvY2tldFN0YWdlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB3ZWJTb2NrZXRTdGFnZVByb3BzID0gKHdlYlNvY2tldFN0YWdlIHx8XG4gICAgICAgIHt9KSBhcyBXZWJTb2NrZXRBcGlDZGtTdGFnZVByb3BzO1xuXG4gICAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgICAgaWYgKHdlYlNvY2tldFN0YWdlUHJvcHMuZG9tYWluTWFwcGluZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRG8gbm90IGNvbmZpZ3VyZSB0aGUgXCJ3ZWJTb2NrZXRTdGFnZS5kb21haW5NYXBwaW5nXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIEFwaSBkb21haW4uYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBDb25maWd1cmUgQ3VzdG9tIERvbWFpblxuICAgICAgY29uc3QgY3VzdG9tRG9tYWluRGF0YSA9IGFwaWdWMkRvbWFpbi5idWlsZEN1c3RvbURvbWFpbkRhdGEoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGN1c3RvbURvbWFpblxuICAgICAgKTtcbiAgICAgIGxldCBkb21haW5NYXBwaW5nO1xuICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEpIHtcbiAgICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEuaXNBcGlnRG9tYWluQ3JlYXRlZCkge1xuICAgICAgICAgIHRoaXMuYXBpR2F0ZXdheURvbWFpbiA9XG4gICAgICAgICAgICBjdXN0b21Eb21haW5EYXRhLmFwaWdEb21haW4gYXMgYXBpZy5Eb21haW5OYW1lO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjdXN0b21Eb21haW5EYXRhLmlzQ2VydGlmaWNhdGVkQ3JlYXRlZCkge1xuICAgICAgICAgIHRoaXMuYWNtQ2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW5EYXRhLmNlcnRpZmljYXRlIGFzIGFjbS5DZXJ0aWZpY2F0ZTtcbiAgICAgICAgfVxuICAgICAgICBkb21haW5NYXBwaW5nID0ge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbkRhdGEuYXBpZ0RvbWFpbixcbiAgICAgICAgICBtYXBwaW5nS2V5OiBjdXN0b21Eb21haW5EYXRhLm1hcHBpbmdLZXksXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX2N1c3RvbURvbWFpblVybCA9IGB3c3M6Ly8ke2N1c3RvbURvbWFpbkRhdGEudXJsfWA7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBzdGFnZVxuICAgICAgdGhpcy53ZWJTb2NrZXRTdGFnZSA9IG5ldyBhcGlnLldlYlNvY2tldFN0YWdlKHRoaXMsIFwiU3RhZ2VcIiwge1xuICAgICAgICB3ZWJTb2NrZXRBcGk6IHRoaXMud2ViU29ja2V0QXBpLFxuICAgICAgICBzdGFnZU5hbWU6ICh0aGlzLm5vZGUucm9vdCBhcyBBcHApLnN0YWdlLFxuICAgICAgICBhdXRvRGVwbG95OiB0cnVlLFxuICAgICAgICBkb21haW5NYXBwaW5nLFxuICAgICAgICAuLi53ZWJTb2NrZXRTdGFnZVByb3BzLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIENvbmZpZ3VyZSBBY2Nlc3MgTG9nXG4gICAgICB0aGlzLmFjY2Vzc0xvZ0dyb3VwID0gYXBpZ1YyQWNjZXNzTG9nLmJ1aWxkQWNjZXNzTG9nRGF0YShcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYWNjZXNzTG9nLFxuICAgICAgICB0aGlzLndlYlNvY2tldFN0YWdlLFxuICAgICAgICB0cnVlXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSBkZWZhdWx0IHBlcm1pc3Npb25zXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gbm90ZTogdGhpcyBhbGxvd3MgZnVuY3Rpb25zIHRvIG1ha2UgQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkucG9zdFRvQ29ubmVjdGlvblxuICAgIC8vICAgICAgIGNhbGxzLlxuICAgIHRoaXMuYXR0YWNoUGVybWlzc2lvbnMoW1xuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcImV4ZWN1dGUtYXBpOk1hbmFnZUNvbm5lY3Rpb25zXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFt0aGlzLl9jb25uZWN0aW9uc0Fybl0sXG4gICAgICB9KSxcbiAgICBdKTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSByb3V0ZXNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChyb3V0ZXMpIHtcbiAgICAgIHRoaXMuYWRkUm91dGVzKHRoaXMsIHJvdXRlcyk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy53ZWJTb2NrZXRTdGFnZS51cmw7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGN1c3RvbURvbWFpblVybCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLl9jdXN0b21Eb21haW5Vcmw7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHJvdXRlcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuZnVuY3Rpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgX2Nvbm5lY3Rpb25zQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFN0YWNrLm9mKHRoaXMpLmZvcm1hdEFybih7XG4gICAgICBzZXJ2aWNlOiBcImV4ZWN1dGUtYXBpXCIsXG4gICAgICByZXNvdXJjZU5hbWU6IGAke3RoaXMud2ViU29ja2V0U3RhZ2Uuc3RhZ2VOYW1lfS9QT1NULypgLFxuICAgICAgcmVzb3VyY2U6IHRoaXMud2ViU29ja2V0QXBpLmFwaUlkLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZFJvdXRlcyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlczoge1xuICAgICAgW2tleTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMocm91dGVzKS5mb3JFYWNoKChyb3V0ZUtleTogc3RyaW5nKSA9PiB7XG4gICAgICAvLyBhZGQgcm91dGVcbiAgICAgIGNvbnN0IGZuID0gdGhpcy5hZGRSb3V0ZShzY29wZSwgcm91dGVLZXksIHJvdXRlc1tyb3V0ZUtleV0pO1xuXG4gICAgICAvLyBhdHRhY2hlZCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PlxuICAgICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RnVuY3Rpb24ocm91dGVLZXk6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSldO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1JvdXRlKFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gdGhpcy5nZXRGdW5jdGlvbihyb3V0ZUtleSk7XG4gICAgaWYgKCFmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGF0dGFjaCBwZXJtaXNzaW9ucy4gUm91dGUgXCIke3JvdXRlS2V5fVwiIGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIldlYlNvY2tldEFwaVwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBodHRwQXBpSWQ6IHRoaXMud2ViU29ja2V0QXBpLmFwaUlkLFxuICAgICAgICBjdXN0b21Eb21haW5Vcmw6IHRoaXMuX2N1c3RvbURvbWFpblVybCxcbiAgICAgICAgcm91dGVzOiBPYmplY3QuZW50cmllcyh0aGlzLmZ1bmN0aW9ucykubWFwKChbcm91dGVLZXksIGZuXSkgPT4gKHtcbiAgICAgICAgICByb3V0ZTogcm91dGVLZXksXG4gICAgICAgICAgZm46IGdldEZ1bmN0aW9uUmVmKGZuKSxcbiAgICAgICAgfSkpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSb3V0ZShcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVWYWx1ZTogRnVuY3Rpb25EZWZpbml0aW9uXG4gICk6IEZuIHtcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gTm9ybWFsaXplIHJvdXRlS2V5XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvdXRlS2V5ID0gdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSk7XG4gICAgaWYgKHRoaXMuZnVuY3Rpb25zW3JvdXRlS2V5XSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBIHJvdXRlIGFscmVhZHkgZXhpc3RzIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEZ1bmN0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICByb3V0ZUtleSxcbiAgICAgIHJvdXRlVmFsdWUsXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgcm91dGVzIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBBcGkgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gR2V0IGF1dGhvcml6YXRpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgeyBhdXRob3JpemF0aW9uVHlwZSwgYXV0aG9yaXplciB9ID0gdGhpcy5idWlsZFJvdXRlQXV0aChyb3V0ZUtleSk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIHJvdXRlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHJvdXRlID0gbmV3IGFwaWcuV2ViU29ja2V0Um91dGUoc2NvcGUsIGBSb3V0ZV8ke3JvdXRlS2V5fWAsIHtcbiAgICAgIHdlYlNvY2tldEFwaTogdGhpcy53ZWJTb2NrZXRBcGksXG4gICAgICByb3V0ZUtleSxcbiAgICAgIGludGVncmF0aW9uOiBuZXcgYXBpZ0ludGVncmF0aW9ucy5XZWJTb2NrZXRMYW1iZGFJbnRlZ3JhdGlvbihcbiAgICAgICAgYEludGVncmF0aW9uXyR7cm91dGVLZXl9YCxcbiAgICAgICAgbGFtYmRhXG4gICAgICApLFxuICAgICAgYXV0aG9yaXplcjogcm91dGVLZXkgPT09IFwiJGNvbm5lY3RcIiA/IGF1dGhvcml6ZXIgOiB1bmRlZmluZWQsXG4gICAgfSk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIGF1dGhvcml6YXRpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAvLyBOb3RlOiBhcyBvZiBDREsgdjEuMTM4LjAsIGF3cy1hcGlnYXRld2F5djIuV2ViU29ja2V0Um91dGUgZG9lcyBub3RcbiAgICAvLyAgICAgICBzdXBwb3J0IElBTSBhdXRob3JpemF0aW9uIHR5cGUuIFdlIG5lZWQgdG8gbWFudWFsbHkgY29uZmlndXJlIGl0LlxuICAgIGlmIChyb3V0ZUtleSA9PT0gXCIkY29ubmVjdFwiKSB7XG4gICAgICAvLyBDb25maWd1cmUgcm91dGUgYXV0aG9yaXphdGlvbiB0eXBlXG4gICAgICAvLyBOb3RlOiB3ZSBuZWVkIHRvIGV4cGxpY2l0bHkgc2V0IGBjZm5Sb3V0ZS5hdXRob3JpemF0aW9uVHlwZWAgdG8gYE5PTkVgXG4gICAgICAvLyAgICAgICBiZWNhdXNlIGlmIGl0IHdlcmUgc2V0IHRvIGBBV1NfSUFNYCwgYW5kIHRoZW4gaXQgaXMgcmVtb3ZlZCBmcm9tXG4gICAgICAvLyAgICAgICB0aGUgQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGUgKGllLiBzZXQgdG8gdW5kZWZpbmVkKSwgQ2xvdWRGb3JtYXRpb25cbiAgICAgIC8vICAgICAgIGRvZXNuJ3QgdXBkYXRlcyB0aGUgcm91dGUuIFRoZSByb3V0ZSdzIGF1dGhvcml6YXRpb25UeXBlIHdvdWxkXG4gICAgICAvLyAgICAgICBzdGlsbCBiZSBgQVdTX0lBTWAuXG4gICAgICBpZiAoXG4gICAgICAgIGF1dGhvcml6YXRpb25UeXBlID09PSBXZWJTb2NrZXRBcGlBdXRob3JpemF0aW9uVHlwZS5DVVNUT00gfHxcbiAgICAgICAgYXV0aG9yaXphdGlvblR5cGUgPT09IFdlYlNvY2tldEFwaUF1dGhvcml6YXRpb25UeXBlLklBTSB8fFxuICAgICAgICBhdXRob3JpemF0aW9uVHlwZSA9PT0gV2ViU29ja2V0QXBpQXV0aG9yaXphdGlvblR5cGUuTk9ORVxuICAgICAgKSB7XG4gICAgICAgIGlmICghcm91dGUubm9kZS5kZWZhdWx0Q2hpbGQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgRmFpbGVkIHRvIGRlZmluZSB0aGUgZGVmYXVsdCByb3V0ZSBmb3IgXCIke3JvdXRlS2V5fVwiYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2ZuUm91dGUgPSByb3V0ZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBjZm5BcGlnLkNmblJvdXRlO1xuICAgICAgICBjZm5Sb3V0ZS5hdXRob3JpemF0aW9uVHlwZSA9IGF1dGhvcml6YXRpb25UeXBlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBTdG9yZSBmdW5jdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICB0aGlzLmZ1bmN0aW9uc1tyb3V0ZUtleV0gPSBsYW1iZGE7XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFJvdXRlQXV0aChyb3V0ZUtleTogc3RyaW5nKSB7XG4gICAgbGV0IGF1dGhvcml6ZXI7XG4gICAgY29uc3QgYXV0aG9yaXphdGlvblR5cGUgPVxuICAgICAgdGhpcy5hdXRob3JpemF0aW9uVHlwZSB8fCBXZWJTb2NrZXRBcGlBdXRob3JpemF0aW9uVHlwZS5OT05FO1xuICAgIGlmIChcbiAgICAgICFPYmplY3QudmFsdWVzKFdlYlNvY2tldEFwaUF1dGhvcml6YXRpb25UeXBlKS5pbmNsdWRlcyhhdXRob3JpemF0aW9uVHlwZSlcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHNzdC5XZWJTb2NrZXRBcGkgZG9lcyBub3QgY3VycmVudGx5IHN1cHBvcnQgJHthdXRob3JpemF0aW9uVHlwZX0uIE9ubHkgXCJJQU1cIiBhbmQgXCJDVVNUT01cIiBhcmUgY3VycmVudGx5IHN1cHBvcnRlZC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBDVVNUT00gQXV0aFxuICAgIGlmIChhdXRob3JpemF0aW9uVHlwZSA9PT0gV2ViU29ja2V0QXBpQXV0aG9yaXphdGlvblR5cGUuQ1VTVE9NKSB7XG4gICAgICBhdXRob3JpemVyID0gdGhpcy5hdXRob3JpemVyO1xuICAgICAgaWYgKCFhdXRob3JpemVyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBjdXN0b20gTGFtYmRhIGF1dGhvcml6ZXIgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IGF1dGhvcml6YXRpb25UeXBlLCBhdXRob3JpemVyIH07XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZVJvdXRlS2V5KHJvdXRlS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiByb3V0ZUtleS50cmltKCk7XG4gIH1cbn1cbiJdfQ==