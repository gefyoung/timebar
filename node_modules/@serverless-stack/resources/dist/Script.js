"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Script = void 0;
const path_1 = __importDefault(require("path"));
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const Function_1 = require("./Function");
class Script extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Validate deprecated "function" prop
        if (props.function)
            this.checkDeprecatedFunction();
        // Validate at least 1 function is provided
        if (!props.onCreate && !props.onUpdate && !props.onDelete) {
            throw new Error(`Need to provide at least one of "onCreate", "onUpdate", or "onDelete" functions for the "${this.node.id}" Script`);
        }
        const root = scope.node.root;
        this.props = props;
        this.createFunction = this.createUserFunction("onCreate", props.onCreate);
        this.updateFunction = this.createUserFunction("onUpdate", props.onUpdate);
        this.deleteFunction = this.createUserFunction("onDelete", props.onDelete);
        const crFunction = this.createCustomResourceFunction();
        this.createCustomResource(root, crFunction);
    }
    attachPermissions(permissions) {
        var _a, _b, _c;
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.attachPermissions(permissions);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.attachPermissions(permissions);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.attachPermissions(permissions);
    }
    createUserFunction(type, fnDef) {
        if (!fnDef) {
            return;
        }
        // function is construct => return function directly
        if (fnDef instanceof Function_1.Function) {
            // validate live dev is not enabled
            if (fnDef._isLiveDevEnabled) {
                throw new Error(`Live Lambda Dev cannot be enabled for functions in the Script construct. Set the "enableLiveDev" prop for the function to "false".`);
            }
            return Function_1.Function.fromDefinition(this, `${type}Function`, fnDef, this.props.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define the "${type}" function using FunctionProps, so the Script construct can apply the "defaultFunctionProps" to them.`);
        }
        // function is string => create function
        else if (typeof fnDef === "string") {
            return Function_1.Function.fromDefinition(this, `${type}Function`, {
                handler: fnDef,
                enableLiveDev: false,
            }, Object.assign({ timeout: 900 }, this.props.defaultFunctionProps));
        }
        // function is props => create function
        return Function_1.Function.fromDefinition(this, `${type}Function`, Object.assign(Object.assign({}, fnDef), { enableLiveDev: false }), Object.assign({ timeout: 900 }, this.props.defaultFunctionProps));
    }
    createCustomResourceFunction() {
        var _a, _b, _c;
        const handler = new lambda.Function(this, "ScriptHandler", {
            code: lambda.Code.fromAsset(path_1.default.join(__dirname, "Script")),
            runtime: lambda.Runtime.NODEJS_14_X,
            handler: "index.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.grantInvoke(handler);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.grantInvoke(handler);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.grantInvoke(handler);
        return handler;
    }
    createCustomResource(app, crFunction) {
        var _a, _b, _c;
        // Note: "BuiltAt" is set to current timestamp to ensure the Custom
        //       Resource function is run on every update.
        //
        //       Do not use the current timestamp in Live mode, b/c we want the
        //       this custom resource to remain the same in CloudFormation template
        //       when rebuilding infrastructure. Otherwise, there will always be
        //       a change when rebuilding infrastructure b/c the "BuildAt" property
        //       changes on each build.
        const builtAt = app.local ? app.debugStartedAt : Date.now();
        new cdk.CustomResource(this, "ScriptResource", {
            serviceToken: crFunction.functionArn,
            resourceType: "Custom::SSTScript",
            properties: {
                UserCreateFunction: (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.functionName,
                UserUpdateFunction: (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.functionName,
                UserDeleteFunction: (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.functionName,
                UserParams: JSON.stringify(this.props.params || {}),
                BuiltAt: builtAt,
            },
        });
    }
    checkDeprecatedFunction() {
        throw new Error(`The "function" property has been replaced by "onCreate" and "onUpdate". More details on upgrading - https://docs.serverless-stack.com/constructs/Script#upgrading-to-v0460`);
    }
}
exports.Script = Script;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1NjcmlwdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLDJDQUF1QztBQUN2QyxpREFBbUM7QUFDbkMsK0RBQWlEO0FBRWpELHlDQUErRTtBQVcvRSxNQUFhLE1BQU8sU0FBUSxzQkFBUztJQU1uQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWtCO1FBQzFELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsc0NBQXNDO1FBQ3RDLElBQUssS0FBYSxDQUFDLFFBQVE7WUFBRSxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUU1RCwyQ0FBMkM7UUFDM0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtZQUN6RCxNQUFNLElBQUksS0FBSyxDQUNiLDRGQUE0RixJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsVUFBVSxDQUNuSCxDQUFDO1NBQ0g7UUFFRCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFFLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUUsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxRSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztRQUN2RCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFTSxpQkFBaUIsQ0FBQyxXQUF3Qjs7UUFDL0MsTUFBQSxJQUFJLENBQUMsY0FBYywwQ0FBRSxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwRCxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3BELE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVTLGtCQUFrQixDQUMxQixJQUFZLEVBQ1osS0FBMEI7UUFFMUIsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLE9BQU87U0FDUjtRQUVELG9EQUFvRDtRQUNwRCxJQUFJLEtBQUssWUFBWSxtQkFBRSxFQUFFO1lBQ3ZCLG1DQUFtQztZQUNuQyxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsRUFBRTtnQkFDM0IsTUFBTSxJQUFJLEtBQUssQ0FDYixvSUFBb0ksQ0FDckksQ0FBQzthQUNIO1lBRUQsT0FBTyxtQkFBRSxDQUFDLGNBQWMsQ0FDdEIsSUFBSSxFQUNKLEdBQUcsSUFBSSxVQUFVLEVBQ2pCLEtBQUssRUFDTCxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUMvQiw4SEFBOEgsSUFBSSx1R0FBdUcsQ0FDMU8sQ0FBQztTQUNIO1FBRUQsd0NBQXdDO2FBQ25DLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO1lBQ2xDLE9BQU8sbUJBQUUsQ0FBQyxjQUFjLENBQ3RCLElBQUksRUFDSixHQUFHLElBQUksVUFBVSxFQUNqQjtnQkFDRSxPQUFPLEVBQUUsS0FBSztnQkFDZCxhQUFhLEVBQUUsS0FBSzthQUNyQixrQkFFQyxPQUFPLEVBQUUsR0FBRyxJQUNULElBQUksQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBRXJDLENBQUM7U0FDSDtRQUVELHVDQUF1QztRQUN2QyxPQUFPLG1CQUFFLENBQUMsY0FBYyxDQUN0QixJQUFJLEVBQ0osR0FBRyxJQUFJLFVBQVUsa0NBRVosS0FBSyxLQUNSLGFBQWEsRUFBRSxLQUFLLHFCQUdwQixPQUFPLEVBQUUsR0FBRyxJQUNULElBQUksQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBRXJDLENBQUM7SUFDSixDQUFDO0lBRU8sNEJBQTRCOztRQUNsQyxNQUFNLE9BQU8sR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLGVBQWUsRUFBRTtZQUN6RCxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDM0QsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxPQUFPLEVBQUUsZUFBZTtZQUN4QixPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2pDLFVBQVUsRUFBRSxJQUFJO1NBQ2pCLENBQUMsQ0FBQztRQUNILE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzFDLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzFDLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTFDLE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFTyxvQkFBb0IsQ0FBQyxHQUFRLEVBQUUsVUFBMkI7O1FBQ2hFLG1FQUFtRTtRQUNuRSxrREFBa0Q7UUFDbEQsRUFBRTtRQUNGLHVFQUF1RTtRQUN2RSwyRUFBMkU7UUFDM0Usd0VBQXdFO1FBQ3hFLDJFQUEyRTtRQUMzRSwrQkFBK0I7UUFDL0IsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzVELElBQUksR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDN0MsWUFBWSxFQUFFLFVBQVUsQ0FBQyxXQUFXO1lBQ3BDLFlBQVksRUFBRSxtQkFBbUI7WUFDakMsVUFBVSxFQUFFO2dCQUNWLGtCQUFrQixFQUFFLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsWUFBWTtnQkFDckQsa0JBQWtCLEVBQUUsTUFBQSxJQUFJLENBQUMsY0FBYywwQ0FBRSxZQUFZO2dCQUNyRCxrQkFBa0IsRUFBRSxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFlBQVk7Z0JBQ3JELFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQztnQkFDbkQsT0FBTyxFQUFFLE9BQU87YUFDakI7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sdUJBQXVCO1FBQzdCLE1BQU0sSUFBSSxLQUFLLENBQ2IsNEtBQTRLLENBQzdLLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUF2SUQsd0JBdUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNjcmlwdFByb3BzIHtcbiAgcmVhZG9ubHkgb25DcmVhdGU/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IG9uVXBkYXRlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBvbkRlbGV0ZT86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgcGFyYW1zPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xufVxuXG5leHBvcnQgY2xhc3MgU2NyaXB0IGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGNyZWF0ZUZ1bmN0aW9uPzogRm47XG4gIHB1YmxpYyByZWFkb25seSB1cGRhdGVGdW5jdGlvbj86IEZuO1xuICBwdWJsaWMgcmVhZG9ubHkgZGVsZXRlRnVuY3Rpb24/OiBGbjtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHByb3BzOiBTY3JpcHRQcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogU2NyaXB0UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgLy8gVmFsaWRhdGUgZGVwcmVjYXRlZCBcImZ1bmN0aW9uXCIgcHJvcFxuICAgIGlmICgocHJvcHMgYXMgYW55KS5mdW5jdGlvbikgdGhpcy5jaGVja0RlcHJlY2F0ZWRGdW5jdGlvbigpO1xuXG4gICAgLy8gVmFsaWRhdGUgYXQgbGVhc3QgMSBmdW5jdGlvbiBpcyBwcm92aWRlZFxuICAgIGlmICghcHJvcHMub25DcmVhdGUgJiYgIXByb3BzLm9uVXBkYXRlICYmICFwcm9wcy5vbkRlbGV0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTmVlZCB0byBwcm92aWRlIGF0IGxlYXN0IG9uZSBvZiBcIm9uQ3JlYXRlXCIsIFwib25VcGRhdGVcIiwgb3IgXCJvbkRlbGV0ZVwiIGZ1bmN0aW9ucyBmb3IgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgU2NyaXB0YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG5cbiAgICB0aGlzLmNyZWF0ZUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVVc2VyRnVuY3Rpb24oXCJvbkNyZWF0ZVwiLCBwcm9wcy5vbkNyZWF0ZSk7XG4gICAgdGhpcy51cGRhdGVGdW5jdGlvbiA9IHRoaXMuY3JlYXRlVXNlckZ1bmN0aW9uKFwib25VcGRhdGVcIiwgcHJvcHMub25VcGRhdGUpO1xuICAgIHRoaXMuZGVsZXRlRnVuY3Rpb24gPSB0aGlzLmNyZWF0ZVVzZXJGdW5jdGlvbihcIm9uRGVsZXRlXCIsIHByb3BzLm9uRGVsZXRlKTtcbiAgICBjb25zdCBjckZ1bmN0aW9uID0gdGhpcy5jcmVhdGVDdXN0b21SZXNvdXJjZUZ1bmN0aW9uKCk7XG4gICAgdGhpcy5jcmVhdGVDdXN0b21SZXNvdXJjZShyb290LCBjckZ1bmN0aW9uKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICB0aGlzLmNyZWF0ZUZ1bmN0aW9uPy5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gICAgdGhpcy51cGRhdGVGdW5jdGlvbj8uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICAgIHRoaXMuZGVsZXRlRnVuY3Rpb24/LmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVVc2VyRnVuY3Rpb24oXG4gICAgdHlwZTogc3RyaW5nLFxuICAgIGZuRGVmPzogRnVuY3Rpb25EZWZpbml0aW9uXG4gICk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIWZuRGVmKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb24gaXMgY29uc3RydWN0ID0+IHJldHVybiBmdW5jdGlvbiBkaXJlY3RseVxuICAgIGlmIChmbkRlZiBpbnN0YW5jZW9mIEZuKSB7XG4gICAgICAvLyB2YWxpZGF0ZSBsaXZlIGRldiBpcyBub3QgZW5hYmxlZFxuICAgICAgaWYgKGZuRGVmLl9pc0xpdmVEZXZFbmFibGVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgTGl2ZSBMYW1iZGEgRGV2IGNhbm5vdCBiZSBlbmFibGVkIGZvciBmdW5jdGlvbnMgaW4gdGhlIFNjcmlwdCBjb25zdHJ1Y3QuIFNldCB0aGUgXCJlbmFibGVMaXZlRGV2XCIgcHJvcCBmb3IgdGhlIGZ1bmN0aW9uIHRvIFwiZmFsc2VcIi5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dHlwZX1GdW5jdGlvbmAsXG4gICAgICAgIGZuRGVmLFxuICAgICAgICB0aGlzLnByb3BzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgICBgVGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgdGhlIFwiJHt0eXBlfVwiIGZ1bmN0aW9uIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBTY3JpcHQgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBmdW5jdGlvbiBpcyBzdHJpbmcgPT4gY3JlYXRlIGZ1bmN0aW9uXG4gICAgZWxzZSBpZiAodHlwZW9mIGZuRGVmID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3R5cGV9RnVuY3Rpb25gLFxuICAgICAgICB7XG4gICAgICAgICAgaGFuZGxlcjogZm5EZWYsXG4gICAgICAgICAgZW5hYmxlTGl2ZURldjogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICB0aW1lb3V0OiA5MDAsXG4gICAgICAgICAgLi4udGhpcy5wcm9wcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBmdW5jdGlvbiBpcyBwcm9wcyA9PiBjcmVhdGUgZnVuY3Rpb25cbiAgICByZXR1cm4gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICB0aGlzLFxuICAgICAgYCR7dHlwZX1GdW5jdGlvbmAsXG4gICAgICB7XG4gICAgICAgIC4uLmZuRGVmLFxuICAgICAgICBlbmFibGVMaXZlRGV2OiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHRpbWVvdXQ6IDkwMCxcbiAgICAgICAgLi4udGhpcy5wcm9wcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDdXN0b21SZXNvdXJjZUZ1bmN0aW9uKCk6IGxhbWJkYS5GdW5jdGlvbiB7XG4gICAgY29uc3QgaGFuZGxlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJTY3JpcHRIYW5kbGVyXCIsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCBcIlNjcmlwdFwiKSksXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgICAgIGhhbmRsZXI6IFwiaW5kZXguaGFuZGxlclwiLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICB9KTtcbiAgICB0aGlzLmNyZWF0ZUZ1bmN0aW9uPy5ncmFudEludm9rZShoYW5kbGVyKTtcbiAgICB0aGlzLnVwZGF0ZUZ1bmN0aW9uPy5ncmFudEludm9rZShoYW5kbGVyKTtcbiAgICB0aGlzLmRlbGV0ZUZ1bmN0aW9uPy5ncmFudEludm9rZShoYW5kbGVyKTtcblxuICAgIHJldHVybiBoYW5kbGVyO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDdXN0b21SZXNvdXJjZShhcHA6IEFwcCwgY3JGdW5jdGlvbjogbGFtYmRhLkZ1bmN0aW9uKTogdm9pZCB7XG4gICAgLy8gTm90ZTogXCJCdWlsdEF0XCIgaXMgc2V0IHRvIGN1cnJlbnQgdGltZXN0YW1wIHRvIGVuc3VyZSB0aGUgQ3VzdG9tXG4gICAgLy8gICAgICAgUmVzb3VyY2UgZnVuY3Rpb24gaXMgcnVuIG9uIGV2ZXJ5IHVwZGF0ZS5cbiAgICAvL1xuICAgIC8vICAgICAgIERvIG5vdCB1c2UgdGhlIGN1cnJlbnQgdGltZXN0YW1wIGluIExpdmUgbW9kZSwgYi9jIHdlIHdhbnQgdGhlXG4gICAgLy8gICAgICAgdGhpcyBjdXN0b20gcmVzb3VyY2UgdG8gcmVtYWluIHRoZSBzYW1lIGluIENsb3VkRm9ybWF0aW9uIHRlbXBsYXRlXG4gICAgLy8gICAgICAgd2hlbiByZWJ1aWxkaW5nIGluZnJhc3RydWN0dXJlLiBPdGhlcndpc2UsIHRoZXJlIHdpbGwgYWx3YXlzIGJlXG4gICAgLy8gICAgICAgYSBjaGFuZ2Ugd2hlbiByZWJ1aWxkaW5nIGluZnJhc3RydWN0dXJlIGIvYyB0aGUgXCJCdWlsZEF0XCIgcHJvcGVydHlcbiAgICAvLyAgICAgICBjaGFuZ2VzIG9uIGVhY2ggYnVpbGQuXG4gICAgY29uc3QgYnVpbHRBdCA9IGFwcC5sb2NhbCA/IGFwcC5kZWJ1Z1N0YXJ0ZWRBdCA6IERhdGUubm93KCk7XG4gICAgbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCBcIlNjcmlwdFJlc291cmNlXCIsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogY3JGdW5jdGlvbi5mdW5jdGlvbkFybixcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVFNjcmlwdFwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBVc2VyQ3JlYXRlRnVuY3Rpb246IHRoaXMuY3JlYXRlRnVuY3Rpb24/LmZ1bmN0aW9uTmFtZSxcbiAgICAgICAgVXNlclVwZGF0ZUZ1bmN0aW9uOiB0aGlzLnVwZGF0ZUZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJEZWxldGVGdW5jdGlvbjogdGhpcy5kZWxldGVGdW5jdGlvbj8uZnVuY3Rpb25OYW1lLFxuICAgICAgICBVc2VyUGFyYW1zOiBKU09OLnN0cmluZ2lmeSh0aGlzLnByb3BzLnBhcmFtcyB8fCB7fSksXG4gICAgICAgIEJ1aWx0QXQ6IGJ1aWx0QXQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0RlcHJlY2F0ZWRGdW5jdGlvbigpOiB2b2lkIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIFwiZnVuY3Rpb25cIiBwcm9wZXJ0eSBoYXMgYmVlbiByZXBsYWNlZCBieSBcIm9uQ3JlYXRlXCIgYW5kIFwib25VcGRhdGVcIi4gTW9yZSBkZXRhaWxzIG9uIHVwZ3JhZGluZyAtIGh0dHBzOi8vZG9jcy5zZXJ2ZXJsZXNzLXN0YWNrLmNvbS9jb25zdHJ1Y3RzL1NjcmlwdCN1cGdyYWRpbmctdG8tdjA0NjBgXG4gICAgKTtcbiAgfVxufVxuIl19