"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppSyncApi = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const graphql_1 = require("graphql");
const merge_1 = require("@graphql-tools/merge");
const load_files_1 = require("@graphql-tools/load-files");
const constructs_1 = require("constructs");
const appsync = __importStar(require("@aws-cdk/aws-appsync-alpha"));
const Table_1 = require("./Table");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class AppSyncApi extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { graphqlApi, dataSources, resolvers, defaultFunctionProps } = props || {};
        this.functionsByDsKey = {};
        this.dataSourcesByDsKey = {};
        this.resolversByResKey = {};
        this.dsKeysByResKey = {};
        this.permissionsAttachedForAllFunctions = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Api
        ////////////////////
        if (Construct_1.isCDKConstruct(graphqlApi)) {
            this.graphqlApi = graphqlApi;
        }
        else {
            const graphqlApiProps = (graphqlApi || {});
            // build schema
            let mainSchema;
            if (typeof graphqlApiProps.schema === "string") {
                mainSchema = appsync.Schema.fromAsset(graphqlApiProps.schema);
            }
            else if (Array.isArray(graphqlApiProps.schema)) {
                if (graphqlApiProps.schema.length > 0) {
                    // merge schema files
                    const mergedSchema = merge_1.mergeTypeDefs(load_files_1.loadFilesSync(graphqlApiProps.schema));
                    const filePath = path.join(root.buildDir, `appsyncapi-${id}-${this.node.addr}.graphql`);
                    fs.writeFileSync(filePath, graphql_1.print(mergedSchema));
                    mainSchema = appsync.Schema.fromAsset(filePath);
                }
            }
            else {
                mainSchema = graphqlApiProps.schema;
            }
            this.graphqlApi = new appsync.GraphqlApi(this, "Api", Object.assign(Object.assign({ name: root.logicalPrefixedName(id), xrayEnabled: true }, graphqlApiProps), { 
                // handle schema is "string"
                schema: mainSchema }));
        }
        ///////////////////////////
        // Configure data sources
        ///////////////////////////
        if (dataSources) {
            Object.keys(dataSources).forEach((key) => this.addDataSource(this, key, dataSources[key]));
        }
        ///////////////////////////
        // Configure resolvers
        ///////////////////////////
        if (resolvers) {
            Object.keys(resolvers).forEach((key) => this.addResolver(this, key, resolvers[key]));
        }
    }
    get url() {
        return this.graphqlApi.graphqlUrl;
    }
    addDataSources(scope, dataSources) {
        Object.keys(dataSources).forEach((key) => {
            // add data source
            const fn = this.addDataSource(scope, key, dataSources[key]);
            // attached existing permissions
            if (fn) {
                this.permissionsAttachedForAllFunctions.forEach((permissions) => fn.attachPermissions(permissions));
            }
        });
    }
    addResolvers(scope, resolvers) {
        Object.keys(resolvers).forEach((key) => {
            // add resolver
            const fn = this.addResolver(scope, key, resolvers[key]);
            // attached existing permissions
            if (fn) {
                this.permissionsAttachedForAllFunctions.forEach((permissions) => fn.attachPermissions(permissions));
            }
        });
    }
    getConstructMetadata() {
        return {
            type: "AppSync",
            data: {
                appSyncApiId: this.graphqlApi.apiId,
                dataSources: Object.entries(this.dataSourcesByDsKey).map(([key]) => ({
                    name: key,
                    fn: Construct_1.getFunctionRef(this.functionsByDsKey[key]),
                })),
            },
        };
    }
    addDataSource(scope, dsKey, dsValue) {
        let dataSource;
        let lambda;
        // Lambda ds
        if (dsValue.function) {
            dsValue = dsValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${dsKey}`, dsValue.function, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${dsKey} data source`);
            dataSource = this.graphqlApi.addLambdaDataSource(dsKey, lambda, dsValue.options);
        }
        // DynamoDb ds
        else if (dsValue.table) {
            dsValue = dsValue;
            const table = dsValue.table instanceof Table_1.Table
                ? dsValue.table.dynamodbTable
                : dsValue.table;
            dataSource = this.graphqlApi.addDynamoDbDataSource(dsKey, table, dsValue.options);
        }
        // Rds ds
        else if (dsValue.serverlessCluster) {
            dsValue = dsValue;
            dataSource = this.graphqlApi.addRdsDataSource(dsKey, dsValue.serverlessCluster, dsValue.secretStore, dsValue.databaseName, dsValue.options);
        }
        // Http ds
        else if (dsValue.endpoint) {
            dsValue = dsValue;
            dataSource = this.graphqlApi.addHttpDataSource(dsKey, dsValue.endpoint, dsValue.options);
        }
        // Lambda function
        else {
            dsValue = dsValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${dsKey}`, dsValue, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${dsKey} data source`);
            dataSource = this.graphqlApi.addLambdaDataSource(dsKey, lambda);
        }
        this.dataSourcesByDsKey[dsKey] = dataSource;
        if (lambda) {
            this.functionsByDsKey[dsKey] = lambda;
        }
        return lambda;
    }
    addResolver(scope, resKey, resValue) {
        // Normalize resKey
        resKey = this.normalizeResolverKey(resKey);
        // Get type and field
        const resolverKeyParts = resKey.split(" ");
        if (resolverKeyParts.length !== 2) {
            throw new Error(`Invalid resolver ${resKey}`);
        }
        const [typeName, fieldName] = resolverKeyParts;
        if (fieldName.length === 0) {
            throw new Error(`Invalid field defined for "${resKey}"`);
        }
        ///////////////////
        // Create data source if not created before
        ///////////////////
        let lambda;
        let dataSource;
        let dataSourceKey;
        let resolverProps;
        // DataSource key
        if (typeof resValue === "string" &&
            Object.keys(this.dataSourcesByDsKey).includes(resValue)) {
            dataSourceKey = resValue;
            dataSource = this.dataSourcesByDsKey[resValue];
            resolverProps = {};
        }
        // DataSource key not exist (string does not have a dot, assume it is referencing a data store)
        else if (typeof resValue === "string" && resValue.indexOf(".") === -1) {
            throw new Error(`Failed to create resolver "${resKey}". Data source "${resValue}" does not exist.`);
        }
        // Lambda resolver
        else if (this.isLambdaResolverProps(resValue)) {
            resValue = resValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${typeName}_${fieldName}`, resValue.function, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${resKey} resolver`);
            dataSourceKey = this.buildDataSourceKey(typeName, fieldName);
            dataSource = this.graphqlApi.addLambdaDataSource(dataSourceKey, lambda);
            resolverProps = resValue.resolverProps || {};
        }
        // DataSource resolver
        else if (this.isDataSourceResolverProps(resValue)) {
            resValue = resValue;
            dataSourceKey = resValue.dataSource;
            dataSource = this.dataSourcesByDsKey[dataSourceKey];
            resolverProps = resValue.resolverProps || {};
        }
        // Lambda function
        else {
            resValue = resValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${typeName}_${fieldName}`, resValue, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${resKey} resolver`);
            dataSourceKey = this.buildDataSourceKey(typeName, fieldName);
            dataSource = this.graphqlApi.addLambdaDataSource(dataSourceKey, lambda);
            resolverProps = {};
        }
        // Store new data source created
        if (lambda) {
            this.dataSourcesByDsKey[dataSourceKey] = dataSource;
            this.functionsByDsKey[dataSourceKey] = lambda;
        }
        this.dsKeysByResKey[resKey] = dataSourceKey;
        ///////////////////
        // Create resolver
        ///////////////////
        const resolver = this.graphqlApi.createResolver(Object.assign({ dataSource,
            typeName,
            fieldName }, resolverProps));
        this.resolversByResKey[resKey] = resolver;
        return lambda;
    }
    isLambdaResolverProps(object) {
        return object.function !== undefined;
    }
    isDataSourceResolverProps(object) {
        return object.dataSource !== undefined;
    }
    normalizeResolverKey(resolverKey) {
        // remove extra spaces in the key
        return resolverKey.split(/\s+/).join(" ");
    }
    buildDataSourceKey(typeName, fieldName) {
        return `LambdaDS_${typeName}_${fieldName}`;
    }
    getFunction(key) {
        let fn = this.functionsByDsKey[key];
        if (!fn) {
            const resKey = this.normalizeResolverKey(key);
            const dsKey = this.dsKeysByResKey[resKey];
            fn = this.functionsByDsKey[dsKey];
        }
        return fn;
    }
    getDataSource(key) {
        let ds = this.dataSourcesByDsKey[key];
        if (!ds) {
            const resKey = this.normalizeResolverKey(key);
            const dsKey = this.dsKeysByResKey[resKey];
            ds = this.dataSourcesByDsKey[dsKey];
        }
        return ds;
    }
    getResolver(key) {
        const resKey = this.normalizeResolverKey(key);
        return this.resolversByResKey[resKey];
    }
    attachPermissions(permissions) {
        Object.values(this.functionsByDsKey).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllFunctions.push(permissions);
    }
    attachPermissionsToDataSource(key, permissions) {
        const fn = this.getFunction(key);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Function does not exist for key "${key}".`);
        }
        fn.attachPermissions(permissions);
    }
}
exports.AppSyncApi = AppSyncApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwU3luY0FwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBTeW5jQXBpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkI7QUFDN0IsNkNBQStCO0FBQy9CLHFDQUFnQztBQUNoQyxnREFBcUQ7QUFDckQsMERBQTBEO0FBRTFELDJDQUF1QztBQUV2QyxvRUFBc0Q7QUFLdEQsbUNBQWdDO0FBQ2hDLDJDQUEyRTtBQUMzRSx5Q0FBK0U7QUE4RC9FLHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCLE1BQWEsVUFBVyxTQUFRLHNCQUFTO0lBV3ZDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBdUI7UUFDL0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsb0JBQW9CLEVBQUUsR0FDaEUsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsaUJBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxrQ0FBa0MsR0FBRyxFQUFFLENBQUM7UUFDN0MsSUFBSSxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO1FBRWpELG9CQUFvQjtRQUNwQixhQUFhO1FBQ2Isb0JBQW9CO1FBRXBCLElBQUksMEJBQWMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUM5QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQWdDLENBQUM7U0FDcEQ7YUFBTTtZQUNMLE1BQU0sZUFB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QUFHLENBQUMsQ0FBQztZQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFDLEVBQUUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDckM7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFTSxXQUFXLENBQUMsR0FBVztRQUM1QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDOUMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVNLGlCQUFpQixDQUFDLFdBQXdCO1FBQy9DLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FDbEQsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUNsQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRU0sNkJBQTZCLENBQ2xDLEdBQVcsRUFDWCxXQUF3QjtRQUV4QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxNQUFNLElBQUksS0FBSyxDQUNiLGtFQUFrRSxHQUFHLElBQUksQ0FDMUUsQ0FBQztTQUNIO1FBRUQsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7Q0FDRjtBQXZZRCxnQ0F1WUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCB7IHByaW50IH0gZnJvbSBcImdyYXBocWxcIjtcbmltcG9ydCB7IG1lcmdlVHlwZURlZnMgfSBmcm9tIFwiQGdyYXBocWwtdG9vbHMvbWVyZ2VcIjtcbmltcG9ydCB7IGxvYWRGaWxlc1N5bmMgfSBmcm9tIFwiQGdyYXBocWwtdG9vbHMvbG9hZC1maWxlc1wiO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgcmRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtcmRzXCI7XG5pbXBvcnQgKiBhcyBhcHBzeW5jIGZyb20gXCJAYXdzLWNkay9hd3MtYXBwc3luYy1hbHBoYVwiO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1keW5hbW9kYlwiO1xuaW1wb3J0ICogYXMgc2VjcmV0c21hbmFnZXIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlclwiO1xuXG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IFRhYmxlIH0gZnJvbSBcIi4vVGFibGVcIjtcbmltcG9ydCB7IGdldEZ1bmN0aW9uUmVmLCBTU1RDb25zdHJ1Y3QsIGlzQ0RLQ29uc3RydWN0IH0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5pbXBvcnQgeyBGdW5jdGlvbiBhcyBGbiwgRnVuY3Rpb25Qcm9wcywgRnVuY3Rpb25EZWZpbml0aW9uIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gSW50ZXJmYWNlc1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaVByb3BzIHtcbiAgcmVhZG9ubHkgZ3JhcGhxbEFwaT86IGFwcHN5bmMuSUdyYXBocWxBcGkgfCBBcHBTeW5jQXBpQ2RrR3JhcGhxbFByb3BzO1xuICByZWFkb25seSBkYXRhU291cmNlcz86IHtcbiAgICBba2V5OiBzdHJpbmddOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgQXBwU3luY0FwaUxhbWJkYURhdGFTb3VyY2VQcm9wc1xuICAgICAgfCBBcHBTeW5jQXBpRHluYW1vRGJEYXRhU291cmNlUHJvcHNcbiAgICAgIHwgQXBwU3luY0FwaVJkc0RhdGFTb3VyY2VQcm9wc1xuICAgICAgfCBBcHBTeW5jQXBpSHR0cERhdGFTb3VyY2VQcm9wcztcbiAgfTtcbiAgcmVhZG9ubHkgcmVzb2x2ZXJzPzoge1xuICAgIFtrZXk6IHN0cmluZ106IHN0cmluZyB8IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEFwcFN5bmNBcGlSZXNvbHZlclByb3BzO1xuICB9O1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaUxhbWJkYURhdGFTb3VyY2VQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IG9wdGlvbnM/OiBhcHBzeW5jLkRhdGFTb3VyY2VPcHRpb25zO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wcyB7XG4gIHJlYWRvbmx5IHRhYmxlOiBUYWJsZSB8IGR5bmFtb2RiLlRhYmxlO1xuICByZWFkb25seSBvcHRpb25zPzogYXBwc3luYy5EYXRhU291cmNlT3B0aW9ucztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcHBTeW5jQXBpUmRzRGF0YVNvdXJjZVByb3BzIHtcbiAgcmVhZG9ubHkgc2VydmVybGVzc0NsdXN0ZXI6IHJkcy5JU2VydmVybGVzc0NsdXN0ZXI7XG4gIHJlYWRvbmx5IHNlY3JldFN0b3JlOiBzZWNyZXRzbWFuYWdlci5JU2VjcmV0O1xuICByZWFkb25seSBkYXRhYmFzZU5hbWU/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IG9wdGlvbnM/OiBhcHBzeW5jLkRhdGFTb3VyY2VPcHRpb25zO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlIdHRwRGF0YVNvdXJjZVByb3BzIHtcbiAgcmVhZG9ubHkgZW5kcG9pbnQ6IHN0cmluZztcbiAgcmVhZG9ubHkgb3B0aW9ucz86IGFwcHN5bmMuSHR0cERhdGFTb3VyY2VPcHRpb25zO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlSZXNvbHZlclByb3BzIHtcbiAgcmVhZG9ubHkgZGF0YVNvdXJjZT86IHN0cmluZztcbiAgcmVhZG9ubHkgZnVuY3Rpb24/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHJlc29sdmVyUHJvcHM/OiBBcHBTeW5jQXBpQ2RrUmVzb2x2ZXJQcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcHBTeW5jQXBpQ2RrR3JhcGhxbFByb3BzXG4gIGV4dGVuZHMgT21pdDxhcHBzeW5jLkdyYXBocWxBcGlQcm9wcywgXCJuYW1lXCIgfCBcInNjaGVtYVwiPiB7XG4gIHJlYWRvbmx5IG5hbWU/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNjaGVtYT86IHN0cmluZyB8IHN0cmluZ1tdIHwgYXBwc3luYy5TY2hlbWE7XG59XG5cbmV4cG9ydCB0eXBlIEFwcFN5bmNBcGlDZGtSZXNvbHZlclByb3BzID0gT21pdDxcbiAgYXBwc3luYy5CYXNlUmVzb2x2ZXJQcm9wcyxcbiAgXCJmaWVsZE5hbWVcIiB8IFwidHlwZU5hbWVcIlxuPjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgQXBwU3luY0FwaSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBncmFwaHFsQXBpOiBhcHBzeW5jLkdyYXBocWxBcGk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25zQnlEc0tleTogeyBba2V5OiBzdHJpbmddOiBGbiB9O1xuICBwcml2YXRlIHJlYWRvbmx5IGRhdGFTb3VyY2VzQnlEc0tleToge1xuICAgIFtrZXk6IHN0cmluZ106IGFwcHN5bmMuQmFzZURhdGFTb3VyY2U7XG4gIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgZHNLZXlzQnlSZXNLZXk6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVzb2x2ZXJzQnlSZXNLZXk6IHsgW2tleTogc3RyaW5nXTogYXBwc3luYy5SZXNvbHZlciB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxGdW5jdGlvbnM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogQXBwU3luY0FwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHsgZ3JhcGhxbEFwaSwgZGF0YVNvdXJjZXMsIHJlc29sdmVycywgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfSA9XG4gICAgICBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLmZ1bmN0aW9uc0J5RHNLZXkgPSB7fTtcbiAgICB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleSA9IHt9O1xuICAgIHRoaXMucmVzb2x2ZXJzQnlSZXNLZXkgPSB7fTtcbiAgICB0aGlzLmRzS2V5c0J5UmVzS2V5ID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsRnVuY3Rpb25zID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgQXBpXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChpc0NES0NvbnN0cnVjdChncmFwaHFsQXBpKSkge1xuICAgICAgdGhpcy5ncmFwaHFsQXBpID0gZ3JhcGhxbEFwaSBhcyBhcHBzeW5jLkdyYXBocWxBcGk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGdyYXBocWxBcGlQcm9wcyA9IChncmFwaHFsQXBpIHx8IHt9KSBhcyBBcHBTeW5jQXBpQ2RrR3JhcGhxbFByb3BzO1xuXG4gICAgICAvLyBidWlsZCBzY2hlbWFcbiAgICAgIGxldCBtYWluU2NoZW1hOiBhcHBzeW5jLlNjaGVtYSB8IHVuZGVmaW5lZDtcbiAgICAgIGlmICh0eXBlb2YgZ3JhcGhxbEFwaVByb3BzLnNjaGVtYSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBtYWluU2NoZW1hID0gYXBwc3luYy5TY2hlbWEuZnJvbUFzc2V0KGdyYXBocWxBcGlQcm9wcy5zY2hlbWEpO1xuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGdyYXBocWxBcGlQcm9wcy5zY2hlbWEpKSB7XG4gICAgICAgIGlmIChncmFwaHFsQXBpUHJvcHMuc2NoZW1hLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAvLyBtZXJnZSBzY2hlbWEgZmlsZXNcbiAgICAgICAgICBjb25zdCBtZXJnZWRTY2hlbWEgPSBtZXJnZVR5cGVEZWZzKFxuICAgICAgICAgICAgbG9hZEZpbGVzU3luYyhncmFwaHFsQXBpUHJvcHMuc2NoZW1hKVxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oXG4gICAgICAgICAgICByb290LmJ1aWxkRGlyLFxuICAgICAgICAgICAgYGFwcHN5bmNhcGktJHtpZH0tJHt0aGlzLm5vZGUuYWRkcn0uZ3JhcGhxbGBcbiAgICAgICAgICApO1xuICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHByaW50KG1lcmdlZFNjaGVtYSkpO1xuICAgICAgICAgIG1haW5TY2hlbWEgPSBhcHBzeW5jLlNjaGVtYS5mcm9tQXNzZXQoZmlsZVBhdGgpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtYWluU2NoZW1hID0gZ3JhcGhxbEFwaVByb3BzLnNjaGVtYTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5ncmFwaHFsQXBpID0gbmV3IGFwcHN5bmMuR3JhcGhxbEFwaSh0aGlzLCBcIkFwaVwiLCB7XG4gICAgICAgIG5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIHhyYXlFbmFibGVkOiB0cnVlLFxuICAgICAgICAuLi5ncmFwaHFsQXBpUHJvcHMsXG5cbiAgICAgICAgLy8gaGFuZGxlIHNjaGVtYSBpcyBcInN0cmluZ1wiXG4gICAgICAgIHNjaGVtYTogbWFpblNjaGVtYSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSBkYXRhIHNvdXJjZXNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChkYXRhU291cmNlcykge1xuICAgICAgT2JqZWN0LmtleXMoZGF0YVNvdXJjZXMpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmFkZERhdGFTb3VyY2UodGhpcywga2V5LCBkYXRhU291cmNlc1trZXldKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDb25maWd1cmUgcmVzb2x2ZXJzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAocmVzb2x2ZXJzKSB7XG4gICAgICBPYmplY3Qua2V5cyhyZXNvbHZlcnMpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmFkZFJlc29sdmVyKHRoaXMsIGtleSwgcmVzb2x2ZXJzW2tleV0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZ3JhcGhxbEFwaS5ncmFwaHFsVXJsO1xuICB9XG5cbiAgcHVibGljIGFkZERhdGFTb3VyY2VzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgZGF0YVNvdXJjZXM6IHtcbiAgICAgIFtrZXk6IHN0cmluZ106XG4gICAgICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgICAgIHwgQXBwU3luY0FwaUxhbWJkYURhdGFTb3VyY2VQcm9wc1xuICAgICAgICB8IEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wc1xuICAgICAgICB8IEFwcFN5bmNBcGlSZHNEYXRhU291cmNlUHJvcHNcbiAgICAgICAgfCBBcHBTeW5jQXBpSHR0cERhdGFTb3VyY2VQcm9wcztcbiAgICB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKGRhdGFTb3VyY2VzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgLy8gYWRkIGRhdGEgc291cmNlXG4gICAgICBjb25zdCBmbiA9IHRoaXMuYWRkRGF0YVNvdXJjZShzY29wZSwga2V5LCBkYXRhU291cmNlc1trZXldKTtcblxuICAgICAgLy8gYXR0YWNoZWQgZXhpc3RpbmcgcGVybWlzc2lvbnNcbiAgICAgIGlmIChmbikge1xuICAgICAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxGdW5jdGlvbnMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+XG4gICAgICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYWRkUmVzb2x2ZXJzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcmVzb2x2ZXJzOiB7XG4gICAgICBba2V5OiBzdHJpbmddOiBGdW5jdGlvbkRlZmluaXRpb24gfCBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcztcbiAgICB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKHJlc29sdmVycykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIC8vIGFkZCByZXNvbHZlclxuICAgICAgY29uc3QgZm4gPSB0aGlzLmFkZFJlc29sdmVyKHNjb3BlLCBrZXksIHJlc29sdmVyc1trZXldKTtcblxuICAgICAgLy8gYXR0YWNoZWQgZXhpc3RpbmcgcGVybWlzc2lvbnNcbiAgICAgIGlmIChmbikge1xuICAgICAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxGdW5jdGlvbnMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+XG4gICAgICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiQXBwU3luY1wiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBhcHBTeW5jQXBpSWQ6IHRoaXMuZ3JhcGhxbEFwaS5hcGlJZCxcbiAgICAgICAgZGF0YVNvdXJjZXM6IE9iamVjdC5lbnRyaWVzKHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5KS5tYXAoKFtrZXldKSA9PiAoe1xuICAgICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgICBmbjogZ2V0RnVuY3Rpb25SZWYodGhpcy5mdW5jdGlvbnNCeURzS2V5W2tleV0pLFxuICAgICAgICB9KSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFkZERhdGFTb3VyY2UoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBkc0tleTogc3RyaW5nLFxuICAgIGRzVmFsdWU6XG4gICAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICAgfCBBcHBTeW5jQXBpTGFtYmRhRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wc1xuICAgICAgfCBBcHBTeW5jQXBpUmRzRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlIdHRwRGF0YVNvdXJjZVByb3BzXG4gICk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgZGF0YVNvdXJjZTtcbiAgICBsZXQgbGFtYmRhO1xuXG4gICAgLy8gTGFtYmRhIGRzXG4gICAgaWYgKChkc1ZhbHVlIGFzIEFwcFN5bmNBcGlMYW1iZGFEYXRhU291cmNlUHJvcHMpLmZ1bmN0aW9uKSB7XG4gICAgICBkc1ZhbHVlID0gZHNWYWx1ZSBhcyBBcHBTeW5jQXBpTGFtYmRhRGF0YVNvdXJjZVByb3BzO1xuICAgICAgbGFtYmRhID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBgTGFtYmRhXyR7ZHNLZXl9YCxcbiAgICAgICAgZHNWYWx1ZS5mdW5jdGlvbixcbiAgICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgICAgYENhbm5vdCBkZWZpbmUgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgd2hlbiBhIEZ1bmN0aW9uIGlzIHBhc3NlZCBpbiB0byB0aGUgXCIke2RzS2V5fSBkYXRhIHNvdXJjZWBcbiAgICAgICk7XG4gICAgICBkYXRhU291cmNlID0gdGhpcy5ncmFwaHFsQXBpLmFkZExhbWJkYURhdGFTb3VyY2UoXG4gICAgICAgIGRzS2V5LFxuICAgICAgICBsYW1iZGEsXG4gICAgICAgIGRzVmFsdWUub3B0aW9uc1xuICAgICAgKTtcbiAgICB9XG4gICAgLy8gRHluYW1vRGIgZHNcbiAgICBlbHNlIGlmICgoZHNWYWx1ZSBhcyBBcHBTeW5jQXBpRHluYW1vRGJEYXRhU291cmNlUHJvcHMpLnRhYmxlKSB7XG4gICAgICBkc1ZhbHVlID0gZHNWYWx1ZSBhcyBBcHBTeW5jQXBpRHluYW1vRGJEYXRhU291cmNlUHJvcHM7XG4gICAgICBjb25zdCB0YWJsZSA9XG4gICAgICAgIGRzVmFsdWUudGFibGUgaW5zdGFuY2VvZiBUYWJsZVxuICAgICAgICAgID8gZHNWYWx1ZS50YWJsZS5keW5hbW9kYlRhYmxlXG4gICAgICAgICAgOiBkc1ZhbHVlLnRhYmxlO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuZ3JhcGhxbEFwaS5hZGREeW5hbW9EYkRhdGFTb3VyY2UoXG4gICAgICAgIGRzS2V5LFxuICAgICAgICB0YWJsZSxcbiAgICAgICAgZHNWYWx1ZS5vcHRpb25zXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBSZHMgZHNcbiAgICBlbHNlIGlmICgoZHNWYWx1ZSBhcyBBcHBTeW5jQXBpUmRzRGF0YVNvdXJjZVByb3BzKS5zZXJ2ZXJsZXNzQ2x1c3Rlcikge1xuICAgICAgZHNWYWx1ZSA9IGRzVmFsdWUgYXMgQXBwU3luY0FwaVJkc0RhdGFTb3VyY2VQcm9wcztcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmdyYXBocWxBcGkuYWRkUmRzRGF0YVNvdXJjZShcbiAgICAgICAgZHNLZXksXG4gICAgICAgIGRzVmFsdWUuc2VydmVybGVzc0NsdXN0ZXIsXG4gICAgICAgIGRzVmFsdWUuc2VjcmV0U3RvcmUsXG4gICAgICAgIGRzVmFsdWUuZGF0YWJhc2VOYW1lLFxuICAgICAgICBkc1ZhbHVlLm9wdGlvbnNcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIEh0dHAgZHNcbiAgICBlbHNlIGlmICgoZHNWYWx1ZSBhcyBBcHBTeW5jQXBpSHR0cERhdGFTb3VyY2VQcm9wcykuZW5kcG9pbnQpIHtcbiAgICAgIGRzVmFsdWUgPSBkc1ZhbHVlIGFzIEFwcFN5bmNBcGlIdHRwRGF0YVNvdXJjZVByb3BzO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuZ3JhcGhxbEFwaS5hZGRIdHRwRGF0YVNvdXJjZShcbiAgICAgICAgZHNLZXksXG4gICAgICAgIGRzVmFsdWUuZW5kcG9pbnQsXG4gICAgICAgIGRzVmFsdWUub3B0aW9uc1xuICAgICAgKTtcbiAgICB9XG4gICAgLy8gTGFtYmRhIGZ1bmN0aW9uXG4gICAgZWxzZSB7XG4gICAgICBkc1ZhbHVlID0gZHNWYWx1ZSBhcyBGdW5jdGlvbkRlZmluaXRpb247XG4gICAgICBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGBMYW1iZGFfJHtkc0tleX1gLFxuICAgICAgICBkc1ZhbHVlLFxuICAgICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgICBgQ2Fubm90IGRlZmluZSBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB3aGVuIGEgRnVuY3Rpb24gaXMgcGFzc2VkIGluIHRvIHRoZSBcIiR7ZHNLZXl9IGRhdGEgc291cmNlYFxuICAgICAgKTtcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmdyYXBocWxBcGkuYWRkTGFtYmRhRGF0YVNvdXJjZShkc0tleSwgbGFtYmRhKTtcbiAgICB9XG4gICAgdGhpcy5kYXRhU291cmNlc0J5RHNLZXlbZHNLZXldID0gZGF0YVNvdXJjZTtcbiAgICBpZiAobGFtYmRhKSB7XG4gICAgICB0aGlzLmZ1bmN0aW9uc0J5RHNLZXlbZHNLZXldID0gbGFtYmRhO1xuICAgIH1cblxuICAgIHJldHVybiBsYW1iZGE7XG4gIH1cblxuICBwcml2YXRlIGFkZFJlc29sdmVyKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcmVzS2V5OiBzdHJpbmcsXG4gICAgcmVzVmFsdWU6IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEFwcFN5bmNBcGlSZXNvbHZlclByb3BzXG4gICk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICAvLyBOb3JtYWxpemUgcmVzS2V5XG4gICAgcmVzS2V5ID0gdGhpcy5ub3JtYWxpemVSZXNvbHZlcktleShyZXNLZXkpO1xuXG4gICAgLy8gR2V0IHR5cGUgYW5kIGZpZWxkXG4gICAgY29uc3QgcmVzb2x2ZXJLZXlQYXJ0cyA9IHJlc0tleS5zcGxpdChcIiBcIik7XG4gICAgaWYgKHJlc29sdmVyS2V5UGFydHMubGVuZ3RoICE9PSAyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcmVzb2x2ZXIgJHtyZXNLZXl9YCk7XG4gICAgfVxuICAgIGNvbnN0IFt0eXBlTmFtZSwgZmllbGROYW1lXSA9IHJlc29sdmVyS2V5UGFydHM7XG4gICAgaWYgKGZpZWxkTmFtZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBmaWVsZCBkZWZpbmVkIGZvciBcIiR7cmVzS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBkYXRhIHNvdXJjZSBpZiBub3QgY3JlYXRlZCBiZWZvcmVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgbGV0IGxhbWJkYTtcbiAgICBsZXQgZGF0YVNvdXJjZTtcbiAgICBsZXQgZGF0YVNvdXJjZUtleTtcbiAgICBsZXQgcmVzb2x2ZXJQcm9wcztcblxuICAgIC8vIERhdGFTb3VyY2Uga2V5XG4gICAgaWYgKFxuICAgICAgdHlwZW9mIHJlc1ZhbHVlID09PSBcInN0cmluZ1wiICYmXG4gICAgICBPYmplY3Qua2V5cyh0aGlzLmRhdGFTb3VyY2VzQnlEc0tleSkuaW5jbHVkZXMocmVzVmFsdWUpXG4gICAgKSB7XG4gICAgICBkYXRhU291cmNlS2V5ID0gcmVzVmFsdWU7XG4gICAgICBkYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlc0J5RHNLZXlbcmVzVmFsdWVdO1xuICAgICAgcmVzb2x2ZXJQcm9wcyA9IHt9O1xuICAgIH1cbiAgICAvLyBEYXRhU291cmNlIGtleSBub3QgZXhpc3QgKHN0cmluZyBkb2VzIG5vdCBoYXZlIGEgZG90LCBhc3N1bWUgaXQgaXMgcmVmZXJlbmNpbmcgYSBkYXRhIHN0b3JlKVxuICAgIGVsc2UgaWYgKHR5cGVvZiByZXNWYWx1ZSA9PT0gXCJzdHJpbmdcIiAmJiByZXNWYWx1ZS5pbmRleE9mKFwiLlwiKSA9PT0gLTEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBjcmVhdGUgcmVzb2x2ZXIgXCIke3Jlc0tleX1cIi4gRGF0YSBzb3VyY2UgXCIke3Jlc1ZhbHVlfVwiIGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIExhbWJkYSByZXNvbHZlclxuICAgIGVsc2UgaWYgKHRoaXMuaXNMYW1iZGFSZXNvbHZlclByb3BzKHJlc1ZhbHVlIGFzIEFwcFN5bmNBcGlSZXNvbHZlclByb3BzKSkge1xuICAgICAgcmVzVmFsdWUgPSByZXNWYWx1ZSBhcyBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcztcbiAgICAgIGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgYExhbWJkYV8ke3R5cGVOYW1lfV8ke2ZpZWxkTmFtZX1gLFxuICAgICAgICByZXNWYWx1ZS5mdW5jdGlvbiBhcyBGdW5jdGlvbkRlZmluaXRpb24sXG4gICAgICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICAgIGBDYW5ub3QgZGVmaW5lIGRlZmF1bHRGdW5jdGlvblByb3BzIHdoZW4gYSBGdW5jdGlvbiBpcyBwYXNzZWQgaW4gdG8gdGhlIFwiJHtyZXNLZXl9IHJlc29sdmVyYFxuICAgICAgKTtcbiAgICAgIGRhdGFTb3VyY2VLZXkgPSB0aGlzLmJ1aWxkRGF0YVNvdXJjZUtleSh0eXBlTmFtZSwgZmllbGROYW1lKTtcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmdyYXBocWxBcGkuYWRkTGFtYmRhRGF0YVNvdXJjZShkYXRhU291cmNlS2V5LCBsYW1iZGEpO1xuICAgICAgcmVzb2x2ZXJQcm9wcyA9IHJlc1ZhbHVlLnJlc29sdmVyUHJvcHMgfHwge307XG4gICAgfVxuICAgIC8vIERhdGFTb3VyY2UgcmVzb2x2ZXJcbiAgICBlbHNlIGlmIChcbiAgICAgIHRoaXMuaXNEYXRhU291cmNlUmVzb2x2ZXJQcm9wcyhyZXNWYWx1ZSBhcyBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcylcbiAgICApIHtcbiAgICAgIHJlc1ZhbHVlID0gcmVzVmFsdWUgYXMgQXBwU3luY0FwaVJlc29sdmVyUHJvcHM7XG4gICAgICBkYXRhU291cmNlS2V5ID0gcmVzVmFsdWUuZGF0YVNvdXJjZSBhcyBzdHJpbmc7XG4gICAgICBkYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlc0J5RHNLZXlbZGF0YVNvdXJjZUtleV07XG4gICAgICByZXNvbHZlclByb3BzID0gcmVzVmFsdWUucmVzb2x2ZXJQcm9wcyB8fCB7fTtcbiAgICB9XG4gICAgLy8gTGFtYmRhIGZ1bmN0aW9uXG4gICAgZWxzZSB7XG4gICAgICByZXNWYWx1ZSA9IHJlc1ZhbHVlIGFzIEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgICAgIGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgYExhbWJkYV8ke3R5cGVOYW1lfV8ke2ZpZWxkTmFtZX1gLFxuICAgICAgICByZXNWYWx1ZSxcbiAgICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgICAgYENhbm5vdCBkZWZpbmUgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgd2hlbiBhIEZ1bmN0aW9uIGlzIHBhc3NlZCBpbiB0byB0aGUgXCIke3Jlc0tleX0gcmVzb2x2ZXJgXG4gICAgICApO1xuICAgICAgZGF0YVNvdXJjZUtleSA9IHRoaXMuYnVpbGREYXRhU291cmNlS2V5KHR5cGVOYW1lLCBmaWVsZE5hbWUpO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuZ3JhcGhxbEFwaS5hZGRMYW1iZGFEYXRhU291cmNlKGRhdGFTb3VyY2VLZXksIGxhbWJkYSk7XG4gICAgICByZXNvbHZlclByb3BzID0ge307XG4gICAgfVxuXG4gICAgLy8gU3RvcmUgbmV3IGRhdGEgc291cmNlIGNyZWF0ZWRcbiAgICBpZiAobGFtYmRhKSB7XG4gICAgICB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleVtkYXRhU291cmNlS2V5XSA9IGRhdGFTb3VyY2U7XG4gICAgICB0aGlzLmZ1bmN0aW9uc0J5RHNLZXlbZGF0YVNvdXJjZUtleV0gPSBsYW1iZGE7XG4gICAgfVxuICAgIHRoaXMuZHNLZXlzQnlSZXNLZXlbcmVzS2V5XSA9IGRhdGFTb3VyY2VLZXk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIHJlc29sdmVyXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHJlc29sdmVyID0gdGhpcy5ncmFwaHFsQXBpLmNyZWF0ZVJlc29sdmVyKHtcbiAgICAgIGRhdGFTb3VyY2UsXG4gICAgICB0eXBlTmFtZSxcbiAgICAgIGZpZWxkTmFtZSxcbiAgICAgIC4uLnJlc29sdmVyUHJvcHMsXG4gICAgfSk7XG4gICAgdGhpcy5yZXNvbHZlcnNCeVJlc0tleVtyZXNLZXldID0gcmVzb2x2ZXI7XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0xhbWJkYVJlc29sdmVyUHJvcHMob2JqZWN0OiBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBvYmplY3QuZnVuY3Rpb24gIT09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgaXNEYXRhU291cmNlUmVzb2x2ZXJQcm9wcyhvYmplY3Q6IEFwcFN5bmNBcGlSZXNvbHZlclByb3BzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9iamVjdC5kYXRhU291cmNlICE9PSB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZVJlc29sdmVyS2V5KHJlc29sdmVyS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIHJlbW92ZSBleHRyYSBzcGFjZXMgaW4gdGhlIGtleVxuICAgIHJldHVybiByZXNvbHZlcktleS5zcGxpdCgvXFxzKy8pLmpvaW4oXCIgXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZERhdGFTb3VyY2VLZXkodHlwZU5hbWU6IHN0cmluZywgZmllbGROYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBgTGFtYmRhRFNfJHt0eXBlTmFtZX1fJHtmaWVsZE5hbWV9YDtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGdW5jdGlvbihrZXk6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgZm4gPSB0aGlzLmZ1bmN0aW9uc0J5RHNLZXlba2V5XTtcblxuICAgIGlmICghZm4pIHtcbiAgICAgIGNvbnN0IHJlc0tleSA9IHRoaXMubm9ybWFsaXplUmVzb2x2ZXJLZXkoa2V5KTtcbiAgICAgIGNvbnN0IGRzS2V5ID0gdGhpcy5kc0tleXNCeVJlc0tleVtyZXNLZXldO1xuICAgICAgZm4gPSB0aGlzLmZ1bmN0aW9uc0J5RHNLZXlbZHNLZXldO1xuICAgIH1cbiAgICByZXR1cm4gZm47XG4gIH1cblxuICBwdWJsaWMgZ2V0RGF0YVNvdXJjZShrZXk6IHN0cmluZyk6IGFwcHN5bmMuQmFzZURhdGFTb3VyY2UgfCB1bmRlZmluZWQge1xuICAgIGxldCBkcyA9IHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5W2tleV07XG5cbiAgICBpZiAoIWRzKSB7XG4gICAgICBjb25zdCByZXNLZXkgPSB0aGlzLm5vcm1hbGl6ZVJlc29sdmVyS2V5KGtleSk7XG4gICAgICBjb25zdCBkc0tleSA9IHRoaXMuZHNLZXlzQnlSZXNLZXlbcmVzS2V5XTtcbiAgICAgIGRzID0gdGhpcy5kYXRhU291cmNlc0J5RHNLZXlbZHNLZXldO1xuICAgIH1cbiAgICByZXR1cm4gZHM7XG4gIH1cblxuICBwdWJsaWMgZ2V0UmVzb2x2ZXIoa2V5OiBzdHJpbmcpOiBhcHBzeW5jLlJlc29sdmVyIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCByZXNLZXkgPSB0aGlzLm5vcm1hbGl6ZVJlc29sdmVyS2V5KGtleSk7XG4gICAgcmV0dXJuIHRoaXMucmVzb2x2ZXJzQnlSZXNLZXlbcmVzS2V5XTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBPYmplY3QudmFsdWVzKHRoaXMuZnVuY3Rpb25zQnlEc0tleSkuZm9yRWFjaCgoZm4pID0+XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbEZ1bmN0aW9ucy5wdXNoKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc1RvRGF0YVNvdXJjZShcbiAgICBrZXk6IHN0cmluZyxcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgZm4gPSB0aGlzLmdldEZ1bmN0aW9uKGtleSk7XG4gICAgaWYgKCFmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGF0dGFjaCBwZXJtaXNzaW9ucy4gRnVuY3Rpb24gZG9lcyBub3QgZXhpc3QgZm9yIGtleSBcIiR7a2V5fVwiLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG59XG4iXX0=