"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildCustomDomainData = void 0;
const cdk = __importStar(require("aws-cdk-lib"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
function buildCustomDomainData(scope, customDomain) {
    if (customDomain === undefined) {
        return;
    }
    // customDomain is a string
    else if (typeof customDomain === "string") {
        return buildDataForStringInput(scope, customDomain);
    }
    // customDomain.domainName not exists
    else if (!customDomain.domainName) {
        throw new Error(`Missing "domainName" in sst.Api's customDomain setting`);
    }
    // customDomain.domainName is a string
    else if (typeof customDomain.domainName === "string") {
        return customDomain.isExternalDomain
            ? buildDataForExternalDomainInput(scope, customDomain)
            : buildDataForInternalDomainInput(scope, customDomain);
    }
    // customDomain.domainName is a construct
    return buildDataForConstructInput(scope, customDomain);
}
exports.buildCustomDomainData = buildCustomDomainData;
function buildDataForStringInput(scope, customDomain) {
    // validate: customDomain is a TOKEN string
    // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
    if (cdk.Token.isUnresolved(customDomain)) {
        throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
    }
    assertDomainNameIsLowerCase(customDomain);
    const domainName = customDomain;
    const hostedZoneDomain = domainName.split(".").slice(1).join(".");
    const hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    const certificate = createCertificate(scope, domainName, hostedZone);
    const apigDomain = createApigDomain(scope, domainName, certificate);
    createARecord(scope, hostedZone, domainName, apigDomain);
    return {
        apigDomain,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated: true,
        url: buildDomainUrl(domainName),
    };
}
function buildDataForInternalDomainInput(scope, customDomain) {
    // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
    // is because "hostedZone" cannot be parsed from a TOKEN value.
    if (cdk.Token.isUnresolved(customDomain.domainName)) {
        if (!customDomain.hostedZone) {
            throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
        }
    }
    else {
        assertDomainNameIsLowerCase(customDomain.domainName);
    }
    const domainName = customDomain.domainName;
    // Lookup hosted zone
    // Note: Allow user passing in `hostedZone` object. The use case is when
    //       there are multiple HostedZones with the same domain, but one is
    //       public, and one is private.
    let hostedZone;
    if (!customDomain.hostedZone) {
        const hostedZoneDomain = domainName.split(".").slice(1).join(".");
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    else if (typeof customDomain.hostedZone === "string") {
        const hostedZoneDomain = customDomain.hostedZone;
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    else {
        hostedZone = customDomain.hostedZone;
    }
    // Create certificate
    // Note: Allow user passing in `certificate` object. The use case is for
    //       user to create wildcard certificate or using an imported certificate.
    let certificate, isCertificatedCreated;
    if (customDomain.certificate) {
        certificate = customDomain.certificate;
        isCertificatedCreated = false;
    }
    else {
        certificate = createCertificate(scope, domainName, hostedZone);
        isCertificatedCreated = true;
    }
    const apigDomain = createApigDomain(scope, domainName, certificate);
    const mappingKey = customDomain.path;
    createARecord(scope, hostedZone, domainName, apigDomain);
    return {
        apigDomain,
        mappingKey,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function buildDataForExternalDomainInput(scope, customDomain) {
    // if it is external, then a certificate is required
    if (!customDomain.certificate) {
        throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
    }
    // if it is external, then the hostedZone is not required
    if (customDomain.hostedZone) {
        throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
    }
    const domainName = customDomain.domainName;
    assertDomainNameIsLowerCase(domainName);
    const certificate = customDomain.certificate;
    const apigDomain = createApigDomain(scope, domainName, certificate);
    const mappingKey = customDomain.path;
    return {
        apigDomain,
        mappingKey,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated: false,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function buildDataForConstructInput(scope, customDomain) {
    //  Allow user passing in `apigDomain` object. The use case is a user creates
    //  multiple API endpoints, and is mapping them under the same custom domain.
    //  `sst.Api` needs to expose the `apigDomain` construct created in the first
    //  Api, and lets user pass it in when creating the second Api.
    if (customDomain.hostedZone) {
        throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
    }
    if (customDomain.certificate) {
        throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
    }
    const apigDomain = customDomain.domainName;
    const domainName = apigDomain.name;
    const mappingKey = customDomain.path;
    return {
        apigDomain,
        mappingKey,
        certificate: undefined,
        isApigDomainCreated: false,
        isCertificatedCreated: false,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function lookupHostedZone(scope, hostedZoneDomain) {
    return route53.HostedZone.fromLookup(scope, "HostedZone", {
        domainName: hostedZoneDomain,
    });
}
function createCertificate(scope, domainName, hostedZone) {
    return new acm.Certificate(scope, "Certificate", {
        domainName,
        validation: acm.CertificateValidation.fromDns(hostedZone),
    });
}
function createApigDomain(scope, domainName, certificate) {
    return new apig.DomainName(scope, "DomainName", {
        domainName,
        certificate,
    });
}
function createARecord(scope, hostedZone, domainName, apigDomain) {
    // create DNS record
    const record = new route53.ARecord(scope, "AliasRecord", {
        recordName: domainName,
        zone: hostedZone,
        target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayv2DomainProperties(apigDomain.regionalDomainName, apigDomain.regionalHostedZoneId)),
    });
    // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
    //       construct will append ".${hostedZoneName}" to the end of the domain.
    //       This is because the construct tries to check if the record name
    //       ends with the domain name. If not, it will append the domain name.
    //       So, we need remove this behavior.
    if (cdk.Token.isUnresolved(domainName)) {
        const cfnRecord = record.node.defaultChild;
        cfnRecord.name = domainName;
    }
}
function buildDomainUrl(domainName, mappingKey) {
    // Note: If mapping key is set, the URL needs a trailing slash. Without the
    //       trailing slash, the API fails with the error
    //       {"message":"Not Found"}
    return mappingKey ? `${domainName}/${mappingKey}/` : domainName;
}
function assertDomainNameIsLowerCase(domainName) {
    if (domainName !== domainName.toLowerCase()) {
        throw new Error(`The domain name needs to be in lowercase`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyRG9tYWluLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyRG9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxpREFBbUM7QUFDbkMsc0VBQXdEO0FBQ3hELGlFQUFtRDtBQUNuRCxnRkFBa0U7QUFDbEUsd0VBQTBEO0FBbUIxRCxTQUFnQixxQkFBcUIsQ0FDbkMsS0FBZ0IsRUFDaEIsWUFBb0Q7SUFFcEQsSUFBSSxZQUFZLEtBQUssU0FBUyxFQUFFO1FBQzlCLE9BQU87S0FDUjtJQUNELDJCQUEyQjtTQUN0QixJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRTtRQUN6QyxPQUFPLHVCQUF1QixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztLQUNyRDtJQUNELHFDQUFxQztTQUNoQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRTtRQUNqQyxNQUFNLElBQUksS0FBSyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7S0FDM0U7SUFDRCxzQ0FBc0M7U0FDakMsSUFBSSxPQUFPLFlBQVksQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFO1FBQ3BELE9BQU8sWUFBWSxDQUFDLGdCQUFnQjtZQUNsQyxDQUFDLENBQUMsK0JBQStCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQztZQUN0RCxDQUFDLENBQUMsK0JBQStCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0tBQzFEO0lBQ0QseUNBQXlDO0lBQ3pDLE9BQU8sMEJBQTBCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ3pELENBQUM7QUF2QkQsc0RBdUJDO0FBRUQsU0FBUyx1QkFBdUIsQ0FDOUIsS0FBZ0IsRUFDaEIsWUFBb0I7SUFFcEIsMkNBQTJDO0lBQzNDLHdFQUF3RTtJQUN4RSxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFlBQVks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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1hbHBoYVwiO1xuaW1wb3J0ICogYXMgcm91dGU1MyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNUYXJnZXRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtcm91dGU1My10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBDdXN0b21Eb21haW5Qcm9wcyB7XG4gIHJlYWRvbmx5IGRvbWFpbk5hbWU6IHN0cmluZyB8IGFwaWcuSURvbWFpbk5hbWU7XG4gIHJlYWRvbmx5IGhvc3RlZFpvbmU/OiBzdHJpbmcgfCByb3V0ZTUzLklIb3N0ZWRab25lO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHJlYWRvbmx5IHBhdGg/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGlzRXh0ZXJuYWxEb21haW4/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEN1c3RvbURvbWFpbkRhdGEge1xuICByZWFkb25seSBhcGlnRG9tYWluOiBhcGlnLklEb21haW5OYW1lO1xuICByZWFkb25seSBtYXBwaW5nS2V5Pzogc3RyaW5nO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHJlYWRvbmx5IGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IGJvb2xlYW47XG4gIHJlYWRvbmx5IGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgdXJsOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZEN1c3RvbURvbWFpbkRhdGEoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGN1c3RvbURvbWFpbjogc3RyaW5nIHwgQ3VzdG9tRG9tYWluUHJvcHMgfCB1bmRlZmluZWRcbik6IEN1c3RvbURvbWFpbkRhdGEgfCB1bmRlZmluZWQge1xuICBpZiAoY3VzdG9tRG9tYWluID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluIGlzIGEgc3RyaW5nXG4gIGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gYnVpbGREYXRhRm9yU3RyaW5nSW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbik7XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgbm90IGV4aXN0c1xuICBlbHNlIGlmICghY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJkb21haW5OYW1lXCIgaW4gc3N0LkFwaSdzIGN1c3RvbURvbWFpbiBzZXR0aW5nYCk7XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgaXMgYSBzdHJpbmdcbiAgZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5kb21haW5OYW1lID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmV0dXJuIGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluXG4gICAgICA/IGJ1aWxkRGF0YUZvckV4dGVybmFsRG9tYWluSW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbilcbiAgICAgIDogYnVpbGREYXRhRm9ySW50ZXJuYWxEb21haW5JbnB1dChzY29wZSwgY3VzdG9tRG9tYWluKTtcbiAgfVxuICAvLyBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBpcyBhIGNvbnN0cnVjdFxuICByZXR1cm4gYnVpbGREYXRhRm9yQ29uc3RydWN0SW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbik7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvclN0cmluZ0lucHV0KFxuICBzY29wZTogQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IHN0cmluZ1xuKTogQ3VzdG9tRG9tYWluRGF0YSB7XG4gIC8vIHZhbGlkYXRlOiBjdXN0b21Eb21haW4gaXMgYSBUT0tFTiBzdHJpbmdcbiAgLy8gaWUuIGltcG9ydGVkIFNTTSB2YWx1ZTogc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZvclN0cmluZ1BhcmFtZXRlcigpXG4gIGlmIChjZGsuVG9rZW4uaXNVbnJlc29sdmVkKGN1c3RvbURvbWFpbikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgWW91IGFsc28gbmVlZCB0byBzcGVjaWZ5IHRoZSBcImhvc3RlZFpvbmVcIiBpZiB0aGUgXCJkb21haW5OYW1lXCIgaXMgcGFzc2VkIGluIGFzIGEgcmVmZXJlbmNlLmBcbiAgICApO1xuICB9XG5cbiAgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGN1c3RvbURvbWFpbik7XG5cbiAgY29uc3QgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbjtcbiAgY29uc3QgaG9zdGVkWm9uZURvbWFpbiA9IGRvbWFpbk5hbWUuc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuICBjb25zdCBob3N0ZWRab25lID0gbG9va3VwSG9zdGVkWm9uZShzY29wZSwgaG9zdGVkWm9uZURvbWFpbik7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gY3JlYXRlQ2VydGlmaWNhdGUoc2NvcGUsIGRvbWFpbk5hbWUsIGhvc3RlZFpvbmUpO1xuICBjb25zdCBhcGlnRG9tYWluID0gY3JlYXRlQXBpZ0RvbWFpbihzY29wZSwgZG9tYWluTmFtZSwgY2VydGlmaWNhdGUpO1xuICBjcmVhdGVBUmVjb3JkKHNjb3BlLCBob3N0ZWRab25lLCBkb21haW5OYW1lLCBhcGlnRG9tYWluKTtcblxuICByZXR1cm4ge1xuICAgIGFwaWdEb21haW4sXG4gICAgY2VydGlmaWNhdGUsXG4gICAgaXNBcGlnRG9tYWluQ3JlYXRlZDogdHJ1ZSxcbiAgICBpc0NlcnRpZmljYXRlZENyZWF0ZWQ6IHRydWUsXG4gICAgdXJsOiBidWlsZERvbWFpblVybChkb21haW5OYW1lKSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gYnVpbGREYXRhRm9ySW50ZXJuYWxEb21haW5JbnB1dChcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgY3VzdG9tRG9tYWluOiBDdXN0b21Eb21haW5Qcm9wc1xuKTogQ3VzdG9tRG9tYWluRGF0YSB7XG4gIC8vIElmIGN1c3RvbURvbWFpbiBpcyBhIFRPS0VOIHN0cmluZywgXCJob3N0ZWRab25lXCIgaGFzIHRvIGJlIHBhc3NlZCBpbi4gVGhpc1xuICAvLyBpcyBiZWNhdXNlIFwiaG9zdGVkWm9uZVwiIGNhbm5vdCBiZSBwYXJzZWQgZnJvbSBhIFRPS0VOIHZhbHVlLlxuICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChjdXN0b21Eb21haW4uZG9tYWluTmFtZSkpIHtcbiAgICBpZiAoIWN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBZb3UgYWxzbyBuZWVkIHRvIHNwZWNpZnkgdGhlIFwiaG9zdGVkWm9uZVwiIGlmIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBwYXNzZWQgaW4gYXMgYSByZWZlcmVuY2UuYFxuICAgICAgKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGFzIHN0cmluZyk7XG4gIH1cblxuICBjb25zdCBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgYXMgc3RyaW5nO1xuXG4gIC8vIExvb2t1cCBob3N0ZWQgem9uZVxuICAvLyBOb3RlOiBBbGxvdyB1c2VyIHBhc3NpbmcgaW4gYGhvc3RlZFpvbmVgIG9iamVjdC4gVGhlIHVzZSBjYXNlIGlzIHdoZW5cbiAgLy8gICAgICAgdGhlcmUgYXJlIG11bHRpcGxlIEhvc3RlZFpvbmVzIHdpdGggdGhlIHNhbWUgZG9tYWluLCBidXQgb25lIGlzXG4gIC8vICAgICAgIHB1YmxpYywgYW5kIG9uZSBpcyBwcml2YXRlLlxuXG4gIGxldCBob3N0ZWRab25lO1xuICBpZiAoIWN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgY29uc3QgaG9zdGVkWm9uZURvbWFpbiA9IGRvbWFpbk5hbWUuc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuICAgIGhvc3RlZFpvbmUgPSBsb29rdXBIb3N0ZWRab25lKHNjb3BlLCBob3N0ZWRab25lRG9tYWluKTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUgPT09IFwic3RyaW5nXCIpIHtcbiAgICBjb25zdCBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgaG9zdGVkWm9uZSA9IGxvb2t1cEhvc3RlZFpvbmUoc2NvcGUsIGhvc3RlZFpvbmVEb21haW4pO1xuICB9IGVsc2Uge1xuICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZTtcbiAgfVxuXG4gIC8vIENyZWF0ZSBjZXJ0aWZpY2F0ZVxuICAvLyBOb3RlOiBBbGxvdyB1c2VyIHBhc3NpbmcgaW4gYGNlcnRpZmljYXRlYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyBmb3JcbiAgLy8gICAgICAgdXNlciB0byBjcmVhdGUgd2lsZGNhcmQgY2VydGlmaWNhdGUgb3IgdXNpbmcgYW4gaW1wb3J0ZWQgY2VydGlmaWNhdGUuXG4gIGxldCBjZXJ0aWZpY2F0ZSwgaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkO1xuICBpZiAoY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKSB7XG4gICAgY2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gICAgaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkID0gZmFsc2U7XG4gIH0gZWxzZSB7XG4gICAgY2VydGlmaWNhdGUgPSBjcmVhdGVDZXJ0aWZpY2F0ZShzY29wZSwgZG9tYWluTmFtZSwgaG9zdGVkWm9uZSk7XG4gICAgaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkID0gdHJ1ZTtcbiAgfVxuXG4gIGNvbnN0IGFwaWdEb21haW4gPSBjcmVhdGVBcGlnRG9tYWluKHNjb3BlLCBkb21haW5OYW1lLCBjZXJ0aWZpY2F0ZSk7XG4gIGNvbnN0IG1hcHBpbmdLZXkgPSBjdXN0b21Eb21haW4ucGF0aDtcbiAgY3JlYXRlQVJlY29yZChzY29wZSwgaG9zdGVkWm9uZSwgZG9tYWluTmFtZSwgYXBpZ0RvbWFpbik7XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlnRG9tYWluLFxuICAgIG1hcHBpbmdLZXksXG4gICAgY2VydGlmaWNhdGUsXG4gICAgaXNBcGlnRG9tYWluQ3JlYXRlZDogdHJ1ZSxcbiAgICBpc0NlcnRpZmljYXRlZENyZWF0ZWQsXG4gICAgdXJsOiBidWlsZERvbWFpblVybChkb21haW5OYW1lLCBtYXBwaW5nS2V5KSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gYnVpbGREYXRhRm9yRXh0ZXJuYWxEb21haW5JbnB1dChcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgY3VzdG9tRG9tYWluOiBDdXN0b21Eb21haW5Qcm9wc1xuKTogQ3VzdG9tRG9tYWluRGF0YSB7XG4gIC8vIGlmIGl0IGlzIGV4dGVybmFsLCB0aGVuIGEgY2VydGlmaWNhdGUgaXMgcmVxdWlyZWRcbiAgaWYgKCFjdXN0b21Eb21haW4uY2VydGlmaWNhdGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQSB2YWxpZCBjZXJ0aWZpY2F0ZSBpcyByZXF1aXJlZCB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIHNldCB0byBcInRydWVcIi5gXG4gICAgKTtcbiAgfVxuICAvLyBpZiBpdCBpcyBleHRlcm5hbCwgdGhlbiB0aGUgaG9zdGVkWm9uZSBpcyBub3QgcmVxdWlyZWRcbiAgaWYgKGN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEhvc3RlZCB6b25lcyBjYW4gb25seSBiZSBjb25maWd1cmVkIGZvciBkb21haW5zIGhvc3RlZCBvbiBBbWF6b24gUm91dGUgNTMuIERvIG5vdCBzZXQgdGhlIFwiY3VzdG9tRG9tYWluLmhvc3RlZFpvbmVcIiB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIGVuYWJsZWQuYFxuICAgICk7XG4gIH1cblxuICBjb25zdCBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgYXMgc3RyaW5nO1xuICBhc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZSk7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICBjb25zdCBhcGlnRG9tYWluID0gY3JlYXRlQXBpZ0RvbWFpbihzY29wZSwgZG9tYWluTmFtZSwgY2VydGlmaWNhdGUpO1xuICBjb25zdCBtYXBwaW5nS2V5ID0gY3VzdG9tRG9tYWluLnBhdGg7XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlnRG9tYWluLFxuICAgIG1hcHBpbmdLZXksXG4gICAgY2VydGlmaWNhdGUsXG4gICAgaXNBcGlnRG9tYWluQ3JlYXRlZDogdHJ1ZSxcbiAgICBpc0NlcnRpZmljYXRlZENyZWF0ZWQ6IGZhbHNlLFxuICAgIHVybDogYnVpbGREb21haW5VcmwoZG9tYWluTmFtZSwgbWFwcGluZ0tleSksXG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvckNvbnN0cnVjdElucHV0KFxuICBzY29wZTogQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IEN1c3RvbURvbWFpblByb3BzXG4pOiBDdXN0b21Eb21haW5EYXRhIHtcbiAgLy8gIEFsbG93IHVzZXIgcGFzc2luZyBpbiBgYXBpZ0RvbWFpbmAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgYSB1c2VyIGNyZWF0ZXNcbiAgLy8gIG11bHRpcGxlIEFQSSBlbmRwb2ludHMsIGFuZCBpcyBtYXBwaW5nIHRoZW0gdW5kZXIgdGhlIHNhbWUgY3VzdG9tIGRvbWFpbi5cbiAgLy8gIGBzc3QuQXBpYCBuZWVkcyB0byBleHBvc2UgdGhlIGBhcGlnRG9tYWluYCBjb25zdHJ1Y3QgY3JlYXRlZCBpbiB0aGUgZmlyc3RcbiAgLy8gIEFwaSwgYW5kIGxldHMgdXNlciBwYXNzIGl0IGluIHdoZW4gY3JlYXRpbmcgdGhlIHNlY29uZCBBcGkuXG5cbiAgaWYgKGN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaG9zdGVkWm9uZVwiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICk7XG4gIH1cbiAgaWYgKGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNlcnRpZmljYXRlXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IGFwaWdEb21haW4gPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBhcyBhcGlnLklEb21haW5OYW1lO1xuICBjb25zdCBkb21haW5OYW1lID0gYXBpZ0RvbWFpbi5uYW1lO1xuICBjb25zdCBtYXBwaW5nS2V5ID0gY3VzdG9tRG9tYWluLnBhdGg7XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlnRG9tYWluLFxuICAgIG1hcHBpbmdLZXksXG4gICAgY2VydGlmaWNhdGU6IHVuZGVmaW5lZCxcbiAgICBpc0FwaWdEb21haW5DcmVhdGVkOiBmYWxzZSxcbiAgICBpc0NlcnRpZmljYXRlZENyZWF0ZWQ6IGZhbHNlLFxuICAgIHVybDogYnVpbGREb21haW5VcmwoZG9tYWluTmFtZSwgbWFwcGluZ0tleSksXG4gIH07XG59XG5cbmZ1bmN0aW9uIGxvb2t1cEhvc3RlZFpvbmUoc2NvcGU6IENvbnN0cnVjdCwgaG9zdGVkWm9uZURvbWFpbjogc3RyaW5nKSB7XG4gIHJldHVybiByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cChzY29wZSwgXCJIb3N0ZWRab25lXCIsIHtcbiAgICBkb21haW5OYW1lOiBob3N0ZWRab25lRG9tYWluLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQ2VydGlmaWNhdGUoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGRvbWFpbk5hbWU6IHN0cmluZyxcbiAgaG9zdGVkWm9uZTogcm91dGU1My5JSG9zdGVkWm9uZVxuKSB7XG4gIHJldHVybiBuZXcgYWNtLkNlcnRpZmljYXRlKHNjb3BlLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICBkb21haW5OYW1lLFxuICAgIHZhbGlkYXRpb246IGFjbS5DZXJ0aWZpY2F0ZVZhbGlkYXRpb24uZnJvbURucyhob3N0ZWRab25lKSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUFwaWdEb21haW4oXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGRvbWFpbk5hbWU6IHN0cmluZyxcbiAgY2VydGlmaWNhdGU6IGFjbS5JQ2VydGlmaWNhdGVcbikge1xuICByZXR1cm4gbmV3IGFwaWcuRG9tYWluTmFtZShzY29wZSwgXCJEb21haW5OYW1lXCIsIHtcbiAgICBkb21haW5OYW1lLFxuICAgIGNlcnRpZmljYXRlLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQVJlY29yZChcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgaG9zdGVkWm9uZTogcm91dGU1My5JSG9zdGVkWm9uZSxcbiAgZG9tYWluTmFtZTogc3RyaW5nLFxuICBhcGlnRG9tYWluOiBhcGlnLklEb21haW5OYW1lXG4pIHtcbiAgLy8gY3JlYXRlIEROUyByZWNvcmRcbiAgY29uc3QgcmVjb3JkID0gbmV3IHJvdXRlNTMuQVJlY29yZChzY29wZSwgXCJBbGlhc1JlY29yZFwiLCB7XG4gICAgcmVjb3JkTmFtZTogZG9tYWluTmFtZSxcbiAgICB6b25lOiBob3N0ZWRab25lLFxuICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgbmV3IHJvdXRlNTNUYXJnZXRzLkFwaUdhdGV3YXl2MkRvbWFpblByb3BlcnRpZXMoXG4gICAgICAgIGFwaWdEb21haW4ucmVnaW9uYWxEb21haW5OYW1lLFxuICAgICAgICBhcGlnRG9tYWluLnJlZ2lvbmFsSG9zdGVkWm9uZUlkXG4gICAgICApXG4gICAgKSxcbiAgfSk7XG4gIC8vIG5vdGU6IElmIGRvbWFpbk5hbWUgaXMgYSBUT0tFTiBzdHJpbmcgaWUuICR7VE9LRU4uLn0sIHRoZSByb3V0ZTUzLkFSZWNvcmRcbiAgLy8gICAgICAgY29uc3RydWN0IHdpbGwgYXBwZW5kIFwiLiR7aG9zdGVkWm9uZU5hbWV9XCIgdG8gdGhlIGVuZCBvZiB0aGUgZG9tYWluLlxuICAvLyAgICAgICBUaGlzIGlzIGJlY2F1c2UgdGhlIGNvbnN0cnVjdCB0cmllcyB0byBjaGVjayBpZiB0aGUgcmVjb3JkIG5hbWVcbiAgLy8gICAgICAgZW5kcyB3aXRoIHRoZSBkb21haW4gbmFtZS4gSWYgbm90LCBpdCB3aWxsIGFwcGVuZCB0aGUgZG9tYWluIG5hbWUuXG4gIC8vICAgICAgIFNvLCB3ZSBuZWVkIHJlbW92ZSB0aGlzIGJlaGF2aW9yLlxuICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgIGNvbnN0IGNmblJlY29yZCA9IHJlY29yZC5ub2RlLmRlZmF1bHRDaGlsZCBhcyByb3V0ZTUzLkNmblJlY29yZFNldDtcbiAgICBjZm5SZWNvcmQubmFtZSA9IGRvbWFpbk5hbWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gYnVpbGREb21haW5VcmwoZG9tYWluTmFtZTogc3RyaW5nLCBtYXBwaW5nS2V5Pzogc3RyaW5nKSB7XG4gIC8vIE5vdGU6IElmIG1hcHBpbmcga2V5IGlzIHNldCwgdGhlIFVSTCBuZWVkcyBhIHRyYWlsaW5nIHNsYXNoLiBXaXRob3V0IHRoZVxuICAvLyAgICAgICB0cmFpbGluZyBzbGFzaCwgdGhlIEFQSSBmYWlscyB3aXRoIHRoZSBlcnJvclxuICAvLyAgICAgICB7XCJtZXNzYWdlXCI6XCJOb3QgRm91bmRcIn1cbiAgcmV0dXJuIG1hcHBpbmdLZXkgPyBgJHtkb21haW5OYW1lfS8ke21hcHBpbmdLZXl9L2AgOiBkb21haW5OYW1lO1xufVxuXG5mdW5jdGlvbiBhc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gIGlmIChkb21haW5OYW1lICE9PSBkb21haW5OYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBkb21haW4gbmFtZSBuZWVkcyB0byBiZSBpbiBsb3dlcmNhc2VgKTtcbiAgfVxufVxuIl19