"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cleanupLogGroupName = exports.buildAccessLogData = void 0;
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const defaultHttpFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"httpMethod":"$context.httpMethod"`,
    `"path":"$context.path"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    `"responseLatency":$context.responseLatency`,
    // integration info
    `"integrationRequestId":"$context.integration.requestId"`,
    `"integrationStatus":"$context.integration.status"`,
    `"integrationLatency":"$context.integration.latency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
];
const defaultWebSocketFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"eventType":"$context.eventType"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    // integration info
    `"integrationRequestId":"$context.awsEndpointRequestId"`,
    `"integrationStatus":"$context.integrationStatus"`,
    `"integrationLatency":"$context.integrationLatency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
    `"connectedAt":"$context.connectedAt"`,
    `"connectionId":"$context.connectionId"`,
];
function buildAccessLogData(scope, accessLog, apiStage, isDefaultStage) {
    if (accessLog === false) {
        return;
    }
    const isWebSocketApi = apiStage instanceof apig.WebSocketStage;
    // note: Access log configuration is not supported by L2 constructs as of CDK v1.85.0. We
    //       need to define it at L1 construct level.
    // create log group
    let logGroup;
    let destinationArn;
    if (accessLog && accessLog.destinationArn) {
        destinationArn = accessLog.destinationArn;
    }
    else {
        const root = scope.node.root;
        const apiName = root.logicalPrefixedName(scope.node.id);
        // Backwards compatibility, only suffix if not default stage
        const logGroupName = "LogGroup" + (isDefaultStage ? "" : apiStage.stageName);
        const retention = (accessLog && accessLog.retention) || "INFINITE";
        const retentionValue = logs.RetentionDays[retention];
        // validate retention
        if (!retentionValue) {
            throw new Error(`Invalid access log retention value "${retention}".`);
        }
        logGroup = new logs.LogGroup(scope, logGroupName, {
            logGroupName: [
                `/aws/vendedlogs/apis`,
                `/${cleanupLogGroupName(apiName)}-${apiStage.api.apiId}`,
                `/${cleanupLogGroupName(apiStage.stageName)}`,
            ].join(""),
            retention: retentionValue,
        });
        destinationArn = logGroup.logGroupArn;
    }
    // get log format
    let format;
    if (accessLog && accessLog.format) {
        format = accessLog.format;
    }
    else if (typeof accessLog === "string") {
        format = accessLog;
    }
    else {
        format = isWebSocketApi
            ? "{" + defaultWebSocketFields.join(",") + "}"
            : "{" + defaultHttpFields.join(",") + "}";
    }
    // get L1 cfnStage construct
    if (!(apiStage === null || apiStage === void 0 ? void 0 : apiStage.node.defaultChild)) {
        throw new Error(`Failed to define the default stage for Http API`);
    }
    // set access log settings
    const cfnStage = apiStage.node.defaultChild;
    cfnStage.accessLogSettings = { format, destinationArn };
    return logGroup;
}
exports.buildAccessLogData = buildAccessLogData;
function cleanupLogGroupName(str) {
    return str.replace(/[^.\-_/#A-Za-z0-9]/g, "");
}
exports.cleanupLogGroupName = cleanupLogGroupName;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyQWNjZXNzTG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSwyREFBNkM7QUFFN0Msc0VBQXdEO0FBUXhELE1BQU0saUJBQWlCLEdBQUc7SUFDeEIsZUFBZTtJQUNmLHNDQUFzQztJQUN0QyxrQ0FBa0M7SUFDbEMsb0NBQW9DO0lBQ3BDLHdCQUF3QjtJQUN4QixnQ0FBZ0M7SUFDaEMsMEJBQTBCO0lBQzFCLDRDQUE0QztJQUM1QyxtQkFBbUI7SUFDbkIseURBQXlEO0lBQ3pELG1EQUFtRDtJQUNuRCxxREFBcUQ7SUFDckQscUVBQXFFO0lBQ3JFLGNBQWM7SUFDZCxtQ0FBbUM7SUFDbkMsMkNBQTJDO0lBQzNDLDJEQUEyRDtDQUM1RCxDQUFDO0FBRUYsTUFBTSxzQkFBc0IsR0FBRztJQUM3QixlQUFlO0lBQ2Ysc0NBQXNDO0lBQ3RDLGtDQUFrQztJQUNsQyxrQ0FBa0M7SUFDbEMsZ0NBQWdDO0lBQ2hDLDBCQUEwQjtJQUMxQixtQkFBbUI7SUFDbkIsd0RBQXdEO0lBQ3hELGtEQUFrRDtJQUNsRCxvREFBb0Q7SUFDcEQscUVBQXFFO0lBQ3JFLGNBQWM7SUFDZCxtQ0FBbUM7SUFDbkMsMkNBQTJDO0lBQzNDLDJEQUEyRDtJQUMzRCxzQ0FBc0M7SUFDdEMsd0NBQXdDO0NBQ3pDLENBQUM7QUFFRixTQUFnQixrQkFBa0IsQ0FDaEMsS0FBZ0IsRUFDaEIsU0FBd0QsRUFDeEQsUUFBOEMsRUFDOUMsY0FBdUI7SUFFdkIsSUFBSSxTQUFTLEtBQUssS0FBSyxFQUFFO1FBQ3ZCLE9BQU87S0FDUjtJQUVELE1BQU0sY0FBYyxHQUFHLFFBQVEsWUFBWSxJQUFJLENBQUMsY0FBYyxDQUFDO0lBRS9ELHlGQUF5RjtJQUN6RixpREFBaUQ7SUFFakQsbUJBQW1CO0lBQ25CLElBQUksUUFBUSxDQUFDO0lBQ2IsSUFBSSxjQUFjLENBQUM7SUFDbkIsSUFBSSxTQUFTLElBQUssU0FBNEIsQ0FBQyxjQUFjLEVBQUU7UUFDN0QsY0FBYyxHQUFJLFNBQTRCLENBQUMsY0FBYyxDQUFDO0tBQy9EO1NBQU07UUFDTCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN4RCw0REFBNEQ7UUFDNUQsTUFBTSxZQUFZLEdBQ2hCLFVBQVUsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUQsTUFBTSxTQUFTLEdBQ2IsQ0FBQyxTQUFTLElBQUssU0FBNEIsQ0FBQyxTQUFTLENBQUMsSUFBSSxVQUFVLENBQUM7UUFDdkUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVyRCxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxTQUFTLElBQUksQ0FBQyxDQUFDO1NBQ3ZFO1FBRUQsUUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsWUFBWSxFQUFFO1lBQ2hELFlBQVksRUFBRTtnQkFDWixzQkFBc0I7Z0JBQ3RCLElBQUksbUJBQW1CLENBQUMsT0FBTyxDQUFDLElBQUksUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3hELElBQUksbUJBQW1CLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2FBQzlDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNWLFNBQVMsRUFBRSxjQUFjO1NBQzFCLENBQUMsQ0FBQztRQUNILGNBQWMsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDO0tBQ3ZDO0lBRUQsaUJBQWlCO0lBQ2pCLElBQUksTUFBTSxDQUFDO0lBQ1gsSUFBSSxTQUFTLElBQUssU0FBNEIsQ0FBQyxNQUFNLEVBQUU7UUFDckQsTUFBTSxHQUFJLFNBQTRCLENBQUMsTUFBTSxDQUFDO0tBQy9DO1NBQU0sSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRLEVBQUU7UUFDeEMsTUFBTSxHQUFHLFNBQVMsQ0FBQztLQUNwQjtTQUFNO1FBQ0wsTUFBTSxHQUFHLGNBQWM7WUFDckIsQ0FBQyxDQUFDLEdBQUcsR0FBRyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRztZQUM5QyxDQUFDLENBQUMsR0FBRyxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7S0FDN0M7SUFFRCw0QkFBNEI7SUFDNUIsSUFBSSxDQUFDLENBQUEsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLElBQUksQ0FBQyxZQUFZLENBQUEsRUFBRTtRQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7S0FDcEU7SUFFRCwwQkFBMEI7SUFDMUIsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFnQyxDQUFDO0lBQ2hFLFFBQVEsQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQztJQUV4RCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBcEVELGdEQW9FQztBQUVELFNBQWdCLG1CQUFtQixDQUFDLEdBQVc7SUFDN0MsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ2hELENBQUM7QUFGRCxrREFFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgY2ZuQXBpZyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXl2MlwiO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1hbHBoYVwiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4uL0FwcFwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFjY2Vzc0xvZ1Byb3BzXG4gIGV4dGVuZHMgY2ZuQXBpZy5DZm5TdGFnZS5BY2Nlc3NMb2dTZXR0aW5nc1Byb3BlcnR5IHtcbiAgcmV0ZW50aW9uPzoga2V5b2YgdHlwZW9mIGxvZ3MuUmV0ZW50aW9uRGF5cztcbn1cblxuY29uc3QgZGVmYXVsdEh0dHBGaWVsZHMgPSBbXG4gIC8vIHJlcXVlc3QgaW5mb1xuICBgXCJyZXF1ZXN0VGltZVwiOlwiJGNvbnRleHQucmVxdWVzdFRpbWVcImAsXG4gIGBcInJlcXVlc3RJZFwiOlwiJGNvbnRleHQucmVxdWVzdElkXCJgLFxuICBgXCJodHRwTWV0aG9kXCI6XCIkY29udGV4dC5odHRwTWV0aG9kXCJgLFxuICBgXCJwYXRoXCI6XCIkY29udGV4dC5wYXRoXCJgLFxuICBgXCJyb3V0ZUtleVwiOlwiJGNvbnRleHQucm91dGVLZXlcImAsXG4gIGBcInN0YXR1c1wiOiRjb250ZXh0LnN0YXR1c2AsIC8vIGludGVnZXIgdmFsdWUsIGRvIG5vdCB3cmFwIGluIHF1b3Rlc1xuICBgXCJyZXNwb25zZUxhdGVuY3lcIjokY29udGV4dC5yZXNwb25zZUxhdGVuY3lgLCAvLyBpbnRlZ2VyIHZhbHVlLCBkbyBub3Qgd3JhcCBpbiBxdW90ZXNcbiAgLy8gaW50ZWdyYXRpb24gaW5mb1xuICBgXCJpbnRlZ3JhdGlvblJlcXVlc3RJZFwiOlwiJGNvbnRleHQuaW50ZWdyYXRpb24ucmVxdWVzdElkXCJgLFxuICBgXCJpbnRlZ3JhdGlvblN0YXR1c1wiOlwiJGNvbnRleHQuaW50ZWdyYXRpb24uc3RhdHVzXCJgLFxuICBgXCJpbnRlZ3JhdGlvbkxhdGVuY3lcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLmxhdGVuY3lcImAsXG4gIGBcImludGVncmF0aW9uU2VydmljZVN0YXR1c1wiOlwiJGNvbnRleHQuaW50ZWdyYXRpb24uaW50ZWdyYXRpb25TdGF0dXNcImAsXG4gIC8vIGNhbGxlciBpbmZvXG4gIGBcImlwXCI6XCIkY29udGV4dC5pZGVudGl0eS5zb3VyY2VJcFwiYCxcbiAgYFwidXNlckFnZW50XCI6XCIkY29udGV4dC5pZGVudGl0eS51c2VyQWdlbnRcImAsXG4gIGBcImNvZ25pdG9JZGVudGl0eUlkXCI6XCIkY29udGV4dC5pZGVudGl0eS5jb2duaXRvSWRlbnRpdHlJZFwiYCxcbl07XG5cbmNvbnN0IGRlZmF1bHRXZWJTb2NrZXRGaWVsZHMgPSBbXG4gIC8vIHJlcXVlc3QgaW5mb1xuICBgXCJyZXF1ZXN0VGltZVwiOlwiJGNvbnRleHQucmVxdWVzdFRpbWVcImAsXG4gIGBcInJlcXVlc3RJZFwiOlwiJGNvbnRleHQucmVxdWVzdElkXCJgLFxuICBgXCJldmVudFR5cGVcIjpcIiRjb250ZXh0LmV2ZW50VHlwZVwiYCxcbiAgYFwicm91dGVLZXlcIjpcIiRjb250ZXh0LnJvdXRlS2V5XCJgLFxuICBgXCJzdGF0dXNcIjokY29udGV4dC5zdGF0dXNgLCAvLyBpbnRlZ2VyIHZhbHVlLCBkbyBub3Qgd3JhcCBpbiBxdW90ZXNcbiAgLy8gaW50ZWdyYXRpb24gaW5mb1xuICBgXCJpbnRlZ3JhdGlvblJlcXVlc3RJZFwiOlwiJGNvbnRleHQuYXdzRW5kcG9pbnRSZXF1ZXN0SWRcImAsXG4gIGBcImludGVncmF0aW9uU3RhdHVzXCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvblN0YXR1c1wiYCxcbiAgYFwiaW50ZWdyYXRpb25MYXRlbmN5XCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvbkxhdGVuY3lcImAsXG4gIGBcImludGVncmF0aW9uU2VydmljZVN0YXR1c1wiOlwiJGNvbnRleHQuaW50ZWdyYXRpb24uaW50ZWdyYXRpb25TdGF0dXNcImAsXG4gIC8vIGNhbGxlciBpbmZvXG4gIGBcImlwXCI6XCIkY29udGV4dC5pZGVudGl0eS5zb3VyY2VJcFwiYCxcbiAgYFwidXNlckFnZW50XCI6XCIkY29udGV4dC5pZGVudGl0eS51c2VyQWdlbnRcImAsXG4gIGBcImNvZ25pdG9JZGVudGl0eUlkXCI6XCIkY29udGV4dC5pZGVudGl0eS5jb2duaXRvSWRlbnRpdHlJZFwiYCxcbiAgYFwiY29ubmVjdGVkQXRcIjpcIiRjb250ZXh0LmNvbm5lY3RlZEF0XCJgLFxuICBgXCJjb25uZWN0aW9uSWRcIjpcIiRjb250ZXh0LmNvbm5lY3Rpb25JZFwiYCxcbl07XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZEFjY2Vzc0xvZ0RhdGEoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGFjY2Vzc0xvZzogYm9vbGVhbiB8IHN0cmluZyB8IEFjY2Vzc0xvZ1Byb3BzIHwgdW5kZWZpbmVkLFxuICBhcGlTdGFnZTogYXBpZy5XZWJTb2NrZXRTdGFnZSB8IGFwaWcuSHR0cFN0YWdlLFxuICBpc0RlZmF1bHRTdGFnZTogYm9vbGVhblxuKTogbG9ncy5Mb2dHcm91cCB8IHVuZGVmaW5lZCB7XG4gIGlmIChhY2Nlc3NMb2cgPT09IGZhbHNlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgaXNXZWJTb2NrZXRBcGkgPSBhcGlTdGFnZSBpbnN0YW5jZW9mIGFwaWcuV2ViU29ja2V0U3RhZ2U7XG5cbiAgLy8gbm90ZTogQWNjZXNzIGxvZyBjb25maWd1cmF0aW9uIGlzIG5vdCBzdXBwb3J0ZWQgYnkgTDIgY29uc3RydWN0cyBhcyBvZiBDREsgdjEuODUuMC4gV2VcbiAgLy8gICAgICAgbmVlZCB0byBkZWZpbmUgaXQgYXQgTDEgY29uc3RydWN0IGxldmVsLlxuXG4gIC8vIGNyZWF0ZSBsb2cgZ3JvdXBcbiAgbGV0IGxvZ0dyb3VwO1xuICBsZXQgZGVzdGluYXRpb25Bcm47XG4gIGlmIChhY2Nlc3NMb2cgJiYgKGFjY2Vzc0xvZyBhcyBBY2Nlc3NMb2dQcm9wcykuZGVzdGluYXRpb25Bcm4pIHtcbiAgICBkZXN0aW5hdGlvbkFybiA9IChhY2Nlc3NMb2cgYXMgQWNjZXNzTG9nUHJvcHMpLmRlc3RpbmF0aW9uQXJuO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IGFwaU5hbWUgPSByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoc2NvcGUubm9kZS5pZCk7XG4gICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHksIG9ubHkgc3VmZml4IGlmIG5vdCBkZWZhdWx0IHN0YWdlXG4gICAgY29uc3QgbG9nR3JvdXBOYW1lID1cbiAgICAgIFwiTG9nR3JvdXBcIiArIChpc0RlZmF1bHRTdGFnZSA/IFwiXCIgOiBhcGlTdGFnZS5zdGFnZU5hbWUpO1xuICAgIGNvbnN0IHJldGVudGlvbiA9XG4gICAgICAoYWNjZXNzTG9nICYmIChhY2Nlc3NMb2cgYXMgQWNjZXNzTG9nUHJvcHMpLnJldGVudGlvbikgfHwgXCJJTkZJTklURVwiO1xuICAgIGNvbnN0IHJldGVudGlvblZhbHVlID0gbG9ncy5SZXRlbnRpb25EYXlzW3JldGVudGlvbl07XG5cbiAgICAvLyB2YWxpZGF0ZSByZXRlbnRpb25cbiAgICBpZiAoIXJldGVudGlvblZhbHVlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYWNjZXNzIGxvZyByZXRlbnRpb24gdmFsdWUgXCIke3JldGVudGlvbn1cIi5gKTtcbiAgICB9XG5cbiAgICBsb2dHcm91cCA9IG5ldyBsb2dzLkxvZ0dyb3VwKHNjb3BlLCBsb2dHcm91cE5hbWUsIHtcbiAgICAgIGxvZ0dyb3VwTmFtZTogW1xuICAgICAgICBgL2F3cy92ZW5kZWRsb2dzL2FwaXNgLFxuICAgICAgICBgLyR7Y2xlYW51cExvZ0dyb3VwTmFtZShhcGlOYW1lKX0tJHthcGlTdGFnZS5hcGkuYXBpSWR9YCxcbiAgICAgICAgYC8ke2NsZWFudXBMb2dHcm91cE5hbWUoYXBpU3RhZ2Uuc3RhZ2VOYW1lKX1gLFxuICAgICAgXS5qb2luKFwiXCIpLFxuICAgICAgcmV0ZW50aW9uOiByZXRlbnRpb25WYWx1ZSxcbiAgICB9KTtcbiAgICBkZXN0aW5hdGlvbkFybiA9IGxvZ0dyb3VwLmxvZ0dyb3VwQXJuO1xuICB9XG5cbiAgLy8gZ2V0IGxvZyBmb3JtYXRcbiAgbGV0IGZvcm1hdDtcbiAgaWYgKGFjY2Vzc0xvZyAmJiAoYWNjZXNzTG9nIGFzIEFjY2Vzc0xvZ1Byb3BzKS5mb3JtYXQpIHtcbiAgICBmb3JtYXQgPSAoYWNjZXNzTG9nIGFzIEFjY2Vzc0xvZ1Byb3BzKS5mb3JtYXQ7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGFjY2Vzc0xvZyA9PT0gXCJzdHJpbmdcIikge1xuICAgIGZvcm1hdCA9IGFjY2Vzc0xvZztcbiAgfSBlbHNlIHtcbiAgICBmb3JtYXQgPSBpc1dlYlNvY2tldEFwaVxuICAgICAgPyBcIntcIiArIGRlZmF1bHRXZWJTb2NrZXRGaWVsZHMuam9pbihcIixcIikgKyBcIn1cIlxuICAgICAgOiBcIntcIiArIGRlZmF1bHRIdHRwRmllbGRzLmpvaW4oXCIsXCIpICsgXCJ9XCI7XG4gIH1cblxuICAvLyBnZXQgTDEgY2ZuU3RhZ2UgY29uc3RydWN0XG4gIGlmICghYXBpU3RhZ2U/Lm5vZGUuZGVmYXVsdENoaWxkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZGVmaW5lIHRoZSBkZWZhdWx0IHN0YWdlIGZvciBIdHRwIEFQSWApO1xuICB9XG5cbiAgLy8gc2V0IGFjY2VzcyBsb2cgc2V0dGluZ3NcbiAgY29uc3QgY2ZuU3RhZ2UgPSBhcGlTdGFnZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBjZm5BcGlnLkNmblN0YWdlO1xuICBjZm5TdGFnZS5hY2Nlc3NMb2dTZXR0aW5ncyA9IHsgZm9ybWF0LCBkZXN0aW5hdGlvbkFybiB9O1xuXG4gIHJldHVybiBsb2dHcm91cDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFudXBMb2dHcm91cE5hbWUoc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gc3RyLnJlcGxhY2UoL1teLlxcLV8vI0EtWmEtejAtOV0vZywgXCJcIik7XG59XG4iXX0=