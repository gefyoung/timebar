"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment*/
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.attachPermissionsToRole = exports.PermissionType = void 0;
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const core_1 = require("@serverless-stack/core");
const index_1 = require("../index");
const Construct_1 = require("../Construct");
const logger = core_1.getChildLogger("resources");
var PermissionType;
(function (PermissionType) {
    PermissionType["ALL"] = "*";
})(PermissionType = exports.PermissionType || (exports.PermissionType = {}));
function attachPermissionsToRole(role, permissions) {
    // Four patterns
    //
    // attachPermissions(PermissionType.ALL);
    // attachPermissions([ 'sns', 'sqs' ]);
    // attachPermissions([ event, queue ]);
    // attachPermissions([
    //   [ event.snsTopic, 'grantPublish' ],
    //   [ queue.sqsQueue, 'grantSendMessages' ],
    // ]);
    // attachPermissions([
    //   new iam.PolicyStatement({
    //     actions: ["s3:*"],
    //     effect: iam.Effect.ALLOW,
    //     resources: [
    //       bucket.bucketArn + "/private/${cognito-identity.amazonaws.com:sub}/*",
    //     ],
    //   })
    // ]);
    ////////////////////////////////////
    // Case: 'admin' permissions => '*'
    ////////////////////////////////////
    if (typeof permissions === "string") {
        if (permissions === PermissionType.ALL) {
            role.addToPolicy(buildPolicy(permissions, ["*"]));
        }
        else {
            throw new Error(`The specified permissions are not supported.`);
        }
        return;
    }
    if (!Array.isArray(permissions)) {
        throw new Error(`The specified permissions are not supported. They are expected to be PermissionType.ALL or an array.`);
    }
    // Handle array of permissions
    permissions.forEach((permission) => {
        ////////////////////////////////////
        // Case: string ie. 's3' or 's3:*'
        ////////////////////////////////////
        if (typeof permission === "string") {
            const perm = permission.indexOf(":") === -1 ? `${permission}:*` : permission;
            role.addToPolicy(buildPolicy(perm, ["*"]));
        }
        ////////////////////////////////////
        // Case: iam.PolicyStatement
        ////////////////////////////////////
        else if (Construct_1.isCDKConstructOf(permission, "aws-cdk-lib.aws_iam.PolicyStatement")) {
            role.addToPolicy(permission);
        }
        ////////////////////////////////////
        // Case: CDK constructs
        ////////////////////////////////////
        else if (permission.tableArn && permission.tableName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const tableArn = permission.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission.topicArn && permission.topicName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sns:*", [permission.topicArn]));
        }
        else if (permission.queueArn && permission.queueName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sqs:*", [permission.queueArn]));
        }
        else if (permission.eventBusArn &&
            permission.eventBusName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("events:*", [permission.eventBusArn]));
        }
        else if (permission.streamArn &&
            permission.streamName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("kinesis:*", [permission.streamArn]));
        }
        else if (permission.deliveryStreamArn &&
            permission.deliveryStreamName) {
            role.addToPolicy(buildPolicy("firehose:*", [permission.deliveryStreamArn]));
        }
        else if (permission.bucketArn &&
            permission.bucketName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const bucketArn = permission.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if (permission.clusterArn) {
            // For ServerlessCluster, we need to grant:
            // - permisssions to access the Data API;
            // - permisssions to access the Secret Manager (required by Data API).
            // No need to grant the permissions for IAM database authentication
            role.addToPolicy(buildPolicy("rds-data:*", [permission.clusterArn]));
            const secret = permission.secret;
            if (secret) {
                role.addToPolicy(buildPolicy(["secretsmanager:GetSecretValue", "secretsmanager:DescribeSecret"], [secret.secretArn]));
            }
        }
        ////////////////////////////////////
        // Case: SST construct
        ////////////////////////////////////
        else if (permission instanceof index_1.Api) {
            const httpApi = permission.httpApi;
            const { account, region } = index_1.Stack.of(httpApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${httpApi.httpApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.ApiGatewayV1Api) {
            const restApi = permission.restApi;
            const { account, region } = index_1.Stack.of(restApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${restApi.restApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.WebSocketApi) {
            const webSocketApi = permission.webSocketApi;
            const { account, region } = index_1.Stack.of(webSocketApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${webSocketApi.apiId}/*`,
            ]));
            role.addToPolicy(buildPolicy("execute-api:ManageConnections", [
                permission._connectionsArn,
            ]));
        }
        else if (permission instanceof index_1.AppSyncApi) {
            const graphqlApi = permission.graphqlApi;
            const { account, region } = index_1.Stack.of(graphqlApi);
            role.addToPolicy(buildPolicy("appsync:GraphQL", [
                `arn:aws:appsync:${region}:${account}:apis/${graphqlApi.apiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.Table) {
            const tableArn = permission.dynamodbTable.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission instanceof index_1.Topic) {
            role.addToPolicy(buildPolicy("sns:*", [permission.snsTopic.topicArn]));
        }
        else if (permission instanceof index_1.Queue) {
            role.addToPolicy(buildPolicy("sqs:*", [permission.sqsQueue.queueArn]));
        }
        else if (permission instanceof index_1.EventBus) {
            role.addToPolicy(buildPolicy("events:*", [permission.eventBridgeEventBus.eventBusArn]));
        }
        else if (permission instanceof index_1.KinesisStream) {
            role.addToPolicy(buildPolicy("kinesis:*", [permission.kinesisStream.streamArn]));
        }
        else if (permission instanceof index_1.Bucket) {
            const bucketArn = permission.s3Bucket.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if (permission instanceof index_1.RDS) {
            role.addToPolicy(buildPolicy("rds-data:*", [permission.clusterArn]));
            if (permission.rdsServerlessCluster.secret) {
                role.addToPolicy(buildPolicy(["secretsmanager:GetSecretValue", "secretsmanager:DescribeSecret"], [permission.rdsServerlessCluster.secret.secretArn]));
            }
        }
        else if (permission instanceof index_1.Function) {
            role.addToPolicy(buildPolicy("lambda:*", [permission.functionArn]));
        }
        ////////////////////////////////////
        // Case: grant method
        ////////////////////////////////////
        else if (Array.isArray(permission) &&
            permission.length === 2 &&
            Construct_1.isCDKConstruct(permission[0]) &&
            typeof permission[1] === "string") {
            const construct = permission[0];
            const methodName = permission[1];
            if (typeof construct[methodName] !== "function")
                throw new Error(`The specified grant method is incorrect.
          Check the available methods that prefixed with grants on the Construct`);
            construct[methodName](role);
        }
        else {
            logger.debug("permission object", permission);
            throw new Error(`The specified permissions are not supported.`);
        }
    });
}
exports.attachPermissionsToRole = attachPermissionsToRole;
function buildPolicy(actions, resources) {
    return new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: typeof actions === "string" ? [actions] : actions,
        resources,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3Blcm1pc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUdyRCx5REFBMkM7QUFDM0MsaURBQXdEO0FBQ3hELG9DQWNrQjtBQUNsQiw0Q0FBZ0U7QUFFaEUsTUFBTSxNQUFNLEdBQUcscUJBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQVMzQyxJQUFZLGNBRVg7QUFGRCxXQUFZLGNBQWM7SUFDeEIsMkJBQVMsQ0FBQTtBQUNYLENBQUMsRUFGVyxjQUFjLEdBQWQsc0JBQWMsS0FBZCxzQkFBYyxRQUV6QjtBQUVELFNBQWdCLHVCQUF1QixDQUNyQyxJQUFjLEVBQ2QsV0FBd0I7SUFFeEIsZ0JBQWdCO0lBQ2hCLEVBQUU7SUFDRix5Q0FBeUM7SUFDekMsdUNBQXVDO0lBQ3ZDLHVDQUF1QztJQUN2QyxzQkFBc0I7SUFDdEIsd0NBQXdDO0lBQ3hDLDZDQUE2QztJQUM3QyxNQUFNO0lBQ04sc0JBQXNCO0lBQ3RCLDhCQUE4QjtJQUM5Qix5QkFBeUI7SUFDekIsZ0NBQWdDO0lBQ2hDLG1CQUFtQjtJQUNuQiwrRUFBK0U7SUFDL0UsU0FBUztJQUNULE9BQU87SUFDUCxNQUFNO0lBRU4sb0NBQW9DO0lBQ3BDLG1DQUFtQztJQUNuQyxvQ0FBb0M7SUFDcEMsSUFBSSxPQUFPLFdBQVcsS0FBSyxRQUFRLEVBQUU7UUFDbkMsSUFBSSxXQUFXLEtBQUssY0FBYyxDQUFDLEdBQUcsRUFBRTtZQUN0QyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkQ7YUFBTTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQztTQUNqRTtRQUNELE9BQU87S0FDUjtJQUVELElBQUksQ0FBQyxLQUFLLENBQUMsT0FB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TyxFQUFFLE9BQU8sT0FBTyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTztRQUMxRCxTQUFTO0tBQ1YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudCovXG5cbmltcG9ydCB7IENvbnN0cnVjdCwgSUNvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB7IGdldENoaWxkTG9nZ2VyIH0gZnJvbSBcIkBzZXJ2ZXJsZXNzLXN0YWNrL2NvcmVcIjtcbmltcG9ydCB7XG4gIEFwaSxcbiAgUkRTLFxuICBUYWJsZSxcbiAgVG9waWMsXG4gIFF1ZXVlLFxuICBCdWNrZXQsXG4gIEV2ZW50QnVzLFxuICBGdW5jdGlvbixcbiAgQXBwU3luY0FwaSxcbiAgV2ViU29ja2V0QXBpLFxuICBLaW5lc2lzU3RyZWFtLFxuICBBcGlHYXRld2F5VjFBcGksXG4gIFN0YWNrLFxufSBmcm9tIFwiLi4vaW5kZXhcIjtcbmltcG9ydCB7IGlzQ0RLQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdE9mIH0gZnJvbSBcIi4uL0NvbnN0cnVjdFwiO1xuXG5jb25zdCBsb2dnZXIgPSBnZXRDaGlsZExvZ2dlcihcInJlc291cmNlc1wiKTtcblxuZXhwb3J0IHR5cGUgUGVybWlzc2lvbnMgPSBQZXJtaXNzaW9uVHlwZSB8IFBlcm1pc3Npb25bXTtcbnR5cGUgUGVybWlzc2lvbiA9XG4gIHwgc3RyaW5nXG4gIHwgSUNvbnN0cnVjdFxuICB8IFtJQ29uc3RydWN0LCBzdHJpbmddXG4gIHwgaWFtLlBvbGljeVN0YXRlbWVudDtcblxuZXhwb3J0IGVudW0gUGVybWlzc2lvblR5cGUge1xuICBBTEwgPSBcIipcIixcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKFxuICByb2xlOiBpYW0uUm9sZSxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4pOiB2b2lkIHtcbiAgLy8gRm91ciBwYXR0ZXJuc1xuICAvL1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhQZXJtaXNzaW9uVHlwZS5BTEwpO1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhbICdzbnMnLCAnc3FzJyBdKTtcbiAgLy8gYXR0YWNoUGVybWlzc2lvbnMoWyBldmVudCwgcXVldWUgXSk7XG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFtcbiAgLy8gICBbIGV2ZW50LnNuc1RvcGljLCAnZ3JhbnRQdWJsaXNoJyBdLFxuICAvLyAgIFsgcXVldWUuc3FzUXVldWUsICdncmFudFNlbmRNZXNzYWdlcycgXSxcbiAgLy8gXSk7XG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFtcbiAgLy8gICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gIC8vICAgICBhY3Rpb25zOiBbXCJzMzoqXCJdLFxuICAvLyAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAvLyAgICAgcmVzb3VyY2VzOiBbXG4gIC8vICAgICAgIGJ1Y2tldC5idWNrZXRBcm4gKyBcIi9wcml2YXRlLyR7Y29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOnN1Yn0vKlwiLFxuICAvLyAgICAgXSxcbiAgLy8gICB9KVxuICAvLyBdKTtcblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gQ2FzZTogJ2FkbWluJyBwZXJtaXNzaW9ucyA9PiAnKidcbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIGlmICh0eXBlb2YgcGVybWlzc2lvbnMgPT09IFwic3RyaW5nXCIpIHtcbiAgICBpZiAocGVybWlzc2lvbnMgPT09IFBlcm1pc3Npb25UeXBlLkFMTCkge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShwZXJtaXNzaW9ucywgW1wiKlwiXSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzcGVjaWZpZWQgcGVybWlzc2lvbnMgYXJlIG5vdCBzdXBwb3J0ZWQuYCk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghQXJyYXkuaXNBcnJheShwZXJtaXNzaW9ucykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIHNwZWNpZmllZCBwZXJtaXNzaW9ucyBhcmUgbm90IHN1cHBvcnRlZC4gVGhleSBhcmUgZXhwZWN0ZWQgdG8gYmUgUGVybWlzc2lvblR5cGUuQUxMIG9yIGFuIGFycmF5LmBcbiAgICApO1xuICB9XG5cbiAgLy8gSGFuZGxlIGFycmF5IG9mIHBlcm1pc3Npb25zXG4gIHBlcm1pc3Npb25zLmZvckVhY2goKHBlcm1pc3Npb246IFBlcm1pc3Npb24pID0+IHtcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBzdHJpbmcgaWUuICdzMycgb3IgJ3MzOionXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKHR5cGVvZiBwZXJtaXNzaW9uID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb25zdCBwZXJtID1cbiAgICAgICAgcGVybWlzc2lvbi5pbmRleE9mKFwiOlwiKSA9PT0gLTEgPyBgJHtwZXJtaXNzaW9ufToqYCA6IHBlcm1pc3Npb247XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KHBlcm0sIFtcIipcIl0pKTtcbiAgICB9XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ2FzZTogaWFtLlBvbGljeVN0YXRlbWVudFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGVsc2UgaWYgKFxuICAgICAgaXNDREtDb25zdHJ1Y3RPZihcbiAgICAgICAgcGVybWlzc2lvbiBhcyBDb25zdHJ1Y3QsXG4gICAgICAgIFwiYXdzLWNkay1saWIuYXdzX2lhbS5Qb2xpY3lTdGF0ZW1lbnRcIlxuICAgICAgKVxuICAgICkge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShwZXJtaXNzaW9uIGFzIGlhbS5Qb2xpY3lTdGF0ZW1lbnQpO1xuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBDREsgY29uc3RydWN0c1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGVsc2UgaWYgKChwZXJtaXNzaW9uIGFzIGFueSkudGFibGVBcm4gJiYgKHBlcm1pc3Npb24gYXMgYW55KS50YWJsZU5hbWUpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgY29uc3QgdGFibGVBcm4gPSBwZXJtaXNzaW9uLnRhYmxlQXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImR5bmFtb2RiOipcIiwgW3RhYmxlQXJuLCBgJHt0YWJsZUFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmICgocGVybWlzc2lvbiBhcyBhbnkpLnRvcGljQXJuICYmIChwZXJtaXNzaW9uIGFzIGFueSkudG9waWNOYW1lKSB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFdlIGRvIG5vdCB3YW50IHRvIGltcG9ydCB0aGUgY2RrIG1vZHVsZXMsIGp1c3QgY2FzdCB0byBhbnlcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzbnM6KlwiLCBbcGVybWlzc2lvbi50b3BpY0Fybl0pKTtcbiAgICB9IGVsc2UgaWYgKChwZXJtaXNzaW9uIGFzIGFueSkucXVldWVBcm4gJiYgKHBlcm1pc3Npb24gYXMgYW55KS5xdWV1ZU5hbWUpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNxczoqXCIsIFtwZXJtaXNzaW9uLnF1ZXVlQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICAocGVybWlzc2lvbiBhcyBhbnkpLmV2ZW50QnVzQXJuICYmXG4gICAgICAocGVybWlzc2lvbiBhcyBhbnkpLmV2ZW50QnVzTmFtZVxuICAgICkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwiZXZlbnRzOipcIiwgW3Blcm1pc3Npb24uZXZlbnRCdXNBcm5dKSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuc3RyZWFtQXJuICYmXG4gICAgICAocGVybWlzc2lvbiBhcyBhbnkpLnN0cmVhbU5hbWVcbiAgICApIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImtpbmVzaXM6KlwiLCBbcGVybWlzc2lvbi5zdHJlYW1Bcm5dKSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuZGVsaXZlcnlTdHJlYW1Bcm4gJiZcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuZGVsaXZlcnlTdHJlYW1OYW1lXG4gICAgKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImZpcmVob3NlOipcIiwgWyhwZXJtaXNzaW9uIGFzIGFueSkuZGVsaXZlcnlTdHJlYW1Bcm5dKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgKHBlcm1pc3Npb24gYXMgYW55KS5idWNrZXRBcm4gJiZcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuYnVja2V0TmFtZVxuICAgICkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICBjb25zdCBidWNrZXRBcm4gPSBwZXJtaXNzaW9uLmJ1Y2tldEFybjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzMzoqXCIsIFtidWNrZXRBcm4sIGAke2J1Y2tldEFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmICgocGVybWlzc2lvbiBhcyBhbnkpLmNsdXN0ZXJBcm4pIHtcbiAgICAgIC8vIEZvciBTZXJ2ZXJsZXNzQ2x1c3Rlciwgd2UgbmVlZCB0byBncmFudDpcbiAgICAgIC8vIC0gcGVybWlzc3Npb25zIHRvIGFjY2VzcyB0aGUgRGF0YSBBUEk7XG4gICAgICAvLyAtIHBlcm1pc3NzaW9ucyB0byBhY2Nlc3MgdGhlIFNlY3JldCBNYW5hZ2VyIChyZXF1aXJlZCBieSBEYXRhIEFQSSkuXG4gICAgICAvLyBObyBuZWVkIHRvIGdyYW50IHRoZSBwZXJtaXNzaW9ucyBmb3IgSUFNIGRhdGFiYXNlIGF1dGhlbnRpY2F0aW9uXG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwicmRzLWRhdGE6KlwiLCBbKHBlcm1pc3Npb24gYXMgYW55KS5jbHVzdGVyQXJuXSkpO1xuICAgICAgY29uc3Qgc2VjcmV0ID0gKHBlcm1pc3Npb24gYXMgYW55KS5zZWNyZXQ7XG4gICAgICBpZiAoc2VjcmV0KSB7XG4gICAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgYnVpbGRQb2xpY3koW1wic2VjcmV0c21hbmFnZXI6R2V0U2VjcmV0VmFsdWVcIiwgXCJzZWNyZXRzbWFuYWdlcjpEZXNjcmliZVNlY3JldFwiXSwgW3NlY3JldC5zZWNyZXRBcm5dKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBTU1QgY29uc3RydWN0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEFwaSkge1xuICAgICAgY29uc3QgaHR0cEFwaSA9IHBlcm1pc3Npb24uaHR0cEFwaTtcbiAgICAgIGNvbnN0IHsgYWNjb3VudCwgcmVnaW9uIH0gPSBTdGFjay5vZihodHRwQXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6SW52b2tlXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3JlZ2lvbn06JHthY2NvdW50fToke2h0dHBBcGkuaHR0cEFwaUlkfS8qYCxcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQXBpR2F0ZXdheVYxQXBpKSB7XG4gICAgICBjb25zdCByZXN0QXBpID0gcGVybWlzc2lvbi5yZXN0QXBpO1xuICAgICAgY29uc3QgeyBhY2NvdW50LCByZWdpb24gfSA9IFN0YWNrLm9mKHJlc3RBcGkpO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJleGVjdXRlLWFwaTpJbnZva2VcIiwgW1xuICAgICAgICAgIGBhcm46YXdzOmV4ZWN1dGUtYXBpOiR7cmVnaW9ufToke2FjY291bnR9OiR7cmVzdEFwaS5yZXN0QXBpSWR9LypgLFxuICAgICAgICBdKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBXZWJTb2NrZXRBcGkpIHtcbiAgICAgIGNvbnN0IHdlYlNvY2tldEFwaSA9IHBlcm1pc3Npb24ud2ViU29ja2V0QXBpO1xuICAgICAgY29uc3QgeyBhY2NvdW50LCByZWdpb24gfSA9IFN0YWNrLm9mKHdlYlNvY2tldEFwaSk7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImV4ZWN1dGUtYXBpOkludm9rZVwiLCBbXG4gICAgICAgICAgYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHtyZWdpb259OiR7YWNjb3VudH06JHt3ZWJTb2NrZXRBcGkuYXBpSWR9LypgLFxuICAgICAgICBdKVxuICAgICAgKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6TWFuYWdlQ29ubmVjdGlvbnNcIiwgW1xuICAgICAgICAgIHBlcm1pc3Npb24uX2Nvbm5lY3Rpb25zQXJuLFxuICAgICAgICBdKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBBcHBTeW5jQXBpKSB7XG4gICAgICBjb25zdCBncmFwaHFsQXBpID0gcGVybWlzc2lvbi5ncmFwaHFsQXBpO1xuICAgICAgY29uc3QgeyBhY2NvdW50LCByZWdpb24gfSA9IFN0YWNrLm9mKGdyYXBocWxBcGkpO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJhcHBzeW5jOkdyYXBoUUxcIiwgW1xuICAgICAgICAgIGBhcm46YXdzOmFwcHN5bmM6JHtyZWdpb259OiR7YWNjb3VudH06YXBpcy8ke2dyYXBocWxBcGkuYXBpSWR9LypgLFxuICAgICAgICBdKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBUYWJsZSkge1xuICAgICAgY29uc3QgdGFibGVBcm4gPSBwZXJtaXNzaW9uLmR5bmFtb2RiVGFibGUudGFibGVBcm47XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwiZHluYW1vZGI6KlwiLCBbdGFibGVBcm4sIGAke3RhYmxlQXJufS8qYF0pKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBUb3BpYykge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNuczoqXCIsIFtwZXJtaXNzaW9uLnNuc1RvcGljLnRvcGljQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFF1ZXVlKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwic3FzOipcIiwgW3Blcm1pc3Npb24uc3FzUXVldWUucXVldWVBcm5dKSk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgRXZlbnRCdXMpIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXZlbnRzOipcIiwgW3Blcm1pc3Npb24uZXZlbnRCcmlkZ2VFdmVudEJ1cy5ldmVudEJ1c0Fybl0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEtpbmVzaXNTdHJlYW0pIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwia2luZXNpczoqXCIsIFtwZXJtaXNzaW9uLmtpbmVzaXNTdHJlYW0uc3RyZWFtQXJuXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQnVja2V0KSB7XG4gICAgICBjb25zdCBidWNrZXRBcm4gPSBwZXJtaXNzaW9uLnMzQnVja2V0LmJ1Y2tldEFybjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzMzoqXCIsIFtidWNrZXRBcm4sIGAke2J1Y2tldEFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgUkRTKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwicmRzLWRhdGE6KlwiLCBbcGVybWlzc2lvbi5jbHVzdGVyQXJuXSkpO1xuICAgICAgaWYgKHBlcm1pc3Npb24ucmRzU2VydmVybGVzc0NsdXN0ZXIuc2VjcmV0KSB7XG4gICAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgYnVpbGRQb2xpY3koW1wic2VjcmV0c21hbmFnZXI6R2V0U2VjcmV0VmFsdWVcIiwgXCJzZWNyZXRzbWFuYWdlcjpEZXNjcmliZVNlY3JldFwiXSwgW3Blcm1pc3Npb24ucmRzU2VydmVybGVzc0NsdXN0ZXIuc2VjcmV0LnNlY3JldEFybl0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgRnVuY3Rpb24pIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJsYW1iZGE6KlwiLCBbcGVybWlzc2lvbi5mdW5jdGlvbkFybl0pKTtcbiAgICB9XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ2FzZTogZ3JhbnQgbWV0aG9kXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgZWxzZSBpZiAoXG4gICAgICBBcnJheS5pc0FycmF5KHBlcm1pc3Npb24pICYmXG4gICAgICBwZXJtaXNzaW9uLmxlbmd0aCA9PT0gMiAmJlxuICAgICAgaXNDREtDb25zdHJ1Y3QocGVybWlzc2lvblswXSkgJiZcbiAgICAgIHR5cGVvZiBwZXJtaXNzaW9uWzFdID09PSBcInN0cmluZ1wiXG4gICAgKSB7XG4gICAgICBjb25zdCBjb25zdHJ1Y3QgPSBwZXJtaXNzaW9uWzBdIGFzIENvbnN0cnVjdDtcbiAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBwZXJtaXNzaW9uWzFdIGFzIGtleW9mIENvbnN0cnVjdDtcbiAgICAgIGlmICh0eXBlb2YgY29uc3RydWN0W21ldGhvZE5hbWVdICE9PSBcImZ1bmN0aW9uXCIpXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlIHNwZWNpZmllZCBncmFudCBtZXRob2QgaXMgaW5jb3JyZWN0LlxuICAgICAgICAgIENoZWNrIHRoZSBhdmFpbGFibGUgbWV0aG9kcyB0aGF0IHByZWZpeGVkIHdpdGggZ3JhbnRzIG9uIHRoZSBDb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICAoY29uc3RydWN0W21ldGhvZE5hbWVdIGFzIHsgKGNvbnN0cnVjdDogQ29uc3RydWN0KTogdm9pZCB9KShyb2xlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwicGVybWlzc2lvbiBvYmplY3RcIiwgcGVybWlzc2lvbik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzcGVjaWZpZWQgcGVybWlzc2lvbnMgYXJlIG5vdCBzdXBwb3J0ZWQuYCk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gYnVpbGRQb2xpY3koYWN0aW9uczogc3RyaW5nIHwgc3RyaW5nW10sIHJlc291cmNlczogc3RyaW5nW10pOiBpYW0uUG9saWN5U3RhdGVtZW50IHtcbiAgcmV0dXJuIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgYWN0aW9uczogdHlwZW9mIGFjdGlvbnMgPT09IFwic3RyaW5nXCIgPyBbYWN0aW9uc10gOiBhY3Rpb25zLFxuICAgIHJlc291cmNlcyxcbiAgfSk7XG59Il19