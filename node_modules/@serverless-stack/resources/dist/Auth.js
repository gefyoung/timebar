"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Auth = void 0;
const constructs_1 = require("constructs");
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const cognito = __importStar(require("aws-cdk-lib/aws-cognito"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const permission_1 = require("./util/permission");
const AuthUserPoolTriggerOperationMapping = {
    createAuthChallenge: cognito.UserPoolOperation.CREATE_AUTH_CHALLENGE,
    customMessage: cognito.UserPoolOperation.CUSTOM_MESSAGE,
    defineAuthChallenge: cognito.UserPoolOperation.DEFINE_AUTH_CHALLENGE,
    postAuthentication: cognito.UserPoolOperation.POST_AUTHENTICATION,
    postConfirmation: cognito.UserPoolOperation.POST_CONFIRMATION,
    preAuthentication: cognito.UserPoolOperation.PRE_AUTHENTICATION,
    preSignUp: cognito.UserPoolOperation.PRE_SIGN_UP,
    preTokenGeneration: cognito.UserPoolOperation.PRE_TOKEN_GENERATION,
    userMigration: cognito.UserPoolOperation.USER_MIGRATION,
    verifyAuthChallengeResponse: cognito.UserPoolOperation.VERIFY_AUTH_CHALLENGE_RESPONSE,
};
class Auth extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Handle deprecated props
        this.checkDeprecatedProps(props);
        const root = scope.node.root;
        const { cognito: cognitoProps, auth0, amazon, apple, facebook, google, twitter, identityPool, } = props;
        this.functions = {};
        this.permissionsAttachedForAllTriggers = [];
        ////////////////////
        // Handle Cognito Identity Providers (ie. User Pool)
        ////////////////////
        const cognitoIdentityProviders = [];
        if (cognitoProps) {
            let isUserPoolImported = false;
            // Create User Pool
            if (typeof cognitoProps === "boolean") {
                this.cognitoUserPool = new cognito.UserPool(this, "UserPool", {
                    userPoolName: root.logicalPrefixedName(id),
                    selfSignUpEnabled: true,
                    signInCaseSensitive: false,
                });
            }
            else if (Construct_1.isCDKConstruct(cognitoProps.userPool)) {
                isUserPoolImported = true;
                this.cognitoUserPool = cognitoProps.userPool;
            }
            else {
                // validate `lambdaTriggers` is not specified
                if (cognitoProps.userPool && cognitoProps.userPool.lambdaTriggers) {
                    throw new Error(`Cannot configure the "cognito.userPool.lambdaTriggers" in the Auth construct. Use the "cognito.triggers" instead.`);
                }
                this.cognitoUserPool = new cognito.UserPool(this, "UserPool", Object.assign({ userPoolName: root.logicalPrefixedName(id), selfSignUpEnabled: true, signInCaseSensitive: false }, (cognitoProps.userPool || {})));
                // Create Trigger functions
                const { triggers, defaultFunctionProps } = cognitoProps;
                this.defaultFunctionProps = defaultFunctionProps;
                if (triggers) {
                    Object.entries(triggers).forEach(([triggerKey, triggerValue]) => this.addTrigger(this, triggerKey, triggerValue));
                }
            }
            // Create User Pool Client
            if (typeof cognitoProps === "boolean") {
                this.cognitoUserPoolClient = new cognito.UserPoolClient(this, "UserPoolClient", {
                    userPool: this.cognitoUserPool,
                });
            }
            else if (Construct_1.isCDKConstruct(cognitoProps.userPoolClient)) {
                if (!isUserPoolImported) {
                    throw new Error(`Cannot import the "userPoolClient" when the "userPool" is not imported.`);
                }
                this.cognitoUserPoolClient = cognitoProps.userPoolClient;
            }
            else {
                this.cognitoUserPoolClient = new cognito.UserPoolClient(this, "UserPoolClient", Object.assign({ userPool: this.cognitoUserPool }, (cognitoProps.userPoolClient || {})));
            }
            // Set cognito providers
            cognitoIdentityProviders.push({
                providerName: this.cognitoUserPool.userPoolProviderName,
                clientId: this.cognitoUserPoolClient.userPoolClientId,
            });
        }
        ////////////////////
        // Handle OpenId Connect Providers (ie. Auth0)
        ////////////////////
        const openIdConnectProviderArns = [];
        if (auth0) {
            if (!auth0.domain) {
                throw new Error(`No Auth0 domain defined for the "${id}" Auth`);
            }
            if (!auth0.clientId) {
                throw new Error(`No Auth0 clientId defined for the "${id}" Auth`);
            }
            const provider = new iam.OpenIdConnectProvider(this, "Auth0Provider", {
                url: auth0.domain.startsWith("https://")
                    ? auth0.domain
                    : `https://${auth0.domain}`,
                clientIds: [auth0.clientId],
            });
            openIdConnectProviderArns.push(provider.openIdConnectProviderArn);
        }
        ////////////////////
        // Handle Social Identity Providers
        ////////////////////
        const supportedLoginProviders = {};
        if (amazon) {
            if (!amazon.appId) {
                throw new Error(`No Amazon appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["www.amazon.com"] = amazon.appId;
        }
        if (facebook) {
            if (!facebook.appId) {
                throw new Error(`No Facebook appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["graph.facebook.com"] = facebook.appId;
        }
        if (google) {
            if (!google.clientId) {
                throw new Error(`No Google appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["accounts.google.com"] = google.clientId;
        }
        if (twitter) {
            if (!twitter.consumerKey) {
                throw new Error(`No Twitter consumer key defined for the "${id}" Auth`);
            }
            if (!twitter.consumerSecret) {
                throw new Error(`No Twitter consumer secret defined for the "${id}" Auth`);
            }
            supportedLoginProviders["api.twitter.com"] = `${twitter.consumerKey};${twitter.consumerSecret}`;
        }
        if (apple) {
            if (!apple.servicesId) {
                throw new Error(`No Apple servicesId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["appleid.apple.com"] = apple.servicesId;
        }
        ////////////////////
        // Create Identity Pool
        ////////////////////
        // Create Cognito Identity Pool
        this.cognitoCfnIdentityPool = new cognito.CfnIdentityPool(this, "IdentityPool", Object.assign({ identityPoolName: root.logicalPrefixedName(id), allowUnauthenticatedIdentities: true, cognitoIdentityProviders,
            supportedLoginProviders,
            openIdConnectProviderArns }, (identityPool || {})));
        this.iamAuthRole = this.createAuthRole(this.cognitoCfnIdentityPool);
        this.iamUnauthRole = this.createUnauthRole(this.cognitoCfnIdentityPool);
        // Attach roles to Identity Pool
        new cognito.CfnIdentityPoolRoleAttachment(this, "IdentityPoolRoleAttachment", {
            identityPoolId: this.cognitoCfnIdentityPool.ref,
            roles: {
                authenticated: this.iamAuthRole.roleArn,
                unauthenticated: this.iamUnauthRole.roleArn,
            },
        });
    }
    get cognitoIdentityPoolId() {
        return this.cognitoCfnIdentityPool.ref;
    }
    attachPermissionsForAuthUsers(permissions) {
        permission_1.attachPermissionsToRole(this.iamAuthRole, permissions);
    }
    attachPermissionsForUnauthUsers(permissions) {
        permission_1.attachPermissionsToRole(this.iamUnauthRole, permissions);
    }
    attachPermissionsForTriggers(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllTriggers.push(permissions);
    }
    attachPermissionsForTrigger(triggerKey, permissions) {
        const fn = this.getFunction(triggerKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Trigger "${triggerKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getFunction(triggerKey) {
        return this.functions[triggerKey];
    }
    getConstructMetadata() {
        var _a;
        return {
            type: "Auth",
            data: {
                identityPoolId: this.cognitoCfnIdentityPool.ref,
                userPoolId: (_a = this.cognitoUserPool) === null || _a === void 0 ? void 0 : _a.userPoolId,
                triggers: Object.entries(this.functions).map(([name, fun]) => ({
                    name,
                    fn: Construct_1.getFunctionRef(fun),
                })),
            },
        };
    }
    checkDeprecatedProps(props) {
        var _a;
        if (props.cognitoUserPool) {
            throw new Error(`The "cognitoUserPool" property is deprecated. Use the "cognito.userPool" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
        }
        if (props.cognitoUserPoolClient) {
            throw new Error(`The "cognitoUserPoolClient" property is deprecated. Use the "cognito.userPoolClient" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
        }
        if (props.cognito) {
            if (props.cognito !== true && ((_a = props.cognito) === null || _a === void 0 ? void 0 : _a.signInAliases)) {
                throw new Error(`The "cognito.signInAliases" property is deprecated. Use the "cognito.userPool.signInAliases" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
            }
        }
    }
    addTrigger(scope, triggerKey, triggerValue) {
        // Validate cognito user pool is defined
        if (!this.cognitoUserPool) {
            throw new Error(`Triggers cannot be added. No Cognito UserPool defined for the Auth construct.`);
        }
        // Create Function
        const lambda = Function_1.Function.fromDefinition(scope, triggerKey, triggerValue, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the triggers using FunctionProps, so the Auth construct can apply the "defaultFunctionProps" to them.`);
        // Create trigger
        const operation = AuthUserPoolTriggerOperationMapping[triggerKey];
        this.cognitoUserPool.addTrigger(operation, lambda);
        // Store function
        this.functions[triggerKey] = lambda;
        return lambda;
    }
    createAuthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolAuthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "authenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "mobileanalytics:PutEvents",
                "cognito-sync:*",
                "cognito-identity:*",
            ],
            resources: ["*"],
        }));
        return role;
    }
    createUnauthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolUnauthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "unauthenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["mobileanalytics:PutEvents", "cognito-sync:*"],
            resources: ["*"],
        }));
        return role;
    }
}
exports.Auth = Auth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9BdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBdUM7QUFDdkMseURBQTJDO0FBQzNDLGlFQUFtRDtBQUduRCwyQ0FBMkU7QUFDM0UseUNBQStFO0FBQy9FLGtEQUF5RTtBQUV6RSxNQUFNLG1DQUFtQyxHQUFHO0lBQzFDLG1CQUFtQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUI7SUFDcEUsYUFBYSxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjO0lBQ3ZELG1CQUFtQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUI7SUFDcEUsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDLG1CQUFtQjtJQUNqRSxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCO0lBQzdELGlCQUFpQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxrQkFBa0I7SUFDL0QsU0FBUyxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXO0lBQ2hELGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0I7SUFDbEUsYUFBYSxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjO0lBQ3ZELDJCQUEyQixFQUN6QixPQUFPLENBQUMsaUJBQWlCLENBQUMsOEJBQThCO0NBQzNELENBQUM7QUEwRUYsTUFBYSxJQUFLLFNBQVEsc0JBQVM7SUFVakMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFnQjtRQUN4RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLDBCQUEwQjtRQUMxQixJQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFakMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENB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QUN0QixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQ3hCLE9BQU8sRUFBRSxDQUFDLDJCQUEyQixFQUFFLGdCQUFnQixDQUFDO1lBQ3hELFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztTQUNqQixDQUFDLENBQ0gsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGO0FBalhELG9CQWlYQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGNvZ25pdG8gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jb2duaXRvXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMsIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5cbmNvbnN0IEF1dGhVc2VyUG9vbFRyaWdnZXJPcGVyYXRpb25NYXBwaW5nID0ge1xuICBjcmVhdGVBdXRoQ2hhbGxlbmdlOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLkNSRUFURV9BVVRIX0NIQUxMRU5HRSxcbiAgY3VzdG9tTWVzc2FnZTogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5DVVNUT01fTUVTU0FHRSxcbiAgZGVmaW5lQXV0aENoYWxsZW5nZTogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5ERUZJTkVfQVVUSF9DSEFMTEVOR0UsXG4gIHBvc3RBdXRoZW50aWNhdGlvbjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QT1NUX0FVVEhFTlRJQ0FUSU9OLFxuICBwb3N0Q29uZmlybWF0aW9uOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLlBPU1RfQ09ORklSTUFUSU9OLFxuICBwcmVBdXRoZW50aWNhdGlvbjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QUkVfQVVUSEVOVElDQVRJT04sXG4gIHByZVNpZ25VcDogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QUkVfU0lHTl9VUCxcbiAgcHJlVG9rZW5HZW5lcmF0aW9uOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLlBSRV9UT0tFTl9HRU5FUkFUSU9OLFxuICB1c2VyTWlncmF0aW9uOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLlVTRVJfTUlHUkFUSU9OLFxuICB2ZXJpZnlBdXRoQ2hhbGxlbmdlUmVzcG9uc2U6XG4gICAgY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5WRVJJRllfQVVUSF9DSEFMTEVOR0VfUkVTUE9OU0UsXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhQcm9wcyB7XG4gIHJlYWRvbmx5IGNvZ25pdG8/OiBib29sZWFuIHwgQXV0aENvZ25pdG9Qcm9wcztcbiAgcmVhZG9ubHkgYXV0aDA/OiBBdXRoQXV0aDBQcm9wcztcbiAgcmVhZG9ubHkgYW1hem9uPzogQXV0aEFtYXpvblByb3BzO1xuICByZWFkb25seSBhcHBsZT86IEF1dGhBcHBsZVByb3BzO1xuICByZWFkb25seSBmYWNlYm9vaz86IEF1dGhGYWNlYm9va1Byb3BzO1xuICByZWFkb25seSBnb29nbGU/OiBBdXRoR29vZ2xlUHJvcHM7XG4gIHJlYWRvbmx5IHR3aXR0ZXI/OiBBdXRoVHdpdHRlclByb3BzO1xuICByZWFkb25seSBpZGVudGl0eVBvb2w/OiBBdXRoQ2RrQ2ZuSWRlbnRpdHlQb29sUHJvcHM7XG4gIC8vIGRlcHJlY2F0ZWRcbiAgcmVhZG9ubHkgY29nbml0b1VzZXJQb29sPzogY29nbml0by5JVXNlclBvb2w7XG4gIHJlYWRvbmx5IGNvZ25pdG9Vc2VyUG9vbENsaWVudD86IGNvZ25pdG8uSVVzZXJQb29sQ2xpZW50O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhDb2duaXRvUHJvcHMge1xuICAvLyBOb3RlOiBDREsgY3VycmVudGx5IGRvZXMgbm90IHN1cHBvcnQgaW1wb3J0aW5nIGV4aXN0aW5nIFVzZXJQb29sIGJlY2F1c2UgdGhlXG4gIC8vICAgICAgIGltcG9ydGVkIElVc2VyUG9vbCBpbnRlcmZhY2UgZG9lcyBub3QgaGF2ZSB0aGUgXCJ1c2VyUG9vbFByb3ZpZGVyTmFtZVwiXG4gIC8vICAgICAgIHByb3BlcnR5LiBcInVzZXJQb29sUHJvdmlkZXJOYW1lXCIgbmVlZHMgdG8gYmUgcGFzc2VkIGludG8gSWRlbnRpdHkgUG9vbC5cbiAgcmVhZG9ubHkgdXNlclBvb2w/OiBjb2duaXRvLlVzZXJQb29sUHJvcHMgfCBjb2duaXRvLlVzZXJQb29sO1xuICByZWFkb25seSB1c2VyUG9vbENsaWVudD86XG4gICAgfCBjb2duaXRvLlVzZXJQb29sQ2xpZW50T3B0aW9uc1xuICAgIHwgY29nbml0by5Vc2VyUG9vbENsaWVudDtcbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICByZWFkb25seSB0cmlnZ2Vycz86IEF1dGhVc2VyUG9vbFRyaWdnZXJzO1xuICAvLyBkZXByZWNhdGVkXG4gIHJlYWRvbmx5IHNpZ25JbkFsaWFzZXM/OiBjb2duaXRvLlNpZ25JbkFsaWFzZXM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aFVzZXJQb29sVHJpZ2dlcnMge1xuICByZWFkb25seSBjcmVhdGVBdXRoQ2hhbGxlbmdlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBjdXN0b21NZXNzYWdlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBkZWZpbmVBdXRoQ2hhbGxlbmdlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBwb3N0QXV0aGVudGljYXRpb24/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHBvc3RDb25maXJtYXRpb24/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHByZUF1dGhlbnRpY2F0aW9uPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBwcmVTaWduVXA/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHByZVRva2VuR2VuZXJhdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgdXNlck1pZ3JhdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgdmVyaWZ5QXV0aENoYWxsZW5nZVJlc3BvbnNlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhBdXRoMFByb3BzIHtcbiAgcmVhZG9ubHkgZG9tYWluOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGNsaWVudElkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aEFtYXpvblByb3BzIHtcbiAgcmVhZG9ubHkgYXBwSWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQXBwbGVQcm9wcyB7XG4gIHJlYWRvbmx5IHNlcnZpY2VzSWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoRmFjZWJvb2tQcm9wcyB7XG4gIHJlYWRvbmx5IGFwcElkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aEdvb2dsZVByb3BzIHtcbiAgcmVhZG9ubHkgY2xpZW50SWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoVHdpdHRlclByb3BzIHtcbiAgcmVhZG9ubHkgY29uc3VtZXJLZXk6IHN0cmluZztcbiAgcmVhZG9ubHkgY29uc3VtZXJTZWNyZXQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQ2RrQ2ZuSWRlbnRpdHlQb29sUHJvcHNcbiAgZXh0ZW5kcyBPbWl0PGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sUHJvcHMsIFwiYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzXCI+IHtcbiAgcmVhZG9ubHkgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEF1dGggZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgY29nbml0b1VzZXJQb29sPzogY29nbml0by5Vc2VyUG9vbDtcbiAgcHVibGljIHJlYWRvbmx5IGNvZ25pdG9Vc2VyUG9vbENsaWVudD86IGNvZ25pdG8uVXNlclBvb2xDbGllbnQ7XG4gIHB1YmxpYyByZWFkb25seSBjb2duaXRvQ2ZuSWRlbnRpdHlQb29sOiBjb2duaXRvLkNmbklkZW50aXR5UG9vbDtcbiAgcHVibGljIHJlYWRvbmx5IGlhbUF1dGhSb2xlOiBpYW0uUm9sZTtcbiAgcHVibGljIHJlYWRvbmx5IGlhbVVuYXV0aFJvbGU6IGlhbS5Sb2xlO1xuICBwcml2YXRlIHJlYWRvbmx5IGZ1bmN0aW9uczogeyBba2V5OiBzdHJpbmddOiBGbiB9O1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsVHJpZ2dlcnM6IFBlcm1pc3Npb25zW107XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEF1dGhQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAvLyBIYW5kbGUgZGVwcmVjYXRlZCBwcm9wc1xuICAgIHRoaXMuY2hlY2tEZXByZWNhdGVkUHJvcHMocHJvcHMpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qge1xuICAgICAgY29nbml0bzogY29nbml0b1Byb3BzLFxuICAgICAgYXV0aDAsXG4gICAgICBhbWF6b24sXG4gICAgICBhcHBsZSxcbiAgICAgIGZhY2Vib29rLFxuICAgICAgZ29vZ2xlLFxuICAgICAgdHdpdHRlcixcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICB9ID0gcHJvcHM7XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUcmlnZ2VycyA9IFtdO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBIYW5kbGUgQ29nbml0byBJZGVudGl0eSBQcm92aWRlcnMgKGllLiBVc2VyIFBvb2wpXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBjb2duaXRvSWRlbnRpdHlQcm92aWRlcnMgPSBbXTtcblxuICAgIGlmIChjb2duaXRvUHJvcHMpIHtcbiAgICAgIGxldCBpc1VzZXJQb29sSW1wb3J0ZWQgPSBmYWxzZTtcblxuICAgICAgLy8gQ3JlYXRlIFVzZXIgUG9vbFxuICAgICAgaWYgKHR5cGVvZiBjb2duaXRvUHJvcHMgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sID0gbmV3IGNvZ25pdG8uVXNlclBvb2wodGhpcywgXCJVc2VyUG9vbFwiLCB7XG4gICAgICAgICAgdXNlclBvb2xOYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICAgIHNlbGZTaWduVXBFbmFibGVkOiB0cnVlLFxuICAgICAgICAgIHNpZ25JbkNhc2VTZW5zaXRpdmU6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoaXNDREtDb25zdHJ1Y3QoY29nbml0b1Byb3BzLnVzZXJQb29sKSkge1xuICAgICAgICBpc1VzZXJQb29sSW1wb3J0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmNvZ25pdG9Vc2VyUG9vbCA9IGNvZ25pdG9Qcm9wcy51c2VyUG9vbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHZhbGlkYXRlIGBsYW1iZGFUcmlnZ2Vyc2AgaXMgbm90IHNwZWNpZmllZFxuICAgICAgICBpZiAoY29nbml0b1Byb3BzLnVzZXJQb29sICYmIGNvZ25pdG9Qcm9wcy51c2VyUG9vbC5sYW1iZGFUcmlnZ2Vycykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNvZ25pdG8udXNlclBvb2wubGFtYmRhVHJpZ2dlcnNcIiBpbiB0aGUgQXV0aCBjb25zdHJ1Y3QuIFVzZSB0aGUgXCJjb2duaXRvLnRyaWdnZXJzXCIgaW5zdGVhZC5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sID0gbmV3IGNvZ25pdG8uVXNlclBvb2wodGhpcywgXCJVc2VyUG9vbFwiLCB7XG4gICAgICAgICAgdXNlclBvb2xOYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICAgIHNlbGZTaWduVXBFbmFibGVkOiB0cnVlLFxuICAgICAgICAgIHNpZ25JbkNhc2VTZW5zaXRpdmU6IGZhbHNlLFxuICAgICAgICAgIC4uLihjb2duaXRvUHJvcHMudXNlclBvb2wgfHwge30pLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBDcmVhdGUgVHJpZ2dlciBmdW5jdGlvbnNcbiAgICAgICAgY29uc3QgeyB0cmlnZ2VycywgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfSA9IGNvZ25pdG9Qcm9wcztcbiAgICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuXG4gICAgICAgIGlmICh0cmlnZ2Vycykge1xuICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHRyaWdnZXJzKS5mb3JFYWNoKChbdHJpZ2dlcktleSwgdHJpZ2dlclZhbHVlXSkgPT5cbiAgICAgICAgICAgIHRoaXMuYWRkVHJpZ2dlcihcbiAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgdHJpZ2dlcktleSBhcyBrZXlvZiBBdXRoVXNlclBvb2xUcmlnZ2VycyxcbiAgICAgICAgICAgICAgdHJpZ2dlclZhbHVlXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDcmVhdGUgVXNlciBQb29sIENsaWVudFxuICAgICAgaWYgKHR5cGVvZiBjb2duaXRvUHJvcHMgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sQ2xpZW50ID0gbmV3IGNvZ25pdG8uVXNlclBvb2xDbGllbnQoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIlVzZXJQb29sQ2xpZW50XCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlclBvb2w6IHRoaXMuY29nbml0b1VzZXJQb29sLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoaXNDREtDb25zdHJ1Y3QoY29nbml0b1Byb3BzLnVzZXJQb29sQ2xpZW50KSkge1xuICAgICAgICBpZiAoIWlzVXNlclBvb2xJbXBvcnRlZCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBDYW5ub3QgaW1wb3J0IHRoZSBcInVzZXJQb29sQ2xpZW50XCIgd2hlbiB0aGUgXCJ1c2VyUG9vbFwiIGlzIG5vdCBpbXBvcnRlZC5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvZ25pdG9Vc2VyUG9vbENsaWVudCA9IGNvZ25pdG9Qcm9wcy51c2VyUG9vbENsaWVudDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sQ2xpZW50ID0gbmV3IGNvZ25pdG8uVXNlclBvb2xDbGllbnQoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIlVzZXJQb29sQ2xpZW50XCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlclBvb2w6IHRoaXMuY29nbml0b1VzZXJQb29sLFxuICAgICAgICAgICAgLi4uKGNvZ25pdG9Qcm9wcy51c2VyUG9vbENsaWVudCB8fCB7fSksXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBTZXQgY29nbml0byBwcm92aWRlcnNcbiAgICAgIGNvZ25pdG9JZGVudGl0eVByb3ZpZGVycy5wdXNoKHtcbiAgICAgICAgcHJvdmlkZXJOYW1lOiB0aGlzLmNvZ25pdG9Vc2VyUG9vbC51c2VyUG9vbFByb3ZpZGVyTmFtZSxcbiAgICAgICAgY2xpZW50SWQ6IHRoaXMuY29nbml0b1VzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEhhbmRsZSBPcGVuSWQgQ29ubmVjdCBQcm92aWRlcnMgKGllLiBBdXRoMClcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IG9wZW5JZENvbm5lY3RQcm92aWRlckFybnMgPSBbXTtcblxuICAgIGlmIChhdXRoMCkge1xuICAgICAgaWYgKCFhdXRoMC5kb21haW4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBBdXRoMCBkb21haW4gZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBpZiAoIWF1dGgwLmNsaWVudElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQXV0aDAgY2xpZW50SWQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBpYW0uT3BlbklkQ29ubmVjdFByb3ZpZGVyKHRoaXMsIFwiQXV0aDBQcm92aWRlclwiLCB7XG4gICAgICAgIHVybDogYXV0aDAuZG9tYWluLnN0YXJ0c1dpdGgoXCJodHRwczovL1wiKVxuICAgICAgICAgID8gYXV0aDAuZG9tYWluXG4gICAgICAgICAgOiBgaHR0cHM6Ly8ke2F1dGgwLmRvbWFpbn1gLFxuICAgICAgICBjbGllbnRJZHM6IFthdXRoMC5jbGllbnRJZF0sXG4gICAgICB9KTtcbiAgICAgIG9wZW5JZENvbm5lY3RQcm92aWRlckFybnMucHVzaChwcm92aWRlci5vcGVuSWRDb25uZWN0UHJvdmlkZXJBcm4pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gSGFuZGxlIFNvY2lhbCBJZGVudGl0eSBQcm92aWRlcnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcblxuICAgIGlmIChhbWF6b24pIHtcbiAgICAgIGlmICghYW1hem9uLmFwcElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQW1hem9uIGFwcElkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXCJ3d3cuYW1hem9uLmNvbVwiXSA9IGFtYXpvbi5hcHBJZDtcbiAgICB9XG4gICAgaWYgKGZhY2Vib29rKSB7XG4gICAgICBpZiAoIWZhY2Vib29rLmFwcElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gRmFjZWJvb2sgYXBwSWQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBzdXBwb3J0ZWRMb2dpblByb3ZpZGVyc1tcImdyYXBoLmZhY2Vib29rLmNvbVwiXSA9IGZhY2Vib29rLmFwcElkO1xuICAgIH1cbiAgICBpZiAoZ29vZ2xlKSB7XG4gICAgICBpZiAoIWdvb2dsZS5jbGllbnRJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIEdvb2dsZSBhcHBJZCBkZWZpbmVkIGZvciB0aGUgXCIke2lkfVwiIEF1dGhgKTtcbiAgICAgIH1cbiAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW1wiYWNjb3VudHMuZ29vZ2xlLmNvbVwiXSA9IGdvb2dsZS5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKHR3aXR0ZXIpIHtcbiAgICAgIGlmICghdHdpdHRlci5jb25zdW1lcktleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIFR3aXR0ZXIgY29uc3VtZXIga2V5IGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgaWYgKCF0d2l0dGVyLmNvbnN1bWVyU2VjcmV0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgTm8gVHdpdHRlciBjb25zdW1lciBzZWNyZXQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXG4gICAgICAgIFwiYXBpLnR3aXR0ZXIuY29tXCJcbiAgICAgIF0gPSBgJHt0d2l0dGVyLmNvbnN1bWVyS2V5fTske3R3aXR0ZXIuY29uc3VtZXJTZWNyZXR9YDtcbiAgICB9XG4gICAgaWYgKGFwcGxlKSB7XG4gICAgICBpZiAoIWFwcGxlLnNlcnZpY2VzSWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBBcHBsZSBzZXJ2aWNlc0lkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXCJhcHBsZWlkLmFwcGxlLmNvbVwiXSA9IGFwcGxlLnNlcnZpY2VzSWQ7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgSWRlbnRpdHkgUG9vbFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAvLyBDcmVhdGUgQ29nbml0byBJZGVudGl0eSBQb29sXG4gICAgdGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sID0gbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKFxuICAgICAgdGhpcyxcbiAgICAgIFwiSWRlbnRpdHlQb29sXCIsXG4gICAgICB7XG4gICAgICAgIGlkZW50aXR5UG9vbE5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIGFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllczogdHJ1ZSxcbiAgICAgICAgY29nbml0b0lkZW50aXR5UHJvdmlkZXJzLFxuICAgICAgICBzdXBwb3J0ZWRMb2dpblByb3ZpZGVycyxcbiAgICAgICAgb3BlbklkQ29ubmVjdFByb3ZpZGVyQXJucyxcbiAgICAgICAgLi4uKGlkZW50aXR5UG9vbCB8fCB7fSksXG4gICAgICB9XG4gICAgKTtcbiAgICB0aGlzLmlhbUF1dGhSb2xlID0gdGhpcy5jcmVhdGVBdXRoUm9sZSh0aGlzLmNvZ25pdG9DZm5JZGVudGl0eVBvb2wpO1xuICAgIHRoaXMuaWFtVW5hdXRoUm9sZSA9IHRoaXMuY3JlYXRlVW5hdXRoUm9sZSh0aGlzLmNvZ25pdG9DZm5JZGVudGl0eVBvb2wpO1xuXG4gICAgLy8gQXR0YWNoIHJvbGVzIHRvIElkZW50aXR5IFBvb2xcbiAgICBuZXcgY29nbml0by5DZm5JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudChcbiAgICAgIHRoaXMsXG4gICAgICBcIklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50XCIsXG4gICAgICB7XG4gICAgICAgIGlkZW50aXR5UG9vbElkOiB0aGlzLmNvZ25pdG9DZm5JZGVudGl0eVBvb2wucmVmLFxuICAgICAgICByb2xlczoge1xuICAgICAgICAgIGF1dGhlbnRpY2F0ZWQ6IHRoaXMuaWFtQXV0aFJvbGUucm9sZUFybixcbiAgICAgICAgICB1bmF1dGhlbnRpY2F0ZWQ6IHRoaXMuaWFtVW5hdXRoUm9sZS5yb2xlQXJuLFxuICAgICAgICB9LFxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGNvZ25pdG9JZGVudGl0eVBvb2xJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNvZ25pdG9DZm5JZGVudGl0eVBvb2wucmVmO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zRm9yQXV0aFVzZXJzKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKHRoaXMuaWFtQXV0aFJvbGUsIHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc0ZvclVuYXV0aFVzZXJzKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKHRoaXMuaWFtVW5hdXRoUm9sZSwgcGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zRm9yVHJpZ2dlcnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmZ1bmN0aW9ucykuZm9yRWFjaCgoZm4pID0+XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRyaWdnZXJzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zRm9yVHJpZ2dlcihcbiAgICB0cmlnZ2VyS2V5OiBrZXlvZiBBdXRoVXNlclBvb2xUcmlnZ2VycyxcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgZm4gPSB0aGlzLmdldEZ1bmN0aW9uKHRyaWdnZXJLZXkpO1xuICAgIGlmICghZm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBhdHRhY2ggcGVybWlzc2lvbnMuIFRyaWdnZXIgXCIke3RyaWdnZXJLZXl9XCIgZG9lcyBub3QgZXhpc3QuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RnVuY3Rpb24odHJpZ2dlcktleToga2V5b2YgQXV0aFVzZXJQb29sVHJpZ2dlcnMpOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuZnVuY3Rpb25zW3RyaWdnZXJLZXldO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIkF1dGhcIiBhcyBjb25zdCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgaWRlbnRpdHlQb29sSWQ6IHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgIHVzZXJQb29sSWQ6IHRoaXMuY29nbml0b1VzZXJQb29sPy51c2VyUG9vbElkLFxuICAgICAgICB0cmlnZ2VyczogT2JqZWN0LmVudHJpZXModGhpcy5mdW5jdGlvbnMpLm1hcCgoW25hbWUsIGZ1bl0pID0+ICh7XG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBmbjogZ2V0RnVuY3Rpb25SZWYoZnVuKSxcbiAgICAgICAgfSkpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0RlcHJlY2F0ZWRQcm9wcyhwcm9wczogQXV0aFByb3BzKTogdm9pZCB7XG4gICAgaWYgKHByb3BzLmNvZ25pdG9Vc2VyUG9vbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlIFwiY29nbml0b1VzZXJQb29sXCIgcHJvcGVydHkgaXMgZGVwcmVjYXRlZC4gVXNlIHRoZSBcImNvZ25pdG8udXNlclBvb2xcIiBpbnN0ZWFkLiBNb3JlIGRldGFpbHMgb24gdXBncmFkaW5nIC0gaHR0cHM6Ly9kb2NzLnNlcnZlcmxlc3Mtc3RhY2suY29tL2NvbnN0cnVjdHMvQXV0aCN1cGdyYWRpbmctdG8tdjAxMjBgXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAocHJvcHMuY29nbml0b1VzZXJQb29sQ2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgXCJjb2duaXRvVXNlclBvb2xDbGllbnRcIiBwcm9wZXJ0eSBpcyBkZXByZWNhdGVkLiBVc2UgdGhlIFwiY29nbml0by51c2VyUG9vbENsaWVudFwiIGluc3RlYWQuIE1vcmUgZGV0YWlscyBvbiB1cGdyYWRpbmcgLSBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9BdXRoI3VwZ3JhZGluZy10by12MDEyMGBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChwcm9wcy5jb2duaXRvKSB7XG4gICAgICBpZiAocHJvcHMuY29nbml0byAhPT0gdHJ1ZSAmJiBwcm9wcy5jb2duaXRvPy5zaWduSW5BbGlhc2VzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlIFwiY29nbml0by5zaWduSW5BbGlhc2VzXCIgcHJvcGVydHkgaXMgZGVwcmVjYXRlZC4gVXNlIHRoZSBcImNvZ25pdG8udXNlclBvb2wuc2lnbkluQWxpYXNlc1wiIGluc3RlYWQuIE1vcmUgZGV0YWlscyBvbiB1cGdyYWRpbmcgLSBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9BdXRoI3VwZ3JhZGluZy10by12MDEyMGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFRyaWdnZXIoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICB0cmlnZ2VyS2V5OiBrZXlvZiBBdXRoVXNlclBvb2xUcmlnZ2VycyxcbiAgICB0cmlnZ2VyVmFsdWU6IEZ1bmN0aW9uRGVmaW5pdGlvblxuICApOiBGbiB7XG4gICAgLy8gVmFsaWRhdGUgY29nbml0byB1c2VyIHBvb2wgaXMgZGVmaW5lZFxuICAgIGlmICghdGhpcy5jb2duaXRvVXNlclBvb2wpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRyaWdnZXJzIGNhbm5vdCBiZSBhZGRlZC4gTm8gQ29nbml0byBVc2VyUG9vbCBkZWZpbmVkIGZvciB0aGUgQXV0aCBjb25zdHJ1Y3QuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgRnVuY3Rpb25cbiAgICBjb25zdCBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgdHJpZ2dlcktleSxcbiAgICAgIHRyaWdnZXJWYWx1ZSxcbiAgICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICBgVGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgYWxsIHRoZSB0cmlnZ2VycyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgQXV0aCBjb25zdHJ1Y3QgY2FuIGFwcGx5IHRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgdG8gdGhlbS5gXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSB0cmlnZ2VyXG4gICAgY29uc3Qgb3BlcmF0aW9uID0gQXV0aFVzZXJQb29sVHJpZ2dlck9wZXJhdGlvbk1hcHBpbmdbdHJpZ2dlcktleV07XG4gICAgdGhpcy5jb2duaXRvVXNlclBvb2wuYWRkVHJpZ2dlcihvcGVyYXRpb24sIGxhbWJkYSk7XG5cbiAgICAvLyBTdG9yZSBmdW5jdGlvblxuICAgIHRoaXMuZnVuY3Rpb25zW3RyaWdnZXJLZXldID0gbGFtYmRhO1xuXG4gICAgcmV0dXJuIGxhbWJkYTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQXV0aFJvbGUoaWRlbnRpdHlQb29sOiBjb2duaXRvLkNmbklkZW50aXR5UG9vbCk6IGlhbS5Sb2xlIHtcbiAgICBjb25zdCByb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsIFwiSWRlbnRpdHlQb29sQXV0aFJvbGVcIiwge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLkZlZGVyYXRlZFByaW5jaXBhbChcbiAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb21cIixcbiAgICAgICAge1xuICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkXCI6IGlkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBcIkZvckFueVZhbHVlOlN0cmluZ0xpa2VcIjoge1xuICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yXCI6IFwiYXV0aGVudGljYXRlZFwiLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIFwic3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlcIlxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwibW9iaWxlYW5hbHl0aWNzOlB1dEV2ZW50c1wiLFxuICAgICAgICAgIFwiY29nbml0by1zeW5jOipcIixcbiAgICAgICAgICBcImNvZ25pdG8taWRlbnRpdHk6KlwiLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gcm9sZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVW5hdXRoUm9sZShpZGVudGl0eVBvb2w6IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKTogaWFtLlJvbGUge1xuICAgIGNvbnN0IHJvbGUgPSBuZXcgaWFtLlJvbGUodGhpcywgXCJJZGVudGl0eVBvb2xVbmF1dGhSb2xlXCIsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5GZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tXCIsXG4gICAgICAgIHtcbiAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZFwiOiBpZGVudGl0eVBvb2wucmVmLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgXCJGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlXCI6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtclwiOiBcInVuYXV0aGVudGljYXRlZFwiLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIFwic3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlcIlxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wibW9iaWxlYW5hbHl0aWNzOlB1dEV2ZW50c1wiLCBcImNvZ25pdG8tc3luYzoqXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gcm9sZTtcbiAgfVxufVxuIl19